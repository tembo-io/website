"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[748],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>g});var o=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),p=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},d=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=p(a),m=n,g=c["".concat(l,".").concat(m)]||c[m]||u[m]||r;return a?o.createElement(g,s(s({ref:t},d),{},{components:a})):o.createElement(g,s({ref:t},d))}));function g(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:n,s[1]=i;for(var p=2;p<r;p++)s[p]=a[p];return o.createElement.apply(null,s)}return o.createElement.apply(null,a)}m.displayName="MDXCreateElement"},3928:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var o=a(87462),n=(a(67294),a(3905));const r={slug:"postgres-16",title:"Postgres 16: The exciting and the unnoticed",authors:["samay"],tags:["postgres"]},s=void 0,i={permalink:"/blog/postgres-16",editUrl:"https://github.com/tembo-io/website/blob/main/blog/2023-09-20-postgres-16/index.md",source:"@site/blog/2023-09-20-postgres-16/index.md",title:"Postgres 16: The exciting and the unnoticed",description:"In case you missed it, Postgres 16 came out last week - and this year it arrived earlier than the last few years. There are many features that I\u2019ve been looking forward to for the last few months and I\u2019m excited to see them get into the hands of users. Before we dive into the specific features of this release, let\u2019s discuss what a Postgres major release actually means.",date:"2023-09-20T00:00:00.000Z",formattedDate:"September 20, 2023",tags:[{label:"postgres",permalink:"/blog/tags/postgres"}],readingTime:8.83,hasTruncateMarker:!1,authors:[{name:"Samay Sharma",title:"CTO Tembo",url:"https://github.com/samay-sharma",email:"noreply@tembo.io",imageURL:"https://github.com/samay-sharma.png",key:"samay"}],frontMatter:{slug:"postgres-16",title:"Postgres 16: The exciting and the unnoticed",authors:["samay"],tags:["postgres"]},prevItem:{title:"Anatomy of a Postgres extension written in Rust: pgmq",permalink:"/blog/postgres-extension-in-rust-pgmq"},nextItem:{title:"Enter the matrix: the four types of Postgres extensions",permalink:"/blog/four-types-of-extensions"}},l={authorsImageUrls:[void 0]},p=[{value:"Postgres Releases",id:"postgres-releases",level:2},{value:"Should I upgrade to Postgres 16?",id:"should-i-upgrade-to-postgres-16",level:2},{value:"What\u2019s most exciting about Postgres 16?",id:"whats-most-exciting-about-postgres-16",level:2},{value:"Logical replication improvements",id:"logical-replication-improvements",level:3},{value:"Monitoring improvements",id:"monitoring-improvements",level:3},{value:"Special mentions",id:"special-mentions",level:3},{value:"Laying the groundwork for an exciting Postgres 17 (and beyond)",id:"laying-the-groundwork-for-an-exciting-postgres-17-and-beyond",level:2},{value:"Postgres continues to deliver",id:"postgres-continues-to-deliver",level:2}],d={toc:p},c="wrapper";function u(e){let{components:t,...r}=e;return(0,n.kt)(c,(0,o.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"In case you missed it, Postgres 16 came out last week - and this year it arrived earlier than the last few years. There are many features that I\u2019ve been looking forward to for the last few months and I\u2019m excited to see them get into the hands of users. Before we dive into the specific features of this release, let\u2019s discuss what a Postgres major release actually means."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"postgres-16",src:a(7223).Z,title:"PG16",width:"1666",height:"1140"})),(0,n.kt)("h2",{id:"postgres-releases"},"Postgres Releases"),(0,n.kt)("p",null,"The PostgreSQL Global Development Group releases a new ",(0,n.kt)("em",{parentName:"p"},"major")," ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/support/versioning/"},"version")," every year with new features. "),(0,n.kt)("p",null,"In addition, Postgres releases minor versions of each major release every 3 months or so with bug fixes and security fixes. No new features are released in minor versions, and that\u2019s what makes major version releases so exciting as it\u2019s the culmination of about a year\u2019s worth of development work on the project. "),(0,n.kt)("p",null,"While there's a case to be made for faster release of features, Postgres prides itself on stability and this release cadence provides enough time for features to be proposed, reviewed, committed and tested before they get shipped."),(0,n.kt)("h2",{id:"should-i-upgrade-to-postgres-16"},"Should I upgrade to Postgres 16?"),(0,n.kt)("p",null,"If you are building a new application, yes, I would recommend that you start with the latest major version of Postgres. This will guarantee the latest and greatest features, and a continuous flow of minor releases that fix bugs and improve the security of your database."),(0,n.kt)("p",null,"If you are upgrading an existing system, there are more factors to consider. The general advice is to ",(0,n.kt)("strong",{parentName:"p"},"upgrade minor versions")," always - because they contain security and bug fixes and the risk of not upgrading is higher. "),(0,n.kt)("p",null,"However, for major versions, you will need to consider the tradeoffs as the major versions usually change the internal format of system tables and data files. That means, you can\u2019t just use previous versions of the data directory \u2014 you\u2019ll need to use ",(0,n.kt)("inlineCode",{parentName:"p"},"pg_dump")," / ",(0,n.kt)("inlineCode",{parentName:"p"},"pg_restore")," or ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/pgupgrade.html"},"pg_upgrade")," to upgrade. In addition, depending on the features you are using and the Postgres release, manual changes to your code or queries may also be required."),(0,n.kt)("p",null,"Obviously, another important factor if you are using a managed service provider is when they provide support for Postgres 16. At ",(0,n.kt)("a",{parentName:"p",href:"https://cloud.tembo.io/"},"Tembo Cloud"),", we\u2019ve already started working on supporting Postgres 16 and expect it to be available in a few weeks."),(0,n.kt)("h2",{id:"whats-most-exciting-about-postgres-16"},"What\u2019s most exciting about Postgres 16?"),(0,n.kt)("p",null,"Postgres 16 delivers exciting features in all aspects of the database ranging from performance improvements, monitoring enhancements, better security and privilege handling, replication improvements, new server features and commands and a lot more. "),(0,n.kt)("p",null,"If you\u2019re interested in the complete list of features, you can read the detailed ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/16/release-16.html"},"release notes"),". Below, I\u2019ll talk about the aspects of this release which excite me the most and we will talk about a few not-so-talked about features which lay the groundwork for more exciting features in Postgres 17."),(0,n.kt)("h3",{id:"logical-replication-improvements"},"Logical replication improvements"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/logical-replication.html"},"Logical replication")," is a feature I\u2019ve always been interested in, as it allows you to expand the capabilities of Postgres by moving data between different Postgres databases or from Postgres to other databases. It finds interesting use cases in: replicating selectively from one database to another, replicating across Postgres versions, online migrations and allowing consolidation from multiple databases."),(0,n.kt)("p",null,"This release, arguably the most exciting logical replication feature, is allowing ",(0,n.kt)("a",{parentName:"p",href:"https://pganalyze.com/blog/5mins-postgres-16-logical-decoding"},"logical replication from standby servers"),". Prior to this feature, you could only create a logical replication slot on the primary which meant adding more replicas would add more load on the primary. With Postgres 16, secondaries also have the ability to create replication slots allowing for more distribution of that load. What\u2019s more is that the replication slots on the secondary are persisted even when the standby is promoted to the primary. This means that subscribers won\u2019t be affected even during a failover! You can read more about this feature in Bertrand\u2019s ",(0,n.kt)("a",{parentName:"p",href:"https://bdrouvot.github.io/2023/04/19/postgres-16-highlight-logical-decoding-on-standby/"},"blog post"),"."),(0,n.kt)("p",null,"The short of it is that now you can do this on a Postgres 16 standby:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"postgres@standby=# select pg_is_in_recovery();\n pg_is_in_recovery\n-------------------\n t\n(1 row)\n\npostgres@standby=# SELECT * FROM pg_create_logical_replication_slot('active_slot', 'test_decoding', false, true);\n  slot_name  |    lsn\n-------------+------------\n active_slot | 0/C0053A78\n(1 row)\n")),(0,n.kt)("p",null,"On Postgres 15, the same thing would have errored out:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"postgres@standby=# SELECT * FROM pg_create_logical_replication_slot('active_slot', 'test_decoding', false, true);\nERROR:  logical decoding cannot be used while in recovery\n")),(0,n.kt)("p",null,"In addition to this, there are a number of other logical replication performance improvements. This includes faster initial table sync using ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/message-id/flat/TYCPR01MB8373B593010467315C2BA8EBED229%40TYCPR01MB8373.jpnprd01.prod.outlook.com#be8109723de40d3724730713175517ab"},"binary format"),", use of ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/message-id/flat/CACawEhX6TvX%2Bj8EpcpCKvnMGao8Gcp8W43Sgc87pg9o6-Xbf2Q%40mail.gmail.com#81e7ec5c7732e7492c9e28d0f38df657"},"btree indexes")," during logical replication apply when tables don\u2019t have a primary key (previously the table would be scanned sequentially) and parallel application of large transactions (~25-40% speedups)."),(0,n.kt)("h3",{id:"monitoring-improvements"},"Monitoring improvements"),(0,n.kt)("p",null,"The other bucket of features which intrigued me are the monitoring enhancements. While Postgres provides a number of statistics tables with monitoring information, I believe more can be done to provide actionable insights to users. As an example, Lukas pointed out several interesting gaps in Postgres monitoring in his ",(0,n.kt)("a",{parentName:"p",href:"https://www.pgcon.org/events/pgcon_2020/sessions/session/132/slides/49/Whats%20Missing%20for%20Postgres%20Monitoring.pdf"},"PGCon 2020 talk"),"."),(0,n.kt)("p",null,"Coming back to this release, ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/16/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW"},(0,n.kt)("inlineCode",{parentName:"a"},"pg_stat_io"))," has to be the most useful piece of information added to the Postgres stats views in Postgres 16. It allows you to understand the I/O done by Postgres at a more granular level, broken down by ",(0,n.kt)("inlineCode",{parentName:"p"},"backend_type")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"context"),". This means you can calculate a more accurate cache hit ratio by ignoring the I/O done by VACUUM, differentiate between ",(0,n.kt)("inlineCode",{parentName:"p"},"extends")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"flushes"),", and separate out bulk operations while deciding which configurations to tune. Melanie talks about this and much more in her ",(0,n.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=rCzSNdUOEdg"},"talk")," and this ",(0,n.kt)("a",{parentName:"p",href:"https://www.depesz.com/2023/02/27/waiting-for-postgresql-16-add-pg_stat_io-view-providing-more-detailed-io-statistics/"},"blog post")," approaches how you would use this as a DBA."),(0,n.kt)("p",null,"Here is an example of the statistics you can see in ",(0,n.kt)("inlineCode",{parentName:"p"},"pg_stat_io"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"$ SELECT * FROM pg_stat_io ;\n    backend_type     \u2502   io_object   \u2502 io_context \u2502  reads  \u2502 writes  \u2502 extends \u2502 op_bytes \u2502 evictions \u2502 reuses  \u2502 fsyncs \u2502          stats_reset\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n autovacuum launcher \u2502 relation      \u2502 bulkread   \u2502       0 \u2502       0 \u2502  [NULL] \u2502     8192 \u2502         0 \u2502       0 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n ...\n autovacuum worker   \u2502 relation      \u2502 bulkread   \u2502       0 \u2502       0 \u2502  [NULL] \u2502     8192 \u2502         0 \u2502       0 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n ...\n client backend      \u2502 temp relation \u2502 normal     \u2502       0 \u2502       0 \u2502       0 \u2502     8192 \u2502         0 \u2502  [NULL] \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n background worker   \u2502 relation      \u2502 bulkread   \u2502  268221 \u2502  268189 \u2502  [NULL] \u2502     8192 \u2502         0 \u2502  268189 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n ...\n checkpointer        \u2502 relation      \u2502 normal     \u2502  [NULL] \u2502   32121 \u2502  [NULL] \u2502     8192 \u2502    [NULL] \u2502  [NULL] \u2502   3356 \u2502 2023-02-27 13:25:39.725072+01\n standalone backend  \u2502 relation      \u2502 bulkread   \u2502       0 \u2502       0 \u2502  [NULL] \u2502     8192 \u2502         0 \u2502       0 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n ...\n startup             \u2502 relation      \u2502 vacuum     \u2502       0 \u2502       0 \u2502       0 \u2502     8192 \u2502         0 \u2502       0 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n walsender           \u2502 relation      \u2502 bulkread   \u2502       0 \u2502       0 \u2502  [NULL] \u2502     8192 \u2502         0 \u2502       0 \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n ...\n walsender           \u2502 temp relation \u2502 normal     \u2502       0 \u2502       0 \u2502       0 \u2502     8192 \u2502         0 \u2502  [NULL] \u2502 [NULL] \u2502 2023-02-27 13:25:39.725072+01\n...\n")),(0,n.kt)("p",null,"In addition to this, there are other improvements including the addition of ",(0,n.kt)("inlineCode",{parentName:"p"},"last_seq_scan")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"last_idx_scan")," on ",(0,n.kt)("inlineCode",{parentName:"p"},"pg_stat_*")," tables which allow you to understand index usage better and figure out when plans for a query might have changed."),(0,n.kt)("h3",{id:"special-mentions"},"Special mentions"),(0,n.kt)("p",null,"Like I said, each release comes with many improvements - and I could not outline them all in a blog post (and if I did, nobody would read it!). But I do want to mention a few other items in Postgres 16 that I won\u2019t be able to dive deeper into but are interesting as well."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Load balancing with multiple hosts in ",(0,n.kt)("inlineCode",{parentName:"li"},"libpq"),": This feature allows to balance the load across Postgres read replicas directly within ",(0,n.kt)("inlineCode",{parentName:"li"},"libpq")," (which is the foundational Postgres client library) without having to use another load balancer. You can read ",(0,n.kt)("a",{parentName:"li",href:"https://mydbops.wordpress.com/2023/05/07/postgresql-16-brings-load-balancing-support-in-libpq-psql/"},"this blog post")," on how this new feature is implemented and can be used."),(0,n.kt)("li",{parentName:"ul"},"Performance: I won\u2019t repeat what\u2019s in the release notes but there\u2019s a long list of performance improvements in this release. There\u2019s support for more parallelism on ",(0,n.kt)("inlineCode",{parentName:"li"},"FULL")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"OUTER")," ",(0,n.kt)("inlineCode",{parentName:"li"},"JOINs")," and on more aggregates, greater usage of incremental sorts, window function optimizations and even an upto 300% performance improvement in ",(0,n.kt)("inlineCode",{parentName:"li"},"COPY"),"."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"VACUUM")," improvements: Last thing I\u2019d mention is improvements to ",(0,n.kt)("inlineCode",{parentName:"li"},"VACUUM")," which include freezing performance improvements, ability to increase (or decrease) shared buffer usage by ",(0,n.kt)("inlineCode",{parentName:"li"},"VACUUM"),", and faster loading of ",(0,n.kt)("inlineCode",{parentName:"li"},"VACUUM")," configs.")),(0,n.kt)("h2",{id:"laying-the-groundwork-for-an-exciting-postgres-17-and-beyond"},"Laying the groundwork for an exciting Postgres 17 (and beyond)"),(0,n.kt)("p",null,"All of the features mentioned above can immediately add a lot of value to your Postgres usage, but there are new features which lay the groundwork for powerful features in future releases. I\u2019ll quickly touch upon three items that I believe are noteworthy:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Direct IO and Async IO in Postgres: In Postgres 16, several building blocks for implementing direct and ",(0,n.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=CD0w3gWBF7s"},"asynchronous IO")," for Postgres were committed. This includes reduced contention on the relation extension lock and addition of Direct IO as a developer only option via the ",(0,n.kt)("inlineCode",{parentName:"li"},"debug_io_direct")," setting. This important but hard work has been ongoing for several releases and Postgres 17 will likely be the first release where users will be able to utilize these features."),(0,n.kt)("li",{parentName:"ul"},"Moving towards Active Active replication: A feature was committed in Postgres 16 to allow logical replication to avoid replication loops, which is when a transaction gets replicated from source to target and back. Postgres 16 allows subscribers to process only changes which have no origin which allows you to prevent these loops. Bi-directional active-active replication is still very complicated and requires solving a lot of problems, but this feature tackles one of those important sub-problems."),(0,n.kt)("li",{parentName:"ul"},"Migration of the build system to Meson: This might have slipped under your radar but in this release, Postgres added support for a new build system which is expected to replace the Autoconf and Windows based build systems. Why, you might ask? Andres makes a compelling case for it in ",(0,n.kt)("a",{parentName:"li",href:"https://www.postgresql.org/message-id/flat/20211012083721.hvixq4pnh2pixr3j%40alap3.anarazel.de"},"this thread")," if you\u2019re interested but some reasons include faster build times, simpler dependency management and moving towards a common build system across Linux and Windows.")),(0,n.kt)("h2",{id:"postgres-continues-to-deliver"},"Postgres continues to deliver"),(0,n.kt)("p",null,"With every new release, Postgres becomes more and more compelling and adds great features that improve the experience of its users. I recommend you check out the ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/about/news/postgresql-16-released-2715/"},"press release"),", and ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/16/release-16.html"},"the release notes")," to see everything coming along with this new release."),(0,n.kt)("p",null,"And if you want to try out the full power of Postgres including its powerful extension ecosystem on a managed service, try out ",(0,n.kt)("a",{parentName:"p",href:"https://cloud.tembo.io/"},"Tembo Cloud"),"."))}u.isMDXComponent=!0},7223:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/postgres-16-1cfe231777e20520fac3b292397f20e6.png"}}]);