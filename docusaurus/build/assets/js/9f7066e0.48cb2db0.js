"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6781],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=u(n),m=r,h=c["".concat(l,".").concat(m)]||c[m]||g[m]||o;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:r,s[1]=i;for(var u=2;u<o;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},99534:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>i,toc:()=>u});var a=n(87462),r=(n(67294),n(3905));const o={slug:"introducing-pg-later",title:"Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake",authors:["adam"],tags:["postgres","announcement","async"]},s=void 0,i={permalink:"/blog/introducing-pg-later",editUrl:"https://github.com/tembo-io/website/blob/main/blog/2023-08-16-introducing-pg-later/index.md",source:"@site/blog/2023-08-16-introducing-pg-later/index.md",title:"Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake",description:"We\u2019re working on asynchronous query execution in Postgres and have packaged the work up in an extension we\u2019re calling pglater. If you\u2019ve used Snowflake\u2019s asynchronous queries, then you might already be familiar with this type of feature. Submit your queries to Postgres now, and come back later and get the query\u2019s results.",date:"2023-08-16T00:00:00.000Z",formattedDate:"August 16, 2023",tags:[{label:"postgres",permalink:"/blog/tags/postgres"},{label:"announcement",permalink:"/blog/tags/announcement"},{label:"async",permalink:"/blog/tags/async"}],readingTime:4.095,hasTruncateMarker:!1,authors:[{name:"Adam Hendel",title:"Founding Engineer",url:"https://github.com/ChuckHend",email:"noreply@tembo.io",imageURL:"https://github.com/chuckhend.png",key:"adam"}],frontMatter:{slug:"introducing-pg-later",title:"Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake",authors:["adam"],tags:["postgres","announcement","async"]},prevItem:{title:"Using pgmq with Python",permalink:"/blog/pgmq-with-python"},nextItem:{title:"Introducing PGMQ: Simple Message Queues built on Postgres",permalink:"/blog/introducing-pgmq"}},l={authorsImageUrls:[void 0]},u=[{value:"Why async queries?",id:"why-async-queries",level:2},{value:"Extending Postgres with async features",id:"extending-postgres-with-async-features",level:2},{value:"Stacking Postgres Extensions",id:"stacking-postgres-extensions",level:2},{value:"Using pg_later",id:"using-pg_later",level:2},{value:"Up next",id:"up-next",level:2}],p={toc:u},c="wrapper";function g(e){let{components:t,...o}=e;return(0,r.kt)(c,(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"We\u2019re working on asynchronous query execution in Postgres and have packaged the work up in an extension we\u2019re calling ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tembo-io/pg_later"},"pg_later"),". If you\u2019ve used ",(0,r.kt)("a",{parentName:"p",href:"https://docs.snowflake.com/developer-guide/python-connector/python-connector-example#examples-of-asynchronous-queries"},"Snowflake\u2019s asynchronous queries"),", then you might already be familiar with this type of feature. Submit your queries to Postgres now, and come back later and get the query\u2019s results."),(0,r.kt)("p",null,"Visit ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tembo-io/pg_later"},"pg_later"),"\u2019s Github repository and give it a star!"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"elephant-tasker",src:n(96115).Z,title:"elephant-tasker",width:"882",height:"878"})),(0,r.kt)("h2",{id:"why-async-queries"},"Why async queries?"),(0,r.kt)("p",null,"Imagine that you\u2019ve initiated a long-running maintenance job. You step away while it is executing, only to come back and discover it was interrupted hours ago due to your laptop shutting down. You don\u2019t want this to happen again, so you spend some time googling or asking your favorite LLM how to run the command in the background with screen or tmux. Having asynchronous query support from the beginning would have saved you a bunch of time and headache!"),(0,r.kt)("p",null,"Asynchronous processing is a useful development pattern in software engineering. It has advantages such as improved resource utilization, and unblocking of the main execution thread."),(0,r.kt)("p",null,"Some examples where async querying can be useful are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"For a DBA running ad-hoc maintenance."),(0,r.kt)("li",{parentName:"ul"},"Developing in interactive environments such as a Jupyter notebook. Rather than submit a long-running query only to have your notebook hang idly and then crash, you can use asynchronous tasks to avoid blocking your Notebook, or simply come back later to check on your task."),(0,r.kt)("li",{parentName:"ul"},"Having a long-running analytical query, for example fulfilling an ad-hoc request like seeing how many new users signed up each day for the past month. You can submit that query and have it run in the background while you continue other work.")),(0,r.kt)("h2",{id:"extending-postgres-with-async-features"},"Extending Postgres with async features"),(0,r.kt)("p",null,"At Tembo, we\u2019ve built a similar feature for Postgres and published it as an extension called ",(0,r.kt)("strong",{parentName:"p"},"pg_later"),". With ",(0,r.kt)("strong",{parentName:"p"},"pg_later"),", you can dispatch a query to your Postgres database and, rather than waiting for the results, your program can return and retrieve the results at your convenience."),(0,r.kt)("p",null,"A common example is manually executing VACUUM on a table. Typically one might execute VACUUM in one session, and then use another session to check the status of the VACUUM job via ",(0,r.kt)("inlineCode",{parentName:"p"},"pg_stat_progress_vacuum"),". pg_later gives you the power to do that in a single session. You can use it to queue up any long-running analytical or administrative task on your Postgres database."),(0,r.kt)("h2",{id:"stacking-postgres-extensions"},"Stacking Postgres Extensions"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"pg_later")," is built on top of ",(0,r.kt)("a",{parentName:"p",href:"https://tembo.io/blog/introducing-pgmq"},"PGMQ"),", another one of Tembo's open source extensions. Once a user submits a query, ",(0,r.kt)("strong",{parentName:"p"},"pg_later")," seamlessly enqueues the request in a Postgres-managed message queue. This mechanism then processes the query asynchronously, ensuring no unnecessary wait times or hold-ups."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"pg_later")," ",(0,r.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/bgworker.html"},"background worker")," picks up the query from the queue and executes it. The results are persisted by being written to a table as ",(0,r.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/current/functions-json.html"},"JSONB")," and can be easily retrieved using the ",(0,r.kt)("strong",{parentName:"p"},"pg_later")," API. You can simply reference the unique job id given upon query submission, and retrieve the result set, or query the table directly. By default, the results are retained forever, however we are building retention policies as a feature into ",(0,r.kt)("strong",{parentName:"p"},"pg_later"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"diagram",src:n(53827).Z,title:"diagram",width:"2146",height:"800"})),(0,r.kt)("h2",{id:"using-pg_later"},"Using pg_later"),(0,r.kt)("p",null,"To get started, check out our project\u2019s ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tembo-io/pg_later/blob/main/README.md"},"README")," for a guide on installing the extension."),(0,r.kt)("p",null,"First, you need to initialize the extension. This handles the management of PGMQ objects like a job queue and some metadata tables."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select pglater.init();\n")),(0,r.kt)("p",null,"You're now set to dispatch your queries. Submit the query using pglater.exec, and be sure to take note of the ",(0,r.kt)("strong",{parentName:"p"},"job_id")," that is returned. In this case, it\u2019s the first job so the ",(0,r.kt)("strong",{parentName:"p"},"job_id")," ",(0,r.kt)("strong",{parentName:"p"},"is 1"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select pglater.exec(\n  'select * from pg_available_extensions limit 2'\n) as job_id;\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"}," job_id \n--------\n     1\n(1 row)\n")),(0,r.kt)("p",null,"And whenever you're ready, your results are a query away:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select pglater.fetch_results(1);\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'{\n  "query": "select * from pg_available_extensions limit 2",\n  "job_id": 1,\n  "result": [\n    {\n      "name": "pg_later",\n      "comment": "pg_later:  Run queries now and get results later",\n      "default_version": "0.0.6",\n      "installed_version": "0.0.6"\n    },\n    {\n      "name": "pgmq",\n      "comment": "Distributed message queues",\n      "default_version": "0.10.1",\n      "installed_version": "0.10.1"\n    }\n  ],\n  "status": "success"\n}\n')),(0,r.kt)("h2",{id:"up-next"},"Up next"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"pg_later")," is a new project and still under development. A few features that we are excited to build:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Status and progress of in-flight queries"),(0,r.kt)("li",{parentName:"ul"},"Security and permission models for submitted queries"),(0,r.kt)("li",{parentName:"ul"},"Cursor support for finished jobs (fetch results row by row)"),(0,r.kt)("li",{parentName:"ul"},"Kill a query that is in the queue or is currently in flight"),(0,r.kt)("li",{parentName:"ul"},"Support for transactions"),(0,r.kt)("li",{parentName:"ul"},"Configurable concurrency levels for background works to increase the throughput of jobs"),(0,r.kt)("li",{parentName:"ul"},"Push notifications for completed and failed jobs"),(0,r.kt)("li",{parentName:"ul"},"Retention policies for completed jobs")),(0,r.kt)("p",null,"Give us a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tembo-io/pg_later"},"star")," and try out pg_later by running the example in the README. If you run into issues, please create an ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tembo-io/pg_later/issues"},"issue"),". We would greatly welcome contributions to the project as well."),(0,r.kt)("p",null,"Please stay tuned for a follow up post on benchmarking PGMQ vs leading open source message queues."))}g.isMDXComponent=!0},53827:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/diagram-d6cbc048f614b1157a4ebdcdf011e537.png"},96115:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/elephant-3d5154dac74be08748e278a9ad3c7a0e.png"}}]);