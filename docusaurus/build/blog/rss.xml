<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Tembo Blog</title>
        <link>https://tembo.io/blog</link>
        <description>Tembo Blog</description>
        <lastBuildDate>Fri, 10 Nov 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 8: Philippe Noël]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep8</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep8</guid>
            <pubDate>Fri, 10 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Search is simple in theory. In practice? Anything but. In today’s Episode 8 of Hacking Postgres, Ry sits down with Philippe Noël of ParadeDB to talk about how search is evolving, the influence of AI, and the lessons you'd tell your younger self.]]></description>
            <content:encoded><![CDATA[<p>Search is simple in theory. In practice? Anything but. In today’s Episode 8 of Hacking Postgres, Ry sits down with Philippe Noël of ParadeDB to talk about how search is evolving, the influence of AI, and the lessons you'd tell your younger self.</p><p>Watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Regina and Paul for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/o73EMG1c3cA?si=ypM2zuSnQD-elBSB" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>ParadeDB - <a href="https://www.paradedb.com/" target="_blank" rel="noopener noreferrer">https://www.paradedb.com/</a></li><li>pg_bm25 - <a href="https://docs.paradedb.com/blog/introducing_bm25" target="_blank" rel="noopener noreferrer">https://docs.paradedb.com/blog/introducing_bm25</a></li><li>pgvector - <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">https://github.com/pgvector/pgvector</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>Elastic - <a href="https://www.elastic.co/" target="_blank" rel="noopener noreferrer">https://www.elastic.co/</a></li><li>pg_search - <a href="https://github.com/Casecommons/pg_search" target="_blank" rel="noopener noreferrer">https://github.com/Casecommons/pg_search</a></li><li>zombodb - <a href="https://github.com/zombodb/zombodb" target="_blank" rel="noopener noreferrer">https://github.com/zombodb/zombodb</a></li><li>Algolia - <a href="https://www.algolia.com/" target="_blank" rel="noopener noreferrer">https://www.algolia.com/</a></li><li>InterDB - <a href="https://www.interdb.jp/" target="_blank" rel="noopener noreferrer">https://www.interdb.jp/</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry">[00:00:12]<!-- --> - Ry<a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Welcome to Hacking Postgres, an interview podcast with the people working on open source projects around Postgres, which in my opinion is the world's best open source database. I'm Rye Walker, founder of Tembo, a managed Postgres company, and today I have Phil Noel from ParadeDB, working on ParadeDB as my guest. Phil, welcome to the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000037---phil">[00:00:37]<!-- --> - Phil<a href="#000037---phil" class="hash-link" aria-label="Direct link to 000037---phil" title="Direct link to 000037---phil">​</a></h5><p>Thanks. Yeah, thanks. Nice to meet you. Thanks for having me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000042---ry">[00:00:42]<!-- --> - Ry<a href="#000042---ry" class="hash-link" aria-label="Direct link to 000042---ry" title="Direct link to 000042---ry">​</a></h5><p>Great to actually meet you. I'd like to start...maybe you could give us a quick background, like maybe where'd you grow up in the world? And what were you doing before?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000053---phil">[00:00:53]<!-- --> - Phil<a href="#000053---phil" class="hash-link" aria-label="Direct link to 000053---phil" title="Direct link to 000053---phil">​</a></h5><p>Yeah, absolutely. Happy to. So I'm originally from Quebec City, the French part of Canada. I actually grew up in this small town called <!-- -->[inaudible 01:02]<!-- --> , which is 2 hours East. Spent most of my life there, and then eventually I left to go to university. I stayed in Boston, studied computer science and neuroscience, did a few things. I started a browser company before ParadeDB, which I ran for about three years, and then after that got acquaintance with the joys of Postgres, you could say through that experience. Sounds somewhat similar to yours, maybe, although not to the same scale. And my previous co founder and I only started ParadeDB.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000135---ry">[00:01:35]<!-- --> - Ry<a href="#000135---ry" class="hash-link" aria-label="Direct link to 000135---ry" title="Direct link to 000135---ry">​</a></h5><p>Nice. Tell the browser company, what was that called and how far did you get in that project?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000143---phil">[00:01:43]<!-- --> - Phil<a href="#000143---phil" class="hash-link" aria-label="Direct link to 000143---phil" title="Direct link to 000143---phil">​</a></h5><p>Oh, that is both a short and a long story. It was called Wisp. We were building like a cloud based web browser, so the initial idea was to offload heavy processing to the cloud by streaming, which is like an age old idea, but we were young and dumb, so we thought we had invented something. We did that for a while, raised a couple of rounds of funding, grew a team to like 25 people, but we never quite found PMF and eventually pivoted to cybersecurity. Did that for a while, but it was a much better market, but not our battle to win. So we closed down the company. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000221---ry">[00:02:21]<!-- --> - Ry<a href="#000221---ry" class="hash-link" aria-label="Direct link to 000221---ry" title="Direct link to 000221---ry">​</a></h5><p>Okay. I'm sure we both have a lot of battle stories we could commiserate over. Do you remember when you first started using Postgres? I can't remember. That's why I ask this question, because it kind of just happened at some point in my career. But do you remember specifically when you started with Postgres?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000245---phil">[00:02:45]<!-- --> - Phil<a href="#000245---phil" class="hash-link" aria-label="Direct link to 000245---phil" title="Direct link to 000245---phil">​</a></h5><p>I don't know. Actually. That's a good question. I don't know. As a user? I don't know. As a developer since earlier this year or last year.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000258---ry">[00:02:58]<!-- --> - Ry<a href="#000258---ry" class="hash-link" aria-label="Direct link to 000258---ry" title="Direct link to 000258---ry">​</a></h5><p>Well, cool. Obviously as a user, you've used it for years, I'm sure. Tell me about your Postgres work. What have you built in the past and what are you building now? Or is this all just the first thing?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000312---phil">[00:03:12]<!-- --> - Phil<a href="#000312---phil" class="hash-link" aria-label="Direct link to 000312---phil" title="Direct link to 000312---phil">​</a></h5><p>I guess I would say it's the first major thing. So we can keep it to that, what we're doing. So we're building ParadeDB. ParadeDB is like a Postgres database, essentially, or Postgres extension, where we're integrating native full text search within Postgres, which is something that some people are quick to jump to say this already exists, and some people are quick to jump to say the one that exists is very bad. And so they're excited about what we're doing. So it depends which camp you fall on. But the first thing we released is this extension is called pg_bm25, where we're essentially integrating proper full text search within Postgres and then combine this with some of the existing innovations that's come, like pgvector to build hybrid search. And our goal is to build this Postgres type database that is sort of the go to choice for companies where search is critical to the product they're building. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000408---ry">[00:04:08]<!-- --> - Ry<a href="#000408---ry" class="hash-link" aria-label="Direct link to 000408---ry" title="Direct link to 000408---ry">​</a></h5><p>Nice. Why do you think you're working on this? What led you here?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000414---phil">[00:04:14]<!-- --> - Phil<a href="#000414---phil" class="hash-link" aria-label="Direct link to 000414---phil" title="Direct link to 000414---phil">​</a></h5><p>Yeah, that's a good question, actually. This is a problem we face ourselves and that's kind of why we wanted to solve it. So after my first company, my co founder and I, we were trying to decide what we're going to do next. So we started doing some contracting work sort of left and right. I was living in Paris at the time and working with a lot of French and German company. And when we were working with this German automaker, they just really needed high quality full text search within Postgres. So the promo we were building for them, and instead we had to glue Elasticsearch or some vector database on top. And it was just a nightmare. And we were very frustrated how bad it was and decided, you know what, maybe we should just fix it ourselves. And so that kind of led us to today. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000500---ry">[00:05:00]<!-- --> - Ry<a href="#000500---ry" class="hash-link" aria-label="Direct link to 000500---ry" title="Direct link to 000500---ry">​</a></h5><p>Got it. Yeah, it's interesting. I don't know. There was a famous tweet that I can't remember the exact wording on, but it basically said something to the effect that, hey, tech founders, you do yourself well to pivot to building something that would support whatever you would be building today. Basically go one level deeper than your current idea is similar to what we did at Astronomer, because we were basically building a competitor to segment clickstream data processing. And then we started using Airflow. Then we said, hey, let's just provide airflow as a service. And kind of made that switch to go down a level and that was the winning pivot for that company. So it sounds like you've kind of jumped down to more of an infrastructural issue, which I think is good. Well, what challenges? Obviously there's a lot of ground to cover, but what are your biggest challenges, would you say you face so far? Building this thing.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000612---phil">[00:06:12]<!-- --> - Phil<a href="#000612---phil" class="hash-link" aria-label="Direct link to 000612---phil" title="Direct link to 000612---phil">​</a></h5><p>You mean like business wise or technical wise or process wise?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000616---ry">[00:06:16]<!-- --> - Ry<a href="#000616---ry" class="hash-link" aria-label="Direct link to 000616---ry" title="Direct link to 000616---ry">​</a></h5><p>Actually, yeah. I'd love to hear all categories of challenge. Yeah, spill the beans. What's hard about this? I imagine fundraise. I mean, it's a tough time to fundraise, so that's probably not awesome. But yeah, maybe start technically.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000633---phil">[00:06:33]<!-- --> - Phil<a href="#000633---phil" class="hash-link" aria-label="Direct link to 000633---phil" title="Direct link to 000633---phil">​</a></h5><p>Yeah, I can start technically. I think software is the easiest part of building a company, so I would say these are our simplest set of challenges. Not to say it's know, I was actually talking to Eric that I listened to the Hacking Postgres episode with Eric and I talked to him afterwards. At first we didn't know pgrx was a thing, and we were like, oh my God, how on earth is this even going to be a thing? And then we found out pgrx was a thing and we're like, wow, it went from near impossible to quite doable, really. So, like on the technical front, I mean, there's just so much you need to do when you're building search, right? We have covered a small ground of features of what people expect, and there are so many more that we need to build, and so we're trying to prioritize that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000725---ry">[00:07:25]<!-- --> - Ry<a href="#000725---ry" class="hash-link" aria-label="Direct link to 000725---ry" title="Direct link to 000725---ry">​</a></h5><p>Obviously Elastic is probably the big competitor. Can you estimate what percentage of their functionality you aim to replace? Is it essentially 100% and what's your progress towards that?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000741---phil">[00:07:41]<!-- --> - Phil<a href="#000741---phil" class="hash-link" aria-label="Direct link to 000741---phil" title="Direct link to 000741---phil">​</a></h5><p>Yeah, that's a good question. I mean, our progress was small. It's small enough that you can use it, but Elastic is enormous, right? I don't think we aim to replace or not to replace, sorry. To match 100% of their features, at least for transactional data, which is what we need today. I think we actually had a decent bit of the way done and definitely enough to keep us busy for a couple of months. But I think that's sort of the first step of what we're looking to match beyond that, like what everything elastic does for observability, that's sort of another story, and that's another milestone that we will see depending on what our customers want.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000829---ry">[00:08:29]<!-- --> - Ry<a href="#000829---ry" class="hash-link" aria-label="Direct link to 000829---ry" title="Direct link to 000829---ry">​</a></h5><p>Obviously I'm building a fresh new tech startup as well, and I understand you got to match the functionality of, I call it the table stakes features. But then you also have to come up with some differentiators or else no one will care. So what are the biggest differentiators you're thinking about with ParadeDB?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000849---phil">[00:08:49]<!-- --> - Phil<a href="#000849---phil" class="hash-link" aria-label="Direct link to 000849---phil" title="Direct link to 000849---phil">​</a></h5><p>Yeah, so that's a good question. I think for ParadeDB right now, the differentiator has been, ironically, I would say the combination of two non differentiated things, if that makes sense, which is like, if you want to do search over transactional data, ParadeDB is sort of the best solution today because it's the only thing that actually truly combines the two. It wasn't done before. And so sort of our initial interest, I would say, has come from that. So typically when people wanted to do this, they would have some managed Postgres provider, of which there are many, and then they would use Elastic and then they would need to combine the two and then run the two and so on. It can be a ton of work. And so ParadeDB sort of makes that a single system and especially for small companies, which is where you've been really, it's been a lot easier to manage, I would say. And so that really draws them to us. That's sort of like our initial point initially, but we have some other things that will be coming up which hopefully will expand on this sort of initial interest.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000952---ry">[00:09:52]<!-- --> - Ry<a href="#000952---ry" class="hash-link" aria-label="Direct link to 000952---ry" title="Direct link to 000952---ry">​</a></h5><p>Yeah, it seemed to me like as I think about building my next search bar in a product, I have to decide do I want to go what I can so call like the old school way versus vector search? Maybe I can get away with some sort of AI integration for search. Are people asking that question or do they have the perception that maybe like vector search somehow gets, replaces or displaces in some way traditional full text search type features?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001028---phil">[00:10:28]<!-- --> - Phil<a href="#001028---phil" class="hash-link" aria-label="Direct link to 001028---phil" title="Direct link to 001028---phil">​</a></h5><p>Yeah, that's a very good question. A lot of people have, I've talked to a lot of people who weigh in on both sides of the coin. I would say my personal take is both will remain quite important just because at the end of the day people will still have data and we'll still need to be able to find instances of those data. Right. And there's one way to find it via similarity, but there's also sometimes you just want to start from a clean place. And so I think both are quite valuable. Most of the people we talk to, hybrid search is very important to them, like the combination of the two, both big and small companies. And that's one of the reasons why we built Parade the way we did today, where pgvector exists and so many others. And I would almost say vector search is kind of table stake now. We don't really have to innovate on that so much ourselves, I would say. But the traditional search is kind of the piece that's been missing, which is why we released this first extension, pg_bm25, and then we offered the combination of both as well <!-- -->[inaudible 11:29]<!-- -->  with another extension called pg_search, which we're going to be publicizing more heavily soon.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001135---ry">[00:11:35]<!-- --> - Ry<a href="#001135---ry" class="hash-link" aria-label="Direct link to 001135---ry" title="Direct link to 001135---ry">​</a></h5><p>Yeah, I think it seems like, well, it seems to me like everything has to have an AI story or else perhaps it's been outdated. Right. So I think even search, even full tech search, you can say I like that the hybrid answer is a good answer. Obviously then you have to figure out how to hybridize it all. And that's not necessarily trivial. But yeah, I'm curious to see what you come up with on this.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001207---phil">[00:12:07]<!-- --> - Phil<a href="#001207---phil" class="hash-link" aria-label="Direct link to 001207---phil" title="Direct link to 001207---phil">​</a></h5><p>Yeah, it takes some effort. It takes some effort. I would say we definitely have an AI story, but our personal take on the whole AI world and fade is like AI is sort of a step function improvement on existing things being done, but you need a foundation of value proposition for customers on the fundamental non AI part of the product, if that makes sense. And that's kind of how we think about it. There are so many people that are trying to bring AI when there was nothing useful to begin with. Well, I really think of AI as taking something that was useful to begin with and making it that much better. And so it kind of plays quite well actually with the way we've been going about delivering this product and saying like, hey, we'll just give you really good full text search and obviously so much more can be done. But if that is not useful in the first place in Postgres, then who cares that I can add AI to.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001301---ry">[00:13:01]<!-- --> - Ry<a href="#001301---ry" class="hash-link" aria-label="Direct link to 001301---ry" title="Direct link to 001301---ry">​</a></h5><p>Yeah, yeah, I agree. Yeah, I think about it. Know you can't build AI without training data, right? And you can't, you can't have training data without a product. You know, to collect some base level data. If you have a base level of product without AI, basically you have to start without AI, don't have data at all. And I think that's a challenge. A lot of founders, maybe they're thinking they're going to go straight to AI. They're like, there's nothing. You got to start basic. Yeah, I agree. What are some big milestones? How many big milestones do you have envisioned for ParadeDB at this moment?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001344---phil">[00:13:44]<!-- --> - Phil<a href="#001344---phil" class="hash-link" aria-label="Direct link to 001344---phil" title="Direct link to 001344---phil">​</a></h5><p>That's also a good question.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001346---ry">[00:13:46]<!-- --> - Ry<a href="#001346---ry" class="hash-link" aria-label="Direct link to 001346---ry" title="Direct link to 001346---ry">​</a></h5><p>I mean you probably have a next one, right? You usually know your next big milestone.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001350---phil">[00:13:50]<!-- --> - Phil<a href="#001350---phil" class="hash-link" aria-label="Direct link to 001350---phil" title="Direct link to 001350---phil">​</a></h5><p>Hopefully you'd have that. Yeah, of course.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001353---ry">[00:13:53]<!-- --> - Ry<a href="#001353---ry" class="hash-link" aria-label="Direct link to 001353---ry" title="Direct link to 001353---ry">​</a></h5><p>And you also tell me what it is. But I'm curious.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001358---phil">[00:13:58]<!-- --> - Phil<a href="#001358---phil" class="hash-link" aria-label="Direct link to 001358---phil" title="Direct link to 001358---phil">​</a></h5><p>Happy to share. I mean, to be honest our big milestones was to get a thousand stars in new Hub and then some stranger posted our repo on Hacker News and somehow that happened in a couple of days, which was really exciting and rather unexpected. Now our big milestone is we're about to release our own small version of managed Postgres ish specifically for ParadeDB to test how else we can deliver value to people. Like many that have been using the product so far have been using our self hosted version, which I'm sure you're extremely familiar with how people don't want to do this, doing Tembo. So that's the next big milestone that's coming, trying to learn to manage this. And then after that we have a couple of, I think after that we'll see the exact number. We're just trying to get more people on it and see what they think. Really.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001453---ry">[00:14:53]<!-- --> - Ry<a href="#001453---ry" class="hash-link" aria-label="Direct link to 001453---ry" title="Direct link to 001453---ry">​</a></h5><p>Yeah, just grow users. This is another thing I've been thinking about around just even like we have stacks at Tembo with different use cases for Postgres, and then some things ought to be workloads separated from other things. Like for example, do you keep your analytical workload separate from transactional? That's clear. But search is interesting, whether that's like an add on. Is that just work that the transactional database should be doing, or is it somehow, do you think the workload for search should be isolated from traditional transactional workloads? From an application standpoint, that's a good question.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001536---phil">[00:15:36]<!-- --> - Phil<a href="#001536---phil" class="hash-link" aria-label="Direct link to 001536---phil" title="Direct link to 001536---phil">​</a></h5><p>I think it depends what product you're building, to be honest, because you don't want to slow down transactions. That's something that's very important to us. For example, I think it's possible to integrate it, actually. I think it's up to you, the way we're thinking about it. So the way we've built ParadeDB is we offer weak consistency over search. So what this means is the way we build searches, we have inverted indices that store the tokenized data that you want to search over, but those are weakly consistent. So just like if you use Elastic, for example, and something like Zombodb, and then you synchronize it, there will be some lag between transactions being updated in your database and eventually being reflected in your search engine, the same thing happens, but it happens automatically for ParadB, instead of being it can be minutes sometimes here will be like a few seconds at the very most, but it ensures that your transactions are never slowed down, which is quite critical for people. So I think if you build in that way, it's actually quite possible to centralize it and have it be integrated with the actual database. If you don't use a product where search is built that way, then I don't think you want to slow down your transaction so you have to isolate them.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001648---ry">[00:16:48]<!-- --> - Ry<a href="#001648---ry" class="hash-link" aria-label="Direct link to 001648---ry" title="Direct link to 001648---ry">​</a></h5><p>Yeah, I think a lot of people just obviously just do it inside their transactional database because it seems like overkill. Spin up a new Postgres, just especially like traditional shitty full tech search that's available. But if we want to get good search, if I wanted to build really good search into an application, I would go buy Algolia or something like that. And that clearly is a microservice at that point, right? I'm sending data to them to index and they're sending me back results really quickly that are happening. It's not taxing my main database as a part of that. So I kind of like thinking of search as, let's call it great search as a microservice candidate for sure, because the better you make it, the more compute it requires. The more compute it requires, the more it's competing. Right? So I don't know, I like the idea of just taking that worldview. That great search needs to be separated from the transactional or analytical.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001803---phil">[00:18:03]<!-- --> - Phil<a href="#001803---phil" class="hash-link" aria-label="Direct link to 001803---phil" title="Direct link to 001803---phil">​</a></h5><p>Yeah, I think you're right in a lot of ways. You do need to be able to orchestrate it properly at scale. This is definitely something that we will ponder more and more as we have more people using it and using it at greater scale. I do think even if it needs to be solely separate from what we have done today, one of the great things and where DBMS and Postgres managed companies like ParadeDB or Tembo show up is in the ability to just make it transparent to the customer. The actual complexity of the orchestration behind the.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001837---ry">[00:18:37]<!-- --> - Ry<a href="#001837---ry" class="hash-link" aria-label="Direct link to 001837---ry" title="Direct link to 001837---ry">​</a></h5><p>So, you know, you've been writing code for a number of years now. What would you say your most important lesson has been? Kind of switching from the technical to the interpersonal or just like professional. Do you have any top lesson? If you're going to meet with a young developer, you'd say.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001900---phil">[00:19:00]<!-- --> - Phil<a href="#001900---phil" class="hash-link" aria-label="Direct link to 001900---phil" title="Direct link to 001900---phil">​</a></h5><p>Specifically on writing code? Yeah, specifically on writing code. I would say only write the code that you need to write. I think that's like a big one. Our previous company, maybe I'll bother with this one. I like to think of products and startups now as like science experiments, as works of art. And I think our previous company, we thought of it as a work of art. So we came out of college, we were so incredibly into it and we wanted to be perfect. We cared so tremendously about what we did, that we always went above and beyond and it always made the product better and it involved writing more code, but it did not always make the product better in a way that meaningfully improved the experience of the user or brought us closer to product market fit. Right. And so I think if you think of a work of art like it's never finished, it needs to be perfect, versus a science experiment is more like, what's the bare minimum I can do to validate or invalidate this hypothesis I have or deliver value to a customer. And so what I would say, what I wish I could say to my younger self was, if no one has asked for this, I don't think you need to do it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002012---ry">[00:20:12]<!-- --> - Ry<a href="#002012---ry" class="hash-link" aria-label="Direct link to 002012---ry" title="Direct link to 002012---ry">​</a></h5><p>Yeah, it's a good point. So you're saying be more of a scientist than an artist, perhaps to some degree. When you're starting on something and it's not validated.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002026---phil">[00:20:26]<!-- --> - Phil<a href="#002026---phil" class="hash-link" aria-label="Direct link to 002026---phil" title="Direct link to 002026---phil">​</a></h5><p>I think a lot of great products are almost like work of arts. Like, people were so obsessed over it and you can feel that. And so I don't think you want to leave all types of esthetic approach or care to it, but I think definitely early on, before you even sink so much time into it, you just want to get feedback quickly. Right. And that involves just only writing the code you need to write. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002049---ry">[00:20:49]<!-- --> - Ry<a href="#002049---ry" class="hash-link" aria-label="Direct link to 002049---ry" title="Direct link to 002049---ry">​</a></h5><p>I'll tell you a quick story. Like when we started astronomer, I have a good friend, Greg Neiheisel. He was CTO and basically my partner of crime. And we just very much mind melded on a lot of things. But our attitude following your principle was really what we were building was this beautiful lattice of glue, and everything was open source inside. So we used, for example, we used Google's material design, which had just come out, and we built a UI, like, adhering to it perfectly, and ended up being a beautiful UI because guess what? Those guys built a great framework and we had no designer on the team. Google was our designer. We would joke about it all the time, and we actually chose a color scheme for the company that was kind of Googley, had the same four main colors. So it was really easy to build something great. But that we really built the first version of our product was entirely open source components just glued together in a unique way. And that was our art. It was like this inner skeleton of orchestration, or just like I said, I can think of it like a lattice of glue that's holding all these things together. And, yeah, it was a very successful product. And it looks basically how you arrange open source components is art. It's a creative endeavor, I think, and it's enough for a brand new product. It's enough art. You don't have to go and reinvent, like, for example, the airflow UI during this really hard early project. And you don't have to go reinvent the Postgres UI. Maybe you want to, but you're like, let's handle the first things first. So did you think of a lesson that was non technical that you learned that you would tell your younger self or not really?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002249---phil">[00:22:49]<!-- --> - Phil<a href="#002249---phil" class="hash-link" aria-label="Direct link to 002249---phil" title="Direct link to 002249---phil">​</a></h5><p>Oh, I have so many. I spent a lot of time thinking after our previous companies didn't work out specifically. I don't know. This is a broad question. I can go in every direction. Let me think, which one is the best one to share? Yeah, I would say, okay. One interesting lesson is I'll focus on the youth as well. And what you mentioned. When we were building our first company, our first product, we felt very righteous. We were doing something very difficult and objectively, technically difficult. And a lot of people have tried before, and we were like, they must have done it wrong. Who are they? People with more experience and context than us to know how to do this really well. And so we always started every premise of what we were doing from the premise that we were correct. Right. And then we were strived to further validate the fact that we were correct. And I think this leads to a lot of cognitive dissonance when you turn out to be wrong. Right. Because you had this idea of what you were thinking, and it's now being challenged versus now the way we think about it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002407---phil">[00:24:07]<!-- --> - Phil<a href="#002407---phil" class="hash-link" aria-label="Direct link to 002407---phil" title="Direct link to 002407---phil">​</a></h5><p>And I mean this from a personal standpoint, from the way we talk and hire people, from the way we talk to customers, from the way we try to build product now, we just think we're wrong. I always assume I'm wrong in what I think, and then I strive to prove myself correct. Right. And if we do manage to prove ourselves to be correct, then it's like a very positive moment. You're like, that's amazing. I found this great surprise that I wasn't fully convinced of before. And if you turn out to be wrong, you're like, well, kind of thought I could be wrong all along, not a big deal, and then sort of drop this and move to something else. And I think it's a mental framework that has served us a lot better in everything that we do now.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002445---ry">[00:24:45]<!-- --> - Ry<a href="#002445---ry" class="hash-link" aria-label="Direct link to 002445---ry" title="Direct link to 002445---ry">​</a></h5><p>Yeah, I love that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002447---phil">[00:24:47]<!-- --> - Phil<a href="#002447---phil" class="hash-link" aria-label="Direct link to 002447---phil" title="Direct link to 002447---phil">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002448---ry">[00:24:48]<!-- --> - Ry<a href="#002448---ry" class="hash-link" aria-label="Direct link to 002448---ry" title="Direct link to 002448---ry">​</a></h5><p>I think it's a tricky catch 22. Like, you have to, as a founder, live in a reality distortion field just to change the world. You have to have a crazy idea that most people disagree with. Those are the best ideas. Unfortunately, they're also the worst ideas.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002505---phil">[00:25:05]<!-- --> - Phil<a href="#002505---phil" class="hash-link" aria-label="Direct link to 002505---phil" title="Direct link to 002505---phil">​</a></h5><p>Exactly.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002506---ry">[00:25:06]<!-- --> - Ry<a href="#002506---ry" class="hash-link" aria-label="Direct link to 002506---ry" title="Direct link to 002506---ry">​</a></h5><p>Just accept that, hey, you might be. At the same time, you have to also fight for your idea. Even if you hear negative, it's like, oh, man, I built all this infrastructure for it to be righteous, and now it's hard to give up on it. I think it's wrong to give up on it a lot of times, because, again, I think that some of the best ideas almost everyone would disagree with as it starts. I agree. It's a much better mindset to understand that it's a lottery ticket sort of odds not, hey, well, if you were a good student, you know you can get an A in a class, right? You know you can get an A. It's just a matter of doing the right amount of work, and you'll get an A. But it doesn't work that way with startups. Exactly.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002559---phil">[00:25:59]<!-- --> - Phil<a href="#002559---phil" class="hash-link" aria-label="Direct link to 002559---phil" title="Direct link to 002559---phil">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002600---ry">[00:26:00]<!-- --> - Ry<a href="#002600---ry" class="hash-link" aria-label="Direct link to 002600---ry" title="Direct link to 002600---ry">​</a></h5><p>Cool. So, well, I'm curious, like, are you paying attention to the Postgres ecosystem and other developments maybe that you're excited about that you've seen since you started working on.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002613---phil">[00:26:13]<!-- --> - Phil<a href="#002613---phil" class="hash-link" aria-label="Direct link to 002613---phil" title="Direct link to 002613---phil">​</a></h5><p>Have. I mean, there's, there's just so much that's happening in Postgres, obviously pretty excited about Tembo. I've been following you guys' journey. Just like, recently, there are people that I forget the name of the developer. That's very embarrassing. But someone released PG branching, which maybe you've seen, which is like, so I was talking to Nikita, the CEO of Neon, right? And he was, like, raving about their branching system, which I'm sure is world class and amazing. But it turns out other people might be able to do this someday, which is good for the community, perhaps. So I think that's quite an exciting extension that hasn't been made by us, for example, that we're very excited about. And there's many others that I could list.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002656---ry">[00:26:56]<!-- --> - Ry<a href="#002656---ry" class="hash-link" aria-label="Direct link to 002656---ry" title="Direct link to 002656---ry">​</a></h5><p>Yeah, it's interesting. My first reaction I saw, like, AWS announce, oh, we have active, active replication available on RDS. It's a new extension, you know. And I responded on Twitter, is it going to be open source? And crickets. So it makes me feel like time to. We'll study that extension, and the community needs to just build the open source version of it if they won't do it. I'm not salty about how the big clouds operate. Extracting value from open source. Because I'm extracting value from open source, and you are, too. We all are. All the way down. Like I said, it's like value extraction all the way down to Linux, but they could be. Obviously their goal is to build a proprietary alternatives and I really wish there was a Postgres company out there that was big and was worrying about the whole open source ecosystem. That's what we're trying to do. Yeah, there's so much going on. I don't know if it's because I'm looking at it now or if things have changed in 2023 versus 2022. It's great that it's happening too during what I would consider like a law in the venture ecosystem as well. So I think the stuff that's happening now will be strong. They always say like the startups that start during the slow parts of venture usually end up being more successful than the ones at the hype cycle. So you and I are both lucky we're starting here. Even those. It might not feel that way sometimes.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002839---phil">[00:28:39]<!-- --> - Phil<a href="#002839---phil" class="hash-link" aria-label="Direct link to 002839---phil" title="Direct link to 002839---phil">​</a></h5><p>I think it does feel that way though. We raised our seed round, things went quite well. It was a challenging raise, but challenging because people were very critical about what we're doing and I think that's good, right? Like the first company, we raised money on a terrible idea and we thought raising money was the good part. But actually if you have a terrible idea and people convince you of that early on, they're actually doing you a favor, right? Yeah, I think it's good. I'm very bullish on the companies that are going to be founded, that have been founded this year, that will be found next year and so on, because I think you're right. Overall, typically they turn out to be quite good. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002922---ry">[00:29:22]<!-- --> - Ry<a href="#002922---ry" class="hash-link" aria-label="Direct link to 002922---ry" title="Direct link to 002922---ry">​</a></h5><p>So do you have a couple of favorite people that you've met in Postgres Land? Give them a shout out if you do.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002929---phil">[00:29:29]<!-- --> - Phil<a href="#002929---phil" class="hash-link" aria-label="Direct link to 002929---phil" title="Direct link to 002929---phil">​</a></h5><p>Yes, sure. I mean I met Eric, which I think will take the prize for my favorite. He. He's very humble about it. He keeps saying TCDI needed pgrx. I think they really did it beyond what was needed for the benefit of the community. So I think he's definitely gone above and beyond and he continues to go above and beyond. Another one maybe you know him or not. He's the writer of one of the PG internals book called Hironobu, who's this Japanese man who lives in Europe now I haven't engaged with him very much, but he's made this resource called I think InterDB.jp or something like that. I could send you the link if you're curious, which goes into Postgres internals at a great detail. And it's been like a good resource for us in it. So shout out to that guy.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003023---ry">[00:30:23]<!-- --> - Ry<a href="#003023---ry" class="hash-link" aria-label="Direct link to 003023---ry" title="Direct link to 003023---ry">​</a></h5><p>Yeah, I definitely read the website, but I haven't spoken to the man.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003029---phil">[00:30:29]<!-- --> - Phil<a href="#003029---phil" class="hash-link" aria-label="Direct link to 003029---phil" title="Direct link to 003029---phil">​</a></h5><p>Maybe we should try to email him a few times. Yeah, I tried to convince him to join us, but it was too difficult to sell.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003037---ry">[00:30:37]<!-- --> - Ry<a href="#003037---ry" class="hash-link" aria-label="Direct link to 003037---ry" title="Direct link to 003037---ry">​</a></h5><p>Yeah, maybe he, I mean, I tried to convince Eric Ridge to join Tembo in the early on and he was too hard to sell.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003043---phil">[00:30:43]<!-- --> - Phil<a href="#003043---phil" class="hash-link" aria-label="Direct link to 003043---phil" title="Direct link to 003043---phil">​</a></h5><p>I'm sure you did. Of course, I would have loved to convince, um, the naive part of me was like, I can't wait to convince Eric to join Parade. And then I talked to him, realized he basically is the co founder and CTO of TCDI. And I was like, okay, this isn't happening.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003101---ry">[00:31:01]<!-- --> - Ry<a href="#003101---ry" class="hash-link" aria-label="Direct link to 003101---ry" title="Direct link to 003101---ry">​</a></h5><p>Yeah, I was probably the 25th person to go after him. And you were probably the 27th person to go after him. Whatever.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003110---phil">[00:31:10]<!-- --> - Phil<a href="#003110---phil" class="hash-link" aria-label="Direct link to 003110---phil" title="Direct link to 003110---phil">​</a></h5><p>Exactly.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003111---ry">[00:31:11]<!-- --> - Ry<a href="#003111---ry" class="hash-link" aria-label="Direct link to 003111---ry" title="Direct link to 003111---ry">​</a></h5><p>Yeah, I think it's great. I'm kind of excited that these people, I'll call them like the gods of Postgres, are kind of locked up up on Mount Olympus. We don't get to see them or talk to them very much. That's exciting to me, to know that someday we'll get there. Someday, if our companies are strong enough, maybe we can get to work with those people. But it's great to be in an ecosystem where there is a tier of people that are just amazing. I was talking to Samay, who's the CTO here at Tembo, and he did the quick analysis. To see that most people become a committer at Postgres takes like around seven or eight years of contributing to Postgres before you get the commit bit, which is like, wow, that is an amazing. You think of venture backed startups, it's like two startups worth of effort sticking around for your full vesting before you get to be up. So it has nothing to do with the company that you're working for, it's just you're going to dedicate yourself to an open source project for the core of your professional life. Because once you get there, you probably want to stick around for another eight years, I'm sure.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003227---ry">[00:32:27]<!-- --> - Ry<a href="#003227---ry" class="hash-link" aria-label="Direct link to 003227---ry" title="Direct link to 003227---ry">​</a></h5><p>Yeah, it's pretty cool.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003228---phil">[00:32:28]<!-- --> - Phil<a href="#003228---phil" class="hash-link" aria-label="Direct link to 003228---phil" title="Direct link to 003228---phil">​</a></h5><p>Yeah. But these people are great, and I think that's one of the things that's so great about Postgres community. Even though Eric and so on, they're amazing people and they're doing great things and they're very busy and so on. This are quite accessible, really. Eric is very accessible in the pgrx discord and so on. So I do feel like by building open source, we still get to work with them, even though not in the same organization. And some other people I forgot to shout out, which perhaps deserve a lot of shout out, is maybe like Umur and Ozgun from Citus, right? They were like truly visionaries of the Postgres world, building extensions when Postgres was a toy database, as people would like, critic being critical of.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003317---ry">[00:33:17]<!-- --> - Ry<a href="#003317---ry" class="hash-link" aria-label="Direct link to 003317---ry" title="Direct link to 003317---ry">​</a></h5><p>Yeah, yeah, we're definitely standing on their shoulders. They've, they did a lot of hard work early on and yeah, it's great. If you had a magic wand, you could add any feature to Postgres tomorrow and it existed. Is there anything that you would use that wand on? Do you have any things you wish Postgres was that it isn't?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003340---phil">[00:33:40]<!-- --> - Phil<a href="#003340---phil" class="hash-link" aria-label="Direct link to 003340---phil" title="Direct link to 003340---phil">​</a></h5><p>That's very interesting. I think the answer would be better distributed support. Actually, what Citus has done is amazing. But the whole reason Yugabyte exists today, for example, is because there's only so much you can do when you're an extension like Citus did, right? And like Yugabyte is basically trying to be the Postgres equivalent of CockroachDB. And I think if that was baked in natively to Postgres, it would be good for a lot of people that are building on Postgres included.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003413---ry">[00:34:13]<!-- --> - Ry<a href="#003413---ry" class="hash-link" aria-label="Direct link to 003413---ry" title="Direct link to 003413---ry">​</a></h5><p>Yeah, that's a good one. Do you listen to podcasts very much?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003419---phil">[00:34:19]<!-- --> - Phil<a href="#003419---phil" class="hash-link" aria-label="Direct link to 003419---phil" title="Direct link to 003419---phil">​</a></h5><p>Not very much, not very much. Only yours.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003422---ry">[00:34:22]<!-- --> - Ry<a href="#003422---ry" class="hash-link" aria-label="Direct link to 003422---ry" title="Direct link to 003422---ry">​</a></h5><p>Okay, good, thank you. No, I listen to PostgresFM all the time. I'm huge fans of those guys. I do listen to a lot of podcasts. But yeah. Just going to ask you what your favorites are. But you already said. All right, well cool. It was great talking to you. Where can listeners find you online? Maybe just tell us about yourself and then ParadeDB url and so on.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003449---phil">[00:34:49]<!-- --> - Phil<a href="#003449---phil" class="hash-link" aria-label="Direct link to 003449---phil" title="Direct link to 003449---phil">​</a></h5><p>Yeah, so you can find us on paradedb.com or on a GitHub is ParadeDB as well. It's open source. We welcome contributions and users and so on. Of course we're very responsive. As for me specifically, I think you're going to link my Twitter in the bio, but my Twitter is PhilippeMNoel. It's basically my handle across every social media. I feel like when you can find one, you sort of keep it. There's so many people now on the internet, so that's my handle everywhere. People can find me there and I love chatting.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003520---ry">[00:35:20]<!-- --> - Ry<a href="#003520---ry" class="hash-link" aria-label="Direct link to 003520---ry" title="Direct link to 003520---ry">​</a></h5><p>Awesome. Well, thanks for joining. Love to have you on again in the future. We'll see again, it's super early in this podcast life, but track what's going on with ParadeDB and if there's more stuff to talk about, we'll get back together.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003536---phil">[00:35:36]<!-- --> - Phil<a href="#003536---phil" class="hash-link" aria-label="Direct link to 003536---phil" title="Direct link to 003536---phil">​</a></h5><p>Of course. Yeah, I would love to be there. Thank you for having me.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[PGMQ: Lightweight Message Queue on Postgres with No Background Worker]]></title>
            <link>https://tembo.io/blog/pgmq-self-regulating-queue</link>
            <guid>https://tembo.io/blog/pgmq-self-regulating-queue</guid>
            <pubDate>Tue, 07 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[image]]></description>
            <content:encoded><![CDATA[<div style="width:75%"><p><img loading="lazy" alt="image" src="/assets/images/tembo-queue-805449fd409081b900fb16cefd7e52e5.png" width="822" height="753" class="img_ev3q"></p></div><p>Your app needs a message queue. Simple enough—until you try to do it, anyway.</p><p>Go set it up on Kafka? Sure...but now you have a Kafka cluster to manage.
Redis could work, but now you're just managing Redis instances instead.
SQS? That means you have to reconfigure your application to talk to AWS, and you also get an extra external bill as icing on the cake.
Let's build it on Postgres! However, if you follow most blogs and guides, you'll probably end up building an agent, watcher process, or background worker to make sure the queue stays healthy. It's better, but if the background worker fails, you could end up with bigger problems.</p><p>Fortunately, there's a better way.</p><p>By designing with a visibility timeout, we remove the need for external processes for queue management. PGMQ is a Postgres extension built following exactly this sort of self-regulating queue. Today we're going to combine PGMQ with pair of core Postgres features—FOR UPDATE and SKIP LOCKED—to cover all the needs of our message queue. FOR UPDATE helps ensure that just a single consumer receives a message in the queue. And SKIP LOCKED is required if you want to have multiple consumers on the same queue – without it each consumer would wait for the others to remove their locks. Before we put all the pieces together, let's do a quick refresher on how each of these works.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="for-update-ensuring-exclusive-access">FOR UPDATE: Ensuring Exclusive Access<a href="#for-update-ensuring-exclusive-access" class="hash-link" aria-label="Direct link to FOR UPDATE: Ensuring Exclusive Access" title="Direct link to FOR UPDATE: Ensuring Exclusive Access">​</a></h2><p>Imagine a crowded store with a single cashier. As customers approach the counter, the cashier must serve them one at a time, ensuring each transaction is complete before moving on to the next. Similarly, when working with a queue, it's essential to ensure that only one process or transaction works with a particular row of data at a time. This is where FOR UPDATE comes into play.</p><p>The FOR UPDATE clause is used to lock selected rows, preventing other transactions from modifying or locking them until the current transaction ends. This ensures that once a task (or row in our queue) is picked up, it isn't grabbed by another worker or process simultaneously. It guarantees exclusive access, much like how our lone cashier attends to a single customer at a time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="skip-locked-keeping-the-line-moving">SKIP LOCKED: Keeping the Line Moving<a href="#skip-locked-keeping-the-line-moving" class="hash-link" aria-label="Direct link to SKIP LOCKED: Keeping the Line Moving" title="Direct link to SKIP LOCKED: Keeping the Line Moving">​</a></h2><p>Back to our store analogy, if a customer isn't ready to check out and holds up the line, it can cause unnecessary delays for the other customers. What if, instead, those who aren't ready simply step aside, allowing others to continue? That would undoubtedly speed up the checkout process. This is the concept behind SKIP LOCKED.</p><p>When combined with FOR UPDATE, the SKIP LOCKED clause ensures that if a row is locked by another transaction, it gets skipped over, and the next available row is selected. This way, other workers or processes don't get stuck waiting for a locked row to be released; they simply move on to the next available task.</p><p>By using these two clauses together, you can ensure that tasks in your queue are processed smoothly and efficiently, with each task getting picked up by a single worker and other workers moving seamlessly to the next available task.</p><p>However, how can we take this one step further? Many queue implementations have us using FOR UPDATE to mark a message as “in progress” which is great. However, that typically requires us to have a service external to postgres which monitors the queue to check for messages which have been “in progress” for too long.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="self-regulating-queues-in-postgresql">Self-Regulating Queues in PostgreSQL<a href="#self-regulating-queues-in-postgresql" class="hash-link" aria-label="Direct link to Self-Regulating Queues in PostgreSQL" title="Direct link to Self-Regulating Queues in PostgreSQL">​</a></h2><p>If you’re using FOR UPDATE SKIP LOCKED, and setting messages “in progress”, you most likely need a process to watch your queue and check for messages that have been processing for too long. Rather than running a background worker or external process, PGMQ implements a Visibility Timeout (VT). A VT is a designated period during which a message, once read from the queue, becomes invisible to other consumers or workers. This ensures that once a worker picks up a task, other workers won't attempt to process the same task for the duration of this timeout. If the original worker fails to complete the task within the specified timeout, the task becomes visible again by nature of time elapsing past the specified VT, which means PGMQ still provides an at-least-once delivery guarantee even when the VT has elapsed. The task is ready for reprocessing by the same or a different worker.</p><p>In essence, the visibility timeout provides a grace period for tasks to be processed. It becomes a buffer against potential failures, ensuring that if a task isn’t completed due to any unforeseen reasons, it doesn’t get lost but rather re-enters the queue. Without something like the VT, queue systems will need to run a process to watch the queue. If that watcher crashes, or loses connection, then messages will stay unavailable until the watcher is recovered.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="queue-regulation-isnt-just-for-error-modes">Queue regulation isn’t just for error modes<a href="#queue-regulation-isnt-just-for-error-modes" class="hash-link" aria-label="Direct link to Queue regulation isn’t just for error modes" title="Direct link to Queue regulation isn’t just for error modes">​</a></h2><p>A common use case is for a consumer that needs to process a long-running I/O bound task. Let’s say there is a message with a task to create some infrastructure in your favorite <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">cloud provider</a>, e.g. create an EC2 instance if it doesn’t already exist. That could take minutes to start up. Your consumer can submit the request to provision EC2, and then instead of waiting for EC2 to create, it can set the VT on that message to 60 seconds from now, then move on to read the next message. In 60 seconds, the message will become visible again and can be picked up.  That can look something like the follow pseudo-code:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># read a message, make it invisible for 30 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select pgmq.read(‘task_queue’, 30, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...check if S3 bucket already already created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...request to create S3 bucket if not exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set message VT to 60 seconds from now If not exists: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select pgmq.set_vt(‘task_queue’, &lt;msg_id&gt;, 60)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># consumer archives or deletes the message when its finished with its job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select pgmq.archive('test_queue', &lt;msg_id&gt;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With PGMQ’s design, messages do not leave the queue until they are explicitly archived or deleted, so you could think of using the VT directly as “returning the message to the queue”, even though it technically never left the queue. Rather, returning it to a state that can be read by other consumers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="choose-the-simplest-queue-architecture-with-pgmq">Choose the simplest queue architecture with PGMQ<a href="#choose-the-simplest-queue-architecture-with-pgmq" class="hash-link" aria-label="Direct link to Choose the simplest queue architecture with PGMQ" title="Direct link to Choose the simplest queue architecture with PGMQ">​</a></h2><p>Use <code>FOR UPDATE</code> so that you ensure messages are only read by one consumer at time. <code>SKIP LOCKED</code> so that you can have multiple workers processing messages concurrently. Finally, implement a visibility timeout so that you no longer need to rely on an external process to handle messages that have failed to process. Install the open-source <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ extension</a> for Postgres or try it on <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> today and immediately benefit from all of these design decisions.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adam Hendel)</author>
            <category>postgres</category>
            <category>message-queue</category>
            <category>pgmq</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres Ep. 7: Burak Yucesoy]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep7</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep7</guid>
            <pubDate>Fri, 03 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Postgres for everything? How about building a new cloud provider? In episode 7 of Hacking Postgres, Ry talks with Burak Yucesoy of Ubicloud about new clouds, getting attached to extensions, and the future potential of Postgres.]]></description>
            <content:encoded><![CDATA[<p>Postgres for everything? How about building a new cloud provider? In episode 7 of Hacking Postgres, Ry talks with Burak Yucesoy of Ubicloud about new clouds, getting attached to extensions, and the future potential of Postgres.</p><p>Watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Regina and Paul for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/_f4WZwkrXQw?si=V2H6vs_e86Aq2xJt" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>Ubicloud - <a href="https://www.ubicloud.com/" target="_blank" rel="noopener noreferrer">https://www.ubicloud.com/</a></li><li>Citus Data - <a href="https://www.citusdata.com/" target="_blank" rel="noopener noreferrer">https://www.citusdata.com/</a></li><li>PostgreSQL HLL - <a href="https://github.com/citusdata/postgresql-hll" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/postgresql-hll</a></li><li>JSONB - <a href="https://www.postgresql.org/docs/current/datatype-json.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/datatype-json.html</a></li><li>hstore -<a href="https://www.postgresql.org/docs/current/hstore.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/hstore.html</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry"><em>[00:00:12]<!-- --> - Ry</em><a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Hello. I'm Ry Walker, founder of Tembo, a managed Postgres company. And today I have Burak from Ubicloud. How do you say UB? Ubi.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000023---burak"><em>[00:00:23]<!-- --> - Burak</em><a href="#000023---burak" class="hash-link" aria-label="Direct link to 000023---burak" title="Direct link to 000023---burak">​</a></h5><p>Ubicloud.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000024---ry"><em>[00:00:24]<!-- --> - Ry</em><a href="#000024---ry" class="hash-link" aria-label="Direct link to 000024---ry" title="Direct link to 000024---ry">​</a></h5><p>Yeah, UB. Welcome to the podcast Burak.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000033---burak"><em>[00:00:33]<!-- --> - Burak</em><a href="#000033---burak" class="hash-link" aria-label="Direct link to 000033---burak" title="Direct link to 000033---burak">​</a></h5><p>Yeah, thanks a lot for having me here.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000036---ry"><em>[00:00:36]<!-- --> - Ry</em><a href="#000036---ry" class="hash-link" aria-label="Direct link to 000036---ry" title="Direct link to 000036---ry">​</a></h5><p>Yeah, well I'd love to start with giving us a quick background. I'm curious where'd you grow up and what were you doing before?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000048---burak"><em>[00:00:48]<!-- --> - Burak</em><a href="#000048---burak" class="hash-link" aria-label="Direct link to 000048---burak" title="Direct link to 000048---burak">​</a></h5><p>Well, well hello everyone, this is Burak and I work as a software developer and I guess in reverse chronological order I worked at Microsoft, Citus Data and SAP on distributed databases in all three and currently I worked at a startup called Ubicloud. We are basically building a new cloud provider and the primary thing we do differently than other providers is that well all the code is open. You can think it as open alternative to existing cloud providers. You can go to GitHub, check out the code, set it up on a bare meta server and then you can have your own cloud or you can use our managed offering of course. So yeah, this is brief history of me working professionally.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000146---ry"><em>[00:01:46]<!-- --> - Ry</em><a href="#000146---ry" class="hash-link" aria-label="Direct link to 000146---ry" title="Direct link to 000146---ry">​</a></h5><p>Yeah, nice. So you're open sourcing, essentially open sourcing and what AWS and GCP and Azure have done.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000155---burak"><em>[00:01:55]<!-- --> - Burak</em><a href="#000155---burak" class="hash-link" aria-label="Direct link to 000155---burak" title="Direct link to 000155---burak">​</a></h5><p>Yeah, definitely, I'm seeing it what Linux is to proprietary operating systems. This is what we are doing for the cloud providers.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000207---ry"><em>[00:02:07]<!-- --> - Ry</em><a href="#000207---ry" class="hash-link" aria-label="Direct link to 000207---ry" title="Direct link to 000207---ry">​</a></h5><p>Yeah, and you only have to build 300 different services on top of it. Right, but luckily a lot of those are open source too.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000215---burak"><em>[00:02:15]<!-- --> - Burak</em><a href="#000215---burak" class="hash-link" aria-label="Direct link to 000215---burak" title="Direct link to 000215---burak">​</a></h5><p>Kind of. Well, I guess our current plan is not building all 200 render services because most of the time people use only ten at most 20. If you implement 20 of them, I guess you have 80% of the use cases. So I guess this is our initial plan but we never know what would feature show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000242---ry"><em>[00:02:42]<!-- --> - Ry</em><a href="#000242---ry" class="hash-link" aria-label="Direct link to 000242---ry" title="Direct link to 000242---ry">​</a></h5><p>Yeah, I think it's a great idea. I'm excited to watch it evolve and hopefully partner with you guys at some point.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000250---burak"><em>[00:02:50]<!-- --> - Burak</em><a href="#000250---burak" class="hash-link" aria-label="Direct link to 000250---burak" title="Direct link to 000250---burak">​</a></h5><p>Yeah, that would be awesome.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000252---ry"><em>[00:02:52]<!-- --> - Ry</em><a href="#000252---ry" class="hash-link" aria-label="Direct link to 000252---ry" title="Direct link to 000252---ry">​</a></h5><p>Do you remember when you first started using Postgres?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000257---burak"><em>[00:02:57]<!-- --> - Burak</em><a href="#000257---burak" class="hash-link" aria-label="Direct link to 000257---burak" title="Direct link to 000257---burak">​</a></h5><p>Yeah, I do. Well to be honest, when I start programming I started as a web developer and at that time Lamp stack was very common. So my first database was MySQL but then I started working at Citus Data and which is the place that I started working development part of the Postgres. So basically for people who don't know Site, the Sitestata was the company behind many popular extensions such as Citus or Pgcron or PostgreSQL HLL. So when I first joined Citus Data, I initially worked on building Citus extension and while doing that you need to dig to the Postgres code first you need to understand and then you build your extension on top of it. And then we built our own managed service. So I switched to that team to build a Postgres managed service and some of our customers were well, they were heavily using PostgresQL HLL extension and at that time the original authors of the PostgreSQL HLL extension, they went through an acquisition process and they didn't have enough time at their hand to maintain the extension. And well, we know the people and at that time PostgreSQL Community was much smaller.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000437---burak"><em>[00:04:37]<!-- --> - Burak</em><a href="#000437---burak" class="hash-link" aria-label="Direct link to 000437---burak" title="Direct link to 000437---burak">​</a></h5><p>So we just called them and said that, hey, we want to maintain this extension, what do you think about? And they were pretty happy to find a new maintainer. So, long story short, I found myself as the maintainer of the PostgreSQL extension and then the Citus Data got acquired by Microsoft and then well, I continued my Postgres journey on Microsoft. Like we also build a managed server stash. Yeah, I guess that's how I start with Postgres development. Well, not just start like till the almost whole journey.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000518---ry"><em>[00:05:18]<!-- --> - Ry</em><a href="#000518---ry" class="hash-link" aria-label="Direct link to 000518---ry" title="Direct link to 000518---ry">​</a></h5><p>Yeah. And are you taking a little bit of a break from it right now or are you working on Postgres stuff over at Ubicloud?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000531---burak"><em>[00:05:31]<!-- --> - Burak</em><a href="#000531---burak" class="hash-link" aria-label="Direct link to 000531---burak" title="Direct link to 000531---burak">​</a></h5><p>Yeah, well, first of all, we use Postgres in Ubicloud as like most of my professional community, like the friends, and they are from Postgres Community, so there's no way I can leave that community at all. But as a cloud provider, Ubicloud also needs to offer a Postgres service. So we are planning some things like it's not very well defined yet, but I think eventually we will have something for Postgres as well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000612---ry"><em>[00:06:12]<!-- --> - Ry</em><a href="#000612---ry" class="hash-link" aria-label="Direct link to 000612---ry" title="Direct link to 000612---ry">​</a></h5><p>Out of curiosity, are you guys I'm sure this is a hotly debated topic, but Kubernetes or no Kubernetes inside of UBI Cloud?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000622---burak"><em>[00:06:22]<!-- --> - Burak</em><a href="#000622---burak" class="hash-link" aria-label="Direct link to 000622---burak" title="Direct link to 000622---burak">​</a></h5><p>Well, in our case right now, no Kubernetes. We have pretty simple control plane, which if you want, I think you can move it to Kubernetes. But right now we don't use it. Not that we have anything against Kubernetes, it's just I guess right now we don't need that complexity, I believe.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000650---ry"><em>[00:06:50]<!-- --> - Ry</em><a href="#000650---ry" class="hash-link" aria-label="Direct link to 000650---ry" title="Direct link to 000650---ry">​</a></h5><p>Yeah, well, and I imagine you'll have managed Kubernetes. You'd have to have that. That'll be one of your 1st 20 most likely.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000657---burak"><em>[00:06:57]<!-- --> - Burak</em><a href="#000657---burak" class="hash-link" aria-label="Direct link to 000657---burak" title="Direct link to 000657---burak">​</a></h5><p>Yeah, definitely. Because managed Kubernetes is quite one of the most demanded products, so it needs to be one of the first.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000711---ry"><em>[00:07:11]<!-- --> - Ry</em><a href="#000711---ry" class="hash-link" aria-label="Direct link to 000711---ry" title="Direct link to 000711---ry">​</a></h5><p>Well, so again, you were working on Citus...When you started working on it, was it an extension or was it, I don't know the full history? Was it a fork at any point and then became extension?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000725---burak"><em>[00:07:25]<!-- --> - Burak</em><a href="#000725---burak" class="hash-link" aria-label="Direct link to 000725---burak" title="Direct link to 000725---burak">​</a></h5><p>Yeah, at the beginning it was a fork and just before I joined the team it become an extension. So basically Citus become an extension and become an open source at the same time. And I think I joined Citus team in like one month after that. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000745---ry"><em>[00:07:45]<!-- --> - Ry</em><a href="#000745---ry" class="hash-link" aria-label="Direct link to 000745---ry" title="Direct link to 000745---ry">​</a></h5><p>Got it. So you never were part of that previous era. Were a lot of the hard problems already solved, would you say, with Citus? Usually. I just did a talk with the PostGIS team and they said early on is where they solved the most of the problems and it was more gradual after that. Is that the case with Citus too, or was there a big project that happened after you joined well, I think.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000819---burak"><em>[00:08:19]<!-- --> - Burak</em><a href="#000819---burak" class="hash-link" aria-label="Direct link to 000819---burak" title="Direct link to 000819---burak">​</a></h5><p>Most of the difficult problems were already solved and to be honest, I think one of the problems with the extension development is that there isn't good documentation about it. Like for Postgres has pretty good documentation for user facing features. But if you want to as a developer, there isn't that much resources so you usually need to read lots of Postgres code. And to be honest, I think Postgres code is pretty readable for a project at its size and that big and that old, so I think that's a huge plus. But still you need to read lots of code to understand what you need to do. And in our case, thankfully, Citrus hired one of the most prominent contributors of the Postgres Andres Freund and he primarily lead the effort to make Citus an extension. And I think at that time I believe Postgres extension framework also didn't have some of the features we need. So we had to do some hacky workaround. But eventually Postgres extension framework also got improved and we had chance to remove those hacky workaround.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000948---ry"><em>[00:09:48]<!-- --> - Ry</em><a href="#000948---ry" class="hash-link" aria-label="Direct link to 000948---ry" title="Direct link to 000948---ry">​</a></h5><p>Yeah, that's great. Yeah, it sounds like that's happening now with lots know a lot of the innovation in Postgres happens as a fork with the hope that in a version or two can become an extension and then maybe a couple of versions. After that it becomes a less hacky extension. Right? You can streamline it, but it's a four year journey or so. Tell me about PostgreSQL HLL. Tell me what's HLL stand for.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001019---burak"><em>[00:10:19]<!-- --> - Burak</em><a href="#001019---burak" class="hash-link" aria-label="Direct link to 001019---burak" title="Direct link to 001019---burak">​</a></h5><p>Yeah, well, HLL stands for Hyperlog log and it is an extension to make a cardinality estimation, which is a fancy way of saying doing count distinct but approximately. Let me first explain why approximately. The reason is doing count distinct as an accurate number is pretty difficult. Well, not difficult, but maybe unfeasible. If your data size is small, that's okay. But if you have lots of data, the usual way is keeping a hash map or hash set. Every time you see an item you put it to hash set and at the end you count number of items in it. But if you have lots of data that becomes unfeasible. If you have a distributed system, like if you are doing count testing in two different nodes, that becomes even more difficult. Because let's say you bite the bullet and calculate the counter stick in one node and the other node, it's not possible to merge the result. Because there might be common elements, you cannot just sum them up. So what Hyperlog log does is it uses an approximation algorithm. I can go into detail of it as well to have an internal representation of the number of unique elements which is both memory efficient compared to doing a hash map which is also easy to merge.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001204---burak"><em>[00:12:04]<!-- --> - Burak</em><a href="#001204---burak" class="hash-link" aria-label="Direct link to 001204---burak" title="Direct link to 001204---burak">​</a></h5><p>So it allows you to do like the parallel computing. And the only gotcha is it is not an exact number, it's an approximation, but it turns out that we don't need exact number most of the time. Like for example, especially in analytical use cases, let's say you want to count the number of unique users that visit your website. It doesn't matter if they are 4 million or 4.1 million, like you want a ballpark number. And also the good thing is the error rate of hyperlog log is quite small. It is usually around 2% and you can make it even smaller if you give it a bit more memory like you can make it more accurate while this hyperlog log algorithm is just out there. And what PostgreSQL hyperlog log does is it implements this algorithm for PostgreSQL.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001309---ry"><em>[00:13:09]<!-- --> - Ry</em><a href="#001309---ry" class="hash-link" aria-label="Direct link to 001309---ry" title="Direct link to 001309---ry">​</a></h5><p>So how much of a resource reduction would you estimate that using an approximation? So you lose a percentage or two of accuracy, but you get how much less compute required?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001324---burak"><em>[00:13:24]<!-- --> - Burak</em><a href="#001324---burak" class="hash-link" aria-label="Direct link to 001324---burak" title="Direct link to 001324---burak">​</a></h5><p>Well, usually it's about 1.5 KB. So the hyperlogo data structure on default it takes about 1.5 KB memory.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001338---ry"><em>[00:13:38]<!-- --> - Ry</em><a href="#001338---ry" class="hash-link" aria-label="Direct link to 001338---ry" title="Direct link to 001338---ry">​</a></h5><p>Orders of magnitude smaller.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001340---burak"><em>[00:13:40]<!-- --> - Burak</em><a href="#001340---burak" class="hash-link" aria-label="Direct link to 001340---burak" title="Direct link to 001340---burak">​</a></h5><p>Yeah, actually log log parts come from that. So if you are dealing with 32 bit integers, it can go up to two to the 32. You get the log of that, it is 32. You get another log that you get five. So you need five bits of memory to be able to store one bucket. And then what hyperlog log does is it keeps multiple buckets to increase the accuracy. So at the end it end up about like 1.5 kilobyte.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001417---ry"><em>[00:14:17]<!-- --> - Ry</em><a href="#001417---ry" class="hash-link" aria-label="Direct link to 001417---ry" title="Direct link to 001417---ry">​</a></h5><p>Got it. So how involved were you in that extension? Did you start it or did you inherit it?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001425---burak"><em>[00:14:25]<!-- --> - Burak</em><a href="#001425---burak" class="hash-link" aria-label="Direct link to 001425---burak" title="Direct link to 001425---burak">​</a></h5><p>I inherited it. So actually another startup called Aggregate Knowledge built that extension. Then I think they got acquired by New Star and at that time the project was not maintained frequently. So there were some boxes we need to be merged in and our customers were also using it. So we contacted the original authors and said that hey, we want to maintain this. And they were happy to hand over the maintainership to us. And then after that we did bug fixes, we did regular releases. I presented a few conference talks about hyperlog log  in Pgcomp EU and Pgcomp US. Yeah, that's the overall story.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001524---ry"><em>[00:15:24]<!-- --> - Ry</em><a href="#001524---ry" class="hash-link" aria-label="Direct link to 001524---ry" title="Direct link to 001524---ry">​</a></h5><p>I'm curious, have you been able to disconnect from I imagine it's easier to disconnect from Citus as an extension after leaving Microsoft, but disconnecting from this extension PostgreSQL HLL. Are you still kind of watching that because you have that knowledge?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001547---burak"><em>[00:15:47]<!-- --> - Burak</em><a href="#001547---burak" class="hash-link" aria-label="Direct link to 001547---burak" title="Direct link to 001547---burak">​</a></h5><p>Yeah, I have a little bit of emotional bond to that extension. Well, for example, there were few improvements that I wanted to do, but I didn't have time while working at Microsoft and it just, itched me from time to time and it is open source. So I guess at some point in near future I'll open a pull request and hopefully it would get merged. I hope.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001619---ry"><em>[00:16:19]<!-- --> - Ry</em><a href="#001619---ry" class="hash-link" aria-label="Direct link to 001619---ry" title="Direct link to 001619---ry">​</a></h5><p>Yeah, but Microsoft team controls that extension as it sits.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001625---burak"><em>[00:16:25]<!-- --> - Burak</em><a href="#001625---burak" class="hash-link" aria-label="Direct link to 001625---burak" title="Direct link to 001625---burak">​</a></h5><p>Yeah, right now Microsoft team controls, they continue to do regular releases and every time new PostgreSQL version comes up they ensure that it works well and they update the packages, release new packages. If there's a bug report, they are the one who fixes it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001645---ry"><em>[00:16:45]<!-- --> - Ry</em><a href="#001645---ry" class="hash-link" aria-label="Direct link to 001645---ry" title="Direct link to 001645---ry">​</a></h5><p>How many extensions, I mean, obviously there's the Citus extension, this one. How many total extensions would you say like Microsoft has in Postgres? I know maybe it's hard to nail down a number, but there are a bunch of others too.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001701---burak"><em>[00:17:01]<!-- --> - Burak</em><a href="#001701---burak" class="hash-link" aria-label="Direct link to 001701---burak" title="Direct link to 001701---burak">​</a></h5><p>There are there's Citus, there's PostgresQL HLL. There is Pgcron which is also quite popular. It is a Chrome based job scheduler.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001710---ry"><em>[00:17:10]<!-- --> - Ry</em><a href="#001710---ry" class="hash-link" aria-label="Direct link to 001710---ry" title="Direct link to 001710---ry">​</a></h5><p>Yeah, I just started using that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001712---burak"><em>[00:17:12]<!-- --> - Burak</em><a href="#001712---burak" class="hash-link" aria-label="Direct link to 001712---burak" title="Direct link to 001712---burak">​</a></h5><p>Yeah, that's pretty cool. It is primarily developed by Marco Slot. There is one extension to ensure that Postgres works. Postgres is well integrated with Azure. So there's like an extension called PG Azure. I think it's not open source but if you start a Postgres instance from Azure and check the extensions, if there's that extension there is TopN which is also approximation based extension. It gives you top N elements of a sorted list. And if you think about it is also expensive operation to do on big data set because you need to sort them first and take the top N. And I think there are more optimized algorithms that where you can keep heap which is more memory efficient but you still need to go over lots of data at that time. At Citus we also developed this TopN extension. Actually, if you look at it, the general team is about being able to do things at scale because Postgres is already pretty good at doing things in a single node. And like the title primary use case was make. A distributed PostgreSQL and we developed few extensions to make some operations that are not feasible to do at scale and find a ways to make them more feasible.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001906---ry"><em>[00:19:06]<!-- --> - Ry</em><a href="#001906---ry" class="hash-link" aria-label="Direct link to 001906---ry" title="Direct link to 001906---ry">​</a></h5><p>So I'm curious, are there some big milestones in Postgres that you're looking forward to?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001914---burak"><em>[00:19:14]<!-- --> - Burak</em><a href="#001914---burak" class="hash-link" aria-label="Direct link to 001914---burak" title="Direct link to 001914---burak">​</a></h5><p>Yeah, well, actually I was looking forward for Postgres 16 release mostly because of the logical replication improvement. There are few and I think there will be more upcoming because I think logical replication is a very powerful concept but it's still a bit cumbersome to use it with PostgreSQL, especially when there's a change in the data, like if when you run a DDL command or when you have a failover. So there are few gotcha and I think with the Postgres 16 some of these are less problematic and maybe I hope in the upcoming versions it would be even easier to use. Well, when you have a very solid logical replication, it opens up lots of cool features. Well, one thing that I personally invested in is being able to do zero downtime failovers and when I say zero time downtime, I mean like the real zero downtime. Not just like 1 second downtime, but real zero downtime. And I think logical replication, solid logical replication would open up that yeah, I agree.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002045---ry"><em>[00:20:45]<!-- --> - Ry</em><a href="#002045---ry" class="hash-link" aria-label="Direct link to 002045---ry" title="Direct link to 002045---ry">​</a></h5><p>It's one thing to do that too with a single node versus a Citus cluster too right. Zero downtime gets complicated the more complicated your deployment is. But I agree on a single deployment I have this idea where we could basically build scaffolding around the existing thing, whatever it takes, like get another one working. In other words, temporarily have replication happening and then somehow seamlessly up above you have to have some fulcrum that you can so it's a complicated thing to figure out but I think it'd be great for a managed service provider to basically build up temporary infrastructure that helps the zero downtime thing happen. If that's true, then you can restart for all kinds of reasons with impunity like auto scaling is possible, stuff like that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002150---burak"><em>[00:21:50]<!-- --> - Burak</em><a href="#002150---burak" class="hash-link" aria-label="Direct link to 002150---burak" title="Direct link to 002150---burak">​</a></h5><p>Yeah, and one reason I especially interested in was that in our previous managed service we do lots of operations via failover. Like for example, if you want to scale up what we would do is we create another server with higher number of cores and then we would do failover. Or if you want to like for example, we might need to do maintenance like maybe we found a security vulnerability or there is the regular maintenance. What we would do is instead of going and patching the existing server we would create a new one and then we do a failover to that one and each of those failovers. It takes some amount of downtime which is not obviously not preferable and not a good experience for customers but if they were virtually free from the perspective of customer if they don't even notice that there's a failover then you can do as many failovers as you want.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002255---ry"><em>[00:22:55]<!-- --> - Ry</em><a href="#002255---ry" class="hash-link" aria-label="Direct link to 002255---ry" title="Direct link to 002255---ry">​</a></h5><p>You share the same vision as I do there. I think it would be exciting to get there. So I'm curious though, if there was one thing that you could if you had a magic wand and this weekend something new would be in Postgres core, what would it be? What would you use that wand on?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002311---burak"><em>[00:23:11]<!-- --> - Burak</em><a href="#002311---burak" class="hash-link" aria-label="Direct link to 002311---burak" title="Direct link to 002311---burak">​</a></h5><p>Yeah, that's difficult. I want lots of things like picking one is difficult but I guess one thing that bothers me is that for high availability and backups you always need to depend the third party tool I would really love that to be sold in Postgres. Like for example, for Redis it comes with very good default settings that you can use for high availability. But for Postgres there are solutions. There are good solutions but I would love them to be in the core.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002403---ry"><em>[00:24:03]<!-- --> - Ry</em><a href="#002403---ry" class="hash-link" aria-label="Direct link to 002403---ry" title="Direct link to 002403---ry">​</a></h5><p>Yeah, I get that for sure. It's tricky when you have to buy a product or let's say you adopt a product and you immediately have to adopt x additional products right off the bat and that's not a good feeling. It feels complex, right? Yeah, that's cool, I would say. Do you have any opinions about Postgres that almost nobody agrees with you about? Are you a contrarian in any area that you can think of?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002435---burak"><em>[00:24:35]<!-- --> - Burak</em><a href="#002435---burak" class="hash-link" aria-label="Direct link to 002435---burak" title="Direct link to 002435---burak">​</a></h5><p>Let me see. I don't think so. Well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002445---ry"><em>[00:24:45]<!-- --> - Ry</em><a href="#002445---ry" class="hash-link" aria-label="Direct link to 002445---ry" title="Direct link to 002445---ry">​</a></h5><p>Maybe that's one of the areas that put that you think backrupt should be inside.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002448---burak"><em>[00:24:48]<!-- --> - Burak</em><a href="#002448---burak" class="hash-link" aria-label="Direct link to 002448---burak" title="Direct link to 002448---burak">​</a></h5><p>There is that. But I know there are people who also share that opinion. Yeah, I'm not sure it's okay.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002504---ry"><em>[00:25:04]<!-- --> - Ry</em><a href="#002504---ry" class="hash-link" aria-label="Direct link to 002504---ry" title="Direct link to 002504---ry">​</a></h5><p>Yeah, I was just curious. It's always fun to talk about those things, if they exist. Give you a soapbox.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002514---burak"><em>[00:25:14]<!-- --> - Burak</em><a href="#002514---burak" class="hash-link" aria-label="Direct link to 002514---burak" title="Direct link to 002514---burak">​</a></h5><p>Actually, there is one thing, but that's also even I think Tembo kind of agrees with me on that one, is that I think many different use cases can be implemented in Postgres. So instead of having a lot of specialized databases, you can have Postgres. And with some configuration and maybe few extensions, you can implement, like you can implement Kafka in Postgres, you can implement Redis, you can implement like the NoSQL in Postgres. I guess if I said this maybe two, three years ago, probably I would get more raised eye growth. But now I think more people start thinking to think like that. I think Tembo is also thinking things along similar lines, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002614---ry"><em>[00:26:14]<!-- --> - Ry</em><a href="#002614---ry" class="hash-link" aria-label="Direct link to 002614---ry" title="Direct link to 002614---ry">​</a></h5><p>Yeah, I think there's openness to it. I talked to a lot of people, and the question is how people are Postgres for everything. Or question is what percentage of developers are actually on that bandwagon? Obviously on Twitter, it just takes one person, and it's a big community, too, especially if it's a contrarian view. But I'm kind of curious. One of the things I want to find out over the next few months is what percentage of developers would actually if this Postgres for Everything was real, would they actually use it versus still saying "Ehh." And I think it all comes down to like I think, yeah, you can do Kafka, like work on Postgres right now, but it doesn't feel as clean as buying Confluent. That seems like a very safe decision. And doing something like Kafka on Postgres seems like you're just kind of stringing together a Rube Goldberg machine and it doesn't feel like a solid. But the question is, if those solutions were solid, would people use them? And that's our big thesis, is that if they were solid, people would use them. But I just don't know what percentage of people would do that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002738---ry"><em>[00:27:38]<!-- --> - Ry</em><a href="#002738---ry" class="hash-link" aria-label="Direct link to 002738---ry" title="Direct link to 002738---ry">​</a></h5><p>A big percentage or a small percentage?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002740---burak"><em>[00:27:40]<!-- --> - Burak</em><a href="#002740---burak" class="hash-link" aria-label="Direct link to 002740---burak" title="Direct link to 002740---burak">​</a></h5><p>Yeah, I'm not sure. But there is one interesting thing that come into my mind, is, well, today Postgres supports JSONB type, but it was not like that all the time. So in the earlier days, if you want to store JSON data, we had an extension called hstore, which we still have, but not as commonly used as before. And what hstore does is, and this is one of the very powerful part of PostgreSQL extension framework, hstore defined the data type, and on top of it, they defined how you can hash this data type and how you can compare this data type. And when you do this in Postgres, Postgres allows you to create index on that data type. So suddenly you are not only able to store JSON data, but you can index it. And at that time this is kind of rare things even for NoSQL database. So I think it's a bit funny. And also it shows the power of PostgreSQL extension framework is that suddenly you are able to do what NoSQL database does but better. I mean, not in all perspectives, like connection scaling was still a problem, but being able to index NoSQL data, being able to index JSON, it was a rare feature even for NoSQL databases.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002919---burak"><em>[00:29:19]<!-- --> - Burak</em><a href="#002919---burak" class="hash-link" aria-label="Direct link to 002919---burak" title="Direct link to 002919---burak">​</a></h5><p>But you had it in Postgres. I don't know, maybe some of these other databases or other use cases Postgres might have something unexpected that would make it better.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002936---ry"><em>[00:29:36]<!-- --> - Ry</em><a href="#002936---ry" class="hash-link" aria-label="Direct link to 002936---ry" title="Direct link to 002936---ry">​</a></h5><p>An unexpected advantage. Yeah, it's the same way with pgvector right now the great thing about doing vector embeddings inside of Postgres is that you don't have to move the data out of Postgres as part of the process. Right. You can just add a column and keep it where it is, whereas anybody else has if it's an external vector database that's specific for that use case, you have to have data pipelines and all that kind of machinery. Which that's to me, one of the big benefits of keeping it all in Postgres is less data movement. And less data movement can mean much like no data delays and all that kind of stuff go away. So yeah, I agree with you, there's a lot of unexpected benefits for keeping things together.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003025---burak"><em>[00:30:25]<!-- --> - Burak</em><a href="#003025---burak" class="hash-link" aria-label="Direct link to 003025---burak" title="Direct link to 003025---burak">​</a></h5><p>Yeah, I guess since Postgres provides pretty strong asset guarantees, it allows you to build things on top of that. And when you have asset, then you can be much more free to develop complex features. Because what I realize is like while developing software, most of the time as a developer, I try to ensure that hey, what I'm doing is atomic or what I'm doing does not it is isolate. So it's not caused any problems if something is coming and not in the expected order. But you have chance to delegate all this to Postgres, I think that gives you quite a bit of advantage.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003121---ry"><em>[00:31:21]<!-- --> - Ry</em><a href="#003121---ry" class="hash-link" aria-label="Direct link to 003121---ry" title="Direct link to 003121---ry">​</a></h5><p>Well, one of the things I love too is that because the Postgres core team is quite separated from the commercial products, is that I just think it seems like a very stable chassis to build these things on top of. And you really can't if it's more of a captive, open source project, say, like what Kafka is to Confluent. They can move Kafka quickly if they need to for commercial to help their commercial product, but that could introduce more instability. I just don't see this Postgres team doing anything very risky, which to me is a great counterbalance to people developers trying to move fast and build crazy cool new things. It's just nice to have that as a stability factor, I think, inside the product.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003217---burak"><em>[00:32:17]<!-- --> - Burak</em><a href="#003217---burak" class="hash-link" aria-label="Direct link to 003217---burak" title="Direct link to 003217---burak">​</a></h5><p>I think so, yeah. Well, I guess historically I think the Postgres community kind of divided into camps and some of them would want to implement new shiny thing and some of them would try to hey, just let's get stabilized. And I believe this JSONB support comes from the part who wants to innovate and try new things. And at the beginning, I think they got some hesitation from the other company. But at the end, I guess what they do proved itself to be very valuable. And then now JSONB support is one of the most widely used features of Postgres. Yeah, so I guess there is some sort of balance to try risky things and also try being stabilized.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003310---ry"><em>[00:33:10]<!-- --> - Ry</em><a href="#003310---ry" class="hash-link" aria-label="Direct link to 003310---ry" title="Direct link to 003310---ry">​</a></h5><p>If you look at the number of the change log for Postgres 16 they did a lot of things. It's almost more than anyone can keep in their head. That's what I'm saying. The good stuff gets through, it's just the bar is high and then with a lot of assurances that they didn't break any part of Postgres in the process. I really appreciate that part of this thing and it's one of the reasons why I'm so excited to be building a product on top of it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003341---burak"><em>[00:33:41]<!-- --> - Burak</em><a href="#003341---burak" class="hash-link" aria-label="Direct link to 003341---burak" title="Direct link to 003341---burak">​</a></h5><p>Yeah, well, at the same time it is sometimes bit frustrating because sometimes you have a feature you want it to be merged in like you might be author or you might be just someone watching from the site and desperately need that feature. And then you see that there is a huge discussion going on and people cannot convince each other and it falls to the next cycle, which is like the one years later. So that's a bit frustrating but I guess yeah, it is kind of cost of having a quite stable system.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003418---ry"><em>[00:34:18]<!-- --> - Ry</em><a href="#003418---ry" class="hash-link" aria-label="Direct link to 003418---ry" title="Direct link to 003418---ry">​</a></h5><p>It's the cost. And like I said, well, obviously I haven't been here for the 26 years watching the mailing lists and maybe I'm jumping in here relatively late in a cycle and I just appreciate all the efforts and all the debates and all the fights that have happened there because I think it's created such a great core engine. All right, well, so where can listeners find you online? I imagine you're on X. Yeah, they.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003450---burak"><em>[00:34:50]<!-- --> - Burak</em><a href="#003450---burak" class="hash-link" aria-label="Direct link to 003450---burak" title="Direct link to 003450---burak">​</a></h5><p>Can find me at X, at LinkedIn. Yeah, I guess those two would be the places they could find me, but mostly at X. My alias is at BYucesoy. So basically my first letter of my name and my last name. Great.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003510---ry"><em>[00:35:10]<!-- --> - Ry</em><a href="#003510---ry" class="hash-link" aria-label="Direct link to 003510---ry" title="Direct link to 003510---ry">​</a></h5><p>Well, we're excited to see the outcome of as you guys are shipping Ubicloud. Excited to see that. And yeah, appreciate you joining us today.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003524---burak"><em>[00:35:24]<!-- --> - Burak</em><a href="#003524---burak" class="hash-link" aria-label="Direct link to 003524---burak" title="Direct link to 003524---burak">​</a></h5><p>Thanks a lot for having me here, it was great talk, I enjoyed a lot and I'm definitely looking for the other episodes to release so that I can listen.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Application Services: Helping Postgres Do More, Faster]]></title>
            <link>https://tembo.io/blog/tembo-operator-apps</link>
            <guid>https://tembo.io/blog/tembo-operator-apps</guid>
            <pubDate>Wed, 01 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[alttext]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" alt="alt_text" src="/assets/images/tembo_ele-7c81c53d1131a1b7fcca53d6ff51ed82.png" title="Tembo the Operator" width="1784" height="1706" class="img_ev3q"></p><p>So you have a database, and that database does something. (Probably several somethings, if we're honest). However, today, you need it to do something else. </p><p>Simple enough...you just create a tool to give it that new functionality. Job done.</p><p>Except it isn't. Because the requests for new "things" never stop. They get complicated. They slow things down. They conflict with one another. Sometimes they even screw up your database along the way. And if we're honest, you don't really want to be constantly building new tools for every new need anyway. Before you know it, all of these "things" you're asking the database to do are starting to get in the way of its core performance.</p><p>The good news is that Postgres has a rich ecosystem of tools and services built by the community. Many of these run in the database as Postgres extensions, while others run outside the database as external services. Some of the most well known examples are <a href="https://postgrest.org/en/stable/" target="_blank" rel="noopener noreferrer">PostgREST</a>, an out-of-the box REST API for Postgres and <a href="https://www.pgbouncer.org/usage.html" target="_blank" rel="noopener noreferrer">pgbouncer</a>, a production ready connection pooler. A scalable way to run these pieces of software with the Tembo operator is to utilize a new feature called Application Services, which runs these applications in containers next to postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-the-essence-of-tembo-operator">Understanding the Essence of Tembo Operator<a href="#understanding-the-essence-of-tembo-operator" class="hash-link" aria-label="Direct link to Understanding the Essence of Tembo Operator" title="Direct link to Understanding the Essence of Tembo Operator">​</a></h2><p>We have developed the Tembo Operator looking to add new capabilities for developers and enterprises. We believe that it stands out from other techniques in many ways, and in particular, one important feature is that it lets users deploy applications in containers right alongside their PostgreSQL instances, ensuring efficient connection to Postgres with very low latency.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-advantage-of-running-applications-in-separate-containers">The Advantage of Running Applications in Separate Containers<a href="#the-advantage-of-running-applications-in-separate-containers" class="hash-link" aria-label="Direct link to The Advantage of Running Applications in Separate Containers" title="Direct link to The Advantage of Running Applications in Separate Containers">​</a></h2><p>PostgreSQL is a very powerful piece of software. When running in Kubernetes, a useful pattern is to run important applications in a separate container, in the same namespace. By running these applications in separate containers, we isolate application requirements, such as resource allocations. This means that each container can have dedicated CPU and Memory, ensuring there's no competition with the resources reserved for running PostgreSQL. This segregation ensures that the Postgres database and other applications can function and scale efficiently.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spotlight-on-postgrest-a-prime-example">Spotlight on PostgREST: A Prime Example<a href="#spotlight-on-postgrest-a-prime-example" class="hash-link" aria-label="Direct link to Spotlight on PostgREST: A Prime Example" title="Direct link to Spotlight on PostgREST: A Prime Example">​</a></h2><p>PostgREST is a perfect example where an application can run with this pattern. PostgREST serves as a standalone web server that turns your database directly into a RESTful API. The immediate advantage? Developers can use the auto-generated API to build robust applications without writing any code. By simplifying the process and reducing the need for middleware, PostgREST has become a popular tool in the Postgres ecosystem.</p><p>However, let’s remember that  the main advantage of this method is not just resource allocation. It's about ensuring the optimal performance of Postgres without bogging it down with additional tasks. </p><p>Let’s look at an example of a spec that would run the workload that we just described. This will look familiar if you’ve worked with the <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Kubernetes Pod spec.</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">postgres</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"quay.io/tembo/standard-cnpg:15.3.0-1-1096aeb"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">appServices</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgrest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgrest/postgrest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v10.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ingressPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_URI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFromPlatform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ReadWriteConnection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_SCHEMA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_ANON_ROLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The Tembo operator always starts postgres with default configurations, so let’s focus on the <code>appServices</code> section of the spec, which will tell us what and how we’ll run an application container.</p><p>We can run any number of applications in containers near the Postgres instance. Only the <code>name</code> and <code>image</code> parameters are required, but you can configure commands, arguments, environment variables, CPU and memory, and readiness and liveness probes for the application.</p><p>If you need network communication, you can also configure the ingress by specifying a port and a path. In our example, postgREST runs on port 3000 and expects traffic routed to the root path. appServices also support various Middleware configurations, but we will cover those in a future blog.</p><p>Environment variables also have some advanced configuration. The Tembo operator creates a few roles in Postgres, and tracks those credentials in a Kubernetes secret. If we want to pull those credentials into an application, we can do so by using the <code>valueFromPlatform</code> option. The service currently supports pulling in credentials for <code>ReadWriteConnection</code>, <code>ReadOnlyConnection</code> but we’ll be building out more role assignments soon.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrary-container-deployments">Arbitrary container deployments<a href="#arbitrary-container-deployments" class="hash-link" aria-label="Direct link to Arbitrary container deployments" title="Direct link to Arbitrary container deployments">​</a></h2><p>The Tembo operator is not limited to postgREST; it can run nearly any containerized application. For example, run your Rails application, or FastAPI web server. Specify the image, and other configurations as necessary and the Tembo operator will provision the resources.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">postgres</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">appServices</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/myImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ingressPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"python"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-m"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"myapp.py"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MY_ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Kubernetes Footprint</strong></p><p>Let’s take a look at what actually gets created when you specify an appService; we’ll use the postgREST example as an illustration.</p><p>Every application service gets its own Kubernetes Deployment. If the appService has any ingress requirements, then a Kubernetes Service and an ingress resource (Tembo currently uses <a href="https://doc.traefik.io/traefik/middlewares/overview/" target="_blank" rel="noopener noreferrer">Traefik</a>) is created for that appService. Middleware is also created (also Traefik) if the appService has any middleware configuration specified. Here’s an image of the pods you’d likely see in the namespace you create for Postgres.</p><p><img loading="lazy" alt="alt_text" src="/assets/images/kube-5f0581fdf597e5d0acd3b910b88808b3.png" title="image_tooltip" width="1512" height="576" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-to-follow">More to follow<a href="#more-to-follow" class="hash-link" aria-label="Direct link to More to follow" title="Direct link to More to follow">​</a></h2><p>The Tembo operator is under continuous development and runs the entire Postgres Stack, which is not limited to just the core Postgres engine. It also includes auxiliary container services that run outside of Postgres. These auxiliary services augment the Postgres experience by running complex applications outside of Postgres which isolates their workload from your database. Running this with the Tembo Operator makes it simple to get these services up and running.</p><p>And if you want to try out the full power of Postgres without being concerned with how it will run, try out <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>.Drop into our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20dtnhcmo-pLNV7_Aobi50TdTLpfQ~EQ" target="_blank" rel="noopener noreferrer">Slack</a> channel to ask questions and get help from the Tembo team and other community members.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adam Hendel)</author>
            <category>postgres</category>
            <category>kubernetes</category>
            <category>rust</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 6: Regina Obe and Paul Ramsey]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep6</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep6</guid>
            <pubDate>Tue, 31 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In this episode, Ry, Regina, and Paul talk about geospatial development, the challenges of creating and maintaining an extension across multiple Postgres development cycles, and what they’re hoping for in the future of Postgres.]]></description>
            <content:encoded><![CDATA[<p>In this episode, Ry, Regina, and Paul talk about geospatial development, the challenges of creating and maintaining an extension across multiple Postgres development cycles, and what they’re hoping for in the future of Postgres. </p><p>Watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Regina and Paul for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/q3TXM6Nu7Aw?si=El0OVHhXKXkXAoQ1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>SQL Server - <a href="https://www.microsoft.com/en-us/sql-server" target="_blank" rel="noopener noreferrer">https://www.microsoft.com/en-us/sql-server</a></li><li>PostGIS - <a href="https://postgis.net/" target="_blank" rel="noopener noreferrer">https://postgis.net/</a></li><li>Gist - <a href="https://www.postgresql.org/docs/current/gist.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/gist.html</a></li><li>R-tree - <a href="https://www.postgresql.org/docs/current/indexes-types.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/indexes-types.html</a></li><li>KNN - <a href="https://postgis.net/workshops/postgis-intro/knn.html" target="_blank" rel="noopener noreferrer">https://postgis.net/workshops/postgis-intro/knn.html</a></li><li>Parallelism - <a href="https://www.postgresql.org/docs/current/parallel-query.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/parallel-query.html</a></li><li>GEOS - <a href="https://libgeos.org/" target="_blank" rel="noopener noreferrer">https://libgeos.org/</a></li><li>CartoDB - <a href="https://carto.com/" target="_blank" rel="noopener noreferrer">https://carto.com/</a></li><li>Crunchy Data - <a href="https://www.crunchydata.com/" target="_blank" rel="noopener noreferrer">https://www.crunchydata.com/</a></li><li>OGR - <a href="https://github.com/pramsey/pgsql-ogr-fdw" target="_blank" rel="noopener noreferrer">https://github.com/pramsey/pgsql-ogr-fdw</a></li><li>Paragon Corporation - <a href="https://www.paragoncorporation.com/" target="_blank" rel="noopener noreferrer">https://www.paragoncorporation.com/</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---regina"><em>[00:00:12]<!-- --> - Regina</em><a href="#000012---regina" class="hash-link" aria-label="Direct link to 000012---regina" title="Direct link to 000012---regina">​</a></h5><p>Hi, I'm Ry Walker, founder of Tembo, a managed Postgres company. And today I have Regina Obe and Paul Ramsey, two who are working and have been working on PostGIS for quite some time. Welcome to the show, both of you.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000028---regina"><em>[00:00:28]<!-- --> - Regina</em><a href="#000028---regina" class="hash-link" aria-label="Direct link to 000028---regina" title="Direct link to 000028---regina">​</a></h5><p>Thanks, Ry.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000028---paul"><em>[00:00:28]<!-- --> - Paul</em><a href="#000028---paul" class="hash-link" aria-label="Direct link to 000028---paul" title="Direct link to 000028---paul">​</a></h5><p>Thanks, Ry. Nice to be here. Great. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000032---ry"><em>[00:00:32]<!-- --> - Ry</em><a href="#000032---ry" class="hash-link" aria-label="Direct link to 000032---ry" title="Direct link to 000032---ry">​</a></h5><p>So I think you guys have all been using Postgres for quite some time. Maybe. Paul, when did you start using Postgres?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000042---paul"><em>[00:00:42]<!-- --> - Paul</em><a href="#000042---paul" class="hash-link" aria-label="Direct link to 000042---paul" title="Direct link to 000042---paul">​</a></h5><p>I started using Postgres, and I'm sure I can give you a version number, I think like 6.4, which I think puts me in like the '98, '99 era. And yeah, I was using it as a consultant. My first career was in consulting and working for the provincial government. And we were doing a big data analysis project and it was a geospatial project, but all the geospatial processing was being done by an external piece of software and we used Postgres as the backing store for what was a very long, like, 20 day compute cycle to spit out all the results for the entire province. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000117---ry"><em>[00:01:17]<!-- --> - Ry</em><a href="#000117---ry" class="hash-link" aria-label="Direct link to 000117---ry" title="Direct link to 000117---ry">​</a></h5><p>Nice. How about you, Regina?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000118---regina"><em>[00:01:18]<!-- --> - Regina</em><a href="#000118---regina" class="hash-link" aria-label="Direct link to 000118---regina" title="Direct link to 000118---regina">​</a></h5><p>I started out as a SQL Server person, so yeah, Paul dragged me into Postgres. So my first introduction was via PostGIS in 2001, I think it was. So it was like 7.1 or 7.3, I can't remember somewhere between 7.1 and 7.3.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000139---paul"><em>[00:01:39]<!-- --> - Paul</em><a href="#000139---paul" class="hash-link" aria-label="Direct link to 000139---paul" title="Direct link to 000139---paul">​</a></h5><p>It was 7.1 because that was the first version of Postgres that you could actually do a geospatial extension. Oh, nice.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000145---ry"><em>[00:01:45]<!-- --> - Ry</em><a href="#000145---ry" class="hash-link" aria-label="Direct link to 000145---ry" title="Direct link to 000145---ry">​</a></h5><p>And do you regret leaving SQL Server?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000149---regina"><em>[00:01:49]<!-- --> - Regina</em><a href="#000149---regina" class="hash-link" aria-label="Direct link to 000149---regina" title="Direct link to 000149---regina">​</a></h5><p>Well, I still consult for SQL Server, and what's interesting about that is I think I've gotten to be a better SQL Server expert knowing Postgres because Postgres would always introduce things first, like all the lead functions, all the window functions, Postgres introduced those before SQL Server had them and the CTEs and everything.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000218---ry"><em>[00:02:18]<!-- --> - Ry</em><a href="#000218---ry" class="hash-link" aria-label="Direct link to 000218---ry" title="Direct link to 000218---ry">​</a></h5><p>Yeah, got it. What's the state of geospatial in Microsoft SQL Server, would you say compared to Postgres? I don't know too much about that ecosystem, but I'm curious, how much parity have they achieved?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000232---regina"><em>[00:02:32]<!-- --> - Regina</em><a href="#000232---regina" class="hash-link" aria-label="Direct link to 000232---regina" title="Direct link to 000232---regina">​</a></h5><p>Well, I think their geography is still better than ours, but in terms of the geometry support, they're way behind, which is what most of the state people care about.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000242---ry"><em>[00:02:42]<!-- --> - Ry</em><a href="#000242---ry" class="hash-link" aria-label="Direct link to 000242---ry" title="Direct link to 000242---ry">​</a></h5><p>Awesome. Cool. All right, well, I'm going to kind of go off my standard script because how long have you guys been working on PostGIS for? This is one of the oldest extensions, or is it the oldest extension?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000259---paul"><em>[00:02:59]<!-- --> - Paul</em><a href="#000259---paul" class="hash-link" aria-label="Direct link to 000259---paul" title="Direct link to 000259---paul">​</a></h5><p>Yeah, well, I mean, so when we started extension, this didn't exist. It's a pre extension as a package concept. It's just like the idea of runtime, adding things at runtime to the database which was there from the very beginning. That was a stonebreaker original. Like, this is one of the things Postgres can do. PostGIS is from 2001, as Regina mentioned, she started using it within three months of the initial release. So, yeah, may of 2001. So yeah, we're at 22 years.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000328---ry"><em>[00:03:28]<!-- --> - Ry</em><a href="#000328---ry" class="hash-link" aria-label="Direct link to 000328---ry" title="Direct link to 000328---ry">​</a></h5><p>So how has it, has it changed much? Would you say since? Has it been pretty steady progress towards what it is now? Or were there any big milestones, big changes that you can remember that are super noteworthy?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000342---paul"><em>[00:03:42]<!-- --> - Paul</em><a href="#000342---paul" class="hash-link" aria-label="Direct link to 000342---paul" title="Direct link to 000342---paul">​</a></h5><p>It has not been like one linear rise. It's definitely been punctuated equilibrium. And as these things go, the most new features and new capabilities happen right at the start, because we started with nothing, right? We started with first release. It had geospatial types, it had a geospatial index. It had eight functions, I think only one of which was analytical in any way. But that was like release 0.1 in 2001. I think we got to 0.8 in two years, like 2003. And that had the first full set of spatial functions where you could really test all the relationships between the geometries. You could do constructive geometry operations like buffering intersections and unions and so on in the geometries, that was the really big like, you could have stopped there in many respects. If you look at what SQL Server has, that's kind of what they did until 2008. They had no spatial at all. And then they came out with their spatial extension, which was basically what they have now because it was a capable, complete vector spatial database, full stop. But since then, we've kept adding stuff. Maybe Regina will take another tour of what she thinks the biggest things to happen since 0.8 were yeah, so I.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000508---regina"><em>[00:05:08]<!-- --> - Regina</em><a href="#000508---regina" class="hash-link" aria-label="Direct link to 000508---regina" title="Direct link to 000508---regina">​</a></h5><p>Think PostGIS just improved as Postgres improved. So they introduced Gist and all our indexes changed from the old R-tree to the Gist index. They improved aggregation in Postgres, which I think was a huge milestone for us because a lot of the processing we do involves aggregating geometries together. So we would see something like from a tenfold speed improvement in terms of aggregation of geometries. And then the other things. I think CTEs were pretty useful. Now, nobody does any queries in Spatial without using a CTE anymore.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000601---ry"><em>[00:06:01]<!-- --> - Ry</em><a href="#000601---ry" class="hash-link" aria-label="Direct link to 000601---ry" title="Direct link to 000601---ry">​</a></h5><p>Would you say, like those advances in Postgres? I don't know. Let's say that they did 80% of the work towards the thing working ten times faster, and you guys had to do 20%. Or what was the ratio of effort from where were you getting great improvements virtually for free without any effort on your side?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000621---regina"><em>[00:06:21]<!-- --> - Regina</em><a href="#000621---regina" class="hash-link" aria-label="Direct link to 000621---regina" title="Direct link to 000621---regina">​</a></h5><p>Yeah, I think we were getting great improvements for free, pretty much.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000625---ry"><em>[00:06:25]<!-- --> - Ry</em><a href="#000625---ry" class="hash-link" aria-label="Direct link to 000625---ry" title="Direct link to 000625---ry">​</a></h5><p>Oh, that's great.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000625---regina"><em>[00:06:25]<!-- --> - Regina</em><a href="#000625---regina" class="hash-link" aria-label="Direct link to 000625---regina" title="Direct link to 000625---regina">​</a></h5><p>And then there's the whole KNN thing, which they drastically improved from 9.2 to yeah, I was making fun of Bruce, and then Bruce said, I can't believe you'd have to do that. We need to fix it. And so after 9.2, the KNN became real KNN instead of just box KNN. But yeah, in all those cases, there wasn't that much we needed to do to get the improvement.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000649---paul"><em>[00:06:49]<!-- --> - Paul</em><a href="#000649---paul" class="hash-link" aria-label="Direct link to 000649---paul" title="Direct link to 000649---paul">​</a></h5><p>Parallelism.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000650---regina"><em>[00:06:50]<!-- --> - Regina</em><a href="#000650---regina" class="hash-link" aria-label="Direct link to 000650---regina" title="Direct link to 000650---regina">​</a></h5><p>Oh, yeah, parallelism.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000651---paul"><em>[00:06:51]<!-- --> - Paul</em><a href="#000651---paul" class="hash-link" aria-label="Direct link to 000651---paul" title="Direct link to 000651---paul">​</a></h5><p>Another one of which is like a huge freebie. Like, look at that. We do parallel processing.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000657---regina"><em>[00:06:57]<!-- --> - Regina</em><a href="#000657---regina" class="hash-link" aria-label="Direct link to 000657---regina" title="Direct link to 000657---regina">​</a></h5><p>Yeah, the only thing we needed to do is tell people how to configure their Postgres comps to take advantage of parallelism.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000705---ry"><em>[00:07:05]<!-- --> - Ry</em><a href="#000705---ry" class="hash-link" aria-label="Direct link to 000705---ry" title="Direct link to 000705---ry">​</a></h5><p>Curious, what kind of challenges did you guys face? I'd say early on building this.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000714---paul"><em>[00:07:14]<!-- --> - Paul</em><a href="#000714---paul" class="hash-link" aria-label="Direct link to 000714---paul" title="Direct link to 000714---paul">​</a></h5><p>The biggest thing? Well, I don't know. There are a lot of things. As a geospatial extension, our code isn't packed like into one hunk of code that we control. We use a lot of library dependencies. And so we end up having, and we still do having a really complex build almost right out of the gate compared to other extensions, because other extensions like, hey, we're a self contained thing. You just type, make and you're done. Whereas with us it was always like, hey, guess what? You get to track down three or four different other libraries in addition to the thing that we have and make sure they're the right versions, and here's the configuration, so on. So we end up with this really naughty configuration setup. And initially, like, if you're going to start using this stuff back in the day, step one was always to build it. They weren't prepackaged. Postgres itself wasn't prepackaged, everything was from source, so it put this fairly steep entryway in for new users.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000814---regina"><em>[00:08:14]<!-- --> - Regina</em><a href="#000814---regina" class="hash-link" aria-label="Direct link to 000814---regina" title="Direct link to 000814---regina">​</a></h5><p>Yeah, although early on, we didn't have any other dependencies except Postgres, so it was much easier.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000819---paul"><em>[00:08:19]<!-- --> - Paul</em><a href="#000819---paul" class="hash-link" aria-label="Direct link to 000819---paul" title="Direct link to 000819---paul">​</a></h5><p>Well GEOS after two years and then, well, proge at the same time. I mean, we had GEOS and proj almost from the start, and then started picking up format libraries after that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000828---regina"><em>[00:08:28]<!-- --> - Regina</em><a href="#000828---regina" class="hash-link" aria-label="Direct link to 000828---regina" title="Direct link to 000828---regina">​</a></h5><p>Do we have proj?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000829---paul"><em>[00:08:29]<!-- --> - Paul</em><a href="#000829---paul" class="hash-link" aria-label="Direct link to 000829---paul" title="Direct link to 000829---paul">​</a></h5><p>Yeah, I don't remember projection because proj already existed, so tying it in was a pretty straightforward thing to do.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000835---regina"><em>[00:08:35]<!-- --> - Regina</em><a href="#000835---regina" class="hash-link" aria-label="Direct link to 000835---regina" title="Direct link to 000835---regina">​</a></h5><p>Okay, I don't remember that. Or maybe it was an optional dependency, so I just never built with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000843---paul"><em>[00:08:43]<!-- --> - Paul</em><a href="#000843---paul" class="hash-link" aria-label="Direct link to 000843---paul" title="Direct link to 000843---paul">​</a></h5><p>Everything was optional.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000844---ry"><em>[00:08:44]<!-- --> - Ry</em><a href="#000844---ry" class="hash-link" aria-label="Direct link to 000844---ry" title="Direct link to 000844---ry">​</a></h5><p>Tell me what GEOS is. I've seen that mentioned, but I didn't dive in. Is that powering other geospatial solutions besides PostGIS?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000855---paul"><em>[00:08:55]<!-- --> - Paul</em><a href="#000855---paul" class="hash-link" aria-label="Direct link to 000855---paul" title="Direct link to 000855---paul">​</a></h5><p>Yeah, it is. GEOS is an acronym of course, stands for Geometry Engine open source. It provides the computational geometry underpinnings for a bunch of sort of the key functions. I mentioned a buffer, that's a GEOs function at the back end. Intersection is a GEOS function at the back end. The Boolean predicates intersects contains within those are all GEOS functions at the back end. Some of the fancier stuff that we've added to GEOS is now exposed in PostGIS. So if you ask for Delaunay triangles or <!-- -->[...]<!-- --> polygons, you get those from GEOS and then GEOS, because it's like this useful Swiss Army knife of computational geometry is used by other programs in the geospatial ecosystem. So if you use the Google library, it backs out of GEOS for its geospatial operations. And like most prominently, if you use the QGIS desktop GIS, you'll find that the Q just backstops its geospatial algorithms.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000954---ry"><em>[00:09:54]<!-- --> - Ry</em><a href="#000954---ry" class="hash-link" aria-label="Direct link to 000954---ry" title="Direct link to 000954---ry">​</a></h5><p>So did you guys refactor code into that, or did you just end up replacing some stuff you had built early on with that library later on?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001001---regina"><em>[00:10:01]<!-- --> - Regina</em><a href="#001001---regina" class="hash-link" aria-label="Direct link to 001001---regina" title="Direct link to 001001---regina">​</a></h5><p>Well, Paul started GEOS too.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001004---ry"><em>[00:10:04]<!-- --> - Ry</em><a href="#001004---ry" class="hash-link" aria-label="Direct link to 001004---ry" title="Direct link to 001004---ry">​</a></h5><p>Okay. All, it's okay. So it sounds like refactored into that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001009---regina"><em>[00:10:09]<!-- --> - Regina</em><a href="#001009---regina" class="hash-link" aria-label="Direct link to 001009---regina" title="Direct link to 001009---regina">​</a></h5><p>Well, not so much refactor. I think it was always kind of a separate thing. Right. It was always intended to do more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001015---paul"><em>[00:10:15]<!-- --> - Paul</em><a href="#001015---paul" class="hash-link" aria-label="Direct link to 001015---paul" title="Direct link to 001015---paul">​</a></h5><p>And as an external library, there's actually a slight penalty to using it because you got to take your data out of the Postgres memory space and copy it over into the JS memory space to work with it. And that's just expensive enough that for simple things, we still actually kept the original native post, just side implementations for things like area or length or the most complex one that we kept is distance. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001045---ry"><em>[00:10:45]<!-- --> - Ry</em><a href="#001045---ry" class="hash-link" aria-label="Direct link to 001045---ry" title="Direct link to 001045---ry">​</a></h5><p>Are there any milestones going in the future for PostGIS that you're looking forward to or is it just kind of stability and continuous improvement?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001056---paul"><em>[00:10:56]<!-- --> - Paul</em><a href="#001056---paul" class="hash-link" aria-label="Direct link to 001056---paul" title="Direct link to 001056---paul">​</a></h5><p>You go, Regina.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001058---regina"><em>[00:10:58]<!-- --> - Regina</em><a href="#001058---regina" class="hash-link" aria-label="Direct link to 001058---regina" title="Direct link to 001058---regina">​</a></h5><p>Oh, no, you're not going to ask me that. I think speed is always good, and my concern, I think, is mostly improving Raster. And I'm looking forward to Toast's API changes that are coming along and how we could leverage those.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001116---paul"><em>[00:11:16]<!-- --> - Paul</em><a href="#001116---paul" class="hash-link" aria-label="Direct link to 001116---paul" title="Direct link to 001116---paul">​</a></h5><p>That's funny you bring up raster. Maybe we should talk about this in the part we have a little get together, because it's one of the things which in front of me lately is like the underlying infrastructure we have for handling rasters was built well, no, 2010, anyways. It was built, like, in an era when the idea of, say, doing cloud based raster processing was kind of not what would be done. It was built around the idea that you would store your own rasters kind of locally in your local area network, that increasingly organizations just don't do that. They still want to have raster access. And while you can do remote raster access with what we have, it's kind of clunky. It's not optimized for that at all. I feel like just like a relook at what the raster use cases are and kind of a reevaluation of whether how we handle rasters is right is due. I was looking at the API that Alibaba offers on their cloud databases and thinking, yeah, that's kind of an interesting way of tackling rasters.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001217---ry"><em>[00:12:17]<!-- --> - Ry</em><a href="#001217---ry" class="hash-link" aria-label="Direct link to 001217---ry" title="Direct link to 001217---ry">​</a></h5><p>Yeah, you're talking about like Alibaba is like a they have a proprietary database or not, their Postgres.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001225---paul"><em>[00:12:25]<!-- --> - Paul</em><a href="#001225---paul" class="hash-link" aria-label="Direct link to 001225---paul" title="Direct link to 001225---paul">​</a></h5><p>They don't say. They're really cagey about it. So I'm not sure whether it's back then Postgres or not, but their take on rasters is very much all their own. I haven't seen anyone else go at it that way.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001235---regina"><em>[00:12:35]<!-- --> - Regina</em><a href="#001235---regina" class="hash-link" aria-label="Direct link to 001235---regina" title="Direct link to 001235---regina">​</a></h5><p>Oh, I haven't seen that. I should check that out. But yeah, that's one of the complaints that people have, at least the clients I have, that the outdb is much slower and yeah, that could be improved.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001248---paul"><em>[00:12:48]<!-- --> - Paul</em><a href="#001248---paul" class="hash-link" aria-label="Direct link to 001248---paul" title="Direct link to 001248---paul">​</a></h5><p>Yeah, great.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001251---ry"><em>[00:12:51]<!-- --> - Ry</em><a href="#001251---ry" class="hash-link" aria-label="Direct link to 001251---ry" title="Direct link to 001251---ry">​</a></h5><p>I'm curious if you're paying attention. I don't know the difference. I've not studied how PostGIS works or raster, and it is but I'm curious, is the vector search stuff happening that's happening in the ML space? How closely related is the math of that to the math of I'm sure you've kind of paid a little bit of attention to that space. Is it wildly different or is it kind of remarkably similar or neither of those?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001323---paul"><em>[00:13:23]<!-- --> - Paul</em><a href="#001323---paul" class="hash-link" aria-label="Direct link to 001323---paul" title="Direct link to 001323---paul">​</a></h5><p>Yeah, well, I mean, insofar as a 2D vector is the same as a <!-- -->[...]<!-- --> vector. At a conceptual level, they're the same. But from a practicality point of view, the practicalities of handling super high dimensional stuff are just different. Like one of the first things you learn, even like we go to four dimensions, even at four dimensions, the indexing properties start to break down if the kind of sort of standard R-tree stuff just doesn't work as nicely. You don't have to get very high up into a complex dimensional space for that form of indexing to be like, it doesn't work, it's not doing what we need to do. And you can really see that in just how different the indexing approaches are for ML vectors compared to sort of 2D vectors.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001410---ry"><em>[00:14:10]<!-- --> - Ry</em><a href="#001410---ry" class="hash-link" aria-label="Direct link to 001410---ry" title="Direct link to 001410---ry">​</a></h5><p>So, like, high dimensionality just requires an entirely different mindset and solution set. So I'm hearing you say.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001417---paul"><em>[00:14:17]<!-- --> - Paul</em><a href="#001417---paul" class="hash-link" aria-label="Direct link to 001417---paul" title="Direct link to 001417---paul">​</a></h5><p>Yes, totally.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001418---ry"><em>[00:14:18]<!-- --> - Ry</em><a href="#001418---ry" class="hash-link" aria-label="Direct link to 001418---ry" title="Direct link to 001418---ry">​</a></h5><p>Just curious if it somehow scales into that or not. That's cool. Yeah. Well, tell me, I guess, real quick, I'd love to learn a little bit more about the commercial products, I guess. How does this manifest? How does PostGIS manifest commercially for both you and Regina?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001441---regina"><em>[00:14:41]<!-- --> - Regina</em><a href="#001441---regina" class="hash-link" aria-label="Direct link to 001441---regina" title="Direct link to 001441---regina">​</a></h5><p>For my side, it's mostly consulting. Yeah, I don't have any commercial things around.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001452---paul"><em>[00:14:52]<!-- --> - Paul</em><a href="#001452---paul" class="hash-link" aria-label="Direct link to 001452---paul" title="Direct link to 001452---paul">​</a></h5><p>I make sideline in talking about and studying the economics of open source. One of the things that's kind of obvious once you start looking at this stuff is that there's like a project size threshold before you start to see enough money around a project to support full time maintainership or people whose jobs are mostly around the project. And PostGIS is interesting in being like one of the few Postgres extensions which has received achieved that level. But even at that level, it's quite small. So you got Regina, who has a good consulting business. I work for Crunchy Data, which is a professional open source support company, which is to say they sell support contracts to Fortune 100 companies and US Federal government and increasingly a number of international organizations, but of similar size and scale, big organizations. And then also has a software as a service called Crunchy Bridge, which is basically database in the cloud of the sort that everyone's gotten used to. So, I mean, in that respect, I'm kind of like Regina. I work for Crunchy because they value my expertise as a PostGIS committer and my ability to help their customers who deploy PostGIS.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001620---paul"><em>[00:16:20]<!-- --> - Paul</em><a href="#001620---paul" class="hash-link" aria-label="Direct link to 001620---paul" title="Direct link to 001620---paul">​</a></h5><p>So it's still very much like skills for hire. No one has wrapped it up, has wrapped PostGIS itself in particular up as a specific product.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001628---regina"><em>[00:16:28]<!-- --> - Regina</em><a href="#001628---regina" class="hash-link" aria-label="Direct link to 001628---regina" title="Direct link to 001628---regina">​</a></h5><p>Yeah, I mean, others have, it's just.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001630---paul"><em>[00:16:30]<!-- --> - Paul</em><a href="#001630---paul" class="hash-link" aria-label="Direct link to 001630---paul" title="Direct link to 001630---paul">​</a></h5><p>We haven't and then yeah, other members of the development team are also still sort of on the consulting bandwagon and that's how it bundled.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001641---ry"><em>[00:16:41]<!-- --> - Ry</em><a href="#001641---ry" class="hash-link" aria-label="Direct link to 001641---ry" title="Direct link to 001641---ry">​</a></h5><p>I'm not familiar with anyone who's bundled it up as a product per se, who's done that?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001647---regina"><em>[00:16:47]<!-- --> - Regina</em><a href="#001647---regina" class="hash-link" aria-label="Direct link to 001647---regina" title="Direct link to 001647---regina">​</a></h5><p>I mean, it's not so much a product, but like all the cloud providers so Amazon has it, Microsoft has an installable extension. Yeah. As an installable.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001659---paul"><em>[00:16:59]<!-- --> - Paul</em><a href="#001659---paul" class="hash-link" aria-label="Direct link to 001659---paul" title="Direct link to 001659---paul">​</a></h5><p>From the point of view of ubiquity and market spread.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001703---regina"><em>[00:17:03]<!-- --> - Regina</em><a href="#001703---regina" class="hash-link" aria-label="Direct link to 001703---regina" title="Direct link to 001703---regina">​</a></h5><p>Yeah. CartoDB used to be the closest though. But do they still use Postgres or did they switch to something else?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001709---paul"><em>[00:17:09]<!-- --> - Paul</em><a href="#001709---paul" class="hash-link" aria-label="Direct link to 001709---paul" title="Direct link to 001709---paul">​</a></h5><p>Which DB?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001710---regina"><em>[00:17:10]<!-- --> - Regina</em><a href="#001710---regina" class="hash-link" aria-label="Direct link to 001710---regina" title="Direct link to 001710---regina">​</a></h5><p>CartoDB. Carto.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001712---paul"><em>[00:17:12]<!-- --> - Paul</em><a href="#001712---paul" class="hash-link" aria-label="Direct link to 001712---paul" title="Direct link to 001712---paul">​</a></h5><p>They still use Postgres. Yeah. They haven't moved up. That would be a good sort of like example of a productization of PostGIS. Certainly in their earliest incarnation they had a software as a service which did a very good job of allowing you to put data in, visualize it in a whole bunch of ways. And that exposed like SQL as the language for customization of what you were seeing. And it was all sitting on top of PostGIS, but it was marketed as CartoDB. So they had productized around a software service that more or less made the database not invisible, but the actual brand of the database was irrelevant.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001751---ry"><em>[00:17:51]<!-- --> - Ry</em><a href="#001751---ry" class="hash-link" aria-label="Direct link to 001751---ry" title="Direct link to 001751---ry">​</a></h5><p>Do you see real old versions of PostGIS surface? Like, I'm sure you probably don't see 0.8 anymore, but no. How good are people at staying up on the latest, would you say? I have not as good as you.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001808---regina"><em>[00:18:08]<!-- --> - Regina</em><a href="#001808---regina" class="hash-link" aria-label="Direct link to 001808---regina" title="Direct link to 001808---regina">​</a></h5><p>Haven't seen any 1.5 recently. I think there might have been one.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001816---paul"><em>[00:18:16]<!-- --> - Paul</em><a href="#001816---paul" class="hash-link" aria-label="Direct link to 001816---paul" title="Direct link to 001816---paul">​</a></h5><p>Your standards are different from mine, Regina, because I,...I'd freak out if someone brought me a 1.5. I'm shocked at how many version two is just still in the wild. Let me account back that first digit is worth about a year. So we're at 3.4 now. So 3.0, so that's five years. So yeah. So some shows up with a two point something. It's a five year old installation.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001835---regina"><em>[00:18:35]<!-- --> - Regina</em><a href="#001835---regina" class="hash-link" aria-label="Direct link to 001835---regina" title="Direct link to 001835---regina">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001835---ry"><em>[00:18:35]<!-- --> - Ry</em><a href="#001835---ry" class="hash-link" aria-label="Direct link to 001835---ry" title="Direct link to 001835---ry">​</a></h5><p>And they're probably five versions of Postgres old too, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001839---paul"><em>[00:18:39]<!-- --> - Paul</em><a href="#001839---paul" class="hash-link" aria-label="Direct link to 001839---paul" title="Direct link to 001839---paul">​</a></h5><p>Yeah, exactly.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001841---ry"><em>[00:18:41]<!-- --> - Ry</em><a href="#001841---ry" class="hash-link" aria-label="Direct link to 001841---ry" title="Direct link to 001841---ry">​</a></h5><p>What's the biggest jump you'll do? Will you take someone from eleven to 15 or Postgres? That is the equivalent?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001848---regina"><em>[00:18:48]<!-- --> - Regina</em><a href="#001848---regina" class="hash-link" aria-label="Direct link to 001848---regina" title="Direct link to 001848---regina">​</a></h5><p>Yeah, because the latest wouldn't even run on that. Well, in theory, anybody from PostGIS 2...</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001900---regina"><em>[00:19:00]<!-- --> - Regina</em><a href="#001900---regina" class="hash-link" aria-label="Direct link to 001900---regina" title="Direct link to 001900---regina">​</a></h5><p>should be able to go straight to 3.4 without any issue as long as they upgrade their Postgres too. What happens to their development, their applications? Breaking that's on them.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001915---ry"><em>[00:19:15]<!-- --> - Ry</em><a href="#001915---ry" class="hash-link" aria-label="Direct link to 001915---ry" title="Direct link to 001915---ry">​</a></h5><p>Well, it must be nice to be relying on Postgres. I think you can criticize, if you would like, various aspects of how Postgres is built, but I think that it's really great how stable, I want to say slow that the progress is made because it gives you a very stable and reliable chassis to build this on top of. I'm sure you guys agree with that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001944---regina"><em>[00:19:44]<!-- --> - Regina</em><a href="#001944---regina" class="hash-link" aria-label="Direct link to 001944---regina" title="Direct link to 001944---regina">​</a></h5><p>Yeah, I think in terms of slowness, they're actually much faster than other relational databases.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001949---paul"><em>[00:19:49]<!-- --> - Paul</em><a href="#001949---paul" class="hash-link" aria-label="Direct link to 001949---paul" title="Direct link to 001949---paul">​</a></h5><p>Much, much faster in terms of how fast things change. Yeah, I guess there's always that push particularly thing. New SQL dialect stuff has come in pretty quick.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001958---regina"><em>[00:19:58]<!-- --> - Regina</em><a href="#001958---regina" class="hash-link" aria-label="Direct link to 001958---regina" title="Direct link to 001958---regina">​</a></h5><p>Yeah, because I remember when I be talking to my SQL Server friends and they're still waiting for the lead function. That happened like five years ago back in the day. But yeah, I think it moves in terms of the SQL standard a lot faster than the others. I think even faster than Oracle, though I don't have too many Oracle friends to talk about.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002020---paul"><em>[00:20:20]<!-- --> - Paul</em><a href="#002020---paul" class="hash-link" aria-label="Direct link to 002020---paul" title="Direct link to 002020---paul">​</a></h5><p>Yeah. I'm frequently, frequently surprised by how much internal churn there is because I always feel like, oh, we're the supermature extension. We don't reach like super deep into the extension, like into the into the core. We're not hooking into like executor hooks or planner hooks or stuff like that. And yet there's always this there's always this medium to long list of things that have to be tweaked when you move up to a new, like in terms of our code or for it to build and still run correctly, that have to be tweaked at each major Postgres release.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002057---regina"><em>[00:20:57]<!-- --> - Regina</em><a href="#002057---regina" class="hash-link" aria-label="Direct link to 002057---regina" title="Direct link to 002057---regina">​</a></h5><p>Yeah, because I can't think of any release we've done that we didn't have to tweak it for the in development major release of Postgres. So they changed it enough that it always affects yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002110---paul"><em>[00:21:10]<!-- --> - Paul</em><a href="#002110---paul" class="hash-link" aria-label="Direct link to 002110---paul" title="Direct link to 002110---paul">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002110---ry"><em>[00:21:10]<!-- --> - Ry</em><a href="#002110---ry" class="hash-link" aria-label="Direct link to 002110---ry" title="Direct link to 002110---ry">​</a></h5><p>So even if the outer shell seems pretty stable, the insides are changing and you guys have some stuff poking down at least to the middle, if not the bottom. That's great. Yeah, like I said, I think it's to me a really perfect pace because we do get that kind of like annual innovation and if there's something that's really important, it'll get taken care of, I think. I'm curious, are there things happening in Postgres core that you guys are excited about? Maybe for we could talk about 17 or whatever, 18 future? Is there anything in particular that you guys are excited to see?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002153---regina"><em>[00:21:53]<!-- --> - Regina</em><a href="#002153---regina" class="hash-link" aria-label="Direct link to 002153---regina" title="Direct link to 002153---regina">​</a></h5><p>Well, there's bi directional seems to be making its way. I don't know if it's going to make it into 17, but it looks like they're putting in the hooks for it anyway, so that's kind of exciting.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002205---paul"><em>[00:22:05]<!-- --> - Paul</em><a href="#002205---paul" class="hash-link" aria-label="Direct link to 002205---paul" title="Direct link to 002205---paul">​</a></h5><p>Yeah, for me, that's what's exciting. I've been watching the decade long crawl towards being able to do a replicated OLAP system where you get full push down to all the nodes. So every release, the Postgres FTW folks from Toshiba and other places add a couple more turns of stuff that you can push down, which is exciting to me because we're that much closer. We're that much closer to be able to do big multi node queries because there's OLAP workloads and LTP workloads for spatial databases. Really, the bias is towards OLAP for sure. In terms of what you see, how you see people using the database. I mean, they like transactionality, they like to be able to manipulate their data. But when it comes time to ask, what is this for? It's like, oh yeah, we run big analyzes. So the ability to push stuff out to multi node as that gets more mature, as it gets more possible, like, that becomes something that's really exciting on the spatial side. So I watch every little tick of the gears towards that endpoint and get very excited. So it's been pushed down in the last couple of releases.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002322---paul"><em>[00:23:22]<!-- --> - Paul</em><a href="#002322---paul" class="hash-link" aria-label="Direct link to 002322---paul" title="Direct link to 002322---paul">​</a></h5><p>Last release had good stuff around parallelization in the planner and executor as well for partitions, which is like, that's a big deal because the holy grail is you've got your big table partitioned out across the remote nodes. So each of your partition is actually a foreign table. And when you run the query, the planner says, oh, look, I can just ask all the partitions to run it simultaneously, it gets back the result, assembles it and says, Here you go, we're getting close to that. Which would be a big deal because there's a whole bunch of workloads that you can just turn into sort of like a standard OLAP star schema. One big fact table, a bunch of dimensions and you'd be able to do lots of really cool spatial stuff. That right now, not so much. I don't know when we'll ever get to the holy grail, which is to be able be able to do shipping data between nodes in order to allow nodes do things like join across these across two big fact tables. That might never happen. I don't see anyone doing that. But that's the one that would like having me tear my clothes off and dancing in the street.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002434---ry"><em>[00:24:34]<!-- --> - Ry</em><a href="#002434---ry" class="hash-link" aria-label="Direct link to 002434---ry" title="Direct link to 002434---ry">​</a></h5><p>Yeah. So that's interesting. You're talking about like I haven't followed the development of Postgres FDW. I used it recently and it's pretty powerful at low scale, but you're talking about at high scale, at OLAP scale, just optimization across.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002453---regina"><em>[00:24:53]<!-- --> - Regina</em><a href="#002453---regina" class="hash-link" aria-label="Direct link to 002453---regina" title="Direct link to 002453---regina">​</a></h5><p>And Paul has this fantastic foreign data wrapper, a spatial foreign data wrapper, which can read how many formats? 800?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002503---paul"><em>[00:25:03]<!-- --> - Paul</em><a href="#002503---paul" class="hash-link" aria-label="Direct link to 002503---paul" title="Direct link to 002503---paul">​</a></h5><p>Yeah, no, there's not that many formats in the world, but I don't know several different yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002508---ry"><em>[00:25:08]<!-- --> - Ry</em><a href="#002508---ry" class="hash-link" aria-label="Direct link to 002508---ry" title="Direct link to 002508---ry">​</a></h5><p>Formats of geospatial formats. Is that what you said? Or other types of formats.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002514---paul"><em>[00:25:14]<!-- --> - Paul</em><a href="#002514---paul" class="hash-link" aria-label="Direct link to 002514---paul" title="Direct link to 002514---paul">​</a></h5><p>Geospatial formats. But to an extent, geospatial formats is a category which also includes non geospatial things because all you have to do is not have the geospatial column and then what do you call it? Oh, it's just a format. So Excel can be a geospatial format. Got it. And it's something that you can read. SQL Server.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002532---ry"><em>[00:25:32]<!-- --> - Ry</em><a href="#002532---ry" class="hash-link" aria-label="Direct link to 002532---ry" title="Direct link to 002532---ry">​</a></h5><p>What's the name of that extension?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002534---paul"><em>[00:25:34]<!-- --> - Paul</em><a href="#002534---paul" class="hash-link" aria-label="Direct link to 002534---paul" title="Direct link to 002534---paul">​</a></h5><p>Or that extension is called OGR. Under more FDW.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002537---ry"><em>[00:25:37]<!-- --> - Ry</em><a href="#002537---ry" class="hash-link" aria-label="Direct link to 002537---ry" title="Direct link to 002537---ry">​</a></h5><p>OGR.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002538---paul"><em>[00:25:38]<!-- --> - Paul</em><a href="#002538---paul" class="hash-link" aria-label="Direct link to 002538---paul" title="Direct link to 002538---paul">​</a></h5><p>It stands for well, OGR is like it's not even worth trying to unpack it. OGR is just the vector side of the GDL library, which also has an acronym which is not worth unpacking anymore because it's a 20 year old acronym, but it refers to the library that it's binding. This is the OG library for vector formats? Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002558---ry"><em>[00:25:58]<!-- --> - Ry</em><a href="#002558---ry" class="hash-link" aria-label="Direct link to 002558---ry" title="Direct link to 002558---ry">​</a></h5><p>Cool. Yeah, I'll check that out. That's cool. Kind of wrapping this up on the core. Like if you had a magic wand and you could add any feature to know. Of course, if that was added, then you immediately have work to do in PostGIS as well. But what would your magic wand manifest this weekend in Postgres if you could pick one thing?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002620---regina"><em>[00:26:20]<!-- --> - Regina</em><a href="#002620---regina" class="hash-link" aria-label="Direct link to 002620---regina" title="Direct link to 002620---regina">​</a></h5><p>Yeah, I can't think of any.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002621---paul"><em>[00:26:21]<!-- --> - Paul</em><a href="#002621---paul" class="hash-link" aria-label="Direct link to 002621---paul" title="Direct link to 002621---paul">​</a></h5><p>I know what Regina's is. Oh, come on. I'll tell you what yours is then, Regina, if you're not going to say.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002630---ry"><em>[00:26:30]<!-- --> - Ry</em><a href="#002630---ry" class="hash-link" aria-label="Direct link to 002630---ry" title="Direct link to 002630---ry">​</a></h5><p>You guys can answer for each other if you want.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002632---paul"><em>[00:26:32]<!-- --> - Paul</em><a href="#002632---paul" class="hash-link" aria-label="Direct link to 002632---paul" title="Direct link to 002632---paul">​</a></h5><p>It's handling extensions in a slightly different way or sorry, had an extension update in a slightly different way. So extension versioning.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002640---regina"><em>[00:26:40]<!-- --> - Regina</em><a href="#002640---regina" class="hash-link" aria-label="Direct link to 002640---regina" title="Direct link to 002640---regina">​</a></h5><p>Oh, yeah. How did you read my mind? I completely forgot about it because I gave up hope on it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002647---ry"><em>[00:26:47]<!-- --> - Ry</em><a href="#002647---ry" class="hash-link" aria-label="Direct link to 002647---ry" title="Direct link to 002647---ry">​</a></h5><p>Yeah, tell me about that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002648---regina"><em>[00:26:48]<!-- --> - Regina</em><a href="#002648---regina" class="hash-link" aria-label="Direct link to 002648---regina" title="Direct link to 002648---regina">​</a></h5><p>So Sandro, who's also on the PostGIS team, he's been working on an update to the extension machinery that would allow us to reduce our upgrade script to one file because right now we ship like 500 files, which are all pretty much just SIM links to the same thing. And so it's just a way to have the extension machinery understand that, hey, this script can be used to upgrade this version, this version, this version and this version, instead of having to itemize every single version upgrade.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002730---paul"><em>[00:27:30]<!-- --> - Paul</em><a href="#002730---paul" class="hash-link" aria-label="Direct link to 002730---paul" title="Direct link to 002730---paul">​</a></h5><p>Yeah, the extension upgrade machinery is very clever, but it starts with an immediate assumption, which is that as a developer, you will manage your extension upgrades as incrementals between versions and that it will cleverly find the path through the incrementals from the version you have to the version you're going to, applying all the little slices on the way.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002755---regina"><em>[00:27:55]<!-- --> - Regina</em><a href="#002755---regina" class="hash-link" aria-label="Direct link to 002755---regina" title="Direct link to 002755---regina">​</a></h5><p>And it uses Dijkstra for that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002758---paul"><em>[00:27:58]<!-- --> - Paul</em><a href="#002758---paul" class="hash-link" aria-label="Direct link to 002758---paul" title="Direct link to 002758---paul">​</a></h5><p>Yeah, it's super clever. Even like in the best case scenario where you'd already been doing that, it's probably not super ideal for any project where the development path isn't linear. So Post just has, I don't know, 25 or so minor releases like X, Y, and then within those, there's maybe five patch releases across each of those. So we'll have a whole bunch of parallel version trees, right? You're on 2.3.5, or you're going to go to 2.3.6, but then you might want to go to 2.4.8. And that means you have to have all these individual even if you're doing things like one tiny step of time, you would have all these individual little hops across the branches. If you have just this one line, it kind of worked. You just sort of chained together this one little line. You don't have very many files when you have all these little branches, all of a sudden you need all these extra little hops across the branches. And it's made worse because all of our management of the SQL side of it, the SQL side of the extension where you define the functions on SQL land and say, oh, it's over here in the dynamic library.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002924---paul"><em>[00:29:24]<!-- --> - Paul</em><a href="#002924---paul" class="hash-link" aria-label="Direct link to 002924---paul" title="Direct link to 002924---paul">​</a></h5><p>We've been managing that since pre extension world. And our way of managing it was to have a SQL file which can always be cleanly applied against any previous version. So it's quite long because the SQL file has every single definition of every single thing in it. So how you handle the incremental thing from 1.2 to 1.3? Well you have one copy for 1.31 copy for the upgrade as well. So every little upgrade has a full copy of that fairly large SQL file. On Unix systems now we just ship sip links instead of syncing the whole file. But you end up with just a huge pile.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003005---regina"><em>[00:30:05]<!-- --> - Regina</em><a href="#003005---regina" class="hash-link" aria-label="Direct link to 003005---regina" title="Direct link to 003005---regina">​</a></h5><p>Yeah, actually we changed from that to just a file that has nothing in it. Right. To just on any version which kind.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003013---paul"><em>[00:30:13]<!-- --> - Paul</em><a href="#003013---paul" class="hash-link" aria-label="Direct link to 003013---paul" title="Direct link to 003013---paul">​</a></h5><p>Of the chain eventually arrives at the full one.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003017---regina"><em>[00:30:17]<!-- --> - Regina</em><a href="#003017---regina" class="hash-link" aria-label="Direct link to 003017---regina" title="Direct link to 003017---regina">​</a></h5><p>So now that's the same across. But I think ours is more complicated too because for each version we support multiple versions of Postgres and we also enable new features. If you're on like twelve you get something, if you are eleven you don't get that something.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003040---paul"><em>[00:30:40]<!-- --> - Paul</em><a href="#003040---paul" class="hash-link" aria-label="Direct link to 003040---paul" title="Direct link to 003040---paul">​</a></h5><p>Certainly something which is not contemplated by the original designers is our file. Our input file actually goes through, we put it through the C preprocessor before we give it to Postgres because we have a whole bunch of if defs against what Postgres version you're on. Living inside the SQL file that have to be pre processed before it's usable.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003102---ry"><em>[00:31:02]<!-- --> - Ry</em><a href="#003102---ry" class="hash-link" aria-label="Direct link to 003102---ry" title="Direct link to 003102---ry">​</a></h5><p>Yeah, I understand. Was maybe you're saying like the current design is just naive thinking that you're not going to try to support multiple versions of Postgres with one of your versions of the extension and there's not home for that information, I guess for what the range is to some degree.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003122---paul"><em>[00:31:22]<!-- --> - Paul</em><a href="#003122---paul" class="hash-link" aria-label="Direct link to 003122---paul" title="Direct link to 003122---paul">​</a></h5><p>Yeah, I mean although the extension framework does contemplate the idea of versioned extensions, again, it doesn't really contemplate them as anything except for a linear chain. And once you have a more complex situation than that it's kind of hard. Like we for a very long time supported being able to run different versions of PostGIS inside the same Postgres cluster. We still do actually support that, but it's a feature that it seems like mostly OA developers use. So it's optional now and we default just to like one version of Postgres or PostGIS for each Postgres cluster. But that functionality was always there. But the extension facility did not grok that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003205---regina"><em>[00:32:05]<!-- --> - Regina</em><a href="#003205---regina" class="hash-link" aria-label="Direct link to 003205---regina" title="Direct link to 003205---regina">​</a></h5><p>Yeah, and packagers did not grok that either. So they always, always ship one.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003210---ry"><em>[00:32:10]<!-- --> - Ry</em><a href="#003210---ry" class="hash-link" aria-label="Direct link to 003210---ry" title="Direct link to 003210---ry">​</a></h5><p>Great. I'm curious, try to wrap up here a little. I realize now I've been kept you here for quite some time, but do either of you listen to podcasts very much?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003220---paul"><em>[00:32:20]<!-- --> - Paul</em><a href="#003220---paul" class="hash-link" aria-label="Direct link to 003220---paul" title="Direct link to 003220---paul">​</a></h5><p>I do all the time. It's my gym thing. I go down to the garage gym and that's what keeps me from going crazy with me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003228---ry"><em>[00:32:28]<!-- --> - Ry</em><a href="#003228---ry" class="hash-link" aria-label="Direct link to 003228---ry" title="Direct link to 003228---ry">​</a></h5><p>Your give me some of your favorite podcasts.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003231---paul"><em>[00:32:31]<!-- --> - Paul</em><a href="#003231---paul" class="hash-link" aria-label="Direct link to 003231---paul" title="Direct link to 003231---paul">​</a></h5><p>I tend to go on the current affairs side, so I listen to the Ezra Klein show from New York Times a lot and Odd Lots from Bloomberg, a little bit of financial news.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003240---regina"><em>[00:32:40]<!-- --> - Regina</em><a href="#003240---regina" class="hash-link" aria-label="Direct link to 003240---regina" title="Direct link to 003240---regina">​</a></h5><p>Yeah, you can tell he's the son of a politician.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003242---paul"><em>[00:32:42]<!-- --> - Paul</em><a href="#003242---paul" class="hash-link" aria-label="Direct link to 003242---paul" title="Direct link to 003242---paul">​</a></h5><p>It's interesting stuff.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003244---ry"><em>[00:32:44]<!-- --> - Ry</em><a href="#003244---ry" class="hash-link" aria-label="Direct link to 003244---ry" title="Direct link to 003244---ry">​</a></h5><p>Yeah. How about you, Regina?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003247---regina"><em>[00:32:47]<!-- --> - Regina</em><a href="#003247---regina" class="hash-link" aria-label="Direct link to 003247---regina" title="Direct link to 003247---regina">​</a></h5><p>No, I'm not a podcast person. I go swimming. But yeah, I can't really hook up a podcast.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003255---ry"><em>[00:32:55]<!-- --> - Ry</em><a href="#003255---ry" class="hash-link" aria-label="Direct link to 003255---ry" title="Direct link to 003255---ry">​</a></h5><p>Yeah, underwater is probably possible, but not super comfortable. Right, great. All right, well, so where can listeners find you online? Maybe share your websites or Twitter? Mastodon handles.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003313---paul"><em>[00:33:13]<!-- --> - Paul</em><a href="#003313---paul" class="hash-link" aria-label="Direct link to 003313---paul" title="Direct link to 003313---paul">​</a></h5><p>On the site formerly known as Twitter. I'm PWRamsey. I'm also PWRamsay at Mastodon Social and on the blog world, I'm at cleverelephantCA.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003325---regina"><em>[00:33:25]<!-- --> - Regina</em><a href="#003325---regina" class="hash-link" aria-label="Direct link to 003325---regina" title="Direct link to 003325---regina">​</a></h5><p>Yeah, I have how many blogs do I have? I have BostonGIS.com Postgresonline.com. Twitter is just Reginaobe, I think that's and my website, Paragoncorporation.com, I guess those are. Oh, and my book site PostGIS.us.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003347---paul"><em>[00:33:47]<!-- --> - Paul</em><a href="#003347---paul" class="hash-link" aria-label="Direct link to 003347---paul" title="Direct link to 003347---paul">​</a></h5><p>Yeah, the book site.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003349---ry"><em>[00:33:49]<!-- --> - Ry</em><a href="#003349---ry" class="hash-link" aria-label="Direct link to 003349---ry" title="Direct link to 003349---ry">​</a></h5><p>What's that? I always say PostGIS, by the way. I got to learn it's PostGIS. But do you have a book for around it, or have you written many books?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003357---regina"><em>[00:33:57]<!-- --> - Regina</em><a href="#003357---regina" class="hash-link" aria-label="Direct link to 003357---regina" title="Direct link to 003357---regina">​</a></h5><p>Oh, yeah. So I wrote "PostGIS in Action." I'm working on "PG Routing." I'm also supposedly working on a Postgres book, both of which I'm very behind on. And I did "SQL in a Nutshell." And let's see, what else. Is that it? Oh, and "Postgres Up and Running." That's a pretty popular book. Surprisingly popular.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003425---ry"><em>[00:34:25]<!-- --> - Ry</em><a href="#003425---ry" class="hash-link" aria-label="Direct link to 003425---ry" title="Direct link to 003425---ry">​</a></h5><p>Yeah, it's sitting right there. I own that one.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003428---regina"><em>[00:34:28]<!-- --> - Regina</em><a href="#003428---regina" class="hash-link" aria-label="Direct link to 003428---regina" title="Direct link to 003428---regina">​</a></h5><p>Oh, really?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003429---ry"><em>[00:34:29]<!-- --> - Ry</em><a href="#003429---ry" class="hash-link" aria-label="Direct link to 003429---ry" title="Direct link to 003429---ry">​</a></h5><p>Thanks for writing it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003429---regina"><em>[00:34:29]<!-- --> - Regina</em><a href="#003429---regina" class="hash-link" aria-label="Direct link to 003429---regina" title="Direct link to 003429---regina">​</a></h5><p>Oh, yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003431---ry"><em>[00:34:31]<!-- --> - Ry</em><a href="#003431---ry" class="hash-link" aria-label="Direct link to 003431---ry" title="Direct link to 003431---ry">​</a></h5><p>Thank you both for joining. Appreciate you, all the work you've done for Postgres and PostGIS, and appreciate having you on the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003442---paul"><em>[00:34:42]<!-- --> - Paul</em><a href="#003442---paul" class="hash-link" aria-label="Direct link to 003442---paul" title="Direct link to 003442---paul">​</a></h5><p>Thanks for having us, Ron.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003444---regina"><em>[00:34:44]<!-- --> - Regina</em><a href="#003444---regina" class="hash-link" aria-label="Direct link to 003444---regina" title="Direct link to 003444---regina">​</a></h5><p>Thanks, Ryan.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003444---paul"><em>[00:34:44]<!-- --> - Paul</em><a href="#003444---paul" class="hash-link" aria-label="Direct link to 003444---paul" title="Direct link to 003444---paul">​</a></h5><p>Thanks. Bye.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Tembo Operator: A Rust-based Kubernetes Operator for Postgres]]></title>
            <link>https://tembo.io/blog/tembo-operator</link>
            <guid>https://tembo.io/blog/tembo-operator</guid>
            <pubDate>Wed, 25 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[At Tembo, we’ve been developing an open-source Kubernetes Operator for Postgres. We use this operator to power our managed Postgres platform, Tembo Cloud. We’re excited to share our progress, experience, and vision for this project. This post aims to assist anyone interested in utilizing Kubernetes operators for Postgres or writing Kubernetes operators using Rust.]]></description>
            <content:encoded><![CDATA[<p>At Tembo, we’ve been developing an open-source Kubernetes Operator for Postgres. We use this operator to power our managed Postgres platform, <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>. We’re excited to share our progress, experience, and vision for this project. This post aims to assist anyone interested in utilizing Kubernetes operators for Postgres or writing Kubernetes operators using Rust.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-kubernetes-operator">What is a Kubernetes Operator?<a href="#what-is-a-kubernetes-operator" class="hash-link" aria-label="Direct link to What is a Kubernetes Operator?" title="Direct link to What is a Kubernetes Operator?">​</a></h2><p>Kubernetes was designed with automation in mind, and operators allow for users to extend native Kubernetes behavior and principles to manage custom resources and components.</p><p>With a Kubernetes operator, users can write code that defines how their application should be deployed and managed on Kubernetes. This code is then packaged into a container image and deployed to Kubernetes. The operator then watches for changes to the custom resource and takes action to reconcile the state of the application’s components with the desired state of the custom resource.</p><p>In short, using a Kubernetes operator is the most effective way to run applications on Kubernetes in 2023.</p><p>You can read more about Kubernetes operators on this <a href="https://www.cncf.io/blog/2022/06/15/kubernetes-operators-what-are-they-some-examples/" target="_blank" rel="noopener noreferrer">CNCF blog post</a>, where the image below is.</p><p><img loading="lazy" alt="./k8s-operator.webp" src="/assets/images/k8s-operator-e0798d9d346084f00e21f39668252d9d.webp" width="1920" height="1080" class="img_ev3q"></p><p align="center">*Image credit: CNCF blog*</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-operators-and-the-rise-of-rust">Kubernetes Operators and the Rise of Rust<a href="#kubernetes-operators-and-the-rise-of-rust" class="hash-link" aria-label="Direct link to Kubernetes Operators and the Rise of Rust" title="Direct link to Kubernetes Operators and the Rise of Rust">​</a></h2><p>Because Kubernetes itself is written in Go, the majority of Kubernetes operators available today are also written in Go. The <a href="https://book.kubebuilder.io/" target="_blank" rel="noopener noreferrer">kubebuilder</a> project simplifies the process of building Kubernetes operators in Go and is widely considered the de facto standard for doing so.</p><p>With the increasing popularity of Rust, it was only a matter of time before someone developed a framework for building Kubernetes operators in Rust. The <a href="https://github.com/kube-rs/kube" target="_blank" rel="noopener noreferrer">kube-rs</a> project allows developers to build Rust-based Kubernetes operators in a similar manner to the <code>kubebuilder</code> project. This project excited us for a few reasons:</p><ol><li>We were interested in learning Rust.</li><li>We wanted to explore whether Rust could be a viable alternative to Go for writing Kubernetes operators.</li><li>We were inspired by the success of companies like <a href="https://github.com/stackabletech" target="_blank" rel="noopener noreferrer">Stackable</a>, who have developed numerous Kubernetes operators in Rust.</li></ol><p>This excitement led us to the decision to write our Kubernetes operator in Rust.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-the-tembo-operator">Building the Tembo Operator<a href="#building-the-tembo-operator" class="hash-link" aria-label="Direct link to Building the Tembo Operator" title="Direct link to Building the Tembo Operator">​</a></h2><p>Tembo Cloud distinguishes itself from other managed Postgres offerings in several ways, one of which is the ability to install and enable Postgres extensions on the fly. This experience is in part powered by <a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer">Trunk</a>, a Postgres extension registry and companion CLI that provide a simplified extension management experience.</p><p>It also introduces the concept of <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">Stacks</a>, which are pre-built use-case-specific Postgres deployments which are optimized and tuned to serve a specific workload.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="roll-your-own">Roll Your Own<a href="#roll-your-own" class="hash-link" aria-label="Direct link to Roll Your Own" title="Direct link to Roll Your Own">​</a></h3><p>In order to build these unique capabilities, we knew we’d need to harness the power and flexibility of a Kubernetes operator in our own way. Although there are several Kubernetes operators for Postgres available, none of them offer the same unique Postgres extension management experience or the concept of Stacks.</p><p>Initially, we attempted to build our own operator from scratch. We had successfully built the extension management piece, but soon realized that we were duplicating existing efforts. We had a comprehensive list of baseline features to develop, which included:</p><ul><li>Backup</li><li>Recovery</li><li>Connection Pooling</li><li>Failover</li><li>Upgrades</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cnpg-to-the-rescue">CNPG to the Rescue<a href="#cnpg-to-the-rescue" class="hash-link" aria-label="Direct link to CNPG to the Rescue" title="Direct link to CNPG to the Rescue">​</a></h3><p>Enter <a href="https://cloudnative-pg.io/" target="_blank" rel="noopener noreferrer">CloudNativePG</a> (CNPG). CNPG is a Kubernetes operator for Postgres created by the folks at EDB. We found it to be the most compelling of the many Kubernetes operators for Postgres out there. It provided many of the features we needed, including backup, recovery, connection pooling, failover, and upgrades. However, we still needed the ability to install and enable any Postgres extensions on the fly and define Stacks.</p><p>This is where the Tembo Operator comes in. We built the Tembo Operator in a way that utilizes CNPG, which enables us to offer a distinctive management experience for Postgres extensions and Stacks while utilizing a reliable and stable Postgres solution.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-tembo-operator">Using the Tembo Operator<a href="#using-the-tembo-operator" class="hash-link" aria-label="Direct link to Using the Tembo Operator" title="Direct link to Using the Tembo Operator">​</a></h2><p>Let’s take a look at what a custom resource spec looks like for the Tembo Operator. Here’s an example for our Machine Learning Stack. We can see this sample spec makes use of our Machine Learning Stack and includes a handful of extensions. Keep in mind, these extensions are installed at runtime with Trunk and are not built into the container image.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">machine</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">learning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"quay.io/tembo/ml-cnpg:15.3.0-1-a3e532d"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">stop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">stack</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MachineLearning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">postgres_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_stat_statements.track</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cron.host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /controller/run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> track_io_timing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'on'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_stat_statements</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pgml</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_cron</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">trunk_installs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgvector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2.7.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.14.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project pgvector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project postgresml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2.7.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project pg_embedding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.14.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> simple vector search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> async query execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">runtime_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shared_buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1024MB"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> max_connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"431"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> work_mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"5MB"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bgwriter_delay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"200ms"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> effective_cache_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2867MB"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> maintenance_work_mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"204MB"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> max_wal_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10GB"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To create our Postgres instance, we run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl apply -f yaml/sample-machine-learning.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredb.coredb.io/sample-machine-learning created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl get po</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                               READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample-machine-learning-1                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample-machine-learning-metrics-5fbcf9b676-hkxtk   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once we’ve connected to the Postgres instance, we can run <code>\dx</code> to confirm the extensions were installed and enabled as expected:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">PGPASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get secrets/sample-machine-learning-connection --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable punctuation" style="color:#393A34">{</span><span class="token variable punctuation" style="color:#393A34">{</span><span class="token variable" style="color:#36acaa">.data.password</span><span class="token variable punctuation" style="color:#393A34">}</span><span class="token variable punctuation" style="color:#393A34">}</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> base64 -d</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">❯ psql postgres://postgres:</span><span class="token variable" style="color:#36acaa">$PGPASSWORD</span><span class="token plain">@sample-machine-learning.localhost:5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ubuntu </span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain">-1.pgdg22.04+1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, server </span><span class="token number" style="color:#36acaa">15.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSL connection </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token string" style="color:#e3116c">"help"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">postgres</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># \dx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Version </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   Schema   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                              Description                               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------+---------+------------+------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_cron            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Job scheduler </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> PostgreSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_later           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.8   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pglater    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_later:  Run queries now and get results later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_stat_statements </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.10</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> track planning and execution statistics of all SQL statements executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.14</span><span class="token plain">.2  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vector             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vector data </span><span class="token builtin class-name">type</span><span class="token plain"> and ivfflat access method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vectorize          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.2   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vectorize  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> The simplest way to </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> vector search on Postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let’s install a new extension by adding the following to our sample spec:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">trunk_installs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_bm25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_bm25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.4.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After applying the updated spec and connecting to Postgres, we can see the new extension <a href="https://pgt.dev/extensions/pg_bm25" target="_blank" rel="noopener noreferrer">pg_bm25</a> is installed and enabled as expected:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ psql postgres://postgres:</span><span class="token variable" style="color:#36acaa">$PGPASSWORD</span><span class="token plain">@sample-machine-learning.localhost:5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ubuntu </span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain">-1.pgdg22.04+1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, server </span><span class="token number" style="color:#36acaa">15.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSL connection </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token string" style="color:#e3116c">"help"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">postgres</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># \dx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Version </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   Schema   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                              Description                               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------+---------+------------+------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_bm25            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paradedb   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_bm25: PostgreSQL-native, full text search using BM25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_cron            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Job scheduler </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> PostgreSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_later           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.8   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pglater    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_later:  Run queries now and get results later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_stat_statements </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.10</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> track planning and execution statistics of all SQL statements executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.14</span><span class="token plain">.2  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vector             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vector data </span><span class="token builtin class-name">type</span><span class="token plain"> and ivfflat access method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vectorize          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.2   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vectorize  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> The simplest way to </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> vector search on Postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="up-next">Up Next<a href="#up-next" class="hash-link" aria-label="Direct link to Up Next" title="Direct link to Up Next">​</a></h2><p>We’re currently working on exciting new features that enable the deployment of custom applications alongside Postgres. These features include a REST API, GraphQL, and more. Stay tuned for future updates!</p><p>For more information on running the Tembo Operator, check out our docs at:</p><ul><li><a href="https://tembo.io/docs/tembo-stacks/local-tembo-operator" target="_blank" rel="noopener noreferrer">https://tembo.io/docs/tembo-stacks/local-tembo-operator</a></li></ul><p>If you're interested in contributing to the project, check out our Github repo at:</p><ul><li><a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator</a></li></ul><p>And if you want to try out the full power of Postgres and fully delegate extension management to us, <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">try out Tembo Cloud</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Ian Stanton)</author>
            <category>postgres</category>
            <category>kubernetes</category>
            <category>rust</category>
        </item>
        <item>
            <title><![CDATA[Anonymized dump of your Postgres data]]></title>
            <link>https://tembo.io/blog/anon-dump</link>
            <guid>https://tembo.io/blog/anon-dump</guid>
            <pubDate>Tue, 24 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Someone on X wanted to know how to get an anonymous dump of Postgres data, but doesn't want to install an extension in their production DB. I want to show how you can start a local database, dump the production data there, then do an anonymized dump from that without too much hassle.]]></description>
            <content:encoded><![CDATA[<p>Someone on X wanted to know how to get an anonymous dump of Postgres data, but doesn't want to install an extension in their production DB. I want to show how you can start a local database, dump the production data there, then do an anonymized dump from that without too much hassle.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p>Dockerfile:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Install extensions from Trunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> pgcrypto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> postgresql_anonymizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Setting samples to use for anonymization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token builtin class-name">cd</span><span class="token plain"> /var/lib/postgresql/data/tembo/extension/anon </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/lorem_ipsum.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifiers_category.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifier_fr_FR.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifier_en_US.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/address.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/city.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/company.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/country.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/email.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/first_name.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/iban.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/last_name.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/postcode.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/siret.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/lorem_ipsum.csv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Build and run it like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> --force local-tembo </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally in more detail.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dump-the-data-into-your-local-db">Dump the data into your local DB<a href="#dump-the-data-into-your-local-db" class="hash-link" aria-label="Direct link to Dump the data into your local DB" title="Direct link to Dump the data into your local DB">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_dump </span><span class="token string" style="color:#e3116c">'your-connection-string-here'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> psql </span><span class="token string" style="color:#e3116c">'postgres://postgres:postgres@localhost:5432'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="anonymize-the-local-db">Anonymize the local DB<a href="#anonymize-the-local-db" class="hash-link" aria-label="Direct link to Anonymize the local DB" title="Direct link to Anonymize the local DB">​</a></h2><p>Initialize the extension:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> session_preload_libraries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'anon'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'anon'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> anon </span><span class="token keyword" style="color:#00009f">CASCADE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> anon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For example, I have a table called "extension_owners", and I would like to anonymize the user_name column:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select extension_id,user_name from extension_owners limit 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> extension_id |      user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------+---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           26 | coredb-service-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I configured anonymization on that column like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SECURITY LABEL </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> anon </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> extension_owners</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MASKED WITH FUNCTION anon.lorem_ipsum( words := 1 )'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are a lot of other options for anonymizing data, and you can even write your own functions. More information in <a href="https://gitlab.com/dalibo/postgresql_anonymizer/-/blob/master/docs/masking_functions.md?ref_type=heads" target="_blank" rel="noopener noreferrer">these docs</a>.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>This next step replaces data in the local database.</p></div></div><p>Since we are working on a local copy of the data, we can just use this function to replace anonymized columns in-place.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT anon.anonymize_database();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see now this column has been anonymized.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select user_name from extension_owners limit 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> They</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Cell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Parent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Republican</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> With</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Between</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(10 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can do further modification from here, for example masking and replacing additional columns, formatting columns, etc.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="done">Done!<a href="#done" class="hash-link" aria-label="Direct link to Done!" title="Direct link to Done!">​</a></h2><p>Now you have an anonymized database locally. From here, you can pg_dump to a file, or do something else!</p><p>If you think this kind of thing is cool, follow me on X (<a href="https://x.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>) for more content. At Tembo, we are all about Postgres extensions. You can try out extensions on <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> for free.</p>]]></content:encoded>
            <author>noreply@tembo.io (Steven Miller)</author>
            <category>postgres</category>
            <category>extensions</category>
            <category>postgresql_anonymizer</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 5: Alexander Korotkov]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep5</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep5</guid>
            <pubDate>Mon, 23 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In this episode, Ry and Alexander talk about OrioleDB (and the challenge of fighting bloat), fuzzy and vector search, and the challenges behind database management. Watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Alexander for joining us today!]]></description>
            <content:encoded><![CDATA[<p>In this episode, Ry and Alexander talk about OrioleDB (and the challenge of fighting bloat), fuzzy and vector search, and the challenges behind database management. Watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Alexander for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/FrOvwkmAPvg?si=9OgASSFxHfkYSfb2" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>OrioleDB - <a href="https://www.orioledata.com/" target="_blank" rel="noopener noreferrer">https://www.orioledata.com/</a></li><li>fuzzystrmatch - <a href="https://www.postgresql.org/docs/current/fuzzystrmatch.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/fuzzystrmatch.html</a></li><li>pg_trgm - <a href="https://www.postgresql.org/docs/current/pgtrgm.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/pgtrgm.html</a></li><li>MVCC - <a href="https://www.postgresql.org/docs/7.1/mvcc.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/7.1/mvcc.html</a></li><li><a href="https://rbranson.medium.com/10-things-i-hate-about-postgresql-20dbab8c2791" target="_blank" rel="noopener noreferrer">“Ten Things I Hate About Postgres”</a> - article by Rick Branson</li><li>“<a href="https://www.uber.com/blog/postgres-to-mysql-migration/" target="_blank" rel="noopener noreferrer">Why Uber Engineering Switched from Postgres to MySQL</a>” - blog from Uber Engineering team</li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---alexander"><em>[00:00:12]<!-- --> - Alexander</em><a href="#000012---alexander" class="hash-link" aria-label="Direct link to 000012---alexander" title="Direct link to 000012---alexander">​</a></h5><p>Hi, I'm Ry Walker, founder of Tembo, a managed Postgres company. And today I have Alexander Korotkov from OrioleDB as my guest. Alexander, welcome to the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000024---alexander"><em>[00:00:24]<!-- --> - Alexander</em><a href="#000024---alexander" class="hash-link" aria-label="Direct link to 000024---alexander" title="Direct link to 000024---alexander">​</a></h5><p>Hello, thank you very much for inviting me. It's a pleasure to participate. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000032---ry"><em>[00:00:32]<!-- --> - Ry</em><a href="#000032---ry" class="hash-link" aria-label="Direct link to 000032---ry" title="Direct link to 000032---ry">​</a></h5><p>Awesome. Maybe I'd like to start by having you give us a quick background, like where did you grow up and what were you doing before you started working on Postgres?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000041---alexander"><em>[00:00:41]<!-- --> - Alexander</em><a href="#000041---alexander" class="hash-link" aria-label="Direct link to 000041---alexander" title="Direct link to 000041---alexander">​</a></h5><p>Even before Postgres?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000043---ry"><em>[00:00:43]<!-- --> - Ry</em><a href="#000043---ry" class="hash-link" aria-label="Direct link to 000043---ry" title="Direct link to 000043---ry">​</a></h5><p>Yeah, way back. Were you only like ten years old then?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000049---alexander"><em>[00:00:49]<!-- --> - Alexander</em><a href="#000049---alexander" class="hash-link" aria-label="Direct link to 000049---alexander" title="Direct link to 000049---alexander">​</a></h5><p>Yes, I started actually from web development. Yes. And for web development, Postgres become my favorite database management system. That time there were basically two popular open source database management system, MySQL and Postgres. And Postgres behavior looked way more consistent for me. And this is why Postgres become my favorite. And also thing which attracts my attention was generalized indexing in Postgres that Postgres have even that time had GiST and gene indexes which you could apply to different data types, different search operators. And that was very interesting for me. And I also have studied for PhD in university and I was interested in fuzzy search and features like this. And in Postgres I found fuzzystrmatch complete model. And that model contained Levenshtein function which defines editing distance between two strings, number of editing operations. And I found that it doesn't work with multibyte encoding, with multibyte encoding. So it just compares two strings, byte per byte. And my first patch was to just fix this bug. I actually didn't know if I could produce the I just downloaded sources. Thankfully that time compiling a Postgres already wasn't a problem. So I just had Linux on my desktop and just cloned it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000308---alexander"><em>[00:03:08]<!-- --> - Alexander</em><a href="#000308---alexander" class="hash-link" aria-label="Direct link to 000308---alexander" title="Direct link to 000308---alexander">​</a></h5><p>Probably that time it was CVS repository, I cloned it and it wasn't difficult to locate the place in the source code responsible for this function. And I just have to find which functions are responsible for getting lengths of multi byte string in Postgres and stuff. Work was very easy, and I have submitted my first patch to Postgres, but then Robert Haas picked my patch to work on it to review and commit. And that time I get that it's not so easy this process community, because we have quite long thread studying possible performance regressions and on, and I rewrote patch this small patch many times. But finally we find a way when this patch not only fixes the problem of multibyte encoding, but also doesn't produce noticeable overhead when it's single byte encoding or strings, just uses single byte characters. In both of these cases, the overhead was negligible. And then Robert did commit my patch.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000440---ry"><em>[00:04:40]<!-- --> - Ry</em><a href="#000440---ry" class="hash-link" aria-label="Direct link to 000440---ry" title="Direct link to 000440---ry">​</a></h5><p>That's amazing. Yeah, it's interesting. How many lines of code was the patch, I wonder?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000446---alexander"><em>[00:04:46]<!-- --> - Alexander</em><a href="#000446---alexander" class="hash-link" aria-label="Direct link to 000446---alexander" title="Direct link to 000446---alexander">​</a></h5><p>I don't remember exactly. You could find it on the list, but this patch should be in dozens of lights, probably 20 or something like this, really small. But also with these fix, I started to work on improving this function, improving the performance because if you use the Levenshtein function you are typically looking for strings which are close to your string. Right. And the thing is you basically don't care about large distances. For instance, you are looking for strings with editing distance three or less. And that means that if it would be four you don't care how much bigger is that distance. And if you need only this, then you could easily, not easily, but you could significantly accelerate function Levenshtein calculation in many times and this functionality took even more work for me and Robert. But you could use it, it's Levenshtein less equal. Nice function.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000609---ry"><em>[00:06:09]<!-- --> - Ry</em><a href="#000609---ry" class="hash-link" aria-label="Direct link to 000609---ry" title="Direct link to 000609---ry">​</a></h5><p>That's great. Yeah. I also came to Postgres from being a web developer prior and I've realized in recent weeks actually, that the reason why I went to Postgres and not MySQL is primarily I was using Ruby on Rails, which just kind of was Postgres first and then I really didn't like PHP. Hopefully you weren't a PHP developer, but the lamp stack had MySQL and PHP together and I always just like I don't want to go anywhere near anything near PHP. That's really not a great reason, but it's just a fact.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000648---alexander"><em>[00:06:48]<!-- --> - Alexander</em><a href="#000648---alexander" class="hash-link" aria-label="Direct link to 000648---alexander" title="Direct link to 000648---alexander">​</a></h5><p>Yes, probably one of the great feature I have discovered in podcast in early days was DDL transactions. So that if you need to do a database schema migration, you can wrap all the changes into transaction and if something go wrong you can roll. Yes, that's just amazing. And it's interesting that even old and mature database management systems like Oracle or MSS SQL Server lacks of this functionality. I'm not sure about the present day, but at time indefinitely they all were lacking and this was very useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000736---ry"><em>[00:07:36]<!-- --> - Ry</em><a href="#000736---ry" class="hash-link" aria-label="Direct link to 000736---ry" title="Direct link to 000736---ry">​</a></h5><p>Yeah, that's great. So you built obviously you started with that first patch and worked on other fuzzy search stuff. Have you worked on any Postgres extensions?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000752---alexander"><em>[00:07:52]<!-- --> - Alexander</em><a href="#000752---alexander" class="hash-link" aria-label="Direct link to 000752---alexander" title="Direct link to 000752---alexander">​</a></h5><p>Yes, I continued to work on Postgres. Then I have found that I get known with Oleg and Theodore who was in Russian contributors of Postgres and I get familiar with their work. Some of their work I already know Gist and Jin. But for others work, it was interesting for me that we could accelerate also search for like patterns. Not just perfect patterns, but imagine you looking something that could be in the middle of the string. And there were that time Pgtrgm module. But at that time it only supports trigram similarity. Search using indexes. But I found that it's pretty easy if you decompose string with trigrams it's pretty easy to implement like search. So you could just extract trigrams from the like patterns and search for them. And thanks that trigrams are extracted all over the string so you can find this substring anywhere. And that time I would say my feeling was just great. So it's just amazing. So with quite small patch you could teach database server with some amazing advanced functionality and I get even more encouragement when I would be sorry if I confusing with names hugh Bert I don't know the guy from blogger from Poland who was posting to the planet PostgresQL waiting for and he also posted waiting for this feature like Word for Pgtrm.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001015---alexander"><em>[00:10:15]<!-- --> - Alexander</em><a href="#001015---alexander" class="hash-link" aria-label="Direct link to 001015---alexander" title="Direct link to 001015---alexander">​</a></h5><p>This was one of my first patches. Another thing that during my PhD research I also researched split algorithms for R3 and I have found more advanced algorithm and I have pushed this algorithm to Postgres core and to PostGIS that took time. Yes, because communities are quite conservatives, but it was also good.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001100---ry"><em>[00:11:00]<!-- --> - Ry</em><a href="#001100---ry" class="hash-link" aria-label="Direct link to 001100---ry" title="Direct link to 001100---ry">​</a></h5><p>Yeah, great. Well, I want to talk about OrioleDB, but before we do that, I was thinking are you paying attention to the whole vector search since you spent so much time on Postgres search features or I don't know, at least sometime. I'm curious, are you kind of tracking what's going on with vector search?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001120---alexander"><em>[00:11:20]<!-- --> - Alexander</em><a href="#001120---alexander" class="hash-link" aria-label="Direct link to 001120---alexander" title="Direct link to 001120---alexander">​</a></h5><p>Yes. That's interesting. That's an interesting subject. Yes. While I have researched the split algorithms, I have also experimented with cube concrete model which supported basically multidimensional rectangles of different number of dimensions up to one dimensions. And what I have found is that if you have low dimensionality two, three, four or five, then when you are producing split, your split will be good for one dimension, but almost don't differentiate other dimension. So you can imagine this if you have two dimensional space filled with points and you need to split them into two rectangles, there is just two good way to do this split vertically or horizontally. All other ways your rectangles would have a huge overlap. But thing changes when your dimensionality increases. There is a so called Woodman quadratic split algorithm and this algorithm actually do clustering. So it just tries to find to divide the set of points into two clusters. And it doesn't work well for low dimensionality, but for high dimensionality of space it becomes better than if you just pick one axis and split in this dimension. And that was interesting for me and I got familiar with cures of dimensions so that if you have low dimensionality space, you can have some guaranteed and quite good search performance.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001336---alexander"><em>[00:13:36]<!-- --> - Alexander</em><a href="#001336---alexander" class="hash-link" aria-label="Direct link to 001336---alexander" title="Direct link to 001336---alexander">​</a></h5><p>Right? So imagine the best example is unidimensional space. You can index this just b three and you have some guaranteed or logarithm n time for search for point request. Right? But when you have high dimensionality, that becomes a problem and uniform random data, which could be good, which you could handle very well with low dimensionality, in high dimensionality it becomes almost unindexable. So if you have 1000 of dimension vectors and you need to search for a similarity, then search in uniform data would be almost impossible to accelerate because you can't identify which particular dimension could give you a match. You could just eat just cumulative results of cumulative results of all dimensions and it's almost impossible to accelerate. I have participated a bit in improvement of PG vector and with some developers of Supabase, we really found that indexing methods, if they applied to uniform data, then they give nothing. So indexing methods, when you have a lot of dimensions, they based on some clustering. The idea is to find, how to say, find the low in the distribution, ununiformity of distribution, and then exploit it. And this is how indexing works. There are different interesting methods for indexing multidimensional space, but I think the favorite is Hnsv method.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001605---alexander"><em>[00:16:05]<!-- --> - Alexander</em><a href="#001605---alexander" class="hash-link" aria-label="Direct link to 001605---alexander" title="Direct link to 001605---alexander">​</a></h5><p>And I have read about this method in the scientific paper way before this AI Hype ten years ago. And that was interesting how far these methods from all others. So it's very self.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001626---ry"><em>[00:16:26]<!-- --> - Ry</em><a href="#001626---ry" class="hash-link" aria-label="Direct link to 001626---ry" title="Direct link to 001626---ry">​</a></h5><p>It seems like just vector search is just on the exact edge of search. And the LLM AI, like you said, it's kind of blending both sides. Well, that's cool. So I wanted to obviously chat about OrioleDB, I imagine. Are you spending trying to spend 100% of your time on OrioleDB, or? It's probably hard to I mean, it sounds like there's lots of great things happening in Postgres to distract you from your own work.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001657---alexander"><em>[00:16:57]<!-- --> - Alexander</em><a href="#001657---alexander" class="hash-link" aria-label="Direct link to 001657---alexander" title="Direct link to 001657---alexander">​</a></h5><p>The thing vector search definitely distract me. And with this AI Hype, it's hard to not be yeah, yeah, I know.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001706---ry"><em>[00:17:06]<!-- --> - Ry</em><a href="#001706---ry" class="hash-link" aria-label="Direct link to 001706---ry" title="Direct link to 001706---ry">​</a></h5><p>For say, I would just love to kind of have the top three or four things you're trying to accomplish with Oriole maybe and maybe give us a progress report.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001720---alexander"><em>[00:17:20]<!-- --> - Alexander</em><a href="#001720---alexander" class="hash-link" aria-label="Direct link to 001720---alexander" title="Direct link to 001720---alexander">​</a></h5><p>Yes. But before this, I'd like to mention about how I use AI in my work.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001726---ry"><em>[00:17:26]<!-- --> - Ry</em><a href="#001726---ry" class="hash-link" aria-label="Direct link to 001726---ry" title="Direct link to 001726---ry">​</a></h5><p>Oh, yeah, sure.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001727---alexander"><em>[00:17:27]<!-- --> - Alexander</em><a href="#001727---alexander" class="hash-link" aria-label="Direct link to 001727---alexander" title="Direct link to 001727---alexander">​</a></h5><p>So I have written the blog post, no more vacuum, no more bloat. You may be aware it was on top of news and interesting that I have mostly generated this with Chat GPT. So I just wrote the short item list and asked Chat GPT to write me a blog post. Then I have corrected a little bit, then I wrote some graph, then add some graph, asked Chet GPT to add another paragraph with them, and then it was done. And I was curious that I expected that I would be revealed and blamed for this. But actually the comments I get was, oh, this blog post is so much well written.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001823---ry"><em>[00:18:23]<!-- --> - Ry</em><a href="#001823---ry" class="hash-link" aria-label="Direct link to 001823---ry" title="Direct link to 001823---ry">​</a></h5><p>I know, it's funny. I agree with you. I'll take just like, notes. Like, for example, here I've got like a list of 20 questions that I'm trying to ask you during this interview, possibly ask you. I guarantee you if I sent this list of 20 questions to ChatGPT and say, hey, make these questions better, it would crush it, give me all kinds of much better questions. But anyway, yeah, I agree. People who aren't using it are really missing out on a great assistant. All right, so back to Oriole. What are the top three or four.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001902---alexander"><em>[00:19:02]<!-- --> - Alexander</em><a href="#001902---alexander" class="hash-link" aria-label="Direct link to 001902---alexander" title="Direct link to 001902---alexander">​</a></h5><p>Things I'd like to first say about the thing which bring me to the Oriole? When I have studied Postgres, it was just like a magic how MVCC works. So you can run multiple sessions in parallel and each session will have its own snapshot of the data and that was just amazing. And I was very interested what is under the hood, but how this works from user size was perfect, but I always wondered how it implemented internally. Because when you in progress, when you're doing an update, then you just have to mark old tuple and insert the new tuple in the heap. And if hot update is not applied, then you also have to insert all the index tuples even if index set values are not updated. And I wondered if we could do this better. And I think I have this background thoughts for years. So I have studied how MVCC implemented in MySQL as and then how it's implemented in Oracle. And it was very interesting for me to get how it's implemented in Oracle because I heard that Oracle have block level undo. Yes, and then I have thought how could it be on a block level?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002054---alexander"><em>[00:20:54]<!-- --> - Alexander</em><a href="#002054---alexander" class="hash-link" aria-label="Direct link to 002054---alexander" title="Direct link to 002054---alexander">​</a></h5><p>Because if two transaction modifies the same tree page and this page got splitted and then one of transaction could be rolled back, then it's not linear list of log records which you could just apply one after another. Because if you need to roll back some change which was before the page split, you need to do some adjustments with it. And then I understood that I need to go deeper and get how it works and then I learn more things, how rider had log working and so on. And I think in 2017 I have started to work on design of my own storage which could work around the most of shortcomings, which I see in Postgres engine. For sure there is no plain wins, in some situation this engine works worse. But I would just like to design some new trade off which could be better in the typical situation. And I can highlight some things in OrioleDB. So the first thing which it is fighting is bloat and in order to eliminate bloat, it has undo log. So if you update a row, then you just have to add a new version of row into the undo chain and you only need to update indexes if their values are updated.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002303---alexander"><em>[00:23:03]<!-- --> - Alexander</em><a href="#002303---alexander" class="hash-link" aria-label="Direct link to 002303---alexander" title="Direct link to 002303---alexander">​</a></h5><p>And also indexes are versioned trees as well. In OrioleDB I have heard that it is so in Oracle and I found that this is very attractive idea. Thanks to that index only scan becomes very simple because your secondary index already contains all the information and you doesn't need to look into any secondary structures. Because I have heard that in Postgres index only scans, index only scans is amazing until you run in some problem because if you have some intensive workloads and so on, you might have significant part of visibility map zero it and your query could get into trouble. Yes, that also could happen. And this is why I found that if secondary index version that's attractive idea and OrioleDB have a mixed underlock containing both row level and block level records and block level records allows to handle some changes like eliminating of dead tuples of the page. So for instance, your page contains some tuples which are deleted but still visible for some transaction. And using block level undo lock you can issue a new version of this page and get rid of all dead rows and reclaim their space. But the transactions which need old version can traverse page level underlock and find the tops that they need and another to eliminate bloat is automatic page merging.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002512---alexander"><em>[00:25:12]<!-- --> - Alexander</em><a href="#002512---alexander" class="hash-link" aria-label="Direct link to 002512---alexander" title="Direct link to 002512---alexander">​</a></h5><p>Anyway, if even you have undo lock it could happen that your workload is so that you have a lot of sparse pages so you have a lot of data inserted but then the data was deleted and AudioDB supports automatic merge of sparse page to eliminate bloat. Okay, and you had some questions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002534---ry"><em>[00:25:34]<!-- --> - Ry</em><a href="#002534---ry" class="hash-link" aria-label="Direct link to 002534---ry" title="Direct link to 002534---ry">​</a></h5><p>Yeah, I was just remembering that it was a blog post or a presentation where you like here are the ten worst things about Postgres. I don't know the exact phrasing you chose but yeah, basically here are ten problems with Postgres.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002552---alexander"><em>[00:25:52]<!-- --> - Alexander</em><a href="#002552---alexander" class="hash-link" aria-label="Direct link to 002552---alexander" title="Direct link to 002552---alexander">​</a></h5><p>That was a blog post of Rick Branson, I hope I spelled the name correctly and yes, I found that was a quite popular blog post. The first popular blog post is definitely Uber blog post about why they moved from Postgres to MySQL. But this blog post from Rick was very interesting for me because the issues he highlighted was very good fit to my vision and to things which I'm going to improve with OrioleDB.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002636---ry"><em>[00:26:36]<!-- --> - Ry</em><a href="#002636---ry" class="hash-link" aria-label="Direct link to 002636---ry" title="Direct link to 002636---ry">​</a></h5><p>You'll probably never be done with OrioleDB because products are never finished, but how's your progress been through your target initial list of things you wanted to accomplish with Oriole are you making good progress through that or give us a progress report.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002653---alexander"><em>[00:26:53]<!-- --> - Alexander</em><a href="#002653---alexander" class="hash-link" aria-label="Direct link to 002653---alexander" title="Direct link to 002653---alexander">​</a></h5><p>Yes, I'm making a good progress but currently the main target is not to add new features or handle more things, the current target is stability to get more users. So it doesn't work to have amazing products if nobody uses. And I would say that Database World is quite conservative because obviously people don't want to lose their data. And this is why, before using some new database technology, you need to ensure that it's really stable and mature. And this is the main challenge for new database management system or new storage engine and especially when it's OLTP and OrioleDB currently mainly targets OLTP because OLTP is typically the source of your data, right? So where your business operation happened, for instance, OLAP could be not so important. So you pull your data from OLTP system and put to OLAP for analysis and if it will disappear in a OLAP system you can just repeat the procedure but that doesn't work for OLTP which is initial source of the data. So this is the main difficulty I think, but we already did very good work with the team, very good work on eliminating the bugs but we definitely need more better testers.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002846---ry"><em>[00:28:46]<!-- --> - Ry</em><a href="#002846---ry" class="hash-link" aria-label="Direct link to 002846---ry" title="Direct link to 002846---ry">​</a></h5><p>Yeah, I mean, it's a big challenge. It's similar for us as well, but you have to create enough differentiation to get people to want to try it. But you can't go so far away from like you're saying the further the distance is from what they consider stable, the riskier it is. But if you're too close to the same thing, there's not enough value to do the switch.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002912---alexander"><em>[00:29:12]<!-- --> - Alexander</em><a href="#002912---alexander" class="hash-link" aria-label="Direct link to 002912---alexander" title="Direct link to 002912---alexander">​</a></h5><p>Right.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002912---ry"><em>[00:29:12]<!-- --> - Ry</em><a href="#002912---ry" class="hash-link" aria-label="Direct link to 002912---ry" title="Direct link to 002912---ry">​</a></h5><p>So it's a tricky catch 22 that you have to do something a little bit dangerous to get the attention. If it's too close, then people will be like, if it's 10% faster, who cares? Right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002928---alexander"><em>[00:29:28]<!-- --> - Alexander</em><a href="#002928---alexander" class="hash-link" aria-label="Direct link to 002928---alexander" title="Direct link to 002928---alexander">​</a></h5><p>Yes, exactly. This is why I am highlighting the cases where OrioleDB is in times faster or even dozens of times.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002942---ry"><em>[00:29:42]<!-- --> - Ry</em><a href="#002942---ry" class="hash-link" aria-label="Direct link to 002942---ry" title="Direct link to 002942---ry">​</a></h5><p>Have you now released kind of the stable candidate? You said you'd need more testers. Is that's kind of your stage now?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002951---alexander"><em>[00:29:51]<!-- --> - Alexander</em><a href="#002951---alexander" class="hash-link" aria-label="Direct link to 002951---alexander" title="Direct link to 002951---alexander">​</a></h5><p>Yes. We are currently discussing with our team and advisors when we can make market release candidate on the release. At some point, this is just how to say at some point, this is decisions of the will. So there is no strict procedure you can go through and say, okay, your product now should be better, or your product now should be generally available. You just need to decide for yourself and make this decision weighing all the risks.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003030---ry"><em>[00:30:30]<!-- --> - Ry</em><a href="#003030---ry" class="hash-link" aria-label="Direct link to 003030---ry" title="Direct link to 003030---ry">​</a></h5><p>Yeah, it was funny. I'll tell you a quick story about that. With my previous company, Astronomer, we were 0.1, 0.2, 0.3. I think we got to like 0.17. And it was like there was nothing big happening in any release that would cause us to say, oh, this should be the 1.0. And then we are also thinking like, this is one of me thinking this, because I was like, let's just make the next one 1.0, goddamn it, but let's save the 1.0 for a big marketing push. I don't know that they ever did it. We waited so long that we never had a 1.0 of that platform. By the time we got to it was like, oh, let's rewrite it. I think it's a tricky thing to ship, but I'm a big fan of shipping early and often. And just mark your thing as an RC candidate. It doesn't matter. It will attract more attention with that RC dot. That zero dot.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003135---alexander"><em>[00:31:35]<!-- --> - Alexander</em><a href="#003135---alexander" class="hash-link" aria-label="Direct link to 003135---alexander" title="Direct link to 003135---alexander">​</a></h5><p>Yes. Actually, the number in the version is marketing you can find in the shop. The price for the good could be $20. But you go away, you come back, and now it's $30 crossed $25.01 of advices. I heard about version numbering was never number. If you have new products, never number your version 1.0.0, nobody will trust it's stable. So you should number something like 1.3 point eleven.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003221---ry"><em>[00:32:21]<!-- --> - Ry</em><a href="#003221---ry" class="hash-link" aria-label="Direct link to 003221---ry" title="Direct link to 003221---ry">​</a></h5><p>Yeah, well, I'm kind of a big fan of CalVer, where the version of your software should be like, how many releases? It's 23 dot whatever.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003235---alexander"><em>[00:32:35]<!-- --> - Alexander</em><a href="#003235---alexander" class="hash-link" aria-label="Direct link to 003235---alexander" title="Direct link to 003235---alexander">​</a></h5><ol start="2023"><li></li></ol><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003235---ry"><em>[00:32:35]<!-- --> - Ry</em><a href="#003235---ry" class="hash-link" aria-label="Direct link to 003235---ry" title="Direct link to 003235---ry">​</a></h5><p>And here's our 6th release in 2023. And that kind of gets rid of all of the traditional semver stuff. But again, that's kind of hard to do as well. Well, I had a bunch of extra little questions I want to ask you just to get to know you a little better. But if you had a magic wand that you could add any feature to Postgres and tomorrow morning we wake up and it's there, what would it be? What's the most important thing? Or would you be most excited to see?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003306---alexander"><em>[00:33:06]<!-- --> - Alexander</em><a href="#003306---alexander" class="hash-link" aria-label="Direct link to 003306---alexander" title="Direct link to 003306---alexander">​</a></h5><p>My question...it could sound probably selfish, but I have a patch set to improve Postgres table access method API. This patch set definitely needs some work and if I magic went I would like this work to be just done and everything is perfect and in the Postgres core perfected. And that would make OrioleDB become a pure extension. But not only that, I think it could clear the path for more table access method implementations.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003348---ry"><em>[00:33:48]<!-- --> - Ry</em><a href="#003348---ry" class="hash-link" aria-label="Direct link to 003348---ry" title="Direct link to 003348---ry">​</a></h5><p>Got it. That's good, that's a great one.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003350---alexander"><em>[00:33:50]<!-- --> - Alexander</em><a href="#003350---alexander" class="hash-link" aria-label="Direct link to 003350---alexander" title="Direct link to 003350---alexander">​</a></h5><p>And one thing if you have a few minutes, the Postgres Extensibility is probably the idea which comes from Postgres early design and remains Postgres differentiation feature till now. Because all our ideas from Postgres design today it sounds weird and it's not.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003419---ry"><em>[00:34:19]<!-- --> - Ry</em><a href="#003419---ry" class="hash-link" aria-label="Direct link to 003419---ry" title="Direct link to 003419---ry">​</a></h5><p>There, but Extensibility is it's it's honestly, I always just thought MySQL and Postgres were just two different. Yeah, I didn't realize how much more Extensible Postgres at least tries to be and has been and how many extensions exist for it. Once you start looking at that list, it's pretty amazing, all the work that people have done to extend it. Is there anything, would you say about Postgres that almost nobody agrees with you about? Do you have an opinion that's controversial or just it's hard for people to agree with you about?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003503---alexander"><em>[00:35:03]<!-- --> - Alexander</em><a href="#003503---alexander" class="hash-link" aria-label="Direct link to 003503---alexander" title="Direct link to 003503---alexander">​</a></h5><p>Probably I don't know this opinion. So there are opinions where we have disagreement in community, but I can't remember the opinion which leaves me alone with that. So probably not. Yeah, there are opinions where I appear in a minority, but not more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003528---ry"><em>[00:35:28]<!-- --> - Ry</em><a href="#003528---ry" class="hash-link" aria-label="Direct link to 003528---ry" title="Direct link to 003528---ry">​</a></h5><p>Yeah, a lot of times that's just because you don't understand everything yet, right? People come in with a hot take and then the mailing list will educate them on other factors.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003540---alexander"><em>[00:35:40]<!-- --> - Alexander</em><a href="#003540---alexander" class="hash-link" aria-label="Direct link to 003540---alexander" title="Direct link to 003540---alexander">​</a></h5><p>Yes, there are disagreements because we are writing patches to Postgres and we understand these patches as improvements. But actually there is never a pure win. If you achieve something, you always lose something. That might be not obvious, but I don't know. So if you are adding too many SQL comments and your parser get complicated and parcel state machine cannot fit to processor cache and get slower and your source code also becomes bigger and harder to understand and so on. And finally we are just a group of people which needs to make some decision of will, of where to go. No way is a clear win. We are trying our best to don't discourage existing users, but even the best offers of them, even with best efforts of them. There are some disprovements for sure. At the end of the day, we need to negotiate and make a decision.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003654---ry"><em>[00:36:54]<!-- --> - Ry</em><a href="#003654---ry" class="hash-link" aria-label="Direct link to 003654---ry" title="Direct link to 003654---ry">​</a></h5><p>Where can people find you online? And in particular, what's the best way for them to get involved with testing OrioleDB?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003704---alexander"><em>[00:37:04]<!-- --> - Alexander</em><a href="#003704---alexander" class="hash-link" aria-label="Direct link to 003704---alexander" title="Direct link to 003704---alexander">​</a></h5><p>Yes, any person can reach me via email and testing Oriole, you just go to GitHub, download and compile sources or even easier, go to Docker Hub and get the docker image and just go experiment with your data and your workload and raise an issue or discussion and share your experience and.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003732---ry"><em>[00:37:32]<!-- --> - Ry</em><a href="#003732---ry" class="hash-link" aria-label="Direct link to 003732---ry" title="Direct link to 003732---ry">​</a></h5><p>Refresh us one last time. Where are the use cases where Oriole is going to outperform vanilla Postgres most dramatically I guess yes.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003743---alexander"><em>[00:37:43]<!-- --> - Alexander</em><a href="#003743---alexander" class="hash-link" aria-label="Direct link to 003743---alexander" title="Direct link to 003743---alexander">​</a></h5><p>So the situations are when you have a lot of updates, very update intensive workload, then OrioleDB could outperform things to undo log. Another case is huge multi core machines and OrioleDB eliminates a lot of bottlenecks and can perform in times faster and also OrioleDB implements role level write ahead log and if you have a huge write ahead log stream and you need geographical replication, OrioleDB can also help a lot. Awesome.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003831---ry"><em>[00:38:31]<!-- --> - Ry</em><a href="#003831---ry" class="hash-link" aria-label="Direct link to 003831---ry" title="Direct link to 003831---ry">​</a></h5><p>Okay, great. Thank you. Yeah. If there's anything else you want to share, feel free, but otherwise it was great chatting with you.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="003840---alexander"><em>[00:38:40]<!-- --> - Alexander</em><a href="#003840---alexander" class="hash-link" aria-label="Direct link to 003840---alexander" title="Direct link to 003840---alexander">​</a></h5><p>No more from me. Thank you very much for inviting. It's always very lovely and friendly talk with.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 4: Pavlo Golub]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep4</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep4</guid>
            <pubDate>Sat, 21 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In this episode, Ry and Pavlo talk about pg_timetable, about the value and place of risk in the ecosystem, and about building for the Postgres core. If you haven’t seen or listened to it yet, you can watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Pavlo for joining us today!]]></description>
            <content:encoded><![CDATA[<p>In this episode, Ry and Pavlo talk about pg_timetable, about the value and place of risk in the ecosystem, and about building for the Postgres core. If you haven’t seen or listened to it yet, you can watch below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Pavlo for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/uDfUxtZK8_Q?si=wrmh4_2l5-LpNOlY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>Cybertec - <a href="https://www.cybertec-postgresql.com/en/" target="_blank" rel="noopener noreferrer">https://www.cybertec-postgresql.com/en/</a></li><li>pg_timetable - <a href="https://github.com/cybertec-postgresql/pg_timetable" target="_blank" rel="noopener noreferrer">https://github.com/cybertec-postgresql/pg_timetable</a></li><li>pgwatch - <a href="https://github.com/cybertec-postgresql/pgwatch2" target="_blank" rel="noopener noreferrer">https://github.com/cybertec-postgresql/pgwatch2</a></li><li>pg_cron - <a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/pg_cron</a></li><li>baseql - <a href="https://www.baseql.com/" target="_blank" rel="noopener noreferrer">https://www.baseql.com/</a></li><li>pg_dump - <a href="https://www.postgresql.org/docs/current/app-pgdump.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/app-pgdump.html</a></li><li>vscode - <a href="https://github.com/microsoft/vscode" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/vscode</a></li><li>GoLand - <a href="https://www.jetbrains.com/go/" target="_blank" rel="noopener noreferrer">https://www.jetbrains.com/go/</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a> or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry"><em>[00:00:12]<!-- --> - Ry</em><a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Hello, welcome to Hacking Postgres. I'm Ry Walker, founder of Tembo, a managed Postgres company. And today I have Pavlo Golub. Did I say that right? Pavlo? Yeah, you can fix it from Cybertec as my guest. So Pavlo, welcome to the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000030---pavlo"><em>[00:00:30]<!-- --> - Pavlo</em><a href="#000030---pavlo" class="hash-link" aria-label="Direct link to 000030---pavlo" title="Direct link to 000030---pavlo">​</a></h5><p>Yes, thank you for having me. Hi there.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000032---ry"><em>[00:00:32]<!-- --> - Ry</em><a href="#000032---ry" class="hash-link" aria-label="Direct link to 000032---ry" title="Direct link to 000032---ry">​</a></h5><p>Hi there. Yeah, so maybe you could start by giving us a quick background, like where you grew up and what were you doing before you started working on Postgres.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000041---pavlo"><em>[00:00:41]<!-- --> - Pavlo</em><a href="#000041---pavlo" class="hash-link" aria-label="Direct link to 000041---pavlo" title="Direct link to 000041---pavlo">​</a></h5><p>Okay, so I was born in Soviet Union so I'm a little bit old, but yeah, I lived in Ukraine. And the first time I saw Postgres, when I was in my high school, it was like fourth year of high school and at that time it wasn't very popular. Everybody we're talking about MySQL like the only database with open source and yeah, at that time I saw the PostgresQL, I tried to install it and run it. It was hard for me to do that because at that time the version was like 7.4 something and at that time there was no installer for Windows and we were mostly like Windows guys at that times. So, yeah, I need to install Linux and then install Postgres. Yeah, I managed to do that, but I wasn't happy about it. The whole process is like I feel like cumbersome or something like that. So I left it for like a couple of years and then my first job in IT I was a support guy, so it was directly connected with the Postgres. So I started my IT career with Postgres and I'm happy that I had this chance.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000236---ry"><em>[00:02:36]<!-- --> - Ry</em><a href="#000236---ry" class="hash-link" aria-label="Direct link to 000236---ry" title="Direct link to 000236---ry">​</a></h5><p>Yeah, that's crazy. I don't personally remember when I first started using Postgres. I think it could have just been when I started using Ruby on Rails, I don't know. But it's funny, I don't remember when I first used Linux or a lot of things, but it's great that you have that distinct memory. You started in support, you've built some stuff. Now on top of it, tell me about the body of work you've done on Postgres or with Postgres. I'm curious to know what you've built.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000313---pavlo"><em>[00:03:13]<!-- --> - Pavlo</em><a href="#000313---pavlo" class="hash-link" aria-label="Direct link to 000313---pavlo" title="Direct link to 000313---pavlo">​</a></h5><p>So right now at Cybertec I'm a consultant, so my position called consultant, they called me consultant, but I prefer to think about myself as a developer. I'm not an Admin, I'm not a DBA, I'm a developer. So I'm mostly doing developing things for Postgres. I had a couple of small patches to these source, but I don't consider them as major things. So I did some client libraries for Delphi if somebody still knows what it is, and later I switched to C, Go, Python, that kind of stuff. And right now I'm mostly develop with the Go language. And at the moment we have a couple of utilities made in Cybertec, so I'm in charge of them. So one of them is like pg_timetable, which is a scheduler for PostgresQL, and another is pg_watch which is a monitoring solution for Postgres.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000430---ry"><em>[00:04:30]<!-- --> - Ry</em><a href="#000430---ry" class="hash-link" aria-label="Direct link to 000430---ry" title="Direct link to 000430---ry">​</a></h5><p>Yeah. Yeah. What caught my attention was pg_timetable because I come from a company that my previous company was Apache Airflow. So the idea of doing dags jobs that are chained off of other jobs, to me, there's no other way. Trying to schedule jobs and hope that they finish by the time of the next one, that's dependent is something that people used to do and they should never, ever do anymore. But I'm sure it still happens. Right. So certainly if people are using pg_cron, no way to chain them, as far as I can see.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000511---pavlo"><em>[00:05:11]<!-- --> - Pavlo</em><a href="#000511---pavlo" class="hash-link" aria-label="Direct link to 000511---pavlo" title="Direct link to 000511---pavlo">​</a></h5><p>We had a client and we have a process, like, lasting, like 14, 15 hours consisting of many steps which are dependent in some complicated ways. So we used a make file to split them into the jobs and to specify that this stage must be executed after that. And that and that worked fine. It's cool to have a special utility to run that kind of jobs or chains, whatever.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000556---ry"><em>[00:05:56]<!-- --> - Ry</em><a href="#000556---ry" class="hash-link" aria-label="Direct link to 000556---ry" title="Direct link to 000556---ry">​</a></h5><p>Yeah. Well, one of the things I think about a lot is how Postgres, the Postgres server is doing lots of jobs, right. I don't know how many processes it's dealing with, someone with better internal knowledges, but I know it's certainly vacuuming. It's certainly processing queries. It's doing a lot of things right. And then question is I'm a fan of SRP single responsibility principle and programming in general, but I also like monoliths too. We all have conflicting ideas in our heads. And having a queue managed inside the Postgres, you're kind of like straddling, right? Because you have a container next to it. So some of the work is happening over there, but some of it is inside of Postgres too. Why not have it all be inside? What are you thinking about for future versions of pg_timetable? Why not just do all the work inside of the running Postgres cluster?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000700---pavlo"><em>[00:07:00]<!-- --> - Pavlo</em><a href="#000700---pavlo" class="hash-link" aria-label="Direct link to 000700---pavlo" title="Direct link to 000700---pavlo">​</a></h5><p>So, yeah, thank you for the question because that was like, the second thought when we released the pg_timetable. So the idea is that PostgreSQL uses a separate process for everything. If you have a new connection, you need a new process. So if you have a background worker for cron or for another scheduler, you will need a background worker. A separate process. Yeah. It's possible. We can create an extensions with Go. It's possible, yes. But right now, I'm not sure what benefits we will have.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000758---ry"><em>[00:07:58]<!-- --> - Ry</em><a href="#000758---ry" class="hash-link" aria-label="Direct link to 000758---ry" title="Direct link to 000758---ry">​</a></h5><p>It also feels kind of gross, right, to think of throwing it all together. But I have this conversation all the time with my team. If you have a system that's dependent on the Postgres, let's say there's an API, right? And the API, if the Postgres is only invoked when the API happens you could theoretically put all that compute into one bucket and just let the API talk to I'm thinking, like, say, take it's a Rust API. Should you serve that Rust API as a separate container and have the separation of concerns? Or should you just create a custom Postgres extension and let the Rust run inside the Postgres cluster and there's zero latency to the data in that regard, but it's a little bit of a Frankenapp at that point. It's a tricky problem.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000852---pavlo"><em>[00:08:52]<!-- --> - Pavlo</em><a href="#000852---pavlo" class="hash-link" aria-label="Direct link to 000852---pavlo" title="Direct link to 000852---pavlo">​</a></h5><p>I will tell you that, that I want to implement this scheduler as an extension for Postgres, not because I think that we will have some benefits, but because this is very interesting task for me as a developer, first of all.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000908---ry"><em>[00:09:08]<!-- --> - Ry</em><a href="#000908---ry" class="hash-link" aria-label="Direct link to 000908---ry" title="Direct link to 000908---ry">​</a></h5><p>Yeah. Is pg_timetable supported by any cloud providers right now?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000916---pavlo"><em>[00:09:16]<!-- --> - Pavlo</em><a href="#000916---pavlo" class="hash-link" aria-label="Direct link to 000916---pavlo" title="Direct link to 000916---pavlo">​</a></h5><p>Yeah, we can run pg_timetable against any cloud provider. If you want, you can run it in Docker and Kubernetes as a standalone binary, or even you can try to grab the source code and put it into this AWS fancy one time run and forget I don't remember how they called it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000946---ry"><em>[00:09:46]<!-- --> - Ry</em><a href="#000946---ry" class="hash-link" aria-label="Direct link to 000946---ry" title="Direct link to 000946---ry">​</a></h5><p>Yeah, but because it has the sidecar, it probably can't be like a standard extension in RDS, for example.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000954---pavlo"><em>[00:09:54]<!-- --> - Pavlo</em><a href="#000954---pavlo" class="hash-link" aria-label="Direct link to 000954---pavlo" title="Direct link to 000954---pavlo">​</a></h5><p>Right, it might be, but I think to make this happen, we need to somehow communicate with AWS and make that happen. It's more like politics, not yeah, well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001010---ry"><em>[00:10:10]<!-- --> - Ry</em><a href="#001010---ry" class="hash-link" aria-label="Direct link to 001010---ry" title="Direct link to 001010---ry">​</a></h5><p>I think it's also just like I don't know if any of the other extensions that they offer have a sidecar requirement. Right. So that's one of the things we're thinking about at Tembo is like, let's allow sidecars if you allow sidecars to extensions in our managed service yes. It's like, again, it's a lot more dangerous in the sense that there's more things that could break, but it's also more powerful. And if we had the rule that dangerous things are bad and you wouldn't have a combustible engine inside of a car where little explosions are happening all the time to power it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001050---pavlo"><em>[00:10:50]<!-- --> - Pavlo</em><a href="#001050---pavlo" class="hash-link" aria-label="Direct link to 001050---pavlo" title="Direct link to 001050---pavlo">​</a></h5><p>On the other hand, you can build your own image, right, and somehow to limit the binary in it to do some dangerous things, et cetera.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001102---ry"><em>[00:11:02]<!-- --> - Ry</em><a href="#001102---ry" class="hash-link" aria-label="Direct link to 001102---ry" title="Direct link to 001102---ry">​</a></h5><p>Yeah. I joke sometimes and say we're building the dangerous Postgres just because it's not really we support 150 extensions now, so it's like, yeah, our support footprint is increased and scarier than if you had 75, but I still say it's worth it to the developer to have the capability. So I'd love to get pg_timetable as a standard option. I want to use it, basically. What's funny is I'm building a data warehouse right now for our company, and I started with pg_cron, and I have these four jobs that all start at the same time and it's very early, so it's not a problem. But I would love to have them be chained. Like I said, I could do that fake with some spacing things out, but I really feel like I've just stepped back 20 years into the world of early data processing. So I appreciate what you built and use it soon.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001208---pavlo"><em>[00:12:08]<!-- --> - Pavlo</em><a href="#001208---pavlo" class="hash-link" aria-label="Direct link to 001208---pavlo" title="Direct link to 001208---pavlo">​</a></h5><p>Okay. Let me know if you're happy with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001211---ry"><em>[00:12:11]<!-- --> - Ry</em><a href="#001211---ry" class="hash-link" aria-label="Direct link to 001211---ry" title="Direct link to 001211---ry">​</a></h5><p>Yeah, I think it's a good idea and it could also help developers avoid having to go pick up some other tool to take the next stage of their data processing, which to me is a big win. And we're trying to make the Meme "Postgres for everything." I know you are too, in a sense, because you built the extension. But yeah, I think there's so much it can do, and it can do a lot more than just writing and reading data.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001254---pavlo"><em>[00:12:54]<!-- --> - Pavlo</em><a href="#001254---pavlo" class="hash-link" aria-label="Direct link to 001254---pavlo" title="Direct link to 001254---pavlo">​</a></h5><p>One more thing about having the pg_timetable as an external application is that you can use your own binaries inside jobs like baseql or pg_dump or something, like to grab something, to convert something, et cetera. So we want to have a possibility for developers to create their own docker images with the binaries or tools they only need and pg_timetable. So in this way it sounds like a Swiss knife, right? So I need a pg_timetable and a couple of utilities for grabbing something to manipulate with files, et cetera. And then we pack it and that's all. We don't need to think how we should allow the application to install it or to have it on the system version, et cetera, et cetera.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001358---ry"><em>[00:13:58]<!-- --> - Ry</em><a href="#001358---ry" class="hash-link" aria-label="Direct link to 001358---ry" title="Direct link to 001358---ry">​</a></h5><p>Yeah, basically what you're saying is it gets even more dangerous quickly, right? Like the base use case is one thing, but then when people start doing some more wild things, including their own, it could be their own packages, right? Their own, of course, completely custom. Nobody knows what's inside of it. It could be a bitcoin miner, it could be anything, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001423---pavlo"><em>[00:14:23]<!-- --> - Pavlo</em><a href="#001423---pavlo" class="hash-link" aria-label="Direct link to 001423---pavlo" title="Direct link to 001423---pavlo">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001426---ry"><em>[00:14:26]<!-- --> - Ry</em><a href="#001426---ry" class="hash-link" aria-label="Direct link to 001426---ry" title="Direct link to 001426---ry">​</a></h5><p>Are you working on the next version of it or is it pretty stable right now and doesn't require a lot?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001432---pavlo"><em>[00:14:32]<!-- --> - Pavlo</em><a href="#001432---pavlo" class="hash-link" aria-label="Direct link to 001432---pavlo" title="Direct link to 001432---pavlo">​</a></h5><p>So at the moment we are stable. So we are open for ideas and then requests, et cetera. But at the moment we are fine, I believe. So it's like in maintenance mode, so we update versions, packages, et cetera. So no new box. I'm happy with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001456---ry"><em>[00:14:56]<!-- --> - Ry</em><a href="#001456---ry" class="hash-link" aria-label="Direct link to 001456---ry" title="Direct link to 001456---ry">​</a></h5><p>Did you build it? Was it sort of a small team there or did you kind of build it solo?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001502---pavlo"><em>[00:15:02]<!-- --> - Pavlo</em><a href="#001502---pavlo" class="hash-link" aria-label="Direct link to 001502---pavlo" title="Direct link to 001502---pavlo">​</a></h5><p>So the initial idea was by Hans, our CEO, and yeah, that was my first project in Go. So I was trying to learn a new language to see how can I do this? And we are now here. That's cool, I believe.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001536---ry"><em>[00:15:36]<!-- --> - Ry</em><a href="#001536---ry" class="hash-link" aria-label="Direct link to 001536---ry" title="Direct link to 001536---ry">​</a></h5><p>What were the biggest challenges would you say you faced while working, while building it? Was it hard to, for example, understand internals or was that part easy? I'm kind of curious what was toughest.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001549---pavlo"><em>[00:15:49]<!-- --> - Pavlo</em><a href="#001549---pavlo" class="hash-link" aria-label="Direct link to 001549---pavlo" title="Direct link to 001549---pavlo">​</a></h5><p>For me, I would say that the new tools that you need to use, like if you are familiar with your favorite IDE and then for Go language, you need to switch to something like Vs code or Go land or whatever. This is completely new tool for you. And you have no this muscular memory for shortcuts, et cetera, et cetera. It's kind of difficult. Like six months I was trying to get used to new tooling, but after that I'm pretty happy.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001626---ry"><em>[00:16:26]<!-- --> - Ry</em><a href="#001626---ry" class="hash-link" aria-label="Direct link to 001626---ry" title="Direct link to 001626---ry">​</a></h5><p>Yeah, that's so when was it that you started working on timetable? pg_timetable?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001635---pavlo"><em>[00:16:35]<!-- --> - Pavlo</em><a href="#001635---pavlo" class="hash-link" aria-label="Direct link to 001635---pavlo" title="Direct link to 001635---pavlo">​</a></h5><p>Maybe three years ago, something like that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001639---ry"><em>[00:16:39]<!-- --> - Ry</em><a href="#001639---ry" class="hash-link" aria-label="Direct link to 001639---ry" title="Direct link to 001639---ry">​</a></h5><p>Yeah. Okay, well, that's great. So have you guys implemented it many times now for customers or how has it been? I know it's not a commercial product, but I assume it should be helping the consulting business, right? Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001658---pavlo"><em>[00:16:58]<!-- --> - Pavlo</em><a href="#001658---pavlo" class="hash-link" aria-label="Direct link to 001658---pavlo" title="Direct link to 001658---pavlo">​</a></h5><p>So it usually goes in a package with something. Usually if we have a new client, we are talking about high availability and we are talking about monitoring, and we are talking about that and that, and then we say, okay, we have a scheduler if you want it, and usually people want it. I don't remember we have like a standalone cell for a pg_timetable. But yeah, it's usually like packaged into something bigger, usually with a high availability and monitoring.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001733---ry"><em>[00:17:33]<!-- --> - Ry</em><a href="#001733---ry" class="hash-link" aria-label="Direct link to 001733---ry" title="Direct link to 001733---ry">​</a></h5><p>Got it. It’s like a sweetener, right? Cool. Well, maybe I'll shift into some more general topics. I'd love to know what are some of the developments in Postgres ecosystem that you're excited about?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001750---pavlo"><em>[00:17:50]<!-- --> - Pavlo</em><a href="#001750---pavlo" class="hash-link" aria-label="Direct link to 001750---pavlo" title="Direct link to 001750---pavlo">​</a></h5><p>So the Postgres itself, the core, I always want to constantly want to do something for the core, but.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001803---ry"><em>[00:18:03]<!-- --> - Ry</em><a href="#001803---ry" class="hash-link" aria-label="Direct link to 001803---ry" title="Direct link to 001803---ry">​</a></h5><p>It's like you're racking your brain around there.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001807---pavlo"><em>[00:18:07]<!-- --> - Pavlo</em><a href="#001807---pavlo" class="hash-link" aria-label="Direct link to 001807---pavlo" title="Direct link to 001807---pavlo">​</a></h5><p>The process itself is not like user friendly. First of all, you need to communicate through the email lists. No GitHub, no issues, no pull requests. And you need constantly update your patches because the development is very active, and you need to defend your patch against many people in the community because why you did it, what purpose, why you do it that way, not another. So that might take some time for.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001846---ry"><em>[00:18:46]<!-- --> - Ry</em><a href="#001846---ry" class="hash-link" aria-label="Direct link to 001846---ry" title="Direct link to 001846---ry">​</a></h5><p>Who are your favorite people in the Postgres ecosystem? You hate to play favorites, but people I should interview get to know anybody come to mind?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001856---pavlo"><em>[00:18:56]<!-- --> - Pavlo</em><a href="#001856---pavlo" class="hash-link" aria-label="Direct link to 001856---pavlo" title="Direct link to 001856---pavlo">​</a></h5><p>Yeah, a lot of them, frankly speaking. Well, I think that the community is the reason, number one, why I am still doing Postgres things. I was working like, for five years without knowing nobody from the community. And then in 2011, I was first time on the PG conference in Europe, in Amsterdam, and that changed my mind. Absolutely. I saw what the community is and what are the main things and why are those working that way and not another. So if you want names, so Bruce Momjian, for sure. Magnus Hagander, Ilya Kosmodemiansky, Vik Fearing, Andreas Scherbaum, a lot of them. Like Lætitia Avrot . A lot of them.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001959---ry"><em>[00:19:59]<!-- --> - Ry</em><a href="#001959---ry" class="hash-link" aria-label="Direct link to 001959---ry" title="Direct link to 001959---ry">​</a></h5><p>Well, I'll reach out to those people. It's obviously a very big community too, certainly, considering the extent, anyone who's touching it is very excited. First, I'm going to the know, the New York City conference here in a couple of months. Yeah. So I'm excited to meet a bunch of people there. And we went to an event in San Jose last spring, which was fun. All right, so here's another one. If you had a magic wand and you could add any feature to Postgres? What would you change about it or what would you add?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002039---pavlo"><em>[00:20:39]<!-- --> - Pavlo</em><a href="#002039---pavlo" class="hash-link" aria-label="Direct link to 002039---pavlo" title="Direct link to 002039---pavlo">​</a></h5><p>I don't think that I can change something in a way that it will be a brick and change but I would like to see if we can implement Postgres using threads, not the processes. I would like to see if that might be better solution that we have now. I'm not sure.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002104---ry"><em>[00:21:04]<!-- --> - Ry</em><a href="#002104---ry" class="hash-link" aria-label="Direct link to 002104---ry" title="Direct link to 002104---ry">​</a></h5><p>It's being debated, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002107---pavlo"><em>[00:21:07]<!-- --> - Pavlo</em><a href="#002107---pavlo" class="hash-link" aria-label="Direct link to 002107---pavlo" title="Direct link to 002107---pavlo">​</a></h5><p>Yeah, absolutely.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002108---ry"><em>[00:21:08]<!-- --> - Ry</em><a href="#002108---ry" class="hash-link" aria-label="Direct link to 002108---ry" title="Direct link to 002108---ry">​</a></h5><p>Yeah, we'll see.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002109---pavlo"><em>[00:21:09]<!-- --> - Pavlo</em><a href="#002109---pavlo" class="hash-link" aria-label="Direct link to 002109---pavlo" title="Direct link to 002109---pavlo">​</a></h5><p>It's a hot topic.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002110---ry"><em>[00:21:10]<!-- --> - Ry</em><a href="#002110---ry" class="hash-link" aria-label="Direct link to 002110---ry" title="Direct link to 002110---ry">​</a></h5><p>Hot topic, yeah. I did join the mailing list for a short period of time. I'm starting a company too and it just was too much. I was like, oh my gosh, this is a fire hose and someday I want to be able to have the time to consume it. But today wasn't that day. Is there anything about Postgres that no one agrees with you about? Do you have any contrarian views about any part of it that you can think of?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002138---pavlo"><em>[00:21:38]<!-- --> - Pavlo</em><a href="#002138---pavlo" class="hash-link" aria-label="Direct link to 002138---pavlo" title="Direct link to 002138---pavlo">​</a></h5><p>Yeah, probably my views about the Windows because I was a Windows guy and I'm still a Windows guy and I'm always saying that we need to support Windows as well as we support Linux. So that means installers for Windows and extensions and tools, et cetera, et cetera. And people usually say, no, Linux is fine and that's enough is enough.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002208---ry"><em>[00:22:08]<!-- --> - Ry</em><a href="#002208---ry" class="hash-link" aria-label="Direct link to 002208---ry" title="Direct link to 002208---ry">​</a></h5><p>Yeah, it's interesting, it's fun. I'm interested in a lot of different areas of programming. I was looking at, say, Unity, you know, game development and it's C# and I'm like "Ugh" and it seems like very Windows centric and I'm like because I'm a Mac user and whatever. For me it'd be like Mac, Linux, Windows in terms of my priority but I'm like certainly not C#, right? But anyway, yeah, the religious wars will never end there, I guess, in terms of platforms.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002247---pavlo"><em>[00:22:47]<!-- --> - Pavlo</em><a href="#002247---pavlo" class="hash-link" aria-label="Direct link to 002247---pavlo" title="Direct link to 002247---pavlo">​</a></h5><p>The bad thing about our approach right now that I think that we don't have enough good GUI programs for PostgreSQL every time we are using psql to show something to demo. And I think that for newbies it would be much easier to follow a demonstration if you use some fancy GUI application.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002315---ry"><em>[00:23:15]<!-- --> - Ry</em><a href="#002315---ry" class="hash-link" aria-label="Direct link to 002315---ry" title="Direct link to 002315---ry">​</a></h5><p>Well, it was great chatting. Where can listeners find you online? Are you on social media anywhere?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002323---pavlo"><em>[00:23:23]<!-- --> - Pavlo</em><a href="#002323---pavlo" class="hash-link" aria-label="Direct link to 002323---pavlo" title="Direct link to 002323---pavlo">​</a></h5><p>Yeah, I'm like on every kind of social media. Like GitHub, LinkedIn, Twitter, Instagram, Facebook, Blue Sky, Mastodon.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002336---ry"><em>[00:23:36]<!-- --> - Ry</em><a href="#002336---ry" class="hash-link" aria-label="Direct link to 002336---ry" title="Direct link to 002336---ry">​</a></h5><p>Great. All right, well, like I said, someday soon I'm going to try pg_timetable and I'll give you some feedback and maybe some ideas in the GitHub and we'll see you there, I suppose.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002347---pavlo"><em>[00:23:47]<!-- --> - Pavlo</em><a href="#002347---pavlo" class="hash-link" aria-label="Direct link to 002347---pavlo" title="Direct link to 002347---pavlo">​</a></h5><p>Sure. Thank you.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002348---ry"><em>[00:23:48]<!-- --> - Ry</em><a href="#002348---ry" class="hash-link" aria-label="Direct link to 002348---ry" title="Direct link to 002348---ry">​</a></h5><p>Great, great chatting with you. Thanks for joining.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002351---pavlo"><em>[00:23:51]<!-- --> - Pavlo</em><a href="#002351---pavlo" class="hash-link" aria-label="Direct link to 002351---pavlo" title="Direct link to 002351---pavlo">​</a></h5><p>Thank you. Thank you.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 3: Eric Ridge]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep3</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep3</guid>
            <pubDate>Fri, 20 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In this episode, Ry and Eric talk about ZomboDB, the complicated road that led to the development of pgrx, and what it means for the future of extensions within Postgres. You can watch it below or listen to it on Apple/Spotify (or your podcast platform of choice). Special thanks to Eric for joining us today!]]></description>
            <content:encoded><![CDATA[<p>In this episode, Ry and Eric talk about ZomboDB, the complicated road that led to the development of pgrx, and what it means for the future of extensions within Postgres. You can watch it below or listen to it on Apple/Spotify (or your podcast platform of choice). Special thanks to Eric for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/tD9e6KXnB20?si=sjZJEGyxhqE7x9U-" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>ZomboDB - <a href="https://github.com/zombodb/zombodb" target="_blank" rel="noopener noreferrer">https://github.com/zombodb/zombodb</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>plrust - <a href="https://github.com/tcdi/plrust" target="_blank" rel="noopener noreferrer">https://github.com/tcdi/plrust</a></li><li>Elasticsearch - <a href="https://www.elastic.co/elasticsearch/" target="_blank" rel="noopener noreferrer">https://www.elastic.co/elasticsearch/</a></li><li>Supabase wrappers - <a href="https://github.com/supabase/wrappers" target="_blank" rel="noopener noreferrer">https://github.com/supabase/wrappers</a></li><li>TCDI - <a href="https://www.tcdi.com/" target="_blank" rel="noopener noreferrer">https://www.tcdi.com/</a></li><li>PostGIS - <a href="https://postgis.net/" target="_blank" rel="noopener noreferrer">https://postgis.net/</a></li><li>postgres_fdw -<a href="https://www.postgresql.org/docs/current/postgres-fdw.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/postgres-fdw.html</a></li><li>Citus - <a href="https://www.citusdata.com/" target="_blank" rel="noopener noreferrer">https://www.citusdata.com/</a></li><li>Valgrind - <a href="https://valgrind.org/" target="_blank" rel="noopener noreferrer">https://valgrind.org/</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a> or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry"><em>[00:00:12]<!-- --> - Ry</em><a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Hey, Eric. What's going on, man?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000014---eric"><em>[00:00:14]<!-- --> - Eric</em><a href="#000014---eric" class="hash-link" aria-label="Direct link to 000014---eric" title="Direct link to 000014---eric">​</a></h5><p>Hi, Ry. How are you?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000015---ry"><em>[00:00:15]<!-- --> - Ry</em><a href="#000015---ry" class="hash-link" aria-label="Direct link to 000015---ry" title="Direct link to 000015---ry">​</a></h5><p>Long time no talk.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000016---eric"><em>[00:00:16]<!-- --> - Eric</em><a href="#000016---eric" class="hash-link" aria-label="Direct link to 000016---eric" title="Direct link to 000016---eric">​</a></h5><p>Yeah, it has been a while.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000018---ry"><em>[00:00:18]<!-- --> - Ry</em><a href="#000018---ry" class="hash-link" aria-label="Direct link to 000018---ry" title="Direct link to 000018---ry">​</a></h5><p>How are things going?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000019---eric"><em>[00:00:19]<!-- --> - Eric</em><a href="#000019---eric" class="hash-link" aria-label="Direct link to 000019---eric" title="Direct link to 000019---eric">​</a></h5><p>Well, I think.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000021---ry"><em>[00:00:21]<!-- --> - Ry</em><a href="#000021---ry" class="hash-link" aria-label="Direct link to 000021---ry" title="Direct link to 000021---ry">​</a></h5><p>Well, maybe let's give our listeners a quick intro on what you've done. I mean, Eric Ridge is pretty much a household name in mean, in case there's someone listening who doesn't know what you've been working on. You want to give us a quick background on your involvement in postgres over the years?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000036---eric"><em>[00:00:36]<!-- --> - Eric</em><a href="#000036---eric" class="hash-link" aria-label="Direct link to 000036---eric" title="Direct link to 000036---eric">​</a></h5><p>I think a household name is absolutely not true. First of all, I'm Eric. I am the reason that this postgres extension name ZomboDB exists. And over the years of developing that, something that's now called Pgrx kind of fell out of all that work that lets us develop extensions for postgres using the Rust programming language. And these things have been where my interest has been as it relates to postgres. I guess past seven, eight years now. Things ZomboDB has been out since 2015, so we're right at eight years.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000114---ry"><em>[00:01:14]<!-- --> - Ry</em><a href="#000114---ry" class="hash-link" aria-label="Direct link to 000114---ry" title="Direct link to 000114---ry">​</a></h5><p>Do you know how many it's at? An uncountable number of Rust extensions now, probably you probably at one point knew how many there were, but now you've lost track.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000124---eric"><em>[00:01:24]<!-- --> - Eric</em><a href="#000124---eric" class="hash-link" aria-label="Direct link to 000124---eric" title="Direct link to 000124---eric">​</a></h5><p>Yeah, that's a good question. It's hard to know. There's no real clearinghouse around extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000130---ry"><em>[00:01:30]<!-- --> - Ry</em><a href="#000130---ry" class="hash-link" aria-label="Direct link to 000130---ry" title="Direct link to 000130---ry">​</a></h5><p>If only there was, that would be a great thing for someone to build.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000133---eric"><em>[00:01:33]<!-- --> - Eric</em><a href="#000133---eric" class="hash-link" aria-label="Direct link to 000133---eric" title="Direct link to 000133---eric">​</a></h5><p>Yeah, it would. I wish somebody would get on that. Right. Yeah, that's a good question. There's some bigger names using Pgrx, and the Timescale is one. Supabase is one. We recently released plrust, and that's found its way out on RDS. So that's exciting for us. What we see popping up are small extensions that are written in Pgrx, and we see a lot of people writing I don't want to call them one off extensions, but one off extensions that are just, like, specific to their business use case and solve some interesting data domain problem that only they would have. But now they have the ability to build that business logic or data manipulation or what have you into their database and into the database itself.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000227---ry"><em>[00:02:27]<!-- --> - Ry</em><a href="#000227---ry" class="hash-link" aria-label="Direct link to 000227---ry" title="Direct link to 000227---ry">​</a></h5><p>Without having to go find a C programmer that's willing to do such work. Right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000231---eric"><em>[00:02:31]<!-- --> - Eric</em><a href="#000231---eric" class="hash-link" aria-label="Direct link to 000231---eric" title="Direct link to 000231---eric">​</a></h5><p>Yeah. And that was one of the motivators for developing Pgrx, was I guess I had been working on postgres extensions in some form or fashion since postgres 8.0, and I think that was even before the extension packaging and create extension command and all that came into existence not long before. But I think that that was before and yeah, I mean, just over the years, I got tired of working in C. When you're developing a postgres extension in C, you're not only putting on your C programmer hat, but you're trying to put on the hat of a postgres hacker. Right. You need to understand postgres sources just as much as you do the language itself. So Rust was becoming a popular a number of years ago. So I was like, you know what, I'm going to try to do this.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000322---ry"><em>[00:03:22]<!-- --> - Ry</em><a href="#000322---ry" class="hash-link" aria-label="Direct link to 000322---ry" title="Direct link to 000322---ry">​</a></h5><p>Well, it's interesting. It's like how a lot of games, if they have mods, the language for the mods has to be easier than the language for the core game. Right. So a game might be written in something like Unity, but then they give you, like, Lua as a tool or JavaScript or something simple to build. But in Postgres, that wasn't true. Now, is Rust as simple as Lua or JavaScript? Maybe not, but it's still like very beloved people who try to learn it. In my experience so far, it's 100% like anyone who tries to learn Rust learns it and loves it. I haven't found someone yet and I have a small sample size, but, yeah, seems like it's a pretty good hit rate in terms of the perfect mix of control and speed with the ease of onboarding.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000410---eric"><em>[00:04:10]<!-- --> - Eric</em><a href="#000410---eric" class="hash-link" aria-label="Direct link to 000410---eric" title="Direct link to 000410---eric">​</a></h5><p>If you're not a C programmer, then writing the postgres extension in C is going to be difficult again, because C and then also because you're really programming Postgres's version of C, which is great, but it's not JavaScript, it's not Ruby, it's not Java. If you're not a Rust programmer, first you've got to learn Rust, and Rust is different enough from all the other languages to make that a point. But what we're trying to do with Pgrx, and it's going to be a multi year effort to do this, it may never get done, but we're trying to present the postgres internals in the most idiomatic way possible to Rust. Right. So that if you are a Rust programmer or you are beginning to learn Rust, it'll be pretty obvious what you need to do in order to make your postgres extension useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000510---ry"><em>[00:05:10]<!-- --> - Ry</em><a href="#000510---ry" class="hash-link" aria-label="Direct link to 000510---ry" title="Direct link to 000510---ry">​</a></h5><p>So you said you were working on extensions as early as Postgres Eight. Were you a Postgres user or our developer even earlier than that, or was that sort of when you got involved?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000521---eric"><em>[00:05:21]<!-- --> - Eric</em><a href="#000521---eric" class="hash-link" aria-label="Direct link to 000521---eric" title="Direct link to 000521---eric">​</a></h5><p>Yeah, Postgres user, I think we started using Postgres at work in the year 2000 and that might have been I mean, is that 7.1, 7.2? It's quite a long time ago and we've been using it every day since. And, yeah, somewhere along the way we needed to do some work inside the database. So here we are today.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000546---ry"><em>[00:05:46]<!-- --> - Ry</em><a href="#000546---ry" class="hash-link" aria-label="Direct link to 000546---ry" title="Direct link to 000546---ry">​</a></h5><p>Yeah. For me, when I think about when did I start using Postgres, it's like thinking about when did I first start using a laptop, it's like I don't remember exactly when, but definitely transitioned to having a laptop at some point. But, yeah, it didn't seem monumental to start using Postgres back then, but obviously it's come a long way and it's a pretty exciting ecosystem right now. So, yeah. What do you think the most powerful thing about extensions are? Do you have any thoughts on what are the most powerful things you can do with extensions, out of curiosity?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000619---eric"><em>[00:06:19]<!-- --> - Eric</em><a href="#000619---eric" class="hash-link" aria-label="Direct link to 000619---eric" title="Direct link to 000619---eric">​</a></h5><p>It's an interesting question.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000621---ry"><em>[00:06:21]<!-- --> - Ry</em><a href="#000621---ry" class="hash-link" aria-label="Direct link to 000621---ry" title="Direct link to 000621---ry">​</a></h5><p>What's the coolest part of, I guess what API? Or maybe another good question is what hasn't been exposed yet that should be or needs to be in Pgrx? That would be powerful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000632---eric"><em>[00:06:32]<!-- --> - Eric</em><a href="#000632---eric" class="hash-link" aria-label="Direct link to 000632---eric" title="Direct link to 000632---eric">​</a></h5><p>Yeah, I'll start there and then work backwards. There's a lot of internal APIs within Postgres, and there's a number of interesting ones. There's the index access method API, which is really easy to implement. We haven't added safe wrappers around that to Pgrx, but it's real easy to implement. It's really just a handful of functions. There's the Foreign Data Wrapper API, which Supabase released a project that they call Wrappers that'll let you create foreign data wrappers using Rust backed up by Pgrx. So kind of the next big API around that genre of internals. There would be the Table Access Method APIs, and we haven't exposed these at all yet. They're actually difficult to get at even through our bindings just because of the way they're set up in the postgres sources. So when we get around to doing that, and I hope that we will, there's going to be some development effort on our part to safely expose these or safely expose the Table Access Method APIs. But that's the API that would let you write your own heap storage engineer system in Rust.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000749---ry"><em>[00:07:49]<!-- --> - Ry</em><a href="#000749---ry" class="hash-link" aria-label="Direct link to 000749---ry" title="Direct link to 000749---ry">​</a></h5><p>Tell me about I mean, probably not everybody knows what ZomboDB is. Maybe quickly describe what it does and what it doesn't do and what's coming next with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000759---eric"><em>[00:07:59]<!-- --> - Eric</em><a href="#000759---eric" class="hash-link" aria-label="Direct link to 000759---eric" title="Direct link to 000759---eric">​</a></h5><p>Yeah, it's the worst named software product.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000803---ry"><em>[00:08:03]<!-- --> - Ry</em><a href="#000803---ry" class="hash-link" aria-label="Direct link to 000803---ry" title="Direct link to 000803---ry">​</a></h5><p>First off, why'd you call it Zombo, everyone wants to know.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000806---eric"><em>[00:08:06]<!-- --> - Eric</em><a href="#000806---eric" class="hash-link" aria-label="Direct link to 000806---eric" title="Direct link to 000806---eric">​</a></h5><p>I think, Ry, you're old enough to remember Zombo.com. If you don't remember it, then that just means you weren't playing on the internet. You're probably doing real work. It still exists so listeners can go and check it out, but the name just came from that. So ZomboDB is a postgres extension, and it's been through numerous iterations over the past eight years, but it has always been postgres extension that lets you create an index on a table that's backed by Elasticsearch. Typically the usage pattern is you create the index indexing all of the columns in the table and you point it to an Elasticsearch endpoint over Http or Https, and the ZomboDB keeps that index up to date. It keeps the index MVCC correct. All of your search results are you only see results that would otherwise be visible within the executing transaction has its own query language for doing full text queries, so users don't have to learn the Elasticsearch query DSL, which is pretty intense.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000914---ry"><em>[00:09:14]<!-- --> - Ry</em><a href="#000914---ry" class="hash-link" aria-label="Direct link to 000914---ry" title="Direct link to 000914---ry">​</a></h5><p>Can you use the Elasticsearch DSL with it, though?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000917---eric"><em>[00:09:17]<!-- --> - Eric</em><a href="#000917---eric" class="hash-link" aria-label="Direct link to 000917---eric" title="Direct link to 000917---eric">​</a></h5><p>You can, and there's a number of ways to do that. The query language itself allows you to just insert as part of an expression. You can insert a JSON block to represent a query DSL node. There's a full set of SQL builder functions, so you can build query DSL through SQL statements. You can mix and match these things together. It's pretty sophisticated on that front, and it also exposes nearly all of Elasticsearch's aggregate endpoints to enable you to do really interesting aggregations with your full text. And since all the fields of a table are also stored in the Elasticsearch index, you can do some really interesting things that involve full text queries and aggregating on various metadata fields and do all this with a large distributed elastic search cluster behind the scenes and do it in near real time. It's really slick. The downside to ZomboDB is that you now have an Elastic search cluster running alongside your postgres cluster. And ES is a living breathing system. It requires significant attention and maintenance in production. It gives you a lot of capabilities to scale out horizontally very easily, but it is its own living breathing system there.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001042---ry"><em>[00:10:42]<!-- --> - Ry</em><a href="#001042---ry" class="hash-link" aria-label="Direct link to 001042---ry" title="Direct link to 001042---ry">​</a></h5><p>Yeah, it'd be great if you can build a version of this without requiring elastic.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001046---eric"><em>[00:10:46]<!-- --> - Eric</em><a href="#001046---eric" class="hash-link" aria-label="Direct link to 001046---eric" title="Direct link to 001046---eric">​</a></h5><p>Yeah, I know a guy that's working on that. I know a company that's working.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001050---ry"><em>[00:10:50]<!-- --> - Ry</em><a href="#001050---ry" class="hash-link" aria-label="Direct link to 001050---ry" title="Direct link to 001050---ry">​</a></h5><p>Yeah, someday that'd be possible.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001053---eric"><em>[00:10:53]<!-- --> - Eric</em><a href="#001053---eric" class="hash-link" aria-label="Direct link to 001053---eric" title="Direct link to 001053---eric">​</a></h5><p>Yeah, well, you had asked where the name came from and I said all that to say that the name came from. Once we kind of got ZomboDB working, we were like, whoa, it's really amazing what you can do with this and how easy it is to use. And one of the mantras from Zombo.com is the only limit is yourself. And ZomboDB really kind of makes it feel that way because it makes querying your data, especially real dense text data, just super simple.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001126---ry"><em>[00:11:26]<!-- --> - Ry</em><a href="#001126---ry" class="hash-link" aria-label="Direct link to 001126---ry" title="Direct link to 001126---ry">​</a></h5><p>And so you use Zombo pretty aggressively within TCDI, which is where you work, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001133---eric"><em>[00:11:33]<!-- --> - Eric</em><a href="#001133---eric" class="hash-link" aria-label="Direct link to 001133---eric" title="Direct link to 001133---eric">​</a></h5><p>Yeah, TCDI is my employer. Yeah. We've had Zombo in production since 2013 and we didn't open source until 2015. Yeah, I don't want to give away numbers, but we have more ZomboDB installations and Elasticsearch instances than we probably want.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001153---ry"><em>[00:11:53]<!-- --> - Ry</em><a href="#001153---ry" class="hash-link" aria-label="Direct link to 001153---ry" title="Direct link to 001153---ry">​</a></h5><p>Is it sort of a competitive advantage for the business? The power that I know, you guys, it's like legal documents. I might get it wrong, but like searching legal documents to some degree, right? Is it a competitive advantage for the business? The fact that Zombo is inside, would you say?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001208---eric"><em>[00:12:08]<!-- --> - Eric</em><a href="#001208---eric" class="hash-link" aria-label="Direct link to 001208---eric" title="Direct link to 001208---eric">​</a></h5><p>Yeah, absolutely. Our industry is ediscovery litigation support and among many other areas within that domain, searching large volumes of text is a key thing. And we're the only player in our industry that has text search capabilities to the degree that we do. And I'm not going to go name or other competitors or anything, but their abilities to do complicated text search that involves fuzzy queries plus regular expressions, plus boolean expressions, plus long tail proximity queries hit highlighting it's our abilities to do that just far exceed our competitors because of ZomboDB, because of postgres, and because of Elasticsearch.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001255---ry"><em>[00:12:55]<!-- --> - Ry</em><a href="#001255---ry" class="hash-link" aria-label="Direct link to 001255---ry" title="Direct link to 001255---ry">​</a></h5><p>Do you use the extension in both transactional use cases as well as analytical? Or is it mostly just powering the search bar inside the product or is there some back end? I guess I call it like analytical type use cases for it as well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001312---eric"><em>[00:13:12]<!-- --> - Eric</em><a href="#001312---eric" class="hash-link" aria-label="Direct link to 001312---eric" title="Direct link to 001312---eric">​</a></h5><p>Yeah. So with postgres. Right. Everything is transactional.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001315---ry"><em>[00:13:15]<!-- --> - Ry</em><a href="#001315---ry" class="hash-link" aria-label="Direct link to 001315---ry" title="Direct link to 001315---ry">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001316---eric"><em>[00:13:16]<!-- --> - Eric</em><a href="#001316---eric" class="hash-link" aria-label="Direct link to 001316---eric" title="Direct link to 001316---eric">​</a></h5><p>We expose search in a very complex manner. I guess, to our users. Users, it's much more than just a search box. They can search by particular fields and design proximity queries, and they can do term lookups. They can create real time dashboards and whatnot through our software. That's all backed by ZomboDB. One interesting use case is in the world of litigation. The plaintiffs will provide the defendants with a list of keywords that need to be searched in order to find documents that are responsive to particular to these topics. And these keywords are sometimes just literally a keyword one word. Sometimes they're phrases, sometimes they're wild card terms. Sometimes they're phrases with embedded wildcards. Sometimes they're patterns that need to be recognized. And so, like an analytics side of what we use ZomboDB for is taking these ginormous lists of things and kicking it off and getting back a list of the 6 million documents out of the 200 million that might match this set of keywords that the plaintiffs have requested production for.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001425---ry"><em>[00:14:25]<!-- --> - Ry</em><a href="#001425---ry" class="hash-link" aria-label="Direct link to 001425---ry" title="Direct link to 001425---ry">​</a></h5><p>Yeah, that's intense. Could see the power of that. What are your other favorite extensions? Probably all the other ones you've made, but give me your top five postgres extensions. zombos, one. What are a couple of others that you like?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001439---eric"><em>[00:14:39]<!-- --> - Eric</em><a href="#001439---eric" class="hash-link" aria-label="Direct link to 001439---eric" title="Direct link to 001439---eric">​</a></h5><p>I don't use PostGIS or PostGIS, but I am super impressed with it. I think of it as kind of like the gold standard of what a postgres extension ought to look like. ZomboDB does integrate with it, but the data world that I live in doesn't involve the need to do geographical type queries. But I've always been really impressed with it. I think the postgres foreign data wrapper as an extension is really great, and that comes from the core community, but pretty impressed with that. Citus has always been interesting to me. I guess they've long since been bought out by Microsoft and are still going strong. I think that Citus really shows off the power of what a postgres extension can do, and it also shows off the power of having committers on the hackers and hackers to be able to help move the extension system in postgres forward so that you can then implement something like Citus on top of it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001536---ry"><em>[00:15:36]<!-- --> - Ry</em><a href="#001536---ry" class="hash-link" aria-label="Direct link to 001536---ry" title="Direct link to 001536---ry">​</a></h5><p>When they were building that, did they have to add things to extensions in order to build that? I don't know the whole history of Citus, but was that kind of like.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001546---eric"><em>[00:15:46]<!-- --> - Eric</em><a href="#001546---eric" class="hash-link" aria-label="Direct link to 001546---eric" title="Direct link to 001546---eric">​</a></h5><p>Yeah, they've had a number of changes in postgres, I think, especially in the planner and executor to be able to support the ability to extend it better. And I think some of that came from the original Citus company people. That's great, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001603---ry"><em>[00:16:03]<!-- --> - Ry</em><a href="#001603---ry" class="hash-link" aria-label="Direct link to 001603---ry" title="Direct link to 001603---ry">​</a></h5><p>Yeah, that's awesome.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001605---eric"><em>[00:16:05]<!-- --> - Eric</em><a href="#001605---eric" class="hash-link" aria-label="Direct link to 001605---eric" title="Direct link to 001605---eric">​</a></h5><p>What I like to see are people using Pgrx to just solve a problem that they have with their application. I see things like somebody just needed to talk to an S3 bucket, and so they put together a little Pgrx extension to do that. Little things like that are what get me excited about Postgres extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001626---ry"><em>[00:16:26]<!-- --> - Ry</em><a href="#001626---ry" class="hash-link" aria-label="Direct link to 001626---ry" title="Direct link to 001626---ry">​</a></h5><p>Yeah, it's pretty timely. I have a co-op that started literally today. Shout out to Jay and I told him to build a clerk FDW using the Supabase Wrappers SDK. And he's like, what the hell do you say to me? Just try read the docs, we'll see where it goes. But I'll report back how that goes. But yeah, Clerk, we're using Clerk for Auth for our company, and I just need a simple read access to three collections. So I figure he should be able to get it done by the end of the day, but I might be pushing too hard.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001700---eric"><em>[00:17:00]<!-- --> - Eric</em><a href="#001700---eric" class="hash-link" aria-label="Direct link to 001700---eric" title="Direct link to 001700---eric">​</a></h5><p>Well, it's possible. And that's a great example of where having a simple framework for making an extension is really powerful. Right. I mean, once you figure out the documentation and how to tie the two things together, it probably is just an afternoon's worth of work. And now you've got something that solves a problem and you can move on.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001721---ry"><em>[00:17:21]<!-- --> - Ry</em><a href="#001721---ry" class="hash-link" aria-label="Direct link to 001721---ry" title="Direct link to 001721---ry">​</a></h5><p>Yeah, I figure his second one maybe will take an afternoon, first one might take a few days, but we'll see.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001726---eric"><em>[00:17:26]<!-- --> - Eric</em><a href="#001726---eric" class="hash-link" aria-label="Direct link to 001726---eric" title="Direct link to 001726---eric">​</a></h5><p>Well, sure, yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001728---ry"><em>[00:17:28]<!-- --> - Ry</em><a href="#001728---ry" class="hash-link" aria-label="Direct link to 001728---ry" title="Direct link to 001728---ry">​</a></h5><p>Well, that's great. Yeah, we're super excited, obviously, by all the possibilities that Pgrx brings to Postgres, and the great work you guys have done historically to get us to this point is much appreciated.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001742---eric"><em>[00:17:42]<!-- --> - Eric</em><a href="#001742---eric" class="hash-link" aria-label="Direct link to 001742---eric" title="Direct link to 001742---eric">​</a></h5><p>Well, thanks. That's one of the reasons why we, TCDI donated Pgrx to the PG Central Foundation is to provide it a long term home for the Postgres community. TCDI is a litigation support company. We're not a database company, so to speak. So we wanted to get this stuff in the hands of a foundation that can help shepherd it forward and make sure that it can survive.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001809---ry"><em>[00:18:09]<!-- --> - Ry</em><a href="#001809---ry" class="hash-link" aria-label="Direct link to 001809---ry" title="Direct link to 001809---ry">​</a></h5><p>I imagine you have some open issues there that you could use help with. They're probably pretty hard to do, right? Like building a framework is a lot harder to building a thing with a framework. But are you looking for additional help from people to build out Pgrx?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001823---eric"><em>[00:18:23]<!-- --> - Eric</em><a href="#001823---eric" class="hash-link" aria-label="Direct link to 001823---eric" title="Direct link to 001823---eric">​</a></h5><p>Yeah, for sure. I can't even tell you off the top of my head how many contributions we've had over the past four years that Pgrx has been alive. And it seems like every couple of weeks somebody new comes by with a new contribution. But yeah, one of the things that we're focused on right now is I guess it's two things kind of concurrently. One is we're improving Pgrx, is testing fundamentals, and it's both tying in more interesting things in CI like Valgrind, to different approaches to unit testing, which includes we're doing a big push on property testing right now within Pgrx. I think there's going to be some pull request landing in the next week or so with that. And we're also focused on improving some of the memory safety and soundness impedance mismatches between Postgres internals and Rust's compiler. So it's a big concerted effort to take a look at these issues.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001925---ry"><em>[00:19:25]<!-- --> - Ry</em><a href="#001925---ry" class="hash-link" aria-label="Direct link to 001925---ry" title="Direct link to 001925---ry">​</a></h5><p>Well, it seems like contributing to Pgrx could be like a gateway drug towards getting closer to helping with postgres itself. Right. Because you need to understand the internals to do anything in know, at least unless you're working on tests or yeah, I mean in general, adding new features to Pgrx means understanding postgres well enough to create that interface, which is big challenge.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001948---eric"><em>[00:19:48]<!-- --> - Eric</em><a href="#001948---eric" class="hash-link" aria-label="Direct link to 001948---eric" title="Direct link to 001948---eric">​</a></h5><p>It does. And we myself and the others that on the decor development team there, we spend probably as much time in the postgres sources as we do actually writing code for it in.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002003---ry"><em>[00:20:03]<!-- --> - Ry</em><a href="#002003---ry" class="hash-link" aria-label="Direct link to 002003---ry" title="Direct link to 002003---ry">​</a></h5><p>You guys. If you come up with a big new release of Pgrx or any other extensions that you can think of, I'd love to have you back. Eric, it was great catching up with you.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002012---eric"><em>[00:20:12]<!-- --> - Eric</em><a href="#002012---eric" class="hash-link" aria-label="Direct link to 002012---eric" title="Direct link to 002012---eric">​</a></h5><p>Yeah, sure. Likewise. Thank you so much for having me.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres, Ep. 2: Adam Hendel]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep2</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep2</guid>
            <pubDate>Thu, 19 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In this episode, Ry and Adam talk about developing extensions for Postgres, being in the trenches of the modern data stack sprawl, and the future of what’s possible with Tembo Stacks. If you haven’t seen or listened to it yet, you can do so below, or on Apple/Spotify (or your podcast platform of choice). Special thanks to Adam for joining us today!]]></description>
            <content:encoded><![CDATA[<p>In this episode, Ry and Adam talk about developing extensions for Postgres, being in the trenches of the modern data stack sprawl, and the future of what’s possible with Tembo Stacks. If you haven’t seen or listened to it yet, you can do so below, or on Apple/Spotify (or your podcast platform of choice). Special thanks to Adam for joining us today!</p><p>Want to know more about something they mentioned? Here’s a starting point:</p><iframe width="560" height="315" src="https://www.youtube.com/embed/8vkhlaY7AqM?si=ttqL-LBuwgXzEvFG" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><ul><li>Pgmq - <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>; also see Adam’s blog post about pgmq - <a href="https://tembo.io/blog/introducing-pgmq" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/introducing-pgmq</a></li><li>pg_later - <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pg_later</a>; Adam wrote about this one too - <a href="https://tembo.io/blog/introducing-pg-later" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/introducing-pg-later</a></li><li>clerk_fdw -<a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/clerk_fdw</a>; for more information, have a look at our blog post about it - <a href="https://tembo.io/blog/clerk-fdw/" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/clerk-fdw/</a></li><li>Supabase wrappers - <a href="https://github.com/supabase/wrappers" target="_blank" rel="noopener noreferrer">https://github.com/supabase/wrappers</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>pg_cron - <a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/pg_cron</a></li><li>Kafka - <a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">https://kafka.apache.org/</a></li><li>Tembo Stacks - <a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates</a>; also check out our blog about them - <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/tembo-stacks-intro</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000013---ry"><em>[00:00:13]<!-- --> - Ry</em><a href="#000013---ry" class="hash-link" aria-label="Direct link to 000013---ry" title="Direct link to 000013---ry">​</a></h5><p>Welcome to the show, Adam. Excited to chat with you today. How many postgres extensions have you authored in 2023?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000023---adam"><em>[00:00:23]<!-- --> - Adam</em><a href="#000023---adam" class="hash-link" aria-label="Direct link to 000023---adam" title="Direct link to 000023---adam">​</a></h5><p>Oh, it at least two.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000028---ry"><em>[00:00:28]<!-- --> - Ry</em><a href="#000028---ry" class="hash-link" aria-label="Direct link to 000028---ry" title="Direct link to 000028---ry">​</a></h5><p>At least two?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000029---adam"><em>[00:00:29]<!-- --> - Adam</em><a href="#000029---adam" class="hash-link" aria-label="Direct link to 000029---adam" title="Direct link to 000029---adam">​</a></h5><p>Well, in early 2023, I was just like, getting started and trying to figure out how to write one. And I know I wrote like a handful of them that didn't really do anything. I think the first one was just put like a rest server inside an extension and see what happens. Kind of didn't work very well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000057---ry"><em>[00:00:57]<!-- --> - Ry</em><a href="#000057---ry" class="hash-link" aria-label="Direct link to 000057---ry" title="Direct link to 000057---ry">​</a></h5><p>Yeah, I remember that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000059---adam"><em>[00:00:59]<!-- --> - Adam</em><a href="#000059---adam" class="hash-link" aria-label="Direct link to 000059---adam" title="Direct link to 000059---adam">​</a></h5><p>I think I made like, a prometheus exporter, and then recently there were two ones that are kind of more useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000105---ry"><em>[00:01:05]<!-- --> - Ry</em><a href="#000105---ry" class="hash-link" aria-label="Direct link to 000105---ry" title="Direct link to 000105---ry">​</a></h5><p>Yeah, that's great. Well, so obviously we know each other. We both worked together at Tembo. I mean, I could ask you questions as if I don't already know the answers, but since I do, I'm not going to do that. I was going to say getting into postgres, though, joining Tembo wasn't your first touch of postgres. Do you remember starting with, like I can't really quite remember when I started. But can you remember when you did?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000133---adam"><em>[00:01:33]<!-- --> - Adam</em><a href="#000133---adam" class="hash-link" aria-label="Direct link to 000133---adam" title="Direct link to 000133---adam">​</a></h5><p>Well, the first time I heard of postgres I'm pretty sure was like in undergrad, like database management systems class. And it was like, there's Oracle, there's these companies around it, and then there's open source stuff, postgresQL, you know? And I remember thinking, like, oh, that's And I probably Googled it and saw the elephant. And then I know I started using it in undergrad. I was doing some scientific computing stuff and I just needed somewhere to I didn't want to just keep writing to CSVs. I wanted to put it somewhere that was easier to search. And I just used postgres for it. Didn't really know what I was doing. It was just like, dump it into this database.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000221---ry"><em>[00:02:21]<!-- --> - Ry</em><a href="#000221---ry" class="hash-link" aria-label="Direct link to 000221---ry" title="Direct link to 000221---ry">​</a></h5><p>Nice, nice. And then as far as hacking postgres, that just started recently, or have you messed with the internals of postgres prior to this year?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000235---adam"><em>[00:02:35]<!-- --> - Adam</em><a href="#000235---adam" class="hash-link" aria-label="Direct link to 000235---adam" title="Direct link to 000235---adam">​</a></h5><p>Definitely not prior to this year. It's mostly focused on the application layer, building stuff on top of postgres. This year still getting deeper into the internals of postgres. I had installed some extensions before this year. Definitely didn't even think about how do you write build an extension, but it's.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000300---ry"><em>[00:03:00]<!-- --> - Ry</em><a href="#000300---ry" class="hash-link" aria-label="Direct link to 000300---ry" title="Direct link to 000300---ry">​</a></h5><p>Pretty easy to build them?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000301---adam"><em>[00:03:01]<!-- --> - Adam</em><a href="#000301---adam" class="hash-link" aria-label="Direct link to 000301---adam" title="Direct link to 000301---adam">​</a></h5><p>Yeah, that's very recent for me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000302---ry"><em>[00:03:02]<!-- --> - Ry</em><a href="#000302---ry" class="hash-link" aria-label="Direct link to 000302---ry" title="Direct link to 000302---ry">​</a></h5><p>Pretty easy to build them. Right. Would you say?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000304---adam"><em>[00:03:04]<!-- --> - Adam</em><a href="#000304---adam" class="hash-link" aria-label="Direct link to 000304---adam" title="Direct link to 000304---adam">​</a></h5><p>Yeah. A shallow one is easy if you can learn rust. Yeah, it's a challenge. I think it's hard.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000317---ry"><em>[00:03:17]<!-- --> - Ry</em><a href="#000317---ry" class="hash-link" aria-label="Direct link to 000317---ry" title="Direct link to 000317---ry">​</a></h5><p>Yeah, I was kind of kidding.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000319---adam"><em>[00:03:19]<!-- --> - Adam</em><a href="#000319---adam" class="hash-link" aria-label="Direct link to 000319---adam" title="Direct link to 000319---adam">​</a></h5><p>And then there's like a learning curve, and then once you get over a curve, you can kind of get moving with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000327---ry"><em>[00:03:27]<!-- --> - Ry</em><a href="#000327---ry" class="hash-link" aria-label="Direct link to 000327---ry" title="Direct link to 000327---ry">​</a></h5><p>Maybe. Let's talk about the extensions that you're, I guess, most proud of or have the most traction so far. What are those?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000339---adam"><em>[00:03:39]<!-- --> - Adam</em><a href="#000339---adam" class="hash-link" aria-label="Direct link to 000339---adam" title="Direct link to 000339---adam">​</a></h5><p>Pgmq, I think, has the most traction message queue extension. It's a lot like SQS Amazon's simple Queue service or Redisimple Message queue except on postgres. Well, we wrote it for Tembo to help run our cloud. We needed a message queue between Control Plane and Data Plane, so we wrote it for that. And then just in the last couple of months, we started kind of talking about it in the community. And after we wrote a blog about it, we've had a few people from the community that didn't know before who are now consistently contributing to the project. So Pgmq is definitely the one that I think has most traction.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000436---ry"><em>[00:04:36]<!-- --> - Ry</em><a href="#000436---ry" class="hash-link" aria-label="Direct link to 000436---ry" title="Direct link to 000436---ry">​</a></h5><p>And I think you're also working on well, you kind of have a stack of them, right? Because your other extension relies on Pgmq. True?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000448---adam"><em>[00:04:48]<!-- --> - Adam</em><a href="#000448---adam" class="hash-link" aria-label="Direct link to 000448---adam" title="Direct link to 000448---adam">​</a></h5><p>PG later.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000450---ry"><em>[00:04:50]<!-- --> - Ry</em><a href="#000450---ry" class="hash-link" aria-label="Direct link to 000450---ry" title="Direct link to 000450---ry">​</a></h5><p>Is that true?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000451---adam"><em>[00:04:51]<!-- --> - Adam</em><a href="#000451---adam" class="hash-link" aria-label="Direct link to 000451---adam" title="Direct link to 000451---adam">​</a></h5><p>Yeah. Okay. Yeah, PG later, that's another extension that lets you submit a query to Postgres and then forget about it and come back later and see the results from that query. And that's built on top of Pgmq. So it's like a stack of extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000520---ry"><em>[00:05:20]<!-- --> - Ry</em><a href="#000520---ry" class="hash-link" aria-label="Direct link to 000520---ry" title="Direct link to 000520---ry">​</a></h5><p>Nice. I guess you're in the position now to be the extension mentor for others in the company who may be building extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000529---adam"><em>[00:05:29]<!-- --> - Adam</em><a href="#000529---adam" class="hash-link" aria-label="Direct link to 000529---adam" title="Direct link to 000529---adam">​</a></h5><p>I know.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000529---ry"><em>[00:05:29]<!-- --> - Ry</em><a href="#000529---ry" class="hash-link" aria-label="Direct link to 000529---ry" title="Direct link to 000529---ry">​</a></h5><p>I just hired a co op who's working on one, and I imagine you're mentoring him to some degree.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000537---adam"><em>[00:05:37]<!-- --> - Adam</em><a href="#000537---adam" class="hash-link" aria-label="Direct link to 000537---adam" title="Direct link to 000537---adam">​</a></h5><p>Yeah, Jay talking about? Yeah, Jay's. Great. Hey, Jay. Jay, if you're listening yeah. Jay's been working on the another extension written in Rust, Clerk FDW. So it's a foreign data wrapper around Clerk, which is like our identity provider. We just want to be able to build this data warehouse that has our users and their organizations and have that data persisted in our data warehouse. So we built well, Jay is building that foreign data wrapper around Clerk, which is pretty cool.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000617---ry"><em>[00:06:17]<!-- --> - Ry</em><a href="#000617---ry" class="hash-link" aria-label="Direct link to 000617---ry" title="Direct link to 000617---ry">​</a></h5><p>Yeah, we probably should give a shout out to Supabase for the Wrappers project that we're using to build that with. Sounds like it's been a pretty nice experience. Jay's a co op that just joined, like, last week and so already being very productive. So I'm excited. I think that there's the possibility of an explosion of new extensions for Postgres now that Pgrx allows us to use Rust. You agree with that?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000651---adam"><em>[00:06:51]<!-- --> - Adam</em><a href="#000651---adam" class="hash-link" aria-label="Direct link to 000651---adam" title="Direct link to 000651---adam">​</a></h5><p>Yeah, it's pretty powerful because take this Clerk FDW, that extension that Jay's building. We can bootstrap the software together the same way as you might do outside of Postgres, but we don't have to spin up another resource somewhere, manage a pod or another VM, can package it up into an extension, use Supabase Wrapper. So that's a software that's already built. It's tested. We don't have to reinvent the wheel on that. We write the extension in Rust. So we pull in Rust libraries that are already built, already tested. Then we write our own tests on top of these things and then package it into our extension and then deploy it as part of the database. And then we can kind of just monitor the data there and not have to manage another service that could crash.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000754---ry"><em>[00:07:54]<!-- --> - Ry</em><a href="#000754---ry" class="hash-link" aria-label="Direct link to 000754---ry" title="Direct link to 000754---ry">​</a></h5><p>Yeah, it's pretty nice. So I was going to change a little bit to...you've also been using a lot of other people's extensions. Again, probably a lot more since joining Tembo than before, but what are some of your, I don't know, favorite extensions that you've been exposed to?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000815---adam"><em>[00:08:15]<!-- --> - Adam</em><a href="#000815---adam" class="hash-link" aria-label="Direct link to 000815---adam" title="Direct link to 000815---adam">​</a></h5><p>Yeah, you said PG Cron a few different places. There's another extension that I'm working on. It's, like, really early, but it's kind of wrapping up kind of some of the stuff that Langchain does in Python, but wrapping it up into an extension, pulling in PG vector into that, pulling in pg_cron, pulls in Pgmq and PostgresML as well. So it's like a bootstrapped extension. So all of those are pretty good PostgresML, pg_cron, pgvector, and they all have pretty good docs, so you can get up and running with them quickly and kind of figure out what you need to do.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000909---ry"><em>[00:09:09]<!-- --> - Ry</em><a href="#000909---ry" class="hash-link" aria-label="Direct link to 000909---ry" title="Direct link to 000909---ry">​</a></h5><p>Yeah. So have you found that you've had to study the internals of postgres much as part of the process of building these extensions?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000923---adam"><em>[00:09:23]<!-- --> - Adam</em><a href="#000923---adam" class="hash-link" aria-label="Direct link to 000923---adam" title="Direct link to 000923---adam">​</a></h5><p>Not really too much. Only when I'm having trouble getting it up and running for the first time do I need to really look at postgres. But a lot of these extensions don't. They're not like touching with hooks into and replacing core functionality of postgres. They're extending things. So a lot of what PostgresML does is just give you functions that go off and make rest calls or download data from elsewhere in the Internet and put it in your database for you, give you access to some pre trained machine learning models. And it's not changing fundamentally how postgres runs. It's still like the normal postgres. It's kind of like a layer on top of yeah. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001019---ry"><em>[00:10:19]<!-- --> - Ry</em><a href="#001019---ry" class="hash-link" aria-label="Direct link to 001019---ry" title="Direct link to 001019---ry">​</a></h5><p>I think some extensions can do surgery and some are, know, laying on top of and not messing with the core functionality.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001028---adam"><em>[00:10:28]<!-- --> - Adam</em><a href="#001028---adam" class="hash-link" aria-label="Direct link to 001028---adam" title="Direct link to 001028---adam">​</a></h5><p>Right? Yeah, it's an area I'm kind of new with that, so I haven't gotten super deep into replacing core functionality of postgres quite yet. But soon we'll probably start working in that space a little bit more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001047---ry"><em>[00:10:47]<!-- --> - Ry</em><a href="#001047---ry" class="hash-link" aria-label="Direct link to 001047---ry" title="Direct link to 001047---ry">​</a></h5><p>What's, like the testing story? If you're a dev that likes to write TDD, test driven development, are you able to do that with extensions in particular, I guess, with Pgrx. What's the test driven story there look like?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001103---adam"><em>[00:11:03]<!-- --> - Adam</em><a href="#001103---adam" class="hash-link" aria-label="Direct link to 001103---adam" title="Direct link to 001103---adam">​</a></h5><p>Pgrx, I think, is pretty good. They have a way for you to say unit test or integration test for the extension that you're writing, so you can say, execute some queries and then make assertions on the outputs of those queries. So kind of like, have normal assertions that you would do in whatever language that you're testing. Pgrx has some tooling around like, oh, I want to spin up postgres 15.3, spin up a new environment for that, install your extension into it, and then run your test suite on it. Yeah, I guess it can get a little bit trickier, I think could be because depending on how complex the extension is, you could have system dependencies, um, like, oh, I need a specific version of GCC or something, or OpenSSL version something has to be installed. I haven't really quite found a good way to test all of those things to make it super portable to say, like, yep, all these test pass. And that means my extension is just good for everybody.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001228---ry"><em>[00:12:28]<!-- --> - Ry</em><a href="#001228---ry" class="hash-link" aria-label="Direct link to 001228---ry" title="Direct link to 001228---ry">​</a></h5><p>For the test running on your local machine. I know they're running on your local machine, but in a docker container or just natively.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001241---adam"><em>[00:12:41]<!-- --> - Adam</em><a href="#001241---adam" class="hash-link" aria-label="Direct link to 001241---adam" title="Direct link to 001241---adam">​</a></h5><p>You could do both, I guess. Kind of like my workflow for it. I guess I would do, like, run the test locally and then have the extension in a GitHub repo and have a CI pipeline that runs the same tests, but in Docker or within a GitHub workflow to be like, hey, before you merge this, you need to pass all these tests, kind of gate yourself a little bit.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001310---ry"><em>[00:13:10]<!-- --> - Ry</em><a href="#001310---ry" class="hash-link" aria-label="Direct link to 001310---ry" title="Direct link to 001310---ry">​</a></h5><p>That's great. Well, cool. So I was going to ask, as far as your background prior to Tembo, you were doing little ML engineering too. Did you use postgres much in that role? I guess the question is, did you use any of the special parts of Postgres or was it really just like a standard transactional store with little knowledge of the extension ecosystem?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001339---adam"><em>[00:13:39]<!-- --> - Adam</em><a href="#001339---adam" class="hash-link" aria-label="Direct link to 001339---adam" title="Direct link to 001339---adam">​</a></h5><p>Nothing too crazy. I've always tried to do a queue on postgres, so be like, build up this giant queue of things that a machine learning model needs to make predictions on, or make a bunch of different predictions, dump them into a queue, and then have another process. Look at all these predictions and pick the best one before giving it back to the user. But a lot of OLTP like high transaction workloads in kind of machine learning space. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001418---ry"><em>[00:14:18]<!-- --> - Ry</em><a href="#001418---ry" class="hash-link" aria-label="Direct link to 001418---ry" title="Direct link to 001418---ry">​</a></h5><p>So you said you've been trying to build queues historically, a lot of times in bigger companies, there are less tools for various tasks. For example, use redis if you want to build a queue, or use snowflake if you want to build a data warehouse. I don't even know that these things were officially declared by any sort of powers that be. It's more like the sales reps at those companies decided that this company is going to be a salesforce company or a snowflake company. Right. It's kind of a slow boil that you suddenly realize, oh, I guess we have kafka now. I guess we're a kafka shop and starts with a POC and then ends up you have all these tools. We call it the modern data stack. But yeah, I'm curious how your take on that in particular? Around start with the queue since you've just implemented it in postgres and probably had to use other tools in the past.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001516---adam"><em>[00:15:16]<!-- --> - Adam</em><a href="#001516---adam" class="hash-link" aria-label="Direct link to 001516---adam" title="Direct link to 001516---adam">​</a></h5><p>Yeah, a couple of places that I've worked at, it's like, hey, we need to pass messages between two services. And any engineer will be like, all right, well, we're going to evaluate what we have here. We want to try to do things like, oh, let's keep things simple, not make things too complex. And then depending on the size of the organization, it'll be like, well, we use Kafka for messaging, so use Kafka. And so it's like, okay, so make progress. A lot of times it's better to not fight that and just be like, we want to make progress, we just need our application to work. It's not like Kafka wouldn't work for this, but it's definitely overkill for a lot of situations. So then it's like, okay, we're going to build this in Kafka and maybe the rest of the application is in postgres, but this message piece of it, we're going to put it in Kafka. And from the application perspective, it's kind of no difference. Like I said, it's an overkill tool for a lot of use cases. But then when things start to go wrong and need to troubleshoot it, it's like, okay, now we have to bring in the Kafka expert.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001635---adam"><em>[00:16:35]<!-- --> - Adam</em><a href="#001635---adam" class="hash-link" aria-label="Direct link to 001635---adam" title="Direct link to 001635---adam">​</a></h5><p>And if it's a big company, it's probably a handful of people who are on this Kafka team and they got a lot of other stuff going on. So it's like, what do you have to do? You have to learn Kafka. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001647---ry"><em>[00:16:47]<!-- --> - Ry</em><a href="#001647---ry" class="hash-link" aria-label="Direct link to 001647---ry" title="Direct link to 001647---ry">​</a></h5><p>And you're a small use case, right? You're like a small unimportant use case. And so, yeah, you can't get their attention. You kind of accepted the fact that, okay, I can learn. It's kind of fun to learn new technologies and try new things out, right? That's the day. Zero joy of learning something new. But then now all of a sudden you've got to support it, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001709---adam"><em>[00:17:09]<!-- --> - Adam</em><a href="#001709---adam" class="hash-link" aria-label="Direct link to 001709---adam" title="Direct link to 001709---adam">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001710---ry"><em>[00:17:10]<!-- --> - Ry</em><a href="#001710---ry" class="hash-link" aria-label="Direct link to 001710---ry" title="Direct link to 001710---ry">​</a></h5><p>You support what you make a lot of. Yeah, you got judoed into that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001716---adam"><em>[00:17:16]<!-- --> - Adam</em><a href="#001716---adam" class="hash-link" aria-label="Direct link to 001716---adam" title="Direct link to 001716---adam">​</a></h5><p>In my career, it was fun to learn Kafka and there's some things I really like about it, but then at the same time, it's a very complex tool and it does take a team to run and manage it. Same with RabbitMQ. If you're going to do those things, you need some people dedicated to making sure that they're functioning the way you expect it to.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001745---ry"><em>[00:17:45]<!-- --> - Ry</em><a href="#001745---ry" class="hash-link" aria-label="Direct link to 001745---ry" title="Direct link to 001745---ry">​</a></h5><p>Yeah, well, I think kind of leads into one of our core missions at the company, which you're leading at Tembo, which is our stacks. I guess it probably would make sense for you to say a few words on what we're trying to accomplish with stacks at the company.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001805---adam"><em>[00:18:05]<!-- --> - Adam</em><a href="#001805---adam" class="hash-link" aria-label="Direct link to 001805---adam" title="Direct link to 001805---adam">​</a></h5><p>Yeah. So stacks are workload optimized postgres clusters. So the message queue stack is one that we have and our goal with that is if you need to run a message queue, we want this to be the most optimized way to do a message queue on postgres. Of course, there'll be a point in time when it's like, hey, your use case has grown so big that maybe that stack's not going to fit you, but that stack will be to the very edge of what postgres can do for that workload. We're taking that same approach with our OLAP stack that we're building right now. We have an OLTP stack, there's a machine learning stack. So each one of these stacks is do it on postgres and we're going to make it be the best possible squeeze every last piece of juice out of postgres that we possibly can for that workload.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001908---ry"><em>[00:19:08]<!-- --> - Ry</em><a href="#001908---ry" class="hash-link" aria-label="Direct link to 001908---ry" title="Direct link to 001908---ry">​</a></h5><p>Yeah. And you're curating extensions for each stack. What else are you doing besides that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001913---adam"><em>[00:19:13]<!-- --> - Adam</em><a href="#001913---adam" class="hash-link" aria-label="Direct link to 001913---adam" title="Direct link to 001913---adam">​</a></h5><p>Yeah, extensions are a big piece. A lot of that has to do with there are certain types of developer experience that we think people want around workloads. And then there's the postgres configuration itself. So like, what should shared buffers be or how many parallel worker processes and how should the auto vacuum vacuum error be tuned for that workload? That's a whole class of things that are unique to every stack. Of course, there's like a user interface component of every stack as well. So if you want to come up and to look and see and observe the stack, there'll be user interface metrics are kind of really tightly related to the UI, so there's different metrics for every stack as well. Some of them are going to be the same across stacks. But for example, current number of messages in a queue, that's like a metric that you can monitor, you can write alerts around that metric and it's mostly unique to the message queue workload.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002032---ry"><em>[00:20:32]<!-- --> - Ry</em><a href="#002032---ry" class="hash-link" aria-label="Direct link to 002032---ry" title="Direct link to 002032---ry">​</a></h5><p>Yeah. And if the message queue stack is competing against a commercial queue product, they probably have some sort of visualization of the state of each queue.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002045---adam"><em>[00:20:45]<!-- --> - Adam</em><a href="#002045---adam" class="hash-link" aria-label="Direct link to 002045---adam" title="Direct link to 002045---adam">​</a></h5><p>Right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002046---ry"><em>[00:20:46]<!-- --> - Ry</em><a href="#002046---ry" class="hash-link" aria-label="Direct link to 002046---ry" title="Direct link to 002046---ry">​</a></h5><p>And so a postgres backed queue ought to have that same UI, that same monitoring tailored monitoring system. It makes it, I don't know how many times harder versus just configuration and curating some extensions, but I think it's all worth it to the user to be able to really defend their choice to use postgres for this use case against one of the modern data stack alternatives. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002120---adam"><em>[00:21:20]<!-- --> - Adam</em><a href="#002120---adam" class="hash-link" aria-label="Direct link to 002120---adam" title="Direct link to 002120---adam">​</a></h5><p>Right? Yeah. I think something really useful that I like about having stacks and having postgres aligned to specific workloads, the complexity of an overall application can really come down a lot by running everything on postgres. You could still have separate postgres clusters for workloads, like a certain set of CPU and memory dedicated to mission critical process A and a separate one for this other mission critical process. But still when it comes to troubleshooting these things, you're troubleshooting postgres and it's not like, hey, I have to switch and be like, okay, now I'm troubleshooting Kafka, or jumping to Redis or jumping to Mongo or Snowflake. It's still like the context switching I think, for the developers is big time minimized when it's still the same underlying data store between all the different workloads, same technology. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002227---ry"><em>[00:22:27]<!-- --> - Ry</em><a href="#002227---ry" class="hash-link" aria-label="Direct link to 002227---ry" title="Direct link to 002227---ry">​</a></h5><p>And we have this vision of potentially having some built in stack connectivity, right, where these databases, if they're all kind of sitting back to back to back so you have five different stacks they could and should be able to communicate really well with each other. And you should be able to write queries across them in the same way that Citus allows you to write queries across an array of postgres clusters very efficiently. You should be able to do the same thing here and pull data from multiple stacks with a very nice user experience, again, without having to move data around. So that's one of the exciting things for me as a former airflow company founder. All these data pipelines are very painful between modern data stack companies. And one of the things I'm excited about is the possibility that we can give developers the option to not have to create all those pipelines.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002336---adam"><em>[00:23:36]<!-- --> - Adam</em><a href="#002336---adam" class="hash-link" aria-label="Direct link to 002336---adam" title="Direct link to 002336---adam">​</a></h5><p>Yeah, I'm really excited to work on that problem when we start doing that, but that'll be I think, a really big differentiator is to say I have ten different machines running postgres and I have a single pane of view across all of them. I think it's definitely doable. It'll be challenging.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002402---ry"><em>[00:24:02]<!-- --> - Ry</em><a href="#002402---ry" class="hash-link" aria-label="Direct link to 002402---ry" title="Direct link to 002402---ry">​</a></h5><p>Yeah, it's a dream we're chasing. Yeah. Good. Well, I think it was great chatting with you, Adam. I'm sure we'll have you on the show again. I know that, again, you've got a lot more extensions coming and appreciate the work you've done for the community so far and yeah, looking forward to seeing your future work and talking about it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002428---adam"><em>[00:24:28]<!-- --> - Adam</em><a href="#002428---adam" class="hash-link" aria-label="Direct link to 002428---adam" title="Direct link to 002428---adam">​</a></h5><p>Sounds good. Thanks a lot, Ry.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Unleashing the power of vector embeddings with PostgreSQL]]></title>
            <link>https://tembo.io/blog/pgvector-and-embedding-solutions-with-postgres</link>
            <guid>https://tembo.io/blog/pgvector-and-embedding-solutions-with-postgres</guid>
            <pubDate>Wed, 18 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Language models are like the wizards of the digital world, conjuring up text that sounds eerily human. These marvels of artificial intelligence, such as GPT-3.5, are sophisticated algorithms that have been trained on vast swathes of text from the internet. They can understand context, generate coherent paragraphs, translate languages, and even assist in tasks like writing, chatbots, and more. Think of them as your trusty digital scribe, ready to assist with their textual sorcery whenever you summon them.]]></description>
            <content:encoded><![CDATA[<p><em>Language models are like the wizards of the digital world, conjuring up text that sounds eerily human. These marvels of artificial intelligence, such as GPT-3.5, are sophisticated algorithms that have been trained on vast swathes of text from the internet. They can understand context, generate coherent paragraphs, translate languages, and even assist in tasks like writing, chatbots, and more. Think of them as your trusty digital scribe, ready to assist with their textual sorcery whenever you summon them.</em></p><p>If you have used ChatGPT in the past, you probably were able to suspect that the previous paragraph was generated using it. And that's true. See the prompt <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">here</a>.</p><p>From the example above, you can witness the eloquence LLMs are capable of. Some people have been shocked so much that they became convinced that these <a href="https://www.scientificamerican.com/article/google-engineer-claims-ai-chatbot-is-sentient-why-that-matters/" target="_blank" rel="noopener noreferrer">models were sentient</a>. However, in the end, they are nothing but a large, complex series of <a href="https://www.youtube.com/watch?v=bCz4OMemCcA" target="_blank" rel="noopener noreferrer">matrix and vector operations</a>. These matrices and vectors have been trained to represent the semantic meaning of words.</p><p>In today's post, we will explore these meaning vectors and how they are related to Postgres. In particular, we are going to play with sentence transformers, vectors, and similarity search. All of that with the help of the pgvector Postgres extension.</p><p>Let’s go!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="from-words-to-vectors">From words to vectors<a href="#from-words-to-vectors" class="hash-link" aria-label="Direct link to From words to vectors" title="Direct link to From words to vectors">​</a></h2><p>Like we said, a vector can represent many things, for example, the position of a character in a 3D video game, the position of a pixel in your screen, the force applied to an object, a color in the RGB space, or even the meaning of a word…</p><p>Word embedding refers to the technique by which words can be represented as vectors. These days, the embeddings offered by <a href="https://openai.com/blog/new-and-improved-embedding-model" target="_blank" rel="noopener noreferrer">OpenAI</a> are very popular. However, other alternatives exist, like <a href="https://arxiv.org/abs/1301.3781" target="_blank" rel="noopener noreferrer">word2vect</a>, <a href="https://aclanthology.org/D14-1162.pdf" target="_blank" rel="noopener noreferrer">Glove</a>, <a href="https://fasttext.cc/docs/en/support.html" target="_blank" rel="noopener noreferrer">FastText</a>, and <a href="https://arxiv.org/abs/1802.05365v2" target="_blank" rel="noopener noreferrer">ELMo</a>.</p><p>Similarly, entire sentences can be represented as vectors using <a href="https://platform.openai.com/docs/guides/embeddings/what-are-embeddings" target="_blank" rel="noopener noreferrer">OpenAI embeddings</a> or <a href="https://sbert.net/" target="_blank" rel="noopener noreferrer">SentenceTransformers</a>, for example.</p><p>These models can be accessed through libraries for different languages. The following Python snippet shows how to obtain the vector embeddings of three sentences using SentenceTransformer:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SentenceTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SentenceTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'all-MiniLM-L6-v2'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentences </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'SentenceTransformers is a Python framework for state-of-the-art sentence, text and image embeddings.'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">'Pgvector is postgres extension for vector similarity search.'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">'Tembo will help you say goodby to database sprawl, and hello to Postgres.'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence_embeddings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Sentence:"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Embedding:"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The code used in this blog post can be found in <a href="https://gist.github.com/binidxaba/2eb3bff573c6be700e4391d650a302db" target="_blank" rel="noopener noreferrer">this gist</a>.</p></div></div><p>The mind-blowing part is that words and sentences with a similar meaning will have similar vectors. This characteristic is the basis of a search technique called similarity search, where we simply find the nearest embedding vectors to find texts that are similar to our query.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-meets-language-models">Postgres meets Language Models<a href="#postgres-meets-language-models" class="hash-link" aria-label="Direct link to Postgres meets Language Models" title="Direct link to Postgres meets Language Models">​</a></h2><p>Models are great at generating content that seems credible, as shown earlier. However, you may have experienced cases where ChatGPT hallucinates answers or delivers out-of-date information. That's because LLMs are <strong>pre-trained</strong> using <strong>general data</strong>. And, because of that, creating a chatbot based only on the pre-trained data wouldn't be helpful for your customers, for instance.</p><p>The concept of <a href="https://arxiv.org/abs/2005.11401" target="_blank" rel="noopener noreferrer">RAG (Retrieval-Augmented Generation)</a> acknowledges this limitation. </p><p>One way of overcoming these problems is to store your company's knowledge base in a database.... preferably in a vector database. You could then query related content and feed that content to the LLM of your preference.</p><p><img loading="lazy" alt="RAG with pgvector" src="/assets/images/RAG-cd4c28ec5c956f11e8de9ccf5bde2db2.png" width="450" height="288" class="img_ev3q"></p><p>Specialized vector databases include <a href="https://milvus.io/" target="_blank" rel="noopener noreferrer">Milvus</a>, <a href="https://qdrant.tech/" target="_blank" rel="noopener noreferrer">Qdrant</a>, <a href="https://weaviate.io/" target="_blank" rel="noopener noreferrer">Weaviate</a>, and <a href="https://www.pinecone.io/" target="_blank" rel="noopener noreferrer">Pinecone</a>. However, you probably want to <a href="https://www.amazingcto.com/postgres-for-everything/" target="_blank" rel="noopener noreferrer">stick to your Postgres database</a>. </p><p>Postgres is not in itself a vector database, but extensions can come to the rescue one more time... This time with <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer"><strong>pgvector</strong></a>.</p><p>Let's use it and explore how we would query related content from a Postgres database.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvector-postgres-as-a-vector-database">pgvector: Postgres as a vector database<a href="#pgvector-postgres-as-a-vector-database" class="hash-link" aria-label="Direct link to pgvector: Postgres as a vector database" title="Direct link to pgvector: Postgres as a vector database">​</a></h2><p><a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">pgvector</a> is a Postgres extension that helps work with vectors and stores them in your postgres database. It offers functions for calculating the distance between vectors and for similarity search.</p><p>For the following demo, I converted all of Tembo’s blogs into document vectors using the following Python script that uses the <a href="https://python.langchain.com" target="_blank" rel="noopener noreferrer">langchain framework</a>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">document_loaders </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TextLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text_splitter </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RecursiveCharacterTextSplitter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vectorstores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pgvector </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> PGVector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONNECTION_STRING </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgresql+psycopg2://postgres:password@localhost:5432/vector_db"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COLLECTION_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'my_collection'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'all-MiniLM-L6-v2'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text_splitter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RecursiveCharacterTextSplitter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chunk_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chunk_overlap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'./corpus'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin">file</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"./corpus/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">file</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Loading: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">file_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TextLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    document </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> loader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    texts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> text_splitter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">document</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_content </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> texts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGVector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            embedding</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            documents</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">texts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            collection_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">COLLECTION_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection_string</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">CONNECTION_STRING</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It basically loads each document and then inserts them into Postgres using the <a href="https://python.langchain.com/docs/integrations/vectorstores/pgvector" target="_blank" rel="noopener noreferrer"><code>PGVector</code> class</a>. As a result, in my Postgres database called <code>vector_db</code>, I got two tables:</p><p><img loading="lazy" alt="Show tables" src="/assets/images/table-list-3c5b0f371564f4dd0af86bcf7d14e209.png" width="434" height="177" class="img_ev3q"></p><ul><li><code>langchain_pg_collection</code>: contains information about all collections.</li><li><code>langchain_pg_embedding</code>: contains all the resulting vectors.</li></ul><p>The following picture shows part of the contents of (2):</p><p><img loading="lazy" alt="Show vectors" src="/assets/images/select-vectors-8523ebc09c243b1bc0987332c2225b8b.png" width="1470" height="465" class="img_ev3q"></p><p>The resulting vectors have <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2" target="_blank" rel="noopener noreferrer">384 dimensions</a>.  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="are-these-sentences-similar">Are these sentences similar?<a href="#are-these-sentences-similar" class="hash-link" aria-label="Direct link to Are these sentences similar?" title="Direct link to Are these sentences similar?">​</a></h2><p>Let’s now play with these vectors.</p><p>Using pgvector we can search content that is similar to a query. For example, we can find content related to <code>postgres 16</code>.</p><p>First, we can obtain a vector that represents a query:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'all-MiniLM-L6-v2'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“What </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> new </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> postgres </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then we can search vectors stored in the database that are similar to the query vector. The tool for that is <a href="https://en.wikipedia.org/wiki/Cosine_similarity" target="_blank" rel="noopener noreferrer"><code>cosine distance</code></a>, which in pgvector is represented with the <code>&lt;=&gt;</code> operator:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding </span><span class="token operator" style="color:#393A34">&lt;=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'[&lt;your_vector_here&gt;]'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> langchain_pg_embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> cosine_similarity </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above query retrieves vectors/chunks of text ordered by how close they are (in terms of <code>cosine distance</code>) to the query vector. In my case, the most similar chunk of text was:</p><blockquote><p>In case you missed it, Postgres 16 came out last week - and this year it
arrived earlier than the last few years. There are many features that
I’ve been looking forward to for the last few months and I’m excited to
see them get into the hands of users. Before we dive into the specific
features of this release, let’s discuss what a Postgres major release
actually means.</p><p>[postgres-16]</p><p>Postgres Releases</p><p>The PostgreSQL Global Development Group releases a new major version
every year with new features.</p><p>In addition, Postgres releases minor versions of each major release
every 3 months or so with bug fixes and security fixes. No new features
are released in minor versions, and that’s what makes major version
releases so exciting as it’s the culmination of about a year’s worth of
development work on the project.</p></blockquote><p>Which is an excerpt from <a href="https://tembo.io/blog/postgres-16" target="_blank" rel="noopener noreferrer">Postgres 16: The exciting and the unnoticed</a>.</p><p>Let us look at what Postgres is doing behind the scenes, using <code>explain analyze</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit  (cost=28.07..28.08 rows=2 width=641) (actual time=1.069..1.071 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Sort  (cost=28.07..28.53 rows=181 width=641) (actual time=1.067..1.068 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Key: ((embedding &lt;=&gt; '[&lt;your_vector&gt;]'::vector))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Method: top-N heapsort  Memory: 28kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         -&gt;  Seq Scan on langchain_pg_embedding  (cost=0.00..26.26 rows=181 width=641) (actual time=0.036..0.953 rows=181 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.079 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.093 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(7 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can observe that Postgres is sequentially scanning all rows. Then it computes the <code>cosine distance</code> for all those rows and sorts them. Finally,  it takes the first two rows.</p><p>The <code>sequential scan</code> could be avoided if we had an index. Indeed, we can create one thanks to pgvector, for example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> langchain_pg_embedding </span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> vector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">384</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> langchain_pg_embedding  </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> ivfflat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding vector_cosine_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lists </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Limit  (cost=5.01..5.11 rows=2 width=641) (actual time=0.175..0.179 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Index Scan using langchain_pg_embedding_embedding_idx2 on langchain_pg_embedding  (cost=5.01..13.49 rows=181 width=641) (actual time=0.172..0.175 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Order By: (embedding &lt;=&gt; '[&lt;your_vector&gt;]'::vector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.154 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.224 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One thing to keep in mind is that these indexes are used for <code>approximate nearest neighbor search</code>. We’ll explore what that means in a future blog post. <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">Let us know</a> if that would be interesting for you.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvectorize">Pgvector(ize)?<a href="#pgvectorize" class="hash-link" aria-label="Direct link to Pgvector(ize)?" title="Direct link to Pgvector(ize)?">​</a></h2><p>Ok, at this point you should now have a sense of what pgvector is, and how to use it together with Python. However, wouldn't it be great if the vectorizing step could happen all within Postgres?</p><p><a href="https://github.com/tembo-io/pg_vectorize" target="_blank" rel="noopener noreferrer"><strong>Pg_vectorize</strong></a> is an extension being developed by <strong>Tembo</strong> that intends to streamline the process of generating vectors from the data in your Postgres tables. It uses a background worker to generate and update the embeddings in batches every <em>N</em> seconds. Also, if you need to find similar vectors, the extension can do that. All within Postgres. Isn't that a cool idea? </p><p>I invite you to check out the repository and stay tuned.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="to-wrap-up">To wrap up...<a href="#to-wrap-up" class="hash-link" aria-label="Direct link to To wrap up..." title="Direct link to To wrap up...">​</a></h2><p>In this post, we briefly discussed the concept of <code>embeddings</code>, why they are important, and how they can be generated using one of the multiple available libraries. We also explored how to store and query the resulting vectors using Postgres and the pgvector extension.</p><p>These concepts are relevant to leveraging a knowledge base in conjunction with LLMs in an emerging technique called RAG. Of course, when implementing a real-life solution, <a href="ttps://medium.com/@neum_ai/retrieval-augmented-generation-at-scale-building-a-distributed-system-for-synchronizing-and-eaa29162521" target="_blank" rel="noopener noreferrer">more factors need to be considered</a>, and this post was just an introduction.</p><p>I invite everyone to try out pgvector (e.g. using the scripts in this post), and the different operations that it offers. Also, can you think of other uses of pgvector? Let us know your thoughts in <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h2><p><em>The first paragraph in this blog post was generated using ChatGPT. <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">Here’s the prompt</a></em></p>]]></content:encoded>
            <author>noreply@tembo.io (Binidxaba)</author>
            <category>postgres</category>
            <category>extensions</category>
            <category>embedding</category>
            <category>vector</category>
            <category>pgvector</category>
        </item>
        <item>
            <title><![CDATA[Hacking Postgres Ep. 1: Marco Slot]]></title>
            <link>https://tembo.io/blog/hacking-postgres-ep1</link>
            <guid>https://tembo.io/blog/hacking-postgres-ep1</guid>
            <pubDate>Mon, 16 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Episode Notes]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="episode-notes">Episode Notes<a href="#episode-notes" class="hash-link" aria-label="Direct link to Episode Notes" title="Direct link to Episode Notes">​</a></h2><p>In this episode, Ry and Marco talk about the early days of Citus and its development, creating pg_cron (on a plane!), and the new possibilities on the horizon for extensions in the Postgres landscape. If you haven’t seen or listened to it yet, you can play the video below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Marco for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/UxUrn6bKDfU?si=JMm_cMMPToh1K2KK" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>CloudFront - <a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/cloudfront/</a></li><li>Citus - <a href="https://www.citusdata.com/" target="_blank" rel="noopener noreferrer">https://www.citusdata.com/</a></li><li>pg_cron - <a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/pg_cron</a></li><li>pg_timetable - <a href="https://github.com/cybertec-postgresql/pg_timetable" target="_blank" rel="noopener noreferrer">https://github.com/cybertec-postgresql/pg_timetable</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>PostGIS - <a href="https://postgis.net/" target="_blank" rel="noopener noreferrer">https://postgis.net/</a></li><li>PostgresML - <a href="https://postgresml.org/" target="_blank" rel="noopener noreferrer">https://postgresml.org/</a></li><li>pgvector - <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">https://github.com/pgvector/pgvector</a></li><li>pg_embedding - <a href="https://github.com/neondatabase/pg_embedding" target="_blank" rel="noopener noreferrer">https://github.com/neondatabase/pg_embedding</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a> or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry"><em>[00:00:12]<!-- --> - Ry</em><a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Welcome to Hacking Postgres. Today we have Marco Slot joining us. I'm meeting Marco for the first time today. I'm super excited to be meeting you, Marco. Welcome to the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000025---marco"><em>[00:00:25]<!-- --> - Marco</em><a href="#000025---marco" class="hash-link" aria-label="Direct link to 000025---marco" title="Direct link to 000025---marco">​</a></h5><p>Hey Ry. Yeah, very nice to meet you. Yeah. So I'm Marco, I work at Microsoft and I've been working on Postgres extensions for about nine years now, starting with Citus, pgCron, and a bunch of other ones. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000044---ry"><em>[00:00:44]<!-- --> - Ry</em><a href="#000044---ry" class="hash-link" aria-label="Direct link to 000044---ry" title="Direct link to 000044---ry">​</a></h5><p>That's awesome.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000045---marco"><em>[00:00:45]<!-- --> - Marco</em><a href="#000045---marco" class="hash-link" aria-label="Direct link to 000045---marco" title="Direct link to 000045---marco">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000045---ry"><em>[00:00:45]<!-- --> - Ry</em><a href="#000045---ry" class="hash-link" aria-label="Direct link to 000045---ry" title="Direct link to 000045---ry">​</a></h5><p>So this is not really supposed to be an interview. It's more just us geeking out about Postgres, extensions, what they mean to users and opinions about anything and everything related to our work is fair game. Yeah, sounds good. So what'd you do before you got into Postgres stuff, out of curiosity?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000109---marco"><em>[00:01:09]<!-- --> - Marco</em><a href="#000109---marco" class="hash-link" aria-label="Direct link to 000109---marco" title="Direct link to 000109---marco">​</a></h5><p>Yeah. My background is more in distributed systems, so I spent a few years at AWS. It was quite early days in AWS when I think I joined. There were three Web Services. S3, SQS and EC2.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000124---ry"><em>[00:01:24]<!-- --> - Ry</em><a href="#000124---ry" class="hash-link" aria-label="Direct link to 000124---ry" title="Direct link to 000124---ry">​</a></h5><p>Wow.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000125---marco"><em>[00:01:25]<!-- --> - Marco</em><a href="#000125---marco" class="hash-link" aria-label="Direct link to 000125---marco" title="Direct link to 000125---marco">​</a></h5><p>And then we built number Four, which was CloudFront, which gives people started using S3 for websites, which it wasn't really built for. But then we were asked to solve this and we built the CDN, and then we also built Route 53 for the DNS.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000140---ry"><em>[00:01:40]<!-- --> - Ry</em><a href="#000140---ry" class="hash-link" aria-label="Direct link to 000140---ry" title="Direct link to 000140---ry">​</a></h5><p>Wow.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000141---marco"><em>[00:01:41]<!-- --> - Marco</em><a href="#000141---marco" class="hash-link" aria-label="Direct link to 000141---marco" title="Direct link to 000141---marco">​</a></h5><p>And then yeah, I did a PhD in sort of self driving cars, but specifically like, cooperation between self driving cars, like, what if they can communicate with each other and sort of coordinate? So it's sort of advanced distributed systems in a way as well. Yeah. So that led to me joining Citus, which is sort of founded by former Amazon folks.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000205---ry"><em>[00:02:05]<!-- --> - Ry</em><a href="#000205---ry" class="hash-link" aria-label="Direct link to 000205---ry" title="Direct link to 000205---ry">​</a></h5><p>Got it. So building Citus was probably easy compared to all other stuff, actually.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000212---marco"><em>[00:02:12]<!-- --> - Marco</em><a href="#000212---marco" class="hash-link" aria-label="Direct link to 000212---marco" title="Direct link to 000212---marco">​</a></h5><p>Yeah. If you do self driving cooperation between self driving cars, which is this kind of like life critical system distribute where your nodes kind of just move around and they move away from each other, it does make things relatively easy. But then yeah, building databases is never actually very easy.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000231---ry"><em>[00:02:31]<!-- --> - Ry</em><a href="#000231---ry" class="hash-link" aria-label="Direct link to 000231---ry" title="Direct link to 000231---ry">​</a></h5><p>No, I know. How good do you want to make it right? Is how hard it becomes.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000238---marco"><em>[00:02:38]<!-- --> - Marco</em><a href="#000238---marco" class="hash-link" aria-label="Direct link to 000238---marco" title="Direct link to 000238---marco">​</a></h5><p>Yeah. I guess the challenge is always everything sort of in the word relational. Right. Like everything relates to everything else. There's not like a feature you can implement without considering all the other aspects of the database and all the things that can happen concurrently with the operation that you're working on and all the possible ways in which things can fail. Especially if you're in a kind of distributed setup.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000301---ry"><em>[00:03:01]<!-- --> - Ry</em><a href="#000301---ry" class="hash-link" aria-label="Direct link to 000301---ry" title="Direct link to 000301---ry">​</a></h5><p>Yeah, I think that's really interesting perspective. You think of all of the configuration options, too. Adding a new configuration option adds complexity, adds flexibility, adds potential complex, and it's tough.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000320---marco"><em>[00:03:20]<!-- --> - Marco</em><a href="#000320---marco" class="hash-link" aria-label="Direct link to 000320---marco" title="Direct link to 000320---marco">​</a></h5><p>Yeah, definitely. I think one thing we learned is there's a sort of certain danger in creating modes where every setting you add, which can be on/off now you have two modes in your system. You add another setting that can be on/off. Now you have four modes in your system. It's kind of this exponential explosion of possible ways in which your database might be running. And so that's hard learned lesson that's, like, don't introduce major modes. Sometimes you have to because of backwards compatibility reasons, maybe, but you want to get rid of them over time.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000357---ry"><em>[00:03:57]<!-- --> - Ry</em><a href="#000357---ry" class="hash-link" aria-label="Direct link to 000357---ry" title="Direct link to 000357---ry">​</a></h5><p>Were you one of the first team members on Citus? Actually, I don't really know the full history. Did it start as a fork and made its way as an extension, or was it always an extension?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000410---marco"><em>[00:04:10]<!-- --> - Marco</em><a href="#000410---marco" class="hash-link" aria-label="Direct link to 000410---marco" title="Direct link to 000410---marco">​</a></h5><p>Yeah, I was one of the first, though I think Samay was already there. I think he's joined Tembo. So but yeah, we started out as a fork and then we called it CitusDB, and then we made it an extension and called it Citus. Though I think the name CitusDB kind of stuck around for...I still hear it sometimes. But yeah, it was very pretty early days for extensions. Like 2015 PostGIS obviously existed. It was one of the first major ones. But yeah, we were lucky at the time. We had Andres Freund working for us. Well, he's also now working for Microsoft, but he's like one of the top Postgres committers, and we put him in a room for a while, know, can you turn this into an extension, please? And he came up with some terrible, terrible hacks. But over time, those also drove some of the extension APIs in Postgres itself, where things that used to require really terrible hacks are now kind of more structured and you can introduce your own sort of data structures into Postgres without doing lots of weird stuff.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000522---ry"><em>[00:05:22]<!-- --> - Ry</em><a href="#000522---ry" class="hash-link" aria-label="Direct link to 000522---ry" title="Direct link to 000522---ry">​</a></h5><p>Well, I was thinking probably not everybody knows what Citus is. Maybe if you could give a quick I'd love to hear a quick overview of what it is and then maybe a couple of things that maybe you can think of that are unusual, that people might not know about it, that are part of it. I don't know if that's a stupid question, but yeah, if you could try no.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000541---marco"><em>[00:05:41]<!-- --> - Marco</em><a href="#000541---marco" class="hash-link" aria-label="Direct link to 000541---marco" title="Direct link to 000541---marco">​</a></h5><p>Yeah, so it comes from basically this denotion that Postgres is ultimately limited to a single machine. I mean, you can read replicas, but you definitely cannot scale the writes. Usually if you have read replicas, they'll kind of end up having the same stuff in memory. So you cannot really scale the memory either. And so Citus is a solution to basically adds sharding to Postgres in a very transparent way, where you can have tables that are sort of transparently sharded across many nodes, you still connect to a Postgres server. There's just a table, looks, walks, and talks like a table. But if you insert into it, it actually gets rooted to a particular node. And if you insert another value, it might get rooted into another node that uses this hash distribution. And that way you can scale across infinitely many machines and have some users have petabytes of data in their Citus cluster part of the advantage is also that queries can get paralyzed on these tables because we can use all the nodes at the same time and multiple cores per node. But more and more it's also actually being used for LTP workloads.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000655---marco"><em>[00:06:55]<!-- --> - Marco</em><a href="#000655---marco" class="hash-link" aria-label="Direct link to 000655---marco" title="Direct link to 000655---marco">​</a></h5><p>And particularly the most popular use case is actually multitenancy, where you have this kind of B2B app where you have lots of relatively independent users and you kind of want to just transparently spread those across different machines without having to actually manage that yourself and figure out how to move data around. Because that was all very kind of automated. You can just ask it to rebalance your data and it does that using logical replication. And so then you have the advantage of just as much memory as you need to make your application fast and as much disk IOPS as you need by just adding more machines with more disks and so that helps you scale. And then we have a sort of managed service in Azure around that. But yeah, we use every hook that's available in Postgres to achieve things like starting with the planner hook. That's one of the interesting things about Postgres. It's like you just replace the whole planner with something else. You get a parsed query tree and then you can do whatever you want with it. You can just do some like okay, look at this query and log something interesting and then just go to the regular planner.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000812---marco"><em>[00:08:12]<!-- --> - Marco</em><a href="#000812---marco" class="hash-link" aria-label="Direct link to 000812---marco" title="Direct link to 000812---marco">​</a></h5><p>Or you could just do something completely different. And so we use all these hooks to kind of create this facade around Postgres tables where it's like Postgres table is still there, you just cannot touch it. We just intercept everything that's going on. The most recent and most terrible hack we did it was like the give it as this hack in Postgres so we can figure out so we have shards. Like the writes go into shards but then if you do logical decoding you see writes on shards, you don't see writes on these what we call distributed tables. But the user doesn't even know about shards probably. So how can we fix that? And there wasn't really any kind of hook we could use to change the way that the logical decoding process works except that we realized that the client specifies a decoder name usually just hard coded like Pgoutput or Wal2json or test_decoding and that actually refers to the name of a .so,  like a shared library. And we realized we could create a .so with the same name and put it in a different directory and then change the dynamic library path to be prefixed with that directory so it would load our library instead.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000934---marco"><em>[00:09:34]<!-- --> - Marco</em><a href="#000934---marco" class="hash-link" aria-label="Direct link to 000934---marco" title="Direct link to 000934---marco">​</a></h5><p>This is kind of the worst thing we did. But it works nicely actually. I mean, that new .so file calls the original .so file and it kind of makes some changes to hide the sharding from the coding. But yeah, it is a hack. It's very much a hack. But it's nice that Postgres ultimately lets you do these kind of things.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000959---ry"><em>[00:09:59]<!-- --> - Ry</em><a href="#000959---ry" class="hash-link" aria-label="Direct link to 000959---ry" title="Direct link to 000959---ry">​</a></h5><p>I think, like Citus says, there's like a requirement that Citus loads first as an extension. Is that true? I'm trying to remember if I'm making that up.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001008---marco"><em>[00:10:08]<!-- --> - Marco</em><a href="#001008---marco" class="hash-link" aria-label="Direct link to 001008---marco" title="Direct link to 001008---marco">​</a></h5><p>It is true. I mean, maybe it's a bit of laziness on our part, but it's also.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001013---ry"><em>[00:10:13]<!-- --> - Ry</em><a href="#001013---ry" class="hash-link" aria-label="Direct link to 001013---ry" title="Direct link to 001013---ry">​</a></h5><p>Because...</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001016---marco"><em>[00:10:16]<!-- --> - Marco</em><a href="#001016---marco" class="hash-link" aria-label="Direct link to 001016---marco" title="Direct link to 001016---marco">​</a></h5><p>We generate very weird plans that wouldn't make any sense to other extensions. So if you have multiple layers of planner hooks, you kind of want Citus to be but by putting it first, it actually becomes the last because everyone else overwrites Citus. And then hopefully when you go through the chain of planner hook, Citus is the last one remaining and it can produce some quirky distributed query plan that doesn't make sense to anyone else and pick that up.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001048---ry"><em>[00:10:48]<!-- --> - Ry</em><a href="#001048---ry" class="hash-link" aria-label="Direct link to 001048---ry" title="Direct link to 001048---ry">​</a></h5><p>Are there known extensions that aren't compatible with Citus that you're aware of or as far as you know? It kind of works with most everything.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001056---marco"><em>[00:10:56]<!-- --> - Marco</em><a href="#001056---marco" class="hash-link" aria-label="Direct link to 001056---marco" title="Direct link to 001056---marco">​</a></h5><p>Yeah, I mean, Citus is a little bit of a paradigm shift because now you have many servers and some extensions just don't make sense if you're on many servers because they keep their state on one of them and then they're not aware of others. But most things just work. But I kind of feel like there's this notion of a deep extension, if you will, like timescaleDB or Citus. They kind of go really deep into planner hooks and change behavioral characteristics. Whereas something like PostGIS and a lot of extensions that just introduce new types and functions. They're sitting on top of this much more clean interface and usually the interoperability of those things is pretty good. But Timescale has this notion of a hyper table inside as a distributed table and you cannot really make a distributed hyper table. But yeah, compatibility, it comes down to sometimes also the individual features. It's not like if you install one, then the other doesn't work anymore. I mean, that happens for some extensions, but for Citus, most other things just kind of work with it. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001208---ry"><em>[00:12:08]<!-- --> - Ry</em><a href="#001208---ry" class="hash-link" aria-label="Direct link to 001208---ry" title="Direct link to 001208---ry">​</a></h5><p>So let's talk about pg_Cron. How early were you involved in that project?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001213---marco"><em>[00:12:13]<!-- --> - Marco</em><a href="#001213---marco" class="hash-link" aria-label="Direct link to 001213---marco" title="Direct link to 001213---marco">​</a></h5><p>Well, I created it. I used to have this thing where I am much more productive on flights and I flew to San Francisco a lot for a while and then I had a few of these projects that I was just working on on flights and pg_Cron was one of them. And so at the time we had customers who did kind of this real time analytics scenarios on Postgres on Citus. And those involve a lot of materialization. So a bunch of raw data keeps coming in like time series data. And at some point you want to take all the new data and kind of pre aggregate it inside of the database and that needs to happen periodically. I think the background worker concept was pretty new at the time. I don't know. This was many years ago. And so I realized you could do something like Cron. It maybe also comes from the Amazon background because Amazon, at least at the time, was all like glued together with Cron, Perl and R Sync. There were Cron jobs that would R sync metadata files to other servers and it was all pretty hacky. But anyway, I figured it would be pretty useful to have this kind of thing in Postgres also for just vacuuming or calling certain stored procedures that, I don't know, delete your old data.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001342---marco"><em>[00:13:42]<!-- --> - Marco</em><a href="#001342---marco" class="hash-link" aria-label="Direct link to 001342---marco" title="Direct link to 001342---marco">​</a></h5><p>Like those kind of maintenance tasks. It was just much easier if that's like you run a command once and then it works forever, rather than I need to maintain this separate infrastructure that periodically connects to the database and does that. So that became quite popular. I think pretty much all major managed services have pg_Cron now. Yeah, I kind of built it as a very I mean, it was definitely my side project. So I also built it as a very low maintenance thing that I wouldn't have to constantly fix bugs in. Also a little bit selective about adding new features. For a long time I resisted adding people want like, can I run a job every few seconds? And normally Cron is like at the minute, granularity. But recently I caved and I added doing it every few seconds because I realized it's kind of feature if there's some kind of issue, some kind of memory leak or whatever, if you run it every few seconds, it's going to be way worse than if you run it once a minute. So you need to be more careful in that case. But you can now also do like every second, for example, which is kind of useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001456---ry"><em>[00:14:56]<!-- --> - Ry</em><a href="#001456---ry" class="hash-link" aria-label="Direct link to 001456---ry" title="Direct link to 001456---ry">​</a></h5><p>That's awesome. Yeah, I was looking at we're just building a new data warehouse, trying to use Postgres to do that. I'm exploring all the columnar extension as well, which sort of is part of Citus. I don't know if you did any work on that, but yeah, looking at pg_cron versus pg_timetable, have you had the question of what about have you looked at timetable and its features and yeah, I'm kind of curious to get your assessment of the two.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001528---marco"><em>[00:15:28]<!-- --> - Marco</em><a href="#001528---marco" class="hash-link" aria-label="Direct link to 001528---marco" title="Direct link to 001528---marco">​</a></h5><p>Yeah, I've looked at it a mean for a long time. It wasn't so much an extension. I think nowadays it is more or less an autonomous extension, I think. Yeah, I mean, it's somewhat more complex in a way. I don't feel like competitive of like you should use pg_cron or use pg_timetable. I think pg_cron is just intentionally simple such just this very simple thing that just works and does what you'd expect it to mean almost unless your time zone is in a different unless you're not in GMT, then it sort of doesn't quite do what you'd expect it to anyway. So yeah, I think Cron is just simpler. But if you need some more specific, I guess it comes down to do you need the extra features that pg_timetable adds? But I think for most people, pg_cron is good enough because you can also just I've also seen people do their own kind of job queues on top of pg_cron, where you just have this thing that runs. Every few seconds or every minute, and then looks are there some jobs to do? And it actually executes the stuff that's in the job state.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001639---marco"><em>[00:16:39]<!-- --> - Marco</em><a href="#001639---marco" class="hash-link" aria-label="Direct link to 001639---marco" title="Direct link to 001639---marco">​</a></h5><p>So it's kind of composable as well. You can build your own things on top if you want. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001645---ry"><em>[00:16:45]<!-- --> - Ry</em><a href="#001645---ry" class="hash-link" aria-label="Direct link to 001645---ry" title="Direct link to 001645---ry">​</a></h5><p>And especially if you could trigger it every second to check for work. Yeah, that's just fine. Yeah, I'm coming from my previous company was doing Apache Airflow and so it's like kind of getting back to some of the stuff. I mean, obviously that's a very complicated system with a lot of capabilities and dag like chaining of tasks and fanning out and all that kind of stuff. But yeah, I think it's interesting to try to do some of that stuff inside of Postgres without requiring we're trying to go with the mantra of like just use Postgres for everything.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001729---marco"><em>[00:17:29]<!-- --> - Marco</em><a href="#001729---marco" class="hash-link" aria-label="Direct link to 001729---marco" title="Direct link to 001729---marco">​</a></h5><p>It's not a bad mantra. You've got, I guess, different levels of commitment to that idea of how much of our backend can we shove into Postgres? And there's these GraphQL extensions where you pretty much put your entire backend in Postgres. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001751---ry"><em>[00:17:51]<!-- --> - Ry</em><a href="#001751---ry" class="hash-link" aria-label="Direct link to 001751---ry" title="Direct link to 001751---ry">​</a></h5><p>Your API, is there?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001752---marco"><em>[00:17:52]<!-- --> - Marco</em><a href="#001752---marco" class="hash-link" aria-label="Direct link to 001752---marco" title="Direct link to 001752---marco">​</a></h5><p>Yeah, I guess Supabase is going pretty long way in that direction, but at some point you want to debug stuff or you want to have certain rollout procedures. And sometimes Postgres is not as mature a tool as just shipping Python files somewhere. There's just better CI tools for most normal programming languages than for Postgres. So you have to find the right balance, I think.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001824---ry"><em>[00:18:24]<!-- --> - Ry</em><a href="#001824---ry" class="hash-link" aria-label="Direct link to 001824---ry" title="Direct link to 001824---ry">​</a></h5><p>Yeah, we're building and maybe this shouldn't have happened, but apparently yesterday we were working on a new FDW and I think it hit an exception that wasn't handled and it appeared to shut down the Postgres server. This is kind of fun. Should that have happened? Should that be possible? Should an extension error take it down? But we're still investigating that. But yeah, I think there's always risk with trying to do a lot inside, but I think with a mature extension that's well tested and battle tested, it should be. I mean, if you think about everything that's happening, there's no SRP in Postgres, right? It's not just doing one thing, it's got a vacuum. There's like lots of processes running and so then the question is, is it a sin to add one more thing? Especially if it has the capability to have a background worker? It's just like staring you in the face. Like use me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001929---marco"><em>[00:19:29]<!-- --> - Marco</em><a href="#001929---marco" class="hash-link" aria-label="Direct link to 001929---marco" title="Direct link to 001929---marco">​</a></h5><p>Like the extension APIs are slowly evolving from just a complete hacky approach for people to try out their Postgres batches before merging them into core. To some, I guess Extensibility was there from the start. But that's more too for custom types and custom functions than it is for planner hooks and background workers and those kind of things. Those are a little bit more what if we add this function pointer to see maybe extensions can do something interesting with it. And it's not very extremely well structured, but I mean the whole rust like pgrx and building extensions in rust, it does create an opportunity to have a little bit more of a well defined method of developing extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002025---ry"><em>[00:20:25]<!-- --> - Ry</em><a href="#002025---ry" class="hash-link" aria-label="Direct link to 002025---ry" title="Direct link to 002025---ry">​</a></h5><p>Yeah, I think what's interesting to me about Postgres is like the history of forks and it sucks to be on the true fork, as I'm sure you were aware. Creating the extension framework helps people out of the land of forks, but it does create the possibility for even more risk extensions in terms of all that. So it's like a double edged sword. I think it's great though, that to me is the reason why Postgres is doing so well now, is all that freedom that the core team has given the community in terms of how to use it. It's unprecedented, almost dangerous, but I also think empowering to developers who want to have some fun with their database.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002121---marco"><em>[00:21:21]<!-- --> - Marco</em><a href="#002121---marco" class="hash-link" aria-label="Direct link to 002121---marco" title="Direct link to 002121---marco">​</a></h5><p>Yeah, definitely. What we also often find is just an extension versus an external tool. At least we're sort of in the business of running a Postgres managed service. But even if you have just your own Postgres servers, it has a fairly straightforward deployment model, right? Like you don't have to create a whole separate cluster with its own configuration that connects to your Postgres database and does things with it. You just shove it into your existing Postgres server and it'll restart the background workers and you don't have to worry about all those things. It does have a lot of merit, actually, to develop a software as a Postgres extension. I mean, it comes with its own protocol. I think the most interesting thing is just like you get all this synergy between all these different extensions, that the sum of the parts is greater than the or what is it? The whole is greater than the sum of the parts. But also things like PostGIS and Citus, they kind of layer like you can distribute it, geospatial joins, whatever. But then also maybe you have some interesting function and you can run it periodically using pg_cron.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002239---marco"><em>[00:22:39]<!-- --> - Marco</em><a href="#002239---marco" class="hash-link" aria-label="Direct link to 002239---marco" title="Direct link to 002239---marco">​</a></h5><p>And it's like all these things kind of give you this little platform where you can just by running SQL queries, do increasingly interesting things. Maybe you have an FTW that does an Http call and you run it using pg_cron, for example. And now your Postgres server is not just pg_cron, is not just Postgres cron, it's actually anything cron. Like you can reach out to other systems. So that plugability.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002310---ry"><em>[00:23:10]<!-- --> - Ry</em><a href="#002310---ry" class="hash-link" aria-label="Direct link to 002310---ry" title="Direct link to 002310---ry">​</a></h5><p>I literally have a co-op that started last week and his first task was, I said create an FDW for this API and use pg_cron and ingest that data. And he's like, well, how do I do it? Just brand new to data warehousing in general, but he's got the FDW built and now he's working on if he has any problems, I'll send him your way. Kidding. I won't. Kidding, kidding. I won't do that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002341---marco"><em>[00:23:41]<!-- --> - Marco</em><a href="#002341---marco" class="hash-link" aria-label="Direct link to 002341---marco" title="Direct link to 002341---marco">​</a></h5><p>If there's bugs open issues like I'd like to know, of course.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002344---ry"><em>[00:23:44]<!-- --> - Ry</em><a href="#002344---ry" class="hash-link" aria-label="Direct link to 002344---ry" title="Direct link to 002344---ry">​</a></h5><p>But there's no bugs. No. So do you have any long flights coming up where you have some new extensions coming?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002351---marco"><em>[00:23:51]<!-- --> - Marco</em><a href="#002351---marco" class="hash-link" aria-label="Direct link to 002351---marco" title="Direct link to 002351---marco">​</a></h5><p>No, we had a baby last year. It's like my flight budget is very low at the moment. That's true.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002358---ry"><em>[00:23:58]<!-- --> - Ry</em><a href="#002358---ry" class="hash-link" aria-label="Direct link to 002358---ry" title="Direct link to 002358---ry">​</a></h5><p>Your latest extension is human.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002401---marco"><em>[00:24:01]<!-- --> - Marco</em><a href="#002401---marco" class="hash-link" aria-label="Direct link to 002401---marco" title="Direct link to 002401---marco">​</a></h5><p>Yeah, but yeah, I'd like to play more with Rust because that the problem with extensions in the past. Like developing them in C has always been like c doesn't have any good sort of dependency framework. There's these old established library like, I don't know, LibZ and LibXML or something, like something that was developed 20 years ago and now, okay, every system has it, you can use it, but for anything newer than ten years, it's extremely annoying and hard to use a C library. And then even if you can figure out your configure and your make files, the memory allocation is probably going to not play nicely with Postgres. So that's where Rust is kind of interesting. Now there's this whole ecosystem of open source libraries that can potentially become extensions and we're still sort of at the very start of that, what's going to happen?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002505---ry"><em>[00:25:05]<!-- --> - Ry</em><a href="#002505---ry" class="hash-link" aria-label="Direct link to 002505---ry" title="Direct link to 002505---ry">​</a></h5><p>It's kind of scary because it could be very much of a Cambrian explosion. What happens if there are 300 new extensions that are worth adding? It's sort of a pain for the managed service providers.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002519---marco"><em>[00:25:19]<!-- --> - Marco</em><a href="#002519---marco" class="hash-link" aria-label="Direct link to 002519---marco" title="Direct link to 002519---marco">​</a></h5><p>Yeah, definitely. Yeah. And they can have funny incompatibilities. It helps that then Rust is a little bit more safe and a little bit more not managed, but the memory allocation is a bit more sort of safe as well. But then, yeah, you can have a lot of weird bugs if you combine all these unknown bits of code.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002546---ry"><em>[00:25:46]<!-- --> - Ry</em><a href="#002546---ry" class="hash-link" aria-label="Direct link to 002546---ry" title="Direct link to 002546---ry">​</a></h5><p>That's great. Are there any extensions that you've run across either recently or in the past that you love, that you would mention as exciting? I mean, you mentioned PostGIS and anything else that you can think of. It's no big deal if not.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002604---marco"><em>[00:26:04]<!-- --> - Marco</em><a href="#002604---marco" class="hash-link" aria-label="Direct link to 002604---marco" title="Direct link to 002604---marco">​</a></h5><p>Yeah, there's many. I'm sort of intrigued by Postgres_ML. It's like this just machine learning extension that they seem to be doing a lot of interesting things. I don't have a good use case for it myself yet, but I really like what you're doing. Also in Rust, I think MIT licensed, so it can be used in a lot of places. There's of course a lot of buzz around pg_vector and more recently pg_embedding, which is sort of an interesting kind of development because now I think they both added this HNSW indexes which are faster than the IFV flat indexes that pgvector provided. But then it also means they are now incompatible with the latest versions. You can create one or the other, not both, which is a little awkward. But I think that is where, of course, one of the most fastest moving areas and I think some of these things will be figured out.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002706---ry"><em>[00:27:06]<!-- --> - Ry</em><a href="#002706---ry" class="hash-link" aria-label="Direct link to 002706---ry" title="Direct link to 002706---ry">​</a></h5><p>Have you gotten those extensions added to the Citus managed service?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002711---marco"><em>[00:27:11]<!-- --> - Marco</em><a href="#002711---marco" class="hash-link" aria-label="Direct link to 002711---marco" title="Direct link to 002711---marco">​</a></h5><p>Yeah, we definitely have pg_vector. Yeah, I mean, I think that took the landscape by storm. I think they're pretty much on every managed service now.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002719---ry"><em>[00:27:19]<!-- --> - Ry</em><a href="#002719---ry" class="hash-link" aria-label="Direct link to 002719---ry" title="Direct link to 002719---ry">​</a></h5><p>It's interesting, we're working on this thing called Trunk where we're trying to maybe I don't know if we can get you guys to participate, but the idea would be to send some metadata to some sort of central repository that we'd know, like which extensions are trending, waning, completely dead or not. I just think it's interesting as a new person coming into the Postgres ecosystem, there's just this library of potential extensions that it's pretty expansive and kind of trails off in a know because you can find them loosely here or there on GitHub. But I think having a better directory of them would be good for the community.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002804---marco"><em>[00:28:04]<!-- --> - Marco</em><a href="#002804---marco" class="hash-link" aria-label="Direct link to 002804---marco" title="Direct link to 002804---marco">​</a></h5><p>Yeah, I guess. One thing that's also tricky about extensions, it's like you'd want it in an ideal world, you write it once and then it works forever. In the real world, every Postgres version potentially breaks your extension, so someone has to actually go and fix it. For new Postgres versions, sometimes it's okay. I think with pg_cron, I had like once or twice. It's like I think Postgres 16 didn't actually no, it did require some fixes. I think there was one Postgres version which didn't require any fixes. Maybe PG 15, I was already happy. But usually C is a bit of this wild west of programming languages. But yeah, sometimes just some function header changes, there's an extra argument and then none of the extensions that use that function compile you have to have some level of maintenance behind each extension. Well, not every extension does well. Great.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002903---ry"><em>[00:29:03]<!-- --> - Ry</em><a href="#002903---ry" class="hash-link" aria-label="Direct link to 002903---ry" title="Direct link to 002903---ry">​</a></h5><p>I mean, it was great to chat with you. Happy to have you back on again. If you have a big new release of Citus, I don't know, do you guys have any big plans for it or has it reached a certain point of stability where it is what it is? Yeah, I'm kind of curious.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002919---marco"><em>[00:29:19]<!-- --> - Marco</em><a href="#002919---marco" class="hash-link" aria-label="Direct link to 002919---marco" title="Direct link to 002919---marco">​</a></h5><p>Well, our most recent major release added this kind of notion of Schema based Sharding, where so far it's always been like you have distributed tables and you have a distribution column and you need to pick which columns you use. But the Schema based Sharding is just like every Schema becomes its own group, own Shard, essentially, so it might be on a different node. So for apps that use Schema per tenant, that's a very nice model. And so we're investing more in that at the moment.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002949---ry"><em>[00:29:49]<!-- --> - Ry</em><a href="#002949---ry" class="hash-link" aria-label="Direct link to 002949---ry" title="Direct link to 002949---ry">​</a></h5><p>Well, great. Good to meet you. Looking forward to continuing to get to know you. And thanks for joining us on the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002956---marco"><em>[00:29:56]<!-- --> - Marco</em><a href="#002956---marco" class="hash-link" aria-label="Direct link to 002956---marco" title="Direct link to 002956---marco">​</a></h5><p>Yeah, it was great. Thanks for having me.</p>]]></content:encoded>
            <author>noreply@tembo.io (Eric Ankenman)</author>
            <category>postgres</category>
            <category>hacking_postgres</category>
        </item>
        <item>
            <title><![CDATA[Introducing Terraform Provider for Tembo]]></title>
            <link>https://tembo.io/blog/introducing-terraform-provider-for-tembo</link>
            <guid>https://tembo.io/blog/introducing-terraform-provider-for-tembo</guid>
            <pubDate>Tue, 10 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[tembo-terraform-provider]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" alt="tembo-terraform-provider" src="/assets/images/tembo-terraform-provider-1f558963ff1cc4e5c8174935be971505.png" width="1408" height="1402" class="img_ev3q"></p><p>At Tembo, we want to empower developers to build fast. That’s why we built the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Provider for Tembo Cloud</a>, allowing developers to manage Postgres resources using Infrastructure-as-Code (IaC). In this blog, we'll explore the Terraform Provider for Tembo and how it can help you streamline database management while keeping teams agile, accountable and enforcing organizational policies.</p><p>Simpler, faster, safer, and easier? That’s Tembo - but let’s back up and start at the beginning.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-tembo-cloud">What is Tembo Cloud?<a href="#what-is-tembo-cloud" class="hash-link" aria-label="Direct link to What is Tembo Cloud?" title="Direct link to What is Tembo Cloud?">​</a></h2><p><a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> is a developer-first, fully-extensible, fully-managed, secure, and scalable Postgres service. It not only simplifies Postgres management but also provides specialized Postgres deployments through <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">Tembo Stacks</a>, catering to various use cases.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="database-as-code-using-terraform">Database as Code using Terraform<a href="#database-as-code-using-terraform" class="hash-link" aria-label="Direct link to Database as Code using Terraform" title="Direct link to Database as Code using Terraform">​</a></h2><p>Databases as code provides a safe, consistent, and repeatable way of managing databases and is a game-changer for developers. This approach allows you to version-control any changes, ensuring auditability, and facilitates efficient workflows such as Pull Request flows and <a href="https://about.gitlab.com/topics/gitops/" target="_blank" rel="noopener noreferrer">GitOps</a>.</p><p>Terraform is the most popular Infrastructure as Code tool today. It provides a way to define the desired state of your infrastructure using Hashicorp Configuration Language(HCL). Terraform handles all the complexity of making sure that when changes are applied, the actual state matches the desired state. Therefore, it is an efficient way of managing databases as code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-terraform-provider-for-tembo">Using Terraform Provider for Tembo<a href="#using-terraform-provider-for-tembo" class="hash-link" aria-label="Direct link to Using Terraform Provider for Tembo" title="Direct link to Using Terraform Provider for Tembo">​</a></h2><p>With the Terraform Provider for Tembo, you can manage Postgres databases on Tembo Cloud with all the benefits mentioned in the previous section. You can find the Terraform Provider for Tembo on the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Registry</a> along with <a href="https://registry.terraform.io/providers/tembo-io/tembo/latest/docs/resources/" target="_blank" rel="noopener noreferrer">the documentation</a>, and the Github repo is <a href="https://github.com/tembo-io/terraform-provider-tembo" target="_blank" rel="noopener noreferrer">here</a>. A new Postgres instance can be provisioned on Tembo Cloud in about 1 minute and destroying an instance takes just 10 seconds.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-terraform-file">Example Terraform file<a href="#example-terraform-file" class="hash-link" aria-label="Direct link to Example Terraform file" title="Direct link to Example Terraform file">​</a></h3><p>You can create a new Tembo instance on Tembo Cloud using the <code>tembo_instance</code> resource available with the provider. Below is an example configuration.</p><p><strong>Note:</strong> Tembo Terraform Provider needs an <code>access_token</code> to authenticate with the API. Generate a long-lived API token by following steps <a href="https://tembo.io/docs/tembo-cloud/security-and-authentication/api-authentication#create-a-long-lived-api-token" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tembo = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source = "tembo-io/tembo"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = "&gt;= 0.1.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider "tembo" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access_token = var.access_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable "access_token" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource "tembo_instance" "test_instance" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_name = "test-instance"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  org_id        = "org_test" # Replace this with your Tembo organization id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cpu           = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stack_type    = "Standard"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment   = "dev"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory        = "4Gi"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage       = "10Gi"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas      = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extensions = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name        = "plperl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = "PL/Perl procedural language"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locations = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      database = "app"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      schema   = "public"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version  = "1.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled  = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        database = "postgres"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        schema   = "public"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        version  = "1.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output "instance" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = tembo_instance.test_instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Applying the above Terraform will provision a Postgres Instance on Tembo Cloud. For a demo explaining the steps watch the video below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="demo">Demo<a href="#demo" class="hash-link" aria-label="Direct link to Demo" title="Direct link to Demo">​</a></h2><p>The demo in the video explains how to use the Terraform Provider for Tembo. The Terraform code used in the video can be found <a href="https://github.com/tembo-io/terraform-provider-tembo/tree/main/examples/resource-creation" target="_blank" rel="noopener noreferrer">here</a>.</p><div style="width:640px;height:360px"></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next-for-the-provider">What’s next for the Provider<a href="#whats-next-for-the-provider" class="hash-link" aria-label="Direct link to What’s next for the Provider" title="Direct link to What’s next for the Provider">​</a></h2><p>We are actively working on an Import feature that will allow you to import existing Tembo instances to Terraform to easily start managing existing instances with Terraform. Stay updated by starring our <a href="https://github.com/tembo-io/terraform-provider-tembo" target="_blank" rel="noopener noreferrer">GitHub repository</a> and monitoring changes on the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Registry</a>. Most importantly, please try it out, and <a href="https://github.com/tembo-io/terraform-provider-tembo/issues" target="_blank" rel="noopener noreferrer">file any issues and feature requests in our repository</a>. You can also access the documentation for the Tembo provider <a href="https://registry.terraform.io/providers/tembo-io/tembo/latest/docs" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adarsh Shah)</author>
            <category>postgres</category>
            <category>announcement</category>
            <category>terraform</category>
            <category>infrastructure_as_code</category>
        </item>
        <item>
            <title><![CDATA[Unlocking value from your Clerk User Management platform with Postgres]]></title>
            <link>https://tembo.io/blog/clerk-fdw</link>
            <guid>https://tembo.io/blog/clerk-fdw</guid>
            <pubDate>Tue, 03 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[The maxim of building a product is to know your user. However, any company big or small will often have user data spread around in various systems. A data platform team will often deploy various pipelines that can sync data from various sources into a data warehouse. As an alternative, Postgres supports the concept of a Foreign Data Wrapper. Let’s dive into what this is and how it can help us.]]></description>
            <content:encoded><![CDATA[<p>The maxim of building a product is to know your user. However, any company big or small will often have user data spread around in various systems. A data platform team will often deploy various pipelines that can sync data from various sources into a data warehouse. As an alternative, Postgres supports the concept of a Foreign Data Wrapper. Let’s dive into what this is and how it can help us.</p><p>In this blog, we'll look at <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a>—a tool that bridges the gap between <a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a>, a leading user management solution, and your very own Postgres Database. By the end, you'll discover how this integration can empower you to make data-driven decisions, optimize your pricing strategy, and refine your market approach. Let's get started!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-a-foreign-data-wrapper">What’s a Foreign Data Wrapper?<a href="#whats-a-foreign-data-wrapper" class="hash-link" aria-label="Direct link to What’s a Foreign Data Wrapper?" title="Direct link to What’s a Foreign Data Wrapper?">​</a></h2><p>A foreign data wrapper is an extension available in PostgreSQL that allows you to bring ‘foreign data’ (i.e. data in a different Postgres DB, a different database like DB2, or even a different kind of data source, like an API) and query it the same way you would query a normal Postgres table. They are particularly useful when your data may be segregated into different databases, but are still related in ways that you could gather some useful information from them. In building a foreign data wrapper for Clerk.com, we have used <a href="https://supabase.github.io/wrappers/" target="_blank" rel="noopener noreferrer">Supabase Wrappers</a> that make it easier to build Foreign Data Wrappers and interact with third-party data using SQL.</p><p>If you should take something away from this blog, is that Postgres’ Foreign Data Wrappers are a great tool to build an analytics platform based on Postgres. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-clerk">What’s Clerk?<a href="#whats-clerk" class="hash-link" aria-label="Direct link to What’s Clerk?" title="Direct link to What’s Clerk?">​</a></h2><p><a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a> is a user management tool. With Clerk, users experience a seamless sign-up and sign-in flow, whether they prefer using email, SMS, or even their favorite social media accounts. Its versatility and developer-friendly APIs make it an excellent choice for us at Tembo for both efficiency and a superior user experience.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-power-of-integration">The Power of Integration<a href="#the-power-of-integration" class="hash-link" aria-label="Direct link to The Power of Integration" title="Direct link to The Power of Integration">​</a></h2><p>Being able to access data from a User Management Tool like Clerk as part of your data platform is especially useful because it enables you to have a 360-degree view of the user experience on your product, without having to set up any complex data export pipelines from Clerk into other systems.</p><p>In fact, we built <code>clerk_fdw</code> at Tembo to address needs in our internal analytics pipeline . Here are some of the ways we are using it:</p><ul><li>Run advanced analytics that combine internal data with user data from Clerk.</li><li>Understand user interaction patterns with our product.</li><li>Identify and engage with top users.</li></ul><p><img loading="lazy" alt="clerk" src="/assets/images/clerk-flowchart-ecda66b28a07b45684d4932e0aac931a.png" title="clerk_fdw structure" width="1345" height="1158" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-clerk_fdw">Setting up <code>clerk_fdw</code><a href="#setting-up-clerk_fdw" class="hash-link" aria-label="Direct link to setting-up-clerk_fdw" title="Direct link to setting-up-clerk_fdw">​</a></h2><p>The first step would be installing the <code>clerk_fdw</code> extension. You can <a href="https://tembo-io.github.io/trunk/#trunk-install" target="_blank" rel="noopener noreferrer">install this extension using trunk</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> clerk_fdw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The next step would be to enable the extension in your postgres instance. You can do so using the following command:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> clerk_fdw</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-foreign-data-wrapper-for-clerk">Create the foreign data wrapper for clerk<a href="#create-the-foreign-data-wrapper-for-clerk" class="hash-link" aria-label="Direct link to Create the foreign data wrapper for clerk" title="Direct link to Create the foreign data wrapper for clerk">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">handler</span><span class="token plain"> clerk_fdw_handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validator clerk_fdw_validator</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connect-to-clerk-using-your-credentials">Connect to Clerk using your credentials<a href="#connect-to-clerk-using-your-credentials" class="hash-link" aria-label="Direct link to Connect to Clerk using your credentials" title="Direct link to Connect to Clerk using your credentials">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api_key </span><span class="token string" style="color:#e3116c">'&lt;clerk secret Key&gt;'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-foreign-table">Create Foreign Table:<a href="#create-foreign-table" class="hash-link" aria-label="Direct link to Create Foreign Table:" title="Direct link to Create Foreign Table:">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="user-table">User table<a href="#user-table" class="hash-link" aria-label="Direct link to User table" title="Direct link to User table">​</a></h4><p>This table will store information about the users.</p><blockquote><p>Note: The current limit is 500 users. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_users </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  first_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gender </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_sign_in_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  phone_numbers </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      object </span><span class="token string" style="color:#e3116c">'users'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="organization-table">Organization Table<a href="#organization-table" class="hash-link" aria-label="Direct link to Organization Table" title="Direct link to Organization Table">​</a></h4><p>This table will store information about the organizations.</p><blockquote><p>Note: The current limit is 500 organizations. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organizations </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slug </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_by </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">'organizations'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="junction-table">Junction Table<a href="#junction-table" class="hash-link" aria-label="Direct link to Junction Table" title="Direct link to Junction Table">​</a></h4><p>This table connects the <code>clerk_users</code> and <code>clerk_orgs</code>. It lists out all users and their roles in each organization.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organization_memberships </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">'organization_memberships'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dive-into-the-data">Dive into the Data<a href="#dive-into-the-data" class="hash-link" aria-label="Direct link to Dive into the Data" title="Direct link to Dive into the Data">​</a></h2><p>Now you can query through your database and get useful information like:</p><ul><li>How many organizations have been created each week in the past</li><li>How many users have signed up in the past 30 days</li><li>What organizations is a user part of</li><li>All users and their roles in an organization</li><li>And more….</li></ul><p>Here are some of the charts we were able to make from the clerk foreign data wrapper using some synthetic data.</p><p><img loading="lazy" alt="chart1" src="/assets/images/chart1-f041e3a0ece55d964478a2e23fffc37d.png" title="Daily New Signups" width="582" height="356" class="img_ev3q">
<img loading="lazy" alt="chart2" src="/assets/images/chart2-c1ad7d55ca70c351cda145b80752bf19.png" title="Total Organizations" width="581" height="351" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In conclusion, we believe that Postgres’ concept of Foreign Data Wrappers is more than just a technical integration—it's a game-changer that allows Postgres users to build data warehouse platforms that reach across all data sources in the business. It paves the way for businesses to harness critical insights directly from their operational databases, making informed decisions easier than ever before. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><p>Give us a star and try out <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a> by running the example in the README. If you hit any snags, please create an issue. We would greatly welcome contributions to the project as well.</p>]]></content:encoded>
            <author>noreply@tembo.io (Jay Kothari)</author>
            <category>postgres</category>
            <category>extensions</category>
        </item>
        <item>
            <title><![CDATA[Version History and Lifecycle Policies for Postgres Tables]]></title>
            <link>https://tembo.io/blog/table-version-history</link>
            <guid>https://tembo.io/blog/table-version-history</guid>
            <pubDate>Fri, 29 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[back-in-time]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" alt="back-in-time" src="/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg" width="788" height="453" class="img_ev3q"></p><p>A nice feature of AWS S3 is version history and lifecycle policies. When objects are updated or deleted, the old object version remains in the bucket, but it’s hidden. Old versions are deleted eventually by the lifecycle policy.</p><p>I would like something like that for my Postgres table data. <strong>We can use the temporal_tables extension for version history, and combine it with pg_partman to partition by time, automatically expiring old versions.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-model">Data model<a href="#data-model" class="hash-link" aria-label="Direct link to Data model" title="Direct link to Data model">​</a></h2><p>Let's say we have a table <strong>employees</strong>, and it looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |  7000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will add one more column to this table, <code>sys_period</code>, which is a time range. This time range represents "since when" is this row the current version. This range is unbounded on the right side, because all the rows in the <strong>employees</strong> table are the present version.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | ["2023-09-28 13:30:19.24318+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | ["2023-09-28 13:33:58.735932+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | ["2023-09-28 13:33:58.738827+00",)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will make a new table <strong>employees_history</strong> to store previous versions. This will have the same columns as the <strong>employees</strong> table, but all the rows in <code>sys_period</code> are bounded on the the right and the left sides. These ranges represent when this row was the current version. We will configure <strong>temporal_tables</strong> to automatically create these rows when anything changes in the <strong>employees</strong> table.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | ["2023-09-28 13:30:19.18544+00","2023-09-28 13:33:58.683279+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | ["2023-09-28 13:33:58.683279+00","2023-09-28 13:33:58.731332+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | ["2023-09-28 13:33:58.731332+00","2023-09-28 13:33:58.735932+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | ["2023-09-28 13:30:19.239152+00","2023-09-28 13:33:58.738827+00")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To automatically delete old versions, we'll add one more column to the <strong>employees_table</strong>, <code>created_at</code>. We will use this information to expire old versions after they are older than our retenion configuration, with the help of <strong>pg_partman</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally. I've followed that guide to set up my environment with <strong>temporal_tables</strong> and <strong>pg_partman</strong>.</p><p>I have a Dockefile, two SQL scripts, and a file with Postgres configurations.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 0_startup.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 1_create_versioned_table.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── custom.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Dockerfile:</strong> We use <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a> to install pg_partman and temporal_tables. Then, we copy the three other files into the image.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install pg_partman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install temporal_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 0_startup.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 1_create_versioned_table.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY custom.conf $PGDATA/extra-configs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>0_startup.sql:</strong> Enables temporal_tables and pg_partman when Postgres starts.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> temporal_tables</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_partman</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>1_create_versioned_table.sql:</strong> Creates a sample table, then enables version history on it.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Sample: an existing table we want to enable versioning on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  department </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Adding version history to the table,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">first we need to add a time range to the existing table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">This represents "since when" has this row been current.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> sys_period tstzrange </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Creating a time-partitioned version table</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">each row has the range the data was valid for,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">and also the time this version was created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> employees INCLUDING DEFAULTS EXCLUDING INDEXES EXCLUDING CONSTRAINTS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at timestamptz </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Allow efficient querying of partition key and name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Enable automatic partitioning with pg_partman, partitioning every 1 minute.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It's more realistic to partition daily or greater.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> create_parent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'public.employees_history'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'created_at'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'native'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1 minute'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- This connects employees table to employees_history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> versioning_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEFORE </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR EACH ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> versioning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'sys_period'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token string" style="color:#e3116c">'employees_history'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Configure retention policy for employee history to keep old versions for 10 minutes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It's more realistic to configure retention for 1 year.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'10 minutes'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        infinite_time_partitions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'public.employees_history'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>custom.conf:</strong> our additions to the Postgres configuration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Enable pg_partman background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shared_preload_libraries = 'pg_partman_bgw'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many seconds between pg_partman background worker runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It's more realistic to run every 3600 seconds, or longer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.interval = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Which database pg_partman should target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.dbname = 'postgres'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It's best practice to use limited permissions for the background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_partman_bgw.role = 'limitedrole'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This was helpful when I was working on getting the settings working</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log_min_messages = 'DEBUG1'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With those four files in place, we can run Postgres like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it -d --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In a separate shell, I connect into the Postgres container.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">psql postgres://postgres:postgres@localhost:5432</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-demo-of-saving-old-versions">Basic demo of saving old versions<a href="#basic-demo-of-saving-old-versions" class="hash-link" aria-label="Direct link to Basic demo of saving old versions" title="Direct link to Basic demo of saving old versions">​</a></h2><p>After we are set up, we have version history and retention policy configured on the <strong>employees</strong> table, but both the <strong>employees</strong> table and the <strong>employees_history</strong> table are empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Adding data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Hatchery and Conditioning Centre'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Lenina Crowne'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Hatchery and Conditioning Centre'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Helmholtz Watson'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'College of Emotional Engineering'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees</strong> has some data, and <strong>employees_history</strong> is still empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |   salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+-----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     |  10000.00 | ["2023-09-28 20:23:14.840624+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |   7000.00 | ["2023-09-28 20:23:14.911528+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson |  18500.00 | ["2023-09-28 20:23:14.913555+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modifying data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11200</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11400</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11601</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Lenina Crowne'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees_history</strong> table has past versions.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | ["2023-09-28 20:23:14.913555+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | ["2023-09-28 20:23:50.731597+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | ["2023-09-28 20:23:50.734214+00",)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | ["2023-09-28 20:23:14.840624+00","2023-09-28 20:23:50.684293+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | ["2023-09-28 20:23:50.684293+00","2023-09-28 20:23:50.727283+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | ["2023-09-28 20:23:50.727283+00","2023-09-28 20:23:50.731597+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | ["2023-09-28 20:23:14.911528+00","2023-09-28 20:23:50.734214+00")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(4 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="looking-up-past-versions">Looking up past versions<a href="#looking-up-past-versions" class="hash-link" aria-label="Direct link to Looking up past versions" title="Direct link to Looking up past versions">​</a></h2><p>Let's say we want to look up Bernard's salary at a previous date. We can check the <strong>employees_history</strong> table to find the row where the time range matches our provided timestamp. However, this wouldn't find the correct salary if we provide a timestamp that is after the most recent update to Bernard's salary, since that row is in the <strong>employees</strong> table.</p><p>We can first create a <a href="https://www.postgresql.org/docs/current/tutorial-views.html" target="_blank" rel="noopener noreferrer">view</a> for this purpose. We only need to do this once, then we can query this view like a table going forward.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VIEW</span><span class="token plain"> employee_history_view </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we can use this query to find Bernard's salary at any given date.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">'2023-09-28 20:23:30+00'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>@&gt;</code> Is a <em>containment operator</em> and you might recognize it if you have used <a href="https://tembo.io/docs/postgres_guides/postgres-basics/jsonb" target="_blank" rel="noopener noreferrer">JSONB</a>.</p><p>Comparing to the <strong>employees_history</strong> table shown above, it is returning the correct value.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also works to look up the current salary:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If I try to query a salary from the future, it will return the current salary. If I try to query a salary from before Bernard is known in the <strong>employees_history</strong> table, then I get an empty result.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partitioning">Partitioning<a href="#partitioning" class="hash-link" aria-label="Direct link to Partitioning" title="Direct link to Partitioning">​</a></h2><p><strong>What is partitioning?</strong> <a href="https://www.postgresql.org/docs/current/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">Postgres documentation</a> has detailed information on partitioning but just to summarize, partitioning is about splitting what is logically one large table into smaller tables. Typically, this is done for query performance. In our case, <strong>we are partitioning to expire old versions.</strong></p><p>Partitioning tables is something I’m familiar with from Tembo’s work in <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, which is a queueing extension for Postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writes">Writes<a href="#writes" class="hash-link" aria-label="Direct link to Writes" title="Direct link to Writes">​</a></h3><p>We should expect write performance to be slower, since we are writing to two tables for every update.</p><p>I created a new table that does not have versioning enabled to compare write performance.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a table like employees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ...and insert one row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees_write_test </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Hatchery and Conditioning Centre'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tstzrange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, I used <code>EXPLAIN ANALYZE</code> to compare the write performance. I ran the query a few times for each.</p><p><strong>Without versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11608</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.654 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.540 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.760 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.079 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>With versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11610</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.423 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=2.430 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 4.783 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.311 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.091 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.979 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.825 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.711 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 5.686 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It's more than twice as slow on a single update. That's because we have to write to two rows instead of one, there is more data to write (the time ranges), and because there is some additional processing, for instance determining which range to put on each row. In the next section, I also compare how much time it takes to write 100,000 rows in each of these tables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reads">Reads<a href="#reads" class="hash-link" aria-label="Direct link to Reads" title="Direct link to Reads">​</a></h3><p>We created a view which is a union between <strong>employees</strong> and <strong>employees_history</strong>, then we query the view to find an employee's salary at a given time.</p><p>To generate some data, let's make a procedure to update a salary 100,000 times in a row. The below example uses <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>. By default, PL/pgSQL functions run as a single transaction, so it would only result in a single update to the <strong>employees_history</strong> table. For this reason, I am using a procedure with <code>COMMIT</code> so that each increment will be a separate transaction, this way we also get 100,000 updates to the <strong>employees_history</strong> table. I had to explain that nuance to chatGPT in order for this procedure to be produced properly.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Table name and employee name as inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to get the current salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'SELECT salary FROM %I WHERE name = $1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> v_salary </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Loop 100 thousand times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Increment the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_salary :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v_salary </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to update the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'UPDATE %I SET salary = $2 WHERE name = $1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_salary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Commit the transaction, triggering the versioning procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'employees'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This took 55 seconds to run on my laptop. I also tried it on the table without versioning enabled, at in this case it took 38 seconds. I ran it a couple more times on the table with versioning enabled, so that the versions would be distributed across multiple partitions. Now we have an <strong>employees_history</strong> table that's populated with many rows for Bernard.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let's run the same type of query command we ran before, with <code>EXPLAIN ANALYZE</code>. I picked a timestamp that will not be found to ensure it's as slow as possible.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bernard Marx'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">'2023-09-28 15:28:25+00'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Simplified query plan output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Append</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Bitmap Heap Scan on employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Recheck Cond: (name = 'Bernard Marx'::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: (sys_period @&gt; '...')</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Heap Blocks: exact=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Bitmap Index Scan on employees_pkey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Index Cond: (name = 'Bernard Marx'::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; '...') AND (name = 'Bernard Marx'::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; '...') AND (name = 'Bernard Marx'::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 99969</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0035</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; '...') AND (name = 'Bernard Marx'::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 97393</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0036</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; '...') AND (name = 'Bernard Marx'::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 102607</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 12.427 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 262.706 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(47 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query took 263 milliseconds. We notice this query needs to scan all partitions, because we are partitioning by <code>created_at</code>, and querying <code>sys_period</code>. We can improve the speed with indexes.</p><p>If this was a real workload, I doubt that employees' salaries are being updated so frequently, or at least that's been the case in my personal experience. However, if it's a big company, then there could be a lot of employees. In that case, it would be best to add an index on the name (or more realistically, employee ID) in the <strong>employees_history</strong> table. Then, withing each partition it will find only rows for the employee being queryed using the index, then it would scan the remaining rows, probably typically zero, one, or two rows, to find the correct salary.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expiring-old-versions">Expiring old versions<a href="#expiring-old-versions" class="hash-link" aria-label="Direct link to Expiring old versions" title="Direct link to Expiring old versions">​</a></h2><p>Earlier in this blog, we configured <strong>pg_partman</strong> to partition in 1 minute increments, to expire partitions that are older than 15 minutes, and to check every 30 seconds. Every 30 seconds, any partition that is older that 15 minutes is deleted by the <strong>pg_partman</strong> background worker.</p><p>With this query, I can check how many rows and the total data size in each partition.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- This query was produced by ChatGPT 4 with the prompt:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- "How can I check the number of rows in each partition of employees_history?"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_total_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> total_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_live_tup </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_inherits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class parent </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhparent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class child </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhrelid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'employees_history'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to check that old versions are being dropped, I ran the procedure to create a lot of salaray increments several times in a row.</p><p>Then, running the above query, I find an output like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2204 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2205 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2206 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13180928 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     868352 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this output, we can see that we have 1 partition for every minute, and a total of 15 partitions. I have old versions expiring after 10 minutes. I thought it's interesting to note that <strong>pg_partman</strong> is preemptively creating partitions for the future, in this case 5 minutes into the future.</p><p>If you refer to the original set up steps, I have configured <code>infinite_time_partitions = true</code>, and this means we will generate partitions even when we are not generating any data for them. I think this is the proper configuration since we also have a retention policy that will drop the old partitions. The concern of making infinite partitions as time passes, even if no data is being generated, is not applicable because old tables are being dropped.</p><p>To confirm data was being deleted, I sampled the above query over time, and we can see the large body of inserts moving up into the oldest available partitions, then falling outside of the retention policy and being deleted.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 131733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2229 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="thanks">Thanks!<a href="#thanks" class="hash-link" aria-label="Direct link to Thanks!" title="Direct link to Thanks!">​</a></h2><p>If you got this far, thank you for reading this! I hope that you are inspired to try out extensions on your own and see what they can do. The next time you have some problem to solve with your data, consider that maybe it could just be handled by a Postgres extension.</p><p>If you want to try extensions without any local setup, you should try Tembo Cloud at <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">cloud.tembo.io</a>.</p><p>Just use Postgres!</p>]]></content:encoded>
            <author>noreply@tembo.io (Steven Miller)</author>
            <category>postgres</category>
            <category>extensions</category>
            <category>temporal_tables</category>
            <category>pg_partman</category>
            <category>trunk</category>
        </item>
        <item>
            <title><![CDATA[Anatomy of a Postgres extension written in Rust: pgmq]]></title>
            <link>https://tembo.io/blog/postgres-extension-in-rust-pgmq</link>
            <guid>https://tembo.io/blog/postgres-extension-in-rust-pgmq</guid>
            <pubDate>Thu, 28 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In my previous submission to this space, I described my experience with pgmq while using the Python library. In this post, I'll share what I found after inspecting the code.]]></description>
            <content:encoded><![CDATA[<p>In my <a href="https://tembo.io/blog/pgmq-with-python" target="_blank" rel="noopener noreferrer">previous submission</a> to this space, I described my experience with <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a> while using the Python library. In this post, I'll share what I found after inspecting the code.</p><p>So, first, I'll describe the general structure of the project. Then, I'll explain what happens when we install the pgmq extension. Finally, I'll describe how some of its functions work.</p><p>In this post, I'll be using version v0.25.0, which you can find <a href="https://github.com/tembo-io/pgmq/releases/tag/v0.25.0" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure">​</a></h2><p>After cloning the appropriate tag, we can see that the repository contains the following files:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTRIBUTING.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dockerfile.build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tembo-pgmq-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tests</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The project uses <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">pgrx</a>. From pgrx's <a href="https://github.com/pgcentralfoundation/pgrx/blob/develop/README.md" target="_blank" rel="noopener noreferrer">README</a>, we know that the relevant files for the extension are <code>Cargo.toml</code>, <code>pgmq.control</code> and the <code>src</code> and <code>sql</code> directories:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tree sql src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.11.1--0.11.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.0--0.8.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.1--0.9.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── errors.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── metrics.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── partition.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── sql_src.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── util.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> directories, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-the-pgmq-extension">Installing the pgmq extension<a href="#installing-the-pgmq-extension" class="hash-link" aria-label="Direct link to Installing the pgmq extension" title="Direct link to Installing the pgmq extension">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This section assumes that you have successfully installed the pre-requisites as described in <a href="https://github.com/tembo-io/pgmq/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">CONTRIBUTING.md</a></p></div></div><p>To build the pgmq extension, we can do the following:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, to build and install the pgmq extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In either case, we can see a shared library <code>pgmq.so</code> being created. The installation process also places the shared library in the <code>lib</code> directory of the postgres installation; and the sql files and the control file in the <code>extensions</code> directory. In my case:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/share/extension/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/lib/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/lib/pgmq.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To test the extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and it'll start a <code>psql</code> prompt. In the prompt, we can execute the <code>create extension</code> statement to start using pgmq:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Enable pgmq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension pgmq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will look something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# create extension pgmq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |                             Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq    | 0.25.0  | public     | A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also list the available functions:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List available functions under pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\df pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \df pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                         List of functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |          Name          |                                                                         Result data type                                                                         |                                                 Argument data types                                                  | Type </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | TABLE(archive boolean)                                                                                                                                           | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create                 | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_non_partitioned | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_partitioned     | void                                                                                                                                                             | queue_name text, partition_interval text DEFAULT '10000'::text, retention_interval text DEFAULT '100000'::text       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | TABLE(delete boolean)                                                                                                                                            | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | drop_queue             | boolean                                                                                                                                                          | queue_name text, partitioned boolean DEFAULT false                                                                   | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | list_queues            | TABLE(queue_name text, created_at timestamp with time zone)                                                                                                      |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics                | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics_all            | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | pop                    | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | purge_queue            | bigint                                                                                                                                                           | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read                   | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, "limit" integer                                                                         | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read_with_poll         | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, "limit" integer, poll_timeout_s integer DEFAULT 5, poll_interval_ms integer DEFAULT 250 | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send                   | bigint                                                                                                                                                           | queue_name text, message jsonb, delay integer DEFAULT 0                                                              | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send_batch             | TABLE(msg_id bigint)                                                                                                                                             | queue_name text, messages jsonb[], delay integer DEFAULT 0                                                           | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | set_vt                 | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, msg_id bigint, vt_offset integer                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(18 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this, we can now explore the extension from the inside. And, if needed, recompile and reinstall the extension to play with it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-internals">The internals<a href="#the-internals" class="hash-link" aria-label="Direct link to The internals" title="Direct link to The internals">​</a></h2><p>We know that when an extension is created with pgrx, it generates a <code>lib.rs</code> file. Let us explore it.</p><p>One of the first thing we can see, is that the other five files in the <code>src/</code> directory are included:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub mod api;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod partition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod util;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After reviewing these files a little bit, we can notice that there's also some relevant code in another module, the one in <code>core/</code>. For example, in <code>src/partition.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use pgmq_core::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors::PgmqError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive, assign_queue, create_archive, create_archive_index, create_index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_meta, grant_pgmon_meta, grant_pgmon_queue, grant_pgmon_queue_seq, insert_meta,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    types::{PGMQ_SCHEMA, QUEUE_PREFIX},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    util::CheckedName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, at this point we know that we can find the source code in two places: <code>src/</code> and <code>core/</code>. </p><p>If we continue exploring <code>lib.rs</code>, we can see that a sql file (<code>sql_src.sql</code>) is executed when the extension is enabled:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE pgmq.meta (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name VARCHAR UNIQUE NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_partitioned BOOLEAN NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can actually see that table with <code>psql</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List tables in the pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List contents of pgmq.meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-# \dt pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema | Name | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------+-------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public | meta | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like right after <code>CREATE EXTENSION</code> is executed:</p><p><img loading="lazy" alt="after-create-extension" src="/assets/images/after-create-extension-e590194728d15b0433b8e5510725f9ff.png" title="after create extension" width="596" height="551" class="img_ev3q"></p><p>From this point, we can suspect that every time we create a queue, a new row is inserted into this table.</p><p>Let us see what <code>pgmq.create()</code> does...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqcreate">pgmq.create()<a href="#pgmqcreate" class="hash-link" aria-label="Direct link to pgmq.create()" title="Direct link to pgmq.create()">​</a></h3><p>Most of the functions provided by pgmq are defined in <code>src/api.rs</code>. In that file, we can find the function <code>pgmq_create(queue_name: &amp;str)</code>, and if we chase the call sequence, we can discover that the interesting function is <code>init_queue(name: &amp;str)</code> in <code>core/src/query.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn init_queue(name: &amp;str) -&gt; Result&lt;Vec&lt;String&gt;, PgmqError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let name = CheckedName::new(name)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(vec![</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert_meta(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grant_pgmon_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function generates several sql statements that are later executed in <code>pgmq_create_non_partitioned</code> using an <a href="https://docs.rs/pgx/latest/pgx/spi/struct.SpiClient.html" target="_blank" rel="noopener noreferrer"><code>Spi</code> client</a>.</p><p>I'll skip the details, but the sql statements basically do:</p><ol><li>Create a table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pqmg extension.</li><li>Create an index on the <code>pgmq.q_&lt;queue_name&gt;</code> table.</li><li>Create a table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pgmq extension.</li><li>Create an index on the <code>pgmq.a_&lt;queue_name&gt;</code> table.</li><li>Insert a row on the <code>pgmq.meta</code> table.</li><li>Grant privileges to <code>pg_monitor</code>.</li></ol><p>We can see the effects of this in psql using the following lines:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List tables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List indexes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\di pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- See the contents of pgmq_meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will show something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq_create('my_queue');</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dt pgmq.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |    Name    | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------+-------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta       | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \di pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |           Name           | Type  |   Owner   |   Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+--------------------------+-------+-----------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue_pkey          | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archived_at_idx_my_queue | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta_queue_name_key      | index | binidxaba | meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_pkey          | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_vt_idx        | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | is_partitioned |          created_at           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ------------+----------------+-------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_queue   | f              | 2023-09-18 23:35:38.163096-06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like at this point:</p><p><img loading="lazy" alt="complete" src="/assets/images/complete-0b9cb3715d61904139d1d12fb7d717e6.png" title="after create queue" width="596" height="551" class="img_ev3q"></p><p>For the queue <code>my_queue</code>, we can see the underlying table and the corresponding archive table. Each table has an index associated with the primary key. The <code>pgmq.q_my_queue</code> table also has an index on the <code>vt</code> column, and <code>pgmq.a_my_queue</code> has an index on the <code>archived_at</code> column.</p><p>We can suspect that the <code>pgmq.q_my_queue</code> table is used in the send and read operations. Let us look at those two functions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqsend">pgmq.send()<a href="#pgmqsend" class="hash-link" aria-label="Direct link to pgmq.send()" title="Direct link to pgmq.send()">​</a></h3><p>We can explore the send operation in a similar way. The relevant SQL is straightforward. It just inserts a new row in the the underlying table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">values</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-send" src="/assets/images/pgmq-send-e0f2306ae56fdd9487889c5125c8b461.png" title="what send does" width="596" height="624" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>At this point, we can see the following pattern in the pgmq project: </p><ul><li>the exposed SQL functions are defined in <code>src/api.rs</code>, and </li><li>the underlying SQL statements are defined in <code>core/src/query.rs</code></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqread">pgmq.read()<a href="#pgmqread" class="hash-link" aria-label="Direct link to pgmq.read()" title="Direct link to pgmq.read()">​</a></h3><p>So, let's see. If I were the one programming <code>pgmq.read()</code>, I would perhaps do something like "get the first <code>{limit}</code> rows from the queue table whose <code>{vt}</code> has already expired, and for those rows, also update the visibility timeout to <code>now() + {vt}</code>." Naively, maybe something like:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'10 seconds'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain">                                                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In reality, <code>pgmq.read</code> is more interesting than that 😅. It performs the following DML:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{vt} seconds'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cte</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cte</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-read" src="/assets/images/pgmq-read-b13515d2be7805a182167d1430faad87.png" title="what read does" width="596" height="624" class="img_ev3q"></p><p>Firstly, in pgmq's version, there is a CTE (Common Table Expression) to obtain the first <code>{limit}</code> message IDs whose <code>vt</code> has expired. (It would be interesting to discuss why pgmq developers used a CTE, but we can explore that in another post.)</p><p>There are two crucial things to notice in the CTE. One is the <code>order by</code> clause that ensures the FIFO ordering. The other one is the <code>FOR UPDATE SKIP LOCKED</code> clause, claiming the rows no one else has claimed. This part is essential because it ensures correctness in the case of concurrent  <code>pgmq.read()</code> operations. </p><p>The next step in the DML is to update the corresponding rows with a new vt value by adding the supplied <code>{vt}</code> to the current timestamp. Additionally, the <code>read_ct</code> value is incremented by 1. What is the use of this counter? In general, we can suspect that there is a problem processing a given message if it has a high <code>read_ct</code> value because users usually archive the message after successfully processing it. So, ideally, a message is only read once. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqarchive">pgmq.archive()<a href="#pgmqarchive" class="hash-link" aria-label="Direct link to pgmq.archive()" title="Direct link to pgmq.archive()">​</a></h3><p>The next stage in the lifecycle of a message is archiving it. For that, pgmq uses the following insert statement:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> archived </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{ARCHIVE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Essentially, it deletes the message with the provided <code>msg_id</code> from the queue table, and then the message is placed in the corresponding archive table.</p><p><img loading="lazy" alt="pgmq-archive" src="/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png" title="what archive does" width="596" height="624" class="img_ev3q"></p><p>One interesting thing to notice is that <code>pgmq.archive()</code> can be used to archive a batch of messages too:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">archive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ARRAY</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq.archive('my_queue', ARRAY[3, 4, 5]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is achieved in pgrx by declaring two functions using the <a href="https://github.com/pgcentralfoundation/pgrx/blob/047b1d1fc9e9c4007c871e226fa81e294f8bf5e6/pgrx-macros/src/lib.rs#L462" target="_blank" rel="noopener noreferrer">same name in the <code>pg_extern</code></a> derive macro as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = "archive")]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive(queue_name: &amp;str, msg_id: i64) -&gt; Result&lt;Option&lt;bool&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = "archive")]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive_batch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name: &amp;str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_ids: Vec&lt;i64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;TableIterator&lt;'static, (name!(archive, bool),)&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqdrop_queue">pgmq.drop<!-- -->_<!-- -->queue()<a href="#pgmqdrop_queue" class="hash-link" aria-label="Direct link to pgmqdrop_queue" title="Direct link to pgmqdrop_queue">​</a></h3><p>Finally, let's talk about <code>pgmq.drop_queue()</code>. It essentially executes multiple statements:</p><ol><li>Unassign the <code>pgmq.q_&lt;queue_name&gt;</code> table from the extension.</li><li>Unassign the <code>pgmq.a_&lt;queue_name&gt;</code> table from the extension.</li><li>Drop the table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Drop the table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Delete the corresponding row from the <code>pgmq.meta</code> table.</li></ol><p>Nothing surprising in this one, and with it, we conclude our tour.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this post, we explored how the pgrx tool is used to generate the pgmq extension. We explored how the metadata objects are created and how they are used in the basic send, read and archive operations. At least from an explorer perspective, the internals of the extension are currently easy to read and understand.</p><p>I invite everyone to explore how the other pgmq functions work. You can explore the code at <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>. And you can learn more about pgrx at: <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Binidxaba)</author>
            <category>postgres</category>
            <category>pgmq</category>
            <category>rust</category>
            <category>pgrx</category>
            <category>extensions</category>
        </item>
        <item>
            <title><![CDATA[Postgres 16: The exciting and the unnoticed]]></title>
            <link>https://tembo.io/blog/postgres-16</link>
            <guid>https://tembo.io/blog/postgres-16</guid>
            <pubDate>Wed, 20 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In case you missed it, Postgres 16 came out last week - and this year it arrived earlier than the last few years. There are many features that I’ve been looking forward to for the last few months and I’m excited to see them get into the hands of users. Before we dive into the specific features of this release, let’s discuss what a Postgres major release actually means.]]></description>
            <content:encoded><![CDATA[<p>In case you missed it, Postgres 16 came out last week - and this year it arrived earlier than the last few years. There are many features that I’ve been looking forward to for the last few months and I’m excited to see them get into the hands of users. Before we dive into the specific features of this release, let’s discuss what a Postgres major release actually means.</p><p><img loading="lazy" alt="postgres-16" src="/assets/images/postgres-16-1cfe231777e20520fac3b292397f20e6.png" title="PG16" width="1666" height="1140" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-releases">Postgres Releases<a href="#postgres-releases" class="hash-link" aria-label="Direct link to Postgres Releases" title="Direct link to Postgres Releases">​</a></h2><p>The PostgreSQL Global Development Group releases a new <em>major</em> <a href="https://www.postgresql.org/support/versioning/" target="_blank" rel="noopener noreferrer">version</a> every year with new features. </p><p>In addition, Postgres releases minor versions of each major release every 3 months or so with bug fixes and security fixes. No new features are released in minor versions, and that’s what makes major version releases so exciting as it’s the culmination of about a year’s worth of development work on the project. </p><p>While there's a case to be made for faster release of features, Postgres prides itself on stability and this release cadence provides enough time for features to be proposed, reviewed, committed and tested before they get shipped.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="should-i-upgrade-to-postgres-16">Should I upgrade to Postgres 16?<a href="#should-i-upgrade-to-postgres-16" class="hash-link" aria-label="Direct link to Should I upgrade to Postgres 16?" title="Direct link to Should I upgrade to Postgres 16?">​</a></h2><p>If you are building a new application, yes, I would recommend that you start with the latest major version of Postgres. This will guarantee the latest and greatest features, and a continuous flow of minor releases that fix bugs and improve the security of your database.</p><p>If you are upgrading an existing system, there are more factors to consider. The general advice is to <strong>upgrade minor versions</strong> always - because they contain security and bug fixes and the risk of not upgrading is higher. </p><p>However, for major versions, you will need to consider the tradeoffs as the major versions usually change the internal format of system tables and data files. That means, you can’t just use previous versions of the data directory — you’ll need to use <code>pg_dump</code> / <code>pg_restore</code> or <a href="https://www.postgresql.org/docs/current/pgupgrade.html" target="_blank" rel="noopener noreferrer">pg_upgrade</a> to upgrade. In addition, depending on the features you are using and the Postgres release, manual changes to your code or queries may also be required.</p><p>Obviously, another important factor if you are using a managed service provider is when they provide support for Postgres 16. At <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we’ve already started working on supporting Postgres 16 and expect it to be available in a few weeks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-most-exciting-about-postgres-16">What’s most exciting about Postgres 16?<a href="#whats-most-exciting-about-postgres-16" class="hash-link" aria-label="Direct link to What’s most exciting about Postgres 16?" title="Direct link to What’s most exciting about Postgres 16?">​</a></h2><p>Postgres 16 delivers exciting features in all aspects of the database ranging from performance improvements, monitoring enhancements, better security and privilege handling, replication improvements, new server features and commands and a lot more. </p><p>If you’re interested in the complete list of features, you can read the detailed <a href="https://www.postgresql.org/docs/16/release-16.html" target="_blank" rel="noopener noreferrer">release notes</a>. Below, I’ll talk about the aspects of this release which excite me the most and we will talk about a few not-so-talked about features which lay the groundwork for more exciting features in Postgres 17.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logical-replication-improvements">Logical replication improvements<a href="#logical-replication-improvements" class="hash-link" aria-label="Direct link to Logical replication improvements" title="Direct link to Logical replication improvements">​</a></h3><p><a href="https://www.postgresql.org/docs/current/logical-replication.html" target="_blank" rel="noopener noreferrer">Logical replication</a> is a feature I’ve always been interested in, as it allows you to expand the capabilities of Postgres by moving data between different Postgres databases or from Postgres to other databases. It finds interesting use cases in: replicating selectively from one database to another, replicating across Postgres versions, online migrations and allowing consolidation from multiple databases.</p><p>This release, arguably the most exciting logical replication feature, is allowing <a href="https://pganalyze.com/blog/5mins-postgres-16-logical-decoding" target="_blank" rel="noopener noreferrer">logical replication from standby servers</a>. Prior to this feature, you could only create a logical replication slot on the primary which meant adding more replicas would add more load on the primary. With Postgres 16, secondaries also have the ability to create replication slots allowing for more distribution of that load. What’s more is that the replication slots on the secondary are persisted even when the standby is promoted to the primary. This means that subscribers won’t be affected even during a failover! You can read more about this feature in Bertrand’s <a href="https://bdrouvot.github.io/2023/04/19/postgres-16-highlight-logical-decoding-on-standby/" target="_blank" rel="noopener noreferrer">blog post</a>.</p><p>The short of it is that now you can do this on a Postgres 16 standby:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# select pg_is_in_recovery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_is_in_recovery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# SELECT * FROM pg_create_logical_replication_slot('active_slot', 'test_decoding', false, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slot_name  |    lsn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> active_slot | 0/C0053A78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On Postgres 15, the same thing would have errored out:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# SELECT * FROM pg_create_logical_replication_slot('active_slot', 'test_decoding', false, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  logical decoding cannot be used while in recovery</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to this, there are a number of other logical replication performance improvements. This includes faster initial table sync using <a href="https://www.postgresql.org/message-id/flat/TYCPR01MB8373B593010467315C2BA8EBED229%40TYCPR01MB8373.jpnprd01.prod.outlook.com#be8109723de40d3724730713175517ab" target="_blank" rel="noopener noreferrer">binary format</a>, use of <a href="https://www.postgresql.org/message-id/flat/CACawEhX6TvX%2Bj8EpcpCKvnMGao8Gcp8W43Sgc87pg9o6-Xbf2Q%40mail.gmail.com#81e7ec5c7732e7492c9e28d0f38df657" target="_blank" rel="noopener noreferrer">btree indexes</a> during logical replication apply when tables don’t have a primary key (previously the table would be scanned sequentially) and parallel application of large transactions (~25-40% speedups).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-improvements">Monitoring improvements<a href="#monitoring-improvements" class="hash-link" aria-label="Direct link to Monitoring improvements" title="Direct link to Monitoring improvements">​</a></h3><p>The other bucket of features which intrigued me are the monitoring enhancements. While Postgres provides a number of statistics tables with monitoring information, I believe more can be done to provide actionable insights to users. As an example, Lukas pointed out several interesting gaps in Postgres monitoring in his <a href="https://www.pgcon.org/events/pgcon_2020/sessions/session/132/slides/49/Whats%20Missing%20for%20Postgres%20Monitoring.pdf" target="_blank" rel="noopener noreferrer">PGCon 2020 talk</a>.</p><p>Coming back to this release, <a href="https://www.postgresql.org/docs/16/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW" target="_blank" rel="noopener noreferrer"><code>pg_stat_io</code></a> has to be the most useful piece of information added to the Postgres stats views in Postgres 16. It allows you to understand the I/O done by Postgres at a more granular level, broken down by <code>backend_type</code> and <code>context</code>. This means you can calculate a more accurate cache hit ratio by ignoring the I/O done by VACUUM, differentiate between <code>extends</code> and <code>flushes</code>, and separate out bulk operations while deciding which configurations to tune. Melanie talks about this and much more in her <a href="https://www.youtube.com/watch?v=rCzSNdUOEdg" target="_blank" rel="noopener noreferrer">talk</a> and this <a href="https://www.depesz.com/2023/02/27/waiting-for-postgresql-16-add-pg_stat_io-view-providing-more-detailed-io-statistics/" target="_blank" rel="noopener noreferrer">blog post</a> approaches how you would use this as a DBA.</p><p>Here is an example of the statistics you can see in <code>pg_stat_io</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ SELECT * FROM pg_stat_io ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backend_type     │   io_object   │ io_context │  reads  │ writes  │ extends │ op_bytes │ evictions │ reuses  │ fsyncs │          stats_reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">─────────────────────┼───────────────┼────────────┼─────────┼─────────┼─────────┼──────────┼───────────┼─────────┼────────┼───────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> autovacuum launcher │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> autovacuum worker   │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> client backend      │ temp relation │ normal     │       0 │       0 │       0 │     8192 │         0 │  [NULL] │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> background worker   │ relation      │ bulkread   │  268221 │  268189 │  [NULL] │     8192 │         0 │  268189 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> checkpointer        │ relation      │ normal     │  [NULL] │   32121 │  [NULL] │     8192 │    [NULL] │  [NULL] │   3356 │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> standalone backend  │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> startup             │ relation      │ vacuum     │       0 │       0 │       0 │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> walsender           │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> walsender           │ temp relation │ normal     │       0 │       0 │       0 │     8192 │         0 │  [NULL] │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to this, there are other improvements including the addition of <code>last_seq_scan</code> and <code>last_idx_scan</code> on <code>pg_stat_*</code> tables which allow you to understand index usage better and figure out when plans for a query might have changed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-mentions">Special mentions<a href="#special-mentions" class="hash-link" aria-label="Direct link to Special mentions" title="Direct link to Special mentions">​</a></h3><p>Like I said, each release comes with many improvements - and I could not outline them all in a blog post (and if I did, nobody would read it!). But I do want to mention a few other items in Postgres 16 that I won’t be able to dive deeper into but are interesting as well.</p><ul><li>Load balancing with multiple hosts in <code>libpq</code>: This feature allows to balance the load across Postgres read replicas directly within <code>libpq</code> (which is the foundational Postgres client library) without having to use another load balancer. You can read <a href="https://mydbops.wordpress.com/2023/05/07/postgresql-16-brings-load-balancing-support-in-libpq-psql/" target="_blank" rel="noopener noreferrer">this blog post</a> on how this new feature is implemented and can be used.</li><li>Performance: I won’t repeat what’s in the release notes but there’s a long list of performance improvements in this release. There’s support for more parallelism on <code>FULL</code> and <code>OUTER</code> <code>JOINs</code> and on more aggregates, greater usage of incremental sorts, window function optimizations and even an upto 300% performance improvement in <code>COPY</code>.</li><li><code>VACUUM</code> improvements: Last thing I’d mention is improvements to <code>VACUUM</code> which include freezing performance improvements, ability to increase (or decrease) shared buffer usage by <code>VACUUM</code>, and faster loading of <code>VACUUM</code> configs.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="laying-the-groundwork-for-an-exciting-postgres-17-and-beyond">Laying the groundwork for an exciting Postgres 17 (and beyond)<a href="#laying-the-groundwork-for-an-exciting-postgres-17-and-beyond" class="hash-link" aria-label="Direct link to Laying the groundwork for an exciting Postgres 17 (and beyond)" title="Direct link to Laying the groundwork for an exciting Postgres 17 (and beyond)">​</a></h2><p>All of the features mentioned above can immediately add a lot of value to your Postgres usage, but there are new features which lay the groundwork for powerful features in future releases. I’ll quickly touch upon three items that I believe are noteworthy:</p><ul><li>Direct IO and Async IO in Postgres: In Postgres 16, several building blocks for implementing direct and <a href="https://www.youtube.com/watch?v=CD0w3gWBF7s" target="_blank" rel="noopener noreferrer">asynchronous IO</a> for Postgres were committed. This includes reduced contention on the relation extension lock and addition of Direct IO as a developer only option via the <code>debug_io_direct</code> setting. This important but hard work has been ongoing for several releases and Postgres 17 will likely be the first release where users will be able to utilize these features.</li><li>Moving towards Active Active replication: A feature was committed in Postgres 16 to allow logical replication to avoid replication loops, which is when a transaction gets replicated from source to target and back. Postgres 16 allows subscribers to process only changes which have no origin which allows you to prevent these loops. Bi-directional active-active replication is still very complicated and requires solving a lot of problems, but this feature tackles one of those important sub-problems.</li><li>Migration of the build system to Meson: This might have slipped under your radar but in this release, Postgres added support for a new build system which is expected to replace the Autoconf and Windows based build systems. Why, you might ask? Andres makes a compelling case for it in <a href="https://www.postgresql.org/message-id/flat/20211012083721.hvixq4pnh2pixr3j%40alap3.anarazel.de" target="_blank" rel="noopener noreferrer">this thread</a> if you’re interested but some reasons include faster build times, simpler dependency management and moving towards a common build system across Linux and Windows.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-continues-to-deliver">Postgres continues to deliver<a href="#postgres-continues-to-deliver" class="hash-link" aria-label="Direct link to Postgres continues to deliver" title="Direct link to Postgres continues to deliver">​</a></h2><p>With every new release, Postgres becomes more and more compelling and adds great features that improve the experience of its users. I recommend you check out the <a href="https://www.postgresql.org/about/news/postgresql-16-released-2715/" target="_blank" rel="noopener noreferrer">press release</a>, and <a href="https://www.postgresql.org/docs/16/release-16.html" target="_blank" rel="noopener noreferrer">the release notes</a> to see everything coming along with this new release.</p><p>And if you want to try out the full power of Postgres including its powerful extension ecosystem on a managed service, try out <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Samay Sharma)</author>
            <category>postgres</category>
        </item>
        <item>
            <title><![CDATA[Enter the matrix: the four types of Postgres extensions]]></title>
            <link>https://tembo.io/blog/four-types-of-extensions</link>
            <guid>https://tembo.io/blog/four-types-of-extensions</guid>
            <pubDate>Thu, 14 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Before working for a Postgres company, I had never used extensions.]]></description>
            <content:encoded><![CDATA[<p>Before working for a Postgres company, I had never used extensions.</p><p>Now, I'm part of a team working to fully automate turning on any extension. I didn't find great resources to explain the process of turning on an extension, and why it varies between different extensions.</p><p><strong>I want to share my mental model for the different types of extensions, how to know what type of extension you're working with, and how to get it turned on.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="turn-on-an-extension">Turn on an extension<a href="#turn-on-an-extension" class="hash-link" aria-label="Direct link to Turn on an extension" title="Direct link to Turn on an extension">​</a></h2><p><img loading="lazy" alt="one-does-not-simply" src="/assets/images/one-does-not-simply-095857686f6255714eb3f6df0f595d5b.png" width="651" height="383" class="img_ev3q"></p><p><strong>What's traditionally involved:</strong></p><ul><li>Find the extension you want</li><li>Figure out how to build it</li><li>Sometimes, installation of dependencies (for example with <em>apt-get</em> or <em>yum</em>)</li><li>Sometimes, installation of other extensions (<em>goto</em> ‘figure out how to build it’)</li><li>Install your extension</li><li>Sometimes, load a library</li><li>Sometimes, provide extension-specific configurations</li><li>Sometimes, run the <code>CREATE EXTENSION</code> command</li></ul><p>Building and installing extensions is well covered by other resources. In this blog, I want to focus on steps to get an extension up and running after it's installed, and how <strong>I believe that all extensions fit into four mostly-tidy categories.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a href="#terminology" class="hash-link" aria-label="Direct link to Terminology" title="Direct link to Terminology">​</a></h3><p>Extensions consist of <strong>SQL</strong> and / or <strong>libraries</strong>.</p><p>A <strong>library</strong> simply means compiled code, for example written in <a href="https://www.postgresql.org/docs/current/xfunc-c.html" target="_blank" rel="noopener noreferrer">C</a> or <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">Rust</a>.</p><p><strong><a href="https://www.postgresql.org/docs/current/extend-extensions.html#:~:text=A%20useful%20extension%20to%20PostgreSQL,package%20to%20simplify%20database%20management." target="_blank" rel="noopener noreferrer">SQL objects</a></strong>, let's just call it SQL, are extensions of SQL, for example new functions and data types. These are often implemented by a library, but can also be implemented in other ways, for example using a procedural language like <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>.</p><p><strong>Hooks:</strong> A Postgres feature informally called <em>hooks</em> can be used to connect into Postgres' existing functionality. Hooks allow for overwriting default Postgres functionality, or calling back into an extension's code at the appropriate time. For example, one type of hook can modify Postgres start up behavior to launch a background worker, and a different type of hook can be used to redirect queries to a different table.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Sometimes extensions are instead referred to as 'modules', but I like to simply refer to everything as an 'extension', but feel free to @ me on X to tell me why that's wrong (<a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>).</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-the-matrix">Enter the matrix<a href="#enter-the-matrix" class="hash-link" aria-label="Direct link to Enter the matrix" title="Direct link to Enter the matrix">​</a></h2><p><img loading="lazy" alt="im-in-matrix" src="/assets/images/im-in-matrix-dc7fbaffd858e30723ad62d60ebdd4a3.gif" width="498" height="278" class="img_ev3q"></p><p>A big part of what I have been working on is fully automating enabling any extension. In order to do that, we have to understand exactly how extensions vary. We can break it down into a 2x2 matrix by defining two boolean categories.</p><p><strong>Requires <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong> true or false and <strong>requires <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a></strong> true or false:</p><table><thead><tr><th></th><th>Requires <code>CREATE EXTENSION</code></th><th>Does not require <code>CREATE EXTENSION</code></th></tr></thead><tbody><tr><td><strong>Requires <code>LOAD</code></strong></td><td>Extensions that use SQL and their libraries have hooks</td><td>Extensions that do not use SQL, may or may not have hooks</td></tr><tr><td><strong>Does not require <code>LOAD</code></strong></td><td>SQL-only extensions, and SQL + libraries without hooks</td><td>Output plugins</td></tr></tbody></table><p><em>By categorizing an extension into this 2x2 matrix, we can know how to turn it on.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load">LOAD<a href="#load" class="hash-link" aria-label="Direct link to LOAD" title="Direct link to LOAD">​</a></h3><p> <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a> is a command that tells Postgres to <em>load</em> a library, meaning make the code accessible to Postgres by loading the compiled code on disk into memory. If a library has hooks, <strong>performing a load will activate the hooks</strong>.</p><p><strong>Requires <code>LOAD</code>: true</strong> means you have to do one of the following steps to load a library:</p><ul><li><strong><a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong>: using the <code>LOAD</code> command directly loads a library for the current connection only</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=at%20session_preload_libraries%20instead.-,session_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">session_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD for new connections</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=pooling%20is%20used.-,shared_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD at server start, and therefore requires a restart</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Even though code is loaded in other ways during <code>CREATE EXTENSION</code>, that is not <strong>requires <code>LOAD</code>: true</strong> under this definition. I mean that the user must do something other than <code>CREATE EXTENSION</code> to load in libraries. Also, we are conflating <a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=load%20that%20module.-,local_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">local_preload_libraries</a> with <code>session_preload_libraries</code> to simplify things in this blog post.</p></div></div><p>For example, if you installed the extension <a href="https://pgt.dev/extensions/auto_explain" target="_blank" rel="noopener noreferrer">auto explain</a>, then you may have a library file called <code>auto_explain.so</code> in your library directory, which can be found with <a href="https://pgpedia.info/d/dynamic_library_path.html" target="_blank" rel="noopener noreferrer">pg_config --pkglibdir</a>. Libraries are not always named exactly the same as the extension.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] auto_explain.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --pkglibdir) | grep auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_explain.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Auto explain can be loaded into your session like <code>LOAD 'auto_explain';</code>. This command will always match exactly the name of the library file, less the file type, in this example <code>.so</code>. With a <a href="https://www.postgresql.org/docs/current/auto-explain.html#AUTO-EXPLAIN-EXAMPLE" target="_blank" rel="noopener noreferrer">couple of configurations</a>, now this extension will automatically log the <a href="https://www.postgresql.org/docs/current/sql-explain.html" target="_blank" rel="noopener noreferrer">EXPLAIN ANALYZE</a> output for long-running queries.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD 'auto_explain';</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, the <code>LOAD</code> command is not typically used directly, and many extensions require you do not load them in this way. Instead, typically the Postgres configuration <a href="https://pgpedia.info/s/shared_preload_libraries.html" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a> is used instead.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD 'pg_cron';</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  pg_cron can only be loaded via shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINT:  Add pg_cron to the shared_preload_libraries configuration variable in postgresql.conf.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The best reason to use <code>LOAD</code> directly is for debugging. It can be nice to <code>LOAD</code> on-demand while troubleshooting.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><strong>What to do when an extension requires load:</strong></p><p>Extensions that <strong>requires <code>LOAD</code>: true</strong> can always be configured in <code>shared_preload_libraries</code>, but this configuration requires a restart to take effect. Some extensions can be loaded without a restart using <code>LOAD</code> directly, but in this case it's usually better to use the <code>session_preload_libraries</code> configuration, and <a href="https://pgpedia.info/p/pg_reload_conf.html" target="_blank" rel="noopener noreferrer">reload the Postgres configuration</a> with <code>SELECT pg_reload_conf();</code>. You should run <code>LOAD</code> directly when you are intentionally loading for only the current connection.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-extension">CREATE EXTENSION<a href="#create-extension" class="hash-link" aria-label="Direct link to CREATE EXTENSION" title="Direct link to CREATE EXTENSION">​</a></h3><p>When you run <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a>, this basically just runs an extension's SQL script. The script will typically create new SQL objects such as functions, data types, operators and so on.</p><p><code>CREATE EXTENSION</code> looks at the extension's <strong>control file</strong>, which is installed to the <code>extension</code> directory of <strong>sharedir</strong>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: "/var/lib/postgresql/data/tembo/15/lib"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using sharedir: "/var/lib/postgresql/data/tembo"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] pg_jsonschema.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema--0.1.4.sql =&gt; /var/lib/postgresql/data/tembo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema.control =&gt; /var/lib/postgresql/data/tembo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>sharedir</strong> can be located with <code>pg_config --sharedir</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$  ls $(pg_config --pkglibdir) | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --sharedir)/extension | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema--0.1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The information in a control file is used to determine what start up or upgrade scripts to run. We'll cover upgrades in-depth in a future blog, so let's focus on first-time enabling. For example, in the above installation output, we notice a file <code>pg_jsonschema--0.1.4.sql</code>. Postgres knows to run this because the name of the control file matches the name of the script suffixed by the <code>default_version</code> defined in the control file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat $(pg_config --sharedir)/extension/pg_jsonschema.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comment = 'JSON schema validation on json and jsonb data types'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = '0.1.4'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = '$libdir/pg_jsonschema'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running <code>CREATE EXTENSION</code>, the extension name always matches exactly the name of a control file, less the <code>.control</code> file type.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I mentioned that a start up script creates new SQL, including new functions. For example in the case of <a href="https://pgt.dev/extensions/pg_jsonschema" target="_blank" rel="noopener noreferrer">pg_jsonschema</a>, the start up script <code>pg_jsonschema--0.1.4.sql</code> includes the following SQL to create a new function called <code>jsonb_matches_schema</code>. Even though we have a library file, we don't need <code>LOAD</code> because <code>CREATE FUNCTION</code> is another way to load code from a file. This is an example of <strong>requires <code>LOAD</code>: false</strong>, <strong>requires <code>CREATE EXTENSION</code>: true</strong>.</p><p><a href="https://www.postgresql.org/docs/current/sql-createfunction.html" target="_blank" rel="noopener noreferrer">CREATE FUNCTION ... AS 'obj_file' documentation</a></p><blockquote><p>obj_file is the name of the shared library file containing the compiled <!-- -->[code]</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE FUNCTION "jsonb_matches_schema"(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "schema" json,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "instance" jsonb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) RETURNS bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMMUTABLE STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LANGUAGE c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS 'MODULE_PATHNAME', 'jsonb_matches_schema_wrapper';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>You can always know whether or not an extension requires <code>CREATE EXTENSION</code> by the presence of a control file in <code>$(pg_config --sharedir)/extension</code></p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooks-that-require-a-restart">Hooks that require a restart<a href="#hooks-that-require-a-restart" class="hash-link" aria-label="Direct link to Hooks that require a restart" title="Direct link to Hooks that require a restart">​</a></h3><p>An extension is in the category <strong>requires <code>CREATE EXTENSION</code>: true</strong> and <strong>requires <code>LOAD</code>: true</strong> if the extension has libraries that use hooks which require a restart and it has a control file.</p><p>You will be able to identify this is the case when the extension's documentation mentions both <code>CREATE EXTENSION</code> and <code>shared_preload_libraries</code>. Sometimes an error message or hint is provided if you run <code>CREATE EXTENSION</code> before loaded the library, or if you try to run <code>LOAD</code> directly, but you can't count on that.</p><p>For example, in the case of both <code>pg_cron</code> and <code>pg_partman</code>, there are a background workers. These are examples of extensions using hooks in the start up process of Postgres. So, in both of these cases the user is expected to configure <code>shared_preload_libraries</code> to start the background worker, then run <code>CREATE EXTENSION</code> on a cluster where that background worker is already running.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-is-needed-when-there-isnt-a-control-file">LOAD is needed when there isn't a control file<a href="#load-is-needed-when-there-isnt-a-control-file" class="hash-link" aria-label="Direct link to LOAD is needed when there isn't a control file" title="Direct link to LOAD is needed when there isn't a control file">​</a></h3><p>In the case of auto_explain, it uses hooks that do not require a restart. In this case, there is no control file and no extra SQL objects to be created. So <code>LOAD</code> is required simply because we have to load it into memory somehow. To demonstrate, it is technically possible to make a control file for auto_explain to allow for <code>CREATE EXTENSION</code> behavior instead of <code>LOAD</code>:</p><p><strong>auto_explain.control:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">comment = 'auto explain'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = '0.0.1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = '$libdir/auto_explain'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>auto_explain--0.0.1.sql</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOAD 'auto_explain';</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In practice, do not use <code>LOAD</code> in an extension start up script to activate hooks. <code>LOAD</code> is only applicable for the current connection.</p></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION auto_explain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name       | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> auto_explain    | 0.0.1   | public     | auto explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql         | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_min_duration = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_analyze = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running the above, now my subsequent queries have their <code>EXPLAIN ANALYZE</code> logged.</p><p>So, if that could work, <strong>why not just have control files for all extensions?</strong></p><p><strong>Having a control file requires version upgrade handling.</strong></p><p>When you have a control file, you also have to write upgrade scripts for every new version. In the case of pg_cron, we can find all these files in <strong>sharedir</strong>. When enabling version 1.5, it will run <code>pg_cron--1.0.sql</code>, then each migration script up to 1.5.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0--1.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.1--1.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.2--1.3.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.3--1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4-1--1.5.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4--1.4-1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since that's not really applicable on auto_explain, because it's just logging outputs and there is nothing to migrate or handle between versions, it's just cleaner to not have a control file. Upgrading auto_explain only involves replacing the library, then loading it again.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Upgrade logic is not applicable for extensions that do not require <code>CREATE EXTENSION</code>. These cases just involve re-loading a new version of the library.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-dont-load-hooks-during-create-extension">You don't load hooks during CREATE EXTENSION<a href="#you-dont-load-hooks-during-create-extension" class="hash-link" aria-label="Direct link to You don't load hooks during CREATE EXTENSION" title="Direct link to You don't load hooks during CREATE EXTENSION">​</a></h3><p>It made sense to me for activating hooks that require a restart they have to be configured in <code>shared_preload_libraries</code>. But for extensions that do not require a restart, it's not obvious why the hooks can't just be loaded during the <code>CREATE EXTENSION</code> start up script like I just demonstrated is possible with auto_explain.</p><p><strong>Even though it's technically possible to <code>LOAD</code> hooks during <code>CREATE EXTENSION</code>, it's a bad idea.</strong></p><p>First of all, when using the <code>LOAD</code> command directly, it's only applicable to the current connection. So, in the above example with auto explain, the queries are only logged in the connection where I ran <code>CREATE EXTENSION</code>. To apply to all connections without a restart, it would need to go into <code>session_preload_libraries</code>. It is technically possible to do that inside of <code>CREATE EXTENSION</code> by doing <code>ALTER SYSTEM SET session_preload_libraries</code> then <code>SELECT pg_reload_conf()</code> in your start up script, but it is not a good approach for <code>CREATE EXTENSION</code> to automatically perform a configuration update. First of all it would confuse a user to change a config on the fly, and secondly there is currently no concept to automatically merge multi-value, comma-separated configurations like <code>session_preload_libraries</code>.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The 2x2 matrix makes it easier to understand how to enable an extension.</p><p>Just ask yourself "do I need to run <code>CREATE EXTENSION</code>?" determined by presence of a control file, and "do I need to do a <code>LOAD</code>?" determined by any mention of <code>LOAD</code>, <code>shared_preload_libraries</code>, or <code>session_preload_libraries</code> in the extension's documentation or an error message.</p><p>In all cases of needing a <code>LOAD</code>, you can get away with setting it in <code>shared_preload_libraries</code>. You can optimize to avoid restarts in some cases.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="output-plugins">Output plugins<a href="#output-plugins" class="hash-link" aria-label="Direct link to Output plugins" title="Direct link to Output plugins">​</a></h3><p>There are some extensions, for example <a href="https://pgt.dev/extensions/wal2json" target="_blank" rel="noopener noreferrer">wal2json</a> that require neither <code>CREATE EXTENSION</code> or <code>LOAD</code>. In all known cases so far, these are <a href="https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html" target="_blank" rel="noopener noreferrer">output plugins</a>. I think it's more of a stretch to call these 'extensions', but since they provide additional functionality to Postgres, that counts in my book.</p><p>In the case of output plugins, the library is loaded when a replication slot is created:</p><p><a href="https://www.postgresql.org/docs/current/logicaldecoding-example.html" target="_blank" rel="noopener noreferrer">Postgresql documentation</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM pg_create_logical_replication_slot('regression_slot', 'test_decoding', false, true);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-extensions">Installing extensions<a href="#installing-extensions" class="hash-link" aria-label="Direct link to Installing extensions" title="Direct link to Installing extensions">​</a></h2><p>Some of the above examples use the free and open source <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk project</a> that Tembo created, which allows us to skip the build process. It also installs extension dependencies, and provides metadata about other dependencies. When I'm trying out extensions, I am starting from one of Tembo’s container images to handle the system dependencies installation.</p><p><strong>I wrote <a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">this guide</a> for trying out extensions locally</strong>. If you have any issues just reach out on our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20v3m8pwz-pPjeFaWSM~Bt3KUqDXff2A" target="_blank" rel="noopener noreferrer">community Slack channel</a> and we can help.</p><p><em>Perhaps it's not so bad after all...</em></p><p><img loading="lazy" alt="files-in-computer" src="/assets/images/files-in-computer-5a613d91e5bd9f281c1b4984e6e20976.gif" width="500" height="213" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automate-everything">Automate everything<a href="#automate-everything" class="hash-link" aria-label="Direct link to Automate everything" title="Direct link to Automate everything">​</a></h2><p>We want to make it possible to automatically install and turn on any Postgres extension. For this reason, we are seeking to qualify all known extensions by these two dimensions: requires <code>CREATE EXTENSION</code> true or false, and requires <code>LOAD</code> true or false.</p><p>To enable the community, that metadata is being published on <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a>. On <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we leverage that information to automatically enable extensions. Currently, we've got this working for over 150 extensions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dear-experts-tell-me-how-im-wrong-seriously">Dear experts, tell me how I'm wrong (seriously!)<a href="#dear-experts-tell-me-how-im-wrong-seriously" class="hash-link" aria-label="Direct link to Dear experts, tell me how I'm wrong (seriously!)" title="Direct link to Dear experts, tell me how I'm wrong (seriously!)">​</a></h2><p>I'm serious that I want you to tell me where this is incorrect! If you're a Postgres extensions expert, or maybe just know a thing or two about extensions that seems to conflict with something in this blog, please reach out on X <a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a> and let me know. Even if it's just minor correction or subjective information, I'd love to hear from you. I also want to hear if there is an easier mental model than this. I hope this blog can serve as a minimal yet comprehensive explanation of what it takes to get extensions turned on.</p><p>Another way to contribute is to <strong>click the "Edit this page" link below</strong>, and suggest changes. I will happily accept improvements to this blog.</p>]]></content:encoded>
            <author>noreply@tembo.io (Steven Miller)</author>
            <category>postgres</category>
            <category>extensions</category>
            <category>trunk</category>
        </item>
        <item>
            <title><![CDATA[Tembo Stacks: Making Postgres the Everything Database]]></title>
            <link>https://tembo.io/blog/tembo-stacks-intro</link>
            <guid>https://tembo.io/blog/tembo-stacks-intro</guid>
            <pubDate>Wed, 06 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[For years, Postgres has been considered among the most popular and advanced open source OLTP databases. Interestingly, 20 years ago, it was a competition between Postgres and MySQL and this debate is still going on today. 🙂 Over the last few years, Postgres added more features and its ecosystem added more extensions and now the comparison list keeps growing. After adding support for jsonb in 9.4, Postgres began to be compared with MongoDB as users started using Postgres to store unstructured data. With Citus, people started using Postgres over other distributed SQL technologies for use cases such as multi-tenancy and analytics. And this phenomenon continues to grow with pgvector, timescaledb and others.]]></description>
            <content:encoded><![CDATA[<p>For years, Postgres has been considered among the most popular and advanced open source OLTP databases. Interestingly, 20 years ago, it was a competition between Postgres and MySQL and this debate is still going on <a href="https://news.ycombinator.com/item?id=35906604" target="_blank" rel="noopener noreferrer">today</a>. 🙂 Over the last few years, Postgres added more features and its ecosystem added more extensions and now the comparison list keeps growing. After adding support for <a href="https://www.postgresql.org/docs/release/9.4.0/" target="_blank" rel="noopener noreferrer">jsonb</a> in 9.4, Postgres began to be compared with MongoDB as users started using Postgres to store unstructured data. With <a href="https://github.com/citusdata/citus" target="_blank" rel="noopener noreferrer">Citus</a>, people started using Postgres over other distributed SQL technologies for use cases such as multi-tenancy and analytics. And this phenomenon continues to grow with <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">pgvector</a>, <a href="https://github.com/timescale/timescaledb" target="_blank" rel="noopener noreferrer">timescaledb</a> and others.</p><h1>Use Postgres for Everything</h1><p>Postgres has evolved to where people have started talking about using “Postgres for everything.” There’s strong agreement that it’s wise to use Postgres until you find a strong reason for why you can’t use it anymore - either a very specialized use case, or scale which can’t be achieved by Postgres. This topic was well-discussed on <a href="https://news.ycombinator.com/item?id=33934139" target="_blank" rel="noopener noreferrer">hacker news</a> thanks to a <a href="https://www.amazingcto.com/postgres-for-everything/" target="_blank" rel="noopener noreferrer">blog</a> by a friend, Steven Schmidt.</p><p>And to clarify, when I say Postgres, I mean the entire Postgres ecosystem - this includes Postgres, its extensions and ecosystem tooling for high-availabilty, backups, connection pooling, etc. All of these together turn Postgres into a powerful data platform which you can use to run diverse workloads. However, it’s easier said than done.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="making-postgres-for-everything-real">Making “Postgres for Everything” real<a href="#making-postgres-for-everything-real" class="hash-link" aria-label="Direct link to Making “Postgres for Everything” real" title="Direct link to Making “Postgres for Everything” real">​</a></h2><p>Advanced users may know the recipe which turns Postgres into a distributed database, a vector database, an OLAP database or a search store, but this is still inaccessible to most developers. Over years of working with Postgres users, I’ve realized that even tuning Postgres for OLTP (which is a fairly well known use case) is very hard for most developers. For example: OLTP deployments often have badly chosen indexes, over / under provisioned hardware, insufficiently tuned autovacuum etc. even though they are running on managed services which do the heavy lifting for them.</p><p>So, expecting developers to be able to figure out how to use Postgres for all these use cases when there are other databases focused on user experience for one particular use case is unrealistic. Even though developers know that dealing with 5 different databases is a pain in the medium to long run, when they are starting, they care about getting off the ground fast. So, to expect everybody to use Postgres for everything, we need to make it possible for every user to have easy access to the recipes which turn Postgres into the database for the data service of their choice.</p><h1>Enter Tembo Stacks</h1><p>Tembo stacks are pre-built use-case-specific Postgres deployments which are optimized and tuned to serve a specific workload. They aim to be a replacement for other databases which you actually don’t need, but you are considering because you don’t know how to solve that problem using Postgres. They help you avoid the pains associated with learning, managing and deploying other database systems. Some examples of Stacks are: OLTP, Message Queue, Data Warehouse, Enterprise LLM and Document Store.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="defining-a-stack">Defining a stack<a href="#defining-a-stack" class="hash-link" aria-label="Direct link to Defining a stack" title="Direct link to Defining a stack">​</a></h2><p>A stack is a recipe of how to run an optimized Postgres for a workload, expressed as a spec file. The spec includes the following components:</p><ul><li>Docker Base Image containing a particular version of Postgres</li><li>Curated set of extensions which turn Postgres into best-in-class for that workload.</li><li>Hardware profile which is best suited for that workload</li><li>Postgres configs optimized according to hardware and workload</li><li>Use-case specific metrics, alerts and recommendations</li><li>On-instance sidecar - Kubernetes Services to Deploy a containerized application near Postgres to expand capabilities while minimizing network latency</li></ul><p>Let’s look at an example of a stack spec for a <a href="https://github.com/tembo-io/tembo-stacks/blob/main/tembo-operator/src/stacks/templates/message_queue.yaml" target="_blank" rel="noopener noreferrer">Message queue</a> stack - an <a href="https://aws.amazon.com/sqs/" target="_blank" rel="noopener noreferrer">SQS</a> / <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> replacement based on Postgres.</p><p>It has the following components:</p><ul><li>A standard Postgres 15 base image</li><li>Curated extensions: <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a>, <a href="https://github.com/pgpartman/pg_partman" target="_blank" rel="noopener noreferrer">pg_partman</a> and <a href="https://www.postgresql.org/docs/current/pgstatstatements.html" target="_blank" rel="noopener noreferrer">pg_stat_statements</a></li><li>Optimized Postgres configs: Aggressive autovacuum settings, reduced random_page_cost and Checkpoint and WAL configs tuned for a high throughput Postgres instance</li><li>CPU::Memory ratio recommendations for hardware</li><li>Message queue specific metrics like queue length, oldest message age, newest message age</li><li>(Coming soon) pg_bouncer</li></ul><p>This and many other such stack specifications are <a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates" target="_blank" rel="noopener noreferrer">open source</a> and can be used to deploy a stack locally on a self-managed instance or fully managed on Tembo Cloud. This is a reflection of one of our core values - to always put developers first. We open source our stacks to create the best development experience: locally and on the cloud, and to invite community feedback and collaboration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-a-stack-on-tembo-cloud">Deploying a stack on Tembo Cloud<a href="#deploying-a-stack-on-tembo-cloud" class="hash-link" aria-label="Direct link to Deploying a stack on Tembo Cloud" title="Direct link to Deploying a stack on Tembo Cloud">​</a></h2><p><a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> is a dev-first, fully-extensible, fully-managed, secure, and scalable Postgres service. It has the ability to take this stack spec and deploy a Postgres instance which is built using this stack spec. With Tembo Cloud, you can get all the benefits of a managed service like: backups, high availability, scaling of storage and compute, metrics and alerts with an easy to use UI and CLI. And you get access to an ever growing list of <a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer">extensions</a> which you can add to your stack or bring your own extensions to deploy on Tembo Cloud.</p><p><img loading="lazy" alt="image" src="/assets/images/image-cae704f1f54958b9c0cff9d1ea5cb41d.png" width="2920" height="2076" class="img_ev3q"></p><h1>Evolving Postgres to be the data platform for everything</h1><p>We know we’ve embarked on a challenging journey to turn Postgres into the data platform for Everything. But, we strongly believe that with the power of Postgres and its ecosystem, it’s possible to replace most deployments of esoteric databases with just a flavor of Postgres and save developers a lot of time and effort.</p><p>We’ll be building many stacks, benchmarking them against “competitive” solutions, and making sure Postgres grows to tackle these workloads. We’ll have to optimize Postgres, support a wide variety of extensions, write several new extensions to close feature and performance gaps with other databases and also evolve Postgres. But, we have no doubt that we, along with the Postgres community can make this happen!</p>]]></content:encoded>
            <author>noreply@tembo.io (Samay Sharma)</author>
            <category>postgres</category>
            <category>tembo</category>
        </item>
        <item>
            <title><![CDATA[Optimizing Postgres's Autovacuum for High-Churn Tables]]></title>
            <link>https://tembo.io/blog/optimizing-postgres-auto-vacuum</link>
            <guid>https://tembo.io/blog/optimizing-postgres-auto-vacuum</guid>
            <pubDate>Thu, 31 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Database systems use various techniques to ensure transactionality and performance. For Postgres, this is called MVCC (Multi-Version Concurrency Control). MVCC allows Postgres to provide great performance even when multiple clients could be working with the same table concurrently.]]></description>
            <content:encoded><![CDATA[<p>Database systems use various techniques to ensure transactionality and performance. For Postgres, this is called MVCC (Multi-Version Concurrency Control). MVCC allows Postgres to provide great performance even when multiple clients could be working with the same table concurrently.</p><p>It is useful to be aware of Postgres’ MVCC implementation to understand how Postgres manages a table’s physical storage. Internally, Postgres refers to rows as “tuples”. And as a baseline, there are two big ideas to keep in mind about how Postgres implements changes to rows in a table:</p><ul><li>An UPDATE operation in Postgres is equivalent to a DELETE of the previous tuple, plus an INSERT of the new one.</li><li>A DELETE operation in Postgres does not cause the data to be removed from physical storage. It only causes it to be marked as deleted.</li></ul><p>This is why Postgres has the <a href="https://www.postgresql.org/docs/current/routine-vacuuming.html#AUTOVACUUM" target="_blank" rel="noopener noreferrer">autovacuum</a> process: It is the automatic process in charge of cleaning up and optimizing table storage for Postgres. You can follow this blog post with a local test environment of Postgres. I will demonstrate with code how MVCC and VACUUM features work, and how to tune the Auto-vacuum process.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-does-it-matter">Why does it matter?<a href="#why-does-it-matter" class="hash-link" aria-label="Direct link to Why does it matter?" title="Direct link to Why does it matter?">​</a></h2><p>Vacuum is not just about cleaning up storage space. In environments where data undergoes constant change, Postgres tables often experience an excessive amount of Inserts, Updates, and Deletes. This activity can lead to table bloat. Table bloat happens when a table’s physical footprint far exceeds the size of the data that it actually holds.</p><p>Table bloat is a condition that if not managed, will likely hamper performance of our database. And so, this takes us back to the autovacuum process: to extract its maximum benefits, you may need to fine-tune its settings.</p><p>Postgres’s default autovacuum settings are pretty good. If you’re like me, it could have been years into your postgres journey before having a negative experience with bloat. However, when the time came I found it challenging to understand and tune these configuration settings. That’s why we will study them safely in a dev environment.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unraveling-the-mystery-of-bloat--vacuums-role">Unraveling the Mystery of Bloat &amp; Vacuum's Role<a href="#unraveling-the-mystery-of-bloat--vacuums-role" class="hash-link" aria-label="Direct link to Unraveling the Mystery of Bloat &amp; Vacuum's Role" title="Direct link to Unraveling the Mystery of Bloat &amp; Vacuum's Role">​</a></h2><p>PostgreSQL's mechanism for handling bloat is unique due to its adherence to MVCC. Contrary to immediate space reclamation after data is deleted or becomes obsolete, Postgres tags these rows as "dead", or “dead tuples”. However, even though they are dead they still occupy disk space and will degrade the performance of your queries. Many queries will continue to scan through these tuples, despite their “dead” status. The auto-vacuum steps in here, ensuring that these rows are removed and both the table and its associated indexes are streamlined for performance. You can’t scan the dead tuples if they no longer exist!</p><p>To illustrate, let us create some bloat and see how it affects a rowcount query:</p><p>Create a table we can easily manipulate, and let’s disable autovacuum so we can observe the consequences.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> bencher </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record_id bigserial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">time</span><span class="token plain"> zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> bencher </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">autovacuum_enabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now insert 10 million rows of example data.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> bencher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> generate_series</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We just created the table, and have only inserted records, so there are currently no dead tuples.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schemaname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_dead_tup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_live_tup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_stat_user_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'bencher'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> schemaname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_dead_tup </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_live_tup </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">------------+---------+------------+------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> bencher </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let’s see how long it takes to get a rowcount with no bloat.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">\timing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> bencher </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> record_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">record_id </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> updated_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-----------+-------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5000000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2023</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">08</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">42</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">05.584778</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Time</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">191.006</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Great, 191ms. Slow, yes but we have no indices because we’re demonstrating bloat. Now lets create a bunch of dead tuples. This can take a minute or so.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.5</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> bencher </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> updated_at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> $$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, lets see how long it takes to fetch the same record:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> bencher </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> record_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">record_id </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> updated_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-----------+-------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5000000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2023</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">08</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">42</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">58.964919</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Time</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">283.728</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It’s getting closer to 300ms now. Let’s check how many dead tuples are on the table.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schemaname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_dead_tup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_live_tup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_stat_user_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'bencher'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schemaname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_dead_tup </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_live_tup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">------------+---------+------------+------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> bencher </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50000000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let’s manually clean up the dead tuples and restore our query performance.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VACUUM </span><span class="token keyword" style="color:#00009f">FULL</span><span class="token plain"> bencher</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And check the dead tuple count, there are no dead tuples.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schemaname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_dead_tup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_live_tup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_stat_user_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_dead_tup </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">--needed to avoid division by zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'bencher'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> schemaname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_dead_tup </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> n_live_tup </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">------------+---------+------------+------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> bencher </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">10000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, let’s retrieve the record. Performance restored!</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> bencher </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> record_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">record_id </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> updated_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-----------+-------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">500000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2023</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">08</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">42</span><span class="token plain">:</span><span class="token number" style="color:#36acaa">58.964919</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Time</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">194.101</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-a-benchmarking-environment">Setting up a benchmarking environment<a href="#setting-up-a-benchmarking-environment" class="hash-link" aria-label="Direct link to Setting up a benchmarking environment" title="Direct link to Setting up a benchmarking environment">​</a></h2><p>The rest of the examples will be run on Postgres in <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>. We’ll use 8 vcore and 16Gb of memory and execute all the <code>psql</code> and <code>pgbench</code> commands from an EC2 instance within the same region as Postgres.</p><p>Let’s set up a script that will create an absurdly large amount of churn on our table and be able to execute it with <code>pgbench</code>. For every iteration, let’s insert a row to our “bencher” table. Then, let’s read and update a single record. Finally, let’s delete the same record. This will create a situation similar to many queue implementations (<a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">like PGMQ</a>), where there are at least 2 transactions for every 1 insert. Additionally, the total record count on the table will typically be low - for every record we insert, we also delete one.</p><p>This creates a situation where a table consists of primarily dead tuples!</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain">– churn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">sql</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rec_id </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> bencher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- read and update a row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> record_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> bencher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> updated_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> record_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> bencher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updated_at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> record_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> record_id </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> cte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> record_id </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> rec_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Delete the row with the returned ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> bencher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> record_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rec_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> $$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Set Postgres to all the default vacuum configurations;</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_scale_factor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_cost_delay </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'20ms'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_cost_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'-1'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> vacuum_cost_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_naptime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1min'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let’s run a benchmark to get a baseline. We will reuse this benchmark through the process.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgbench 'postgresql://postgres:pw@host:5432' -c 100 -j 1 -P 1 -T 300 -r -f churn.sql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="default" src="/assets/images/default-02ce369e1e17c9777de6749b0926159f.png" title="default" width="1000" height="600" class="img_ev3q"></p><p>Average latency is about 3.4 ms. We are benchmarking an expensive set of queries, and you’ve probably noticed the sawtooth pattern in the plot and a high standard deviation relative to the latency. This is a symptom of bloat accumulating on our table. Query latency grows until the vacuum process clears dead tuples, and then grows once again. This also has an inverse impact on transactions per second (TPS). Ideally we can reduce and provide some stability to latency.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="balancing-vacuum-delay-for-optimal-system-performance">Balancing Vacuum Delay for Optimal System Performance<a href="#balancing-vacuum-delay-for-optimal-system-performance" class="hash-link" aria-label="Direct link to Balancing Vacuum Delay for Optimal System Performance" title="Direct link to Balancing Vacuum Delay for Optimal System Performance">​</a></h2><p>Vacuuming is indispensable. However, it is not free and if left unchecked, it can burden your system. The balance lies in <code>autovacuum_vacuum_cost_delay</code> and <code>autovacuum_vacuum_cost_limit</code>. <code>autovacuum_vacuum_cost_delay</code> is the amount of time that the autovacuum process will halt processing when the <code>autovacuum_vacuum_cost_limit</code> is reached. Imagine this series of events - a table reaches 10% bloat, meaning 10% of the tuples are dead. When the 10% threshold is reached, the autovacuum worker begins to work and starts accruing cost. When that cost reaches <code>autovacuum_vacuum_cost_limit</code>, it will pause for the duration specified by <code>autovacuum_vacuum_cost_delay</code>, and then continue working until it is complete.</p><p>Modifying these can craft the perfect balance between seamless vacuuming and system efficiency. Let’s increase the cost limit to the max, and reduce the delay by  half. This will let the autovacuum process run longer and pause for a shorter period of time when it does reach the cost limit, to ideally reduce bloat faster and reduce query latency.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_cost_delay </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'10ms'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_cost_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="delay_cost_limit" src="/assets/images/delay_limit-cd8db2fe56a5809a912c8d92bcbab133.png" title="delay-cost-limit" width="1000" height="600" class="img_ev3q"></p><p>We have a slight reduction in average latency, but we can still see that the obviously grows in latency over time and decrease in TPS. It clears roughly every 60 seconds.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fine-tuning-auto-vacuum-scale-factors">Fine-Tuning Auto Vacuum Scale Factors<a href="#fine-tuning-auto-vacuum-scale-factors" class="hash-link" aria-label="Direct link to Fine-Tuning Auto Vacuum Scale Factors" title="Direct link to Fine-Tuning Auto Vacuum Scale Factors">​</a></h2><p>In the previous example, we manually vacuumed our table. But postgres gives us an automated way to configure the vacuum process. One of the most critical parameters is the <code>autovacuum_vacuum_scale_factor</code>; it denotes the portion of the table size that, when surpassed by "dead" rows, prompts a vacuum action. For tables that see frequent data changes, it might be beneficial to lessen this value.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_scale_factor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="scale-factor" src="/assets/images/scale_factor-3f330c83cc61eb06bc3c92af8348f85d.png" title="scale-factor" width="1000" height="600" class="img_ev3q"></p><p>Reducing the scale factor had minimal impact on our result, so allowing the autovacuum to trigger sooner did not help. We can see that the period of the sawtooth pattern is still about 60 seconds, which means there we are probably limited by <code>autovacuum_naptime</code>, which we'll talk about next.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-quick-siesta-for-your-system">A Quick Siesta for Your System<a href="#a-quick-siesta-for-your-system" class="hash-link" aria-label="Direct link to A Quick Siesta for Your System" title="Direct link to A Quick Siesta for Your System">​</a></h2><p>The autovacuum_naptime parameter in Postgres specifies the minimum delay between autovacuum runs on any given database. The default (which we set earlier) is <code>1min</code>. Generally, depending on just how high-churn your workloads are, it might be necessary to decrease this value, whereas a longer interval could be suited for environments that are not churning at such a high rate. But our table has a crazy amount of churn.</p><p>We want to reduce the height of the latency peaks. One way to do this is to make the vacuum more aggressive and tell it to run sooner. We tried to influence that by setting the <code>autovacuum_vacuum_scale_factor</code>, but we can also lower the <code>autovacuum_naptime</code> value, which will also allow it to run sooner. Let’s cut it in half.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_naptime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'30s'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="naptime" src="/assets/images/naptime-f26979e9689635484e7e55d154a70968.png" title="naptime" width="1000" height="600" class="img_ev3q"></p><p>Allowing the autovacuumer to run more frequently reduced our average latency and increase TPS. However, we’re still seeing a noticeable sawtooth pattern and high standard deviation of latency. Let’s completely disable the cost limitations to the vacuum process, let it have as much compute as it needs.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_vacuum_cost_delay </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="disable-cost" src="/assets/images/disable_cost-d82a984a4c4bff36e6bd4bce3aad305b.png" title="disable-cost" width="1000" height="600" class="img_ev3q"></p><p>Finally, reduce naptime to 10s</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> autovacuum_naptime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'10s'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="naptime-final" src="/assets/images/naptime_final-25b01a2089dac176cf59357ee07ae222.png" title="naptime-final" width="1000" height="600" class="img_ev3q"></p><p>Overall, we’ve iterated on autovacuum settings and reduced the average latency from 3.4ms to 2.8ms and stddev from 0.8ms to 0.7ms, which helped increase TPS from 4.3k to about 5.3k.</p><p>Configuring the autovacuum settings can be a lot of fun and the appreciated values are wildly dependent on the workload. We covered the absurdly high churn use case on a single-table today, which is very similar to what we see when running applications using PGMQ. Vacuum is complicated and can be <a href="https://www.enterprisedb.com/blog/postgresql-vacuum-and-analyze-best-practice-tips" target="_blank" rel="noopener noreferrer">tuned differently</a> when considering multiple tables with different workloads. Other OLTP use cases will call for different settings, and OLAP workloads may be less influenced by the vacuum settings . Follow us, and sign up for <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> because we will surely be writing about these other topics soon.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-on-this-topic">More on this topic<a href="#more-on-this-topic" class="hash-link" aria-label="Direct link to More on this topic" title="Direct link to More on this topic">​</a></h2><p>Watch the video on <a href="https://www.youtube.com/watch?v=D832gi8Qrv4" target="_blank" rel="noopener noreferrer">Optimizing autovacuum: PostgreSQL’s vacuum cleaner by Samay Sharma</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adam Hendel)</author>
            <category>postgres</category>
        </item>
        <item>
            <title><![CDATA[Using pgmq with Python]]></title>
            <link>https://tembo.io/blog/pgmq-with-python</link>
            <guid>https://tembo.io/blog/pgmq-with-python</guid>
            <pubDate>Thu, 24 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In my recent search for something interesting to do with Rust, I discovered that people write postgres extensions using pgrx.]]></description>
            <content:encoded><![CDATA[<p>In my recent search for something interesting to do with Rust, I discovered that people write postgres extensions using <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">pgrx</a>.</p><p>I found that very cool, and while looking for some real-world examples to study and dissect, I came across <a href="https://tembo.io/blog/introducing-pgmq" target="_blank" rel="noopener noreferrer">pgmq</a>: "A lightweight message queue. Like AWS SQS and RSMQ but on Postgres." So, I decided to give it a shot so that perhaps in the future, I can contribute to the project ;)</p><p>When reviewing the <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">repository</a>, I noticed a <a href="https://github.com/tembo-io/pgmq/tree/main/tembo-pgmq-python" target="_blank" rel="noopener noreferrer">Python client</a> to interact with pgmq and began to play with it.</p><p>Let me quickly describe how easy it was for me to use it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-environment">Setting up the environment<a href="#setting-up-the-environment" class="hash-link" aria-label="Direct link to Setting up the environment" title="Direct link to Setting up the environment">​</a></h2><p>The first step was to start Postgres with a docker container. You can check the <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">README</a> for detailed instructions, but in summary, just run:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name postgres -e POSTGRES_PASSWORD=postgres -p 5432:5432 quay.io/tembo/pgmq-pg:latest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A quick test to make sure that Postgres is running:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">psql postgres://postgres:postgres@0.0.0.0:5432/postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After that, I simply installed the pgmq Python client in my virtual environment:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install tembo-pgmq-python</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That's all the setup that I needed.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-pgmqueue-class">The PGMQueue class<a href="#the-pgmqueue-class" class="hash-link" aria-label="Direct link to The PGMQueue class" title="Direct link to The PGMQueue class">​</a></h2><p>To use the library, we need to instantiate a PGMQueue object and from that object we can call the methods described in the following table:</p><table><thead><tr><th>SQL function</th><th>PGMQueue method</th><th>Description</th></tr></thead><tbody><tr><td>pgmq<!-- -->_<!-- -->create(queue)</td><td>create<!-- -->_<!-- -->queue(self, queue: str)</td><td>Creates a new queue with the name queue.</td></tr><tr><td>pgmq<!-- -->_<!-- -->send(queue, message)</td><td>send(self, queue: str, message: dict, delay: Optional<!-- -->[int]<!-- --> = None)</td><td>Appends a message to the queue.</td></tr><tr><td>pgmq<!-- -->_<!-- -->read(queue, vt, num<!-- -->_<!-- -->messages)</td><td>read(self, queue: str, vt: Optional<!-- -->[int]<!-- --> = None)</td><td>Reads num<!-- -->_<!-- -->messages from queue and sets the visibility timeout to vt.</td></tr><tr><td>pgmq<!-- -->_<!-- -->archive(queue, msg<!-- -->_<!-- -->id)</td><td>archive(self, queue: str, msg<!-- -->_<!-- -->id: int)</td><td>Archives the message with msg<!-- -->_<!-- -->id.</td></tr><tr><td>pgmq<!-- -->_<!-- -->pop(queue)</td><td>pop(self, queue: str)</td><td>Pop the next message in the queue.</td></tr><tr><td>pgmq<!-- -->_<!-- -->delete(queue, msg<!-- -->_<!-- -->id)</td><td>delete(self, queue: str, msg<!-- -->_<!-- -->id: int)</td><td>Deletes the message with msg<!-- -->_<!-- -->id from the queue.</td></tr><tr><td>pgmq<!-- -->_<!-- -->drop<!-- -->_<!-- -->queue(queue)</td><td>Not available yet</td><td>Drops the queue.</td></tr></tbody></table><p>Next, let me show you how to implement a simple producer/consumer setup using the methods above.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-a-producer">Implementing a Producer<a href="#implementing-a-producer" class="hash-link" aria-label="Direct link to Implementing a Producer" title="Direct link to Implementing a Producer">​</a></h2><p>In summary, the required steps are:</p><ol><li>Import the Messages and PGMQueue classes.</li><li>Instantiate a PGMQueue object.</li><li>Create a queue.</li><li>Send N messages via the queue in a loop.</li></ol><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> tembo_pgmq_python </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PGMQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGMQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">connection_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_messages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The PGMQueue constructor is the one that receives the connection information. For the Postgres instance initiated by the docker container, the connection details are:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGMQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"localhost"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5432</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                username</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                password</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                database</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-a-consumer">Implementing a Consumer<a href="#implementing-a-consumer" class="hash-link" aria-label="Direct link to Implementing a Consumer" title="Direct link to Implementing a Consumer">​</a></h2><p>In short, the code should basically do:
Import the Messages and PGMQueue classes.
Consume the messages from the queue in a loop.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> tembo_pgmq_python </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PGMQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGMQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">connection_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="harnessing-producer-and-consumer">Harnessing Producer and Consumer<a href="#harnessing-producer-and-consumer" class="hash-link" aria-label="Direct link to Harnessing Producer and Consumer" title="Direct link to Harnessing Producer and Consumer">​</a></h2><p>For simplicity, I used a simple shell script to initiate my experiment:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Spawn one producer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 producer.py </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /tmp/producer.out </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Spawn 5 consumers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">seq</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">5</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  python3 consumer.py </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /tmp/consumer_</span><span class="token variable" style="color:#36acaa">${i}</span><span class="token plain">.out </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Wait for everyone to finish</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The script basically starts 1 producer and 5 consumers in the background. The output is saved in the <code>/tmp</code> directory.</p><p>And that was it...</p><p>From this point, you can explore the other available methods.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="some-final-words">Some final words...<a href="#some-final-words" class="hash-link" aria-label="Direct link to Some final words..." title="Direct link to Some final words...">​</a></h2><p>It was a pleasant surprise how easy it was to create this example: only a couple of shell commands and a couple of short Python scripts. The PGMQueue methods were very intuitive and straightforward. Personally, my next step is to understand how it works internally. But that's a topic for the future :)</p><p>I invite everyone to explore this project at: <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>. Give it a star and also check out the other available clients for <a href="https://github.com/tembo-io/pgmq/tree/main/core" target="_blank" rel="noopener noreferrer">Rust</a> and <a href="https://github.com/craigpastro/pgmq-go" target="_blank" rel="noopener noreferrer">Go</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="appendix">Appendix<a href="#appendix" class="hash-link" aria-label="Direct link to Appendix" title="Direct link to Appendix">​</a></h2><p>Here is the complete code if you want to give it a try (or see it in <a href="https://github.com/binidxaba/pgmq-with-python" target="_blank" rel="noopener noreferrer">this repository</a>):</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">This is the Producer's code</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> tembo_pgmq_python </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PGMQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'__main__'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"localhost"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_messages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    test_queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bench_queue_sample"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGMQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    port</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    password</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    database</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">database</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#queue.drop_queue(test_queue)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_messages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ascii_uppercase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">digits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"payload"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_queue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Sent {} messages"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">This is the Consumer's code</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> tembo_pgmq_python </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PGMQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'__main__'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"localhost"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"postgres"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    no_message_timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    test_queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bench_queue_sample"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGMQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> password</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> database</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">database</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> no_message_timeout </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># type: ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Consumed message: {}"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"payload"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            no_message_timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> IndexError</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            no_message_timeout </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"No more messages for {no_message_timeout} consecutive reads"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <author>noreply@tembo.io (Binidxaba)</author>
            <category>postgres</category>
            <category>pgmq</category>
            <category>python</category>
        </item>
        <item>
            <title><![CDATA[Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake]]></title>
            <link>https://tembo.io/blog/introducing-pg-later</link>
            <guid>https://tembo.io/blog/introducing-pg-later</guid>
            <pubDate>Wed, 16 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[We’re working on asynchronous query execution in Postgres and have packaged the work up in an extension we’re calling pglater. If you’ve used Snowflake’s asynchronous queries, then you might already be familiar with this type of feature. Submit your queries to Postgres now, and come back later and get the query’s results.]]></description>
            <content:encoded><![CDATA[<p>We’re working on asynchronous query execution in Postgres and have packaged the work up in an extension we’re calling <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">pg_later</a>. If you’ve used <a href="https://docs.snowflake.com/developer-guide/python-connector/python-connector-example#examples-of-asynchronous-queries" target="_blank" rel="noopener noreferrer">Snowflake’s asynchronous queries</a>, then you might already be familiar with this type of feature. Submit your queries to Postgres now, and come back later and get the query’s results.</p><p>Visit <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">pg_later</a>’s Github repository and give it a star!</p><p><img loading="lazy" alt="elephant-tasker" src="/assets/images/elephant-3d5154dac74be08748e278a9ad3c7a0e.png" title="elephant-tasker" width="882" height="878" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-async-queries">Why async queries?<a href="#why-async-queries" class="hash-link" aria-label="Direct link to Why async queries?" title="Direct link to Why async queries?">​</a></h2><p>Imagine that you’ve initiated a long-running maintenance job. You step away while it is executing, only to come back and discover it was interrupted hours ago due to your laptop shutting down. You don’t want this to happen again, so you spend some time googling or asking your favorite LLM how to run the command in the background with screen or tmux. Having asynchronous query support from the beginning would have saved you a bunch of time and headache!</p><p>Asynchronous processing is a useful development pattern in software engineering. It has advantages such as improved resource utilization, and unblocking of the main execution thread.</p><p>Some examples where async querying can be useful are:</p><ul><li>For a DBA running ad-hoc maintenance.</li><li>Developing in interactive environments such as a Jupyter notebook. Rather than submit a long-running query only to have your notebook hang idly and then crash, you can use asynchronous tasks to avoid blocking your Notebook, or simply come back later to check on your task.</li><li>Having a long-running analytical query, for example fulfilling an ad-hoc request like seeing how many new users signed up each day for the past month. You can submit that query and have it run in the background while you continue other work.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extending-postgres-with-async-features">Extending Postgres with async features<a href="#extending-postgres-with-async-features" class="hash-link" aria-label="Direct link to Extending Postgres with async features" title="Direct link to Extending Postgres with async features">​</a></h2><p>At Tembo, we’ve built a similar feature for Postgres and published it as an extension called <strong>pg_later</strong>. With <strong>pg_later</strong>, you can dispatch a query to your Postgres database and, rather than waiting for the results, your program can return and retrieve the results at your convenience.</p><p>A common example is manually executing VACUUM on a table. Typically one might execute VACUUM in one session, and then use another session to check the status of the VACUUM job via <code>pg_stat_progress_vacuum</code>. pg_later gives you the power to do that in a single session. You can use it to queue up any long-running analytical or administrative task on your Postgres database.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stacking-postgres-extensions">Stacking Postgres Extensions<a href="#stacking-postgres-extensions" class="hash-link" aria-label="Direct link to Stacking Postgres Extensions" title="Direct link to Stacking Postgres Extensions">​</a></h2><p><strong>pg_later</strong> is built on top of <a href="https://tembo.io/blog/introducing-pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, another one of Tembo's open source extensions. Once a user submits a query, <strong>pg_later</strong> seamlessly enqueues the request in a Postgres-managed message queue. This mechanism then processes the query asynchronously, ensuring no unnecessary wait times or hold-ups.</p><p>The <strong>pg_later</strong> <a href="https://www.postgresql.org/docs/current/bgworker.html" target="_blank" rel="noopener noreferrer">background worker</a> picks up the query from the queue and executes it. The results are persisted by being written to a table as <a href="https://www.postgresql.org/docs/current/functions-json.html" target="_blank" rel="noopener noreferrer">JSONB</a> and can be easily retrieved using the <strong>pg_later</strong> API. You can simply reference the unique job id given upon query submission, and retrieve the result set, or query the table directly. By default, the results are retained forever, however we are building retention policies as a feature into <strong>pg_later</strong>.</p><p><img loading="lazy" alt="diagram" src="/assets/images/diagram-d6cbc048f614b1157a4ebdcdf011e537.png" title="diagram" width="2146" height="800" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-pg_later">Using pg_later<a href="#using-pg_later" class="hash-link" aria-label="Direct link to Using pg_later" title="Direct link to Using pg_later">​</a></h2><p>To get started, check out our project’s <a href="https://github.com/tembo-io/pg_later/blob/main/README.md" target="_blank" rel="noopener noreferrer">README</a> for a guide on installing the extension.</p><p>First, you need to initialize the extension. This handles the management of PGMQ objects like a job queue and some metadata tables.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pglater</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You're now set to dispatch your queries. Submit the query using pglater.exec, and be sure to take note of the <strong>job_id</strong> that is returned. In this case, it’s the first job so the <strong>job_id</strong> <strong>is 1</strong>.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pglater</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">'select * from pg_available_extensions limit 2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> job_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> job_id </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And whenever you're ready, your results are a query away:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pglater</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch_results</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "query": "select * from pg_available_extensions limit 2",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "job_id": 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "result": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "pg_later",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "comment": "pg_later:  Run queries now and get results later",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "default_version": "0.0.6",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "installed_version": "0.0.6"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "pgmq",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "comment": "Distributed message queues",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "default_version": "0.10.1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "installed_version": "0.10.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "status": "success"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="up-next">Up next<a href="#up-next" class="hash-link" aria-label="Direct link to Up next" title="Direct link to Up next">​</a></h2><p><code>pg_later</code> is a new project and still under development. A few features that we are excited to build:</p><ul><li>Status and progress of in-flight queries</li><li>Security and permission models for submitted queries</li><li>Cursor support for finished jobs (fetch results row by row)</li><li>Kill a query that is in the queue or is currently in flight</li><li>Support for transactions</li><li>Configurable concurrency levels for background works to increase the throughput of jobs</li><li>Push notifications for completed and failed jobs</li><li>Retention policies for completed jobs</li></ul><p>Give us a <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">star</a> and try out pg_later by running the example in the README. If you run into issues, please create an <a href="https://github.com/tembo-io/pg_later/issues" target="_blank" rel="noopener noreferrer">issue</a>. We would greatly welcome contributions to the project as well.</p><p>Please stay tuned for a follow up post on benchmarking PGMQ vs leading open source message queues.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adam Hendel)</author>
            <category>postgres</category>
            <category>announcement</category>
            <category>async</category>
        </item>
        <item>
            <title><![CDATA[Introducing PGMQ: Simple Message Queues built on Postgres]]></title>
            <link>https://tembo.io/blog/introducing-pgmq</link>
            <guid>https://tembo.io/blog/introducing-pgmq</guid>
            <pubDate>Thu, 03 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[We’ve released PGMQ, a packaged extension for message queues on Postgres.]]></description>
            <content:encoded><![CDATA[<p>We’ve released <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, a packaged extension for message queues on Postgres. </p><p>People have been implementing queues on Postgres in many different ways and we’re excited about combining lessons learned from those projects into a simple, feature-rich extension. </p><p>Some exciting features of the project include:</p><ul><li>Guaranteed exactly-once delivery of messages within a visibility timeout</li><li>Optional archival of messages retention for replayability and retention</li><li>Familiar SQL interface</li><li>Single and Batch read of messages</li><li>Client SDKs in both Rust and Python for an ORM-like feel</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-need-for-message-queues">The need for message queues<a href="#the-need-for-message-queues" class="hash-link" aria-label="Direct link to The need for message queues" title="Direct link to The need for message queues">​</a></h2><p>Message queues are a very common architectural feature to manage operational pipelines, particularly within the context of asynchronous tasks and distributed systems. There are products in the market that support message queues (Kafka, RSMQ, RabbitMQ, SQS); however, when adopting one of these technologies, you increase your cognitive load, required skills and production support overhead.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-your-queues-on-postgres">Building your queues on Postgres<a href="#building-your-queues-on-postgres" class="hash-link" aria-label="Direct link to Building your queues on Postgres" title="Direct link to Building your queues on Postgres">​</a></h2><p>As a Postgres startup, we had the same issue, and we decided to build our own Message Queue based on Postgres. We are not the first: others have implemented queues on Postgres, and many have written about it including <a href="https://dagster.io/blog/skip-kafka-use-postgres-message-queue" target="_blank" rel="noopener noreferrer">Dagster</a>, <a href="https://www.crunchydata.com/blog/message-queuing-using-native-postgresql" target="_blank" rel="noopener noreferrer">CrunchyData</a>, and <a href="https://postgres.fm/episodes/queues-in-postgres" target="_blank" rel="noopener noreferrer">PostgresFM</a> dedicated an entire podcast episode to them.</p><p>At Tembo, we needed a job queue to manage tasks between our control-plane and data-plane in our managed cloud offering. Our control-plane publishes tasks like <code>create postgres cluster</code>, and <code>update postgres cluster</code>. </p><p>To keep our architecture simple and reduce technology sprawl, we built a Postgres extension so that we could run queues for our cloud and more easily share the implementation with the community.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="queues-implemented-with-best-practices">Queues Implemented with best practices<a href="#queues-implemented-with-best-practices" class="hash-link" aria-label="Direct link to Queues Implemented with best practices" title="Direct link to Queues Implemented with best practices">​</a></h2><p>PGMQ was implemented on Postgres and follows industry best practices. One of the most important practices is the use of Postgres’s <a href="https://www.2ndquadrant.com/en/blog/what-is-select-skip-locked-for-in-postgresql-9-5/" target="_blank" rel="noopener noreferrer">SKIP LOCKED</a>, which is similar to <code>NOWAIT</code> in other databases. <code>SKIP LOCKED</code> helps ensure that consumers don't hang and <code>FOR UPDATE</code> ensures messages are not duplicated on read. PGMQ also supports partitioning, which is particularly beneficial for large queues and can be used to efficiently archive / expire old messages.</p><p>PGMQ also provides exactly once delivery semantics within a visibility timeout. Similar to Amazon’s SQS and RSMQ, PGMQ consumers set the period of time during which Postgres will prevent all consumers from receiving and processing a message. This is done by the consumer on read, and once the visibility timeout expires the message becomes available for consumption once again. That way, if a consumer crashes, there is no data loss. This effectively means at-least-once delivery semantics once the first visibility timeout has expired.</p><p><img loading="lazy" alt="vt" src="/assets/images/vt-460a9da647d1b33b4d5a3fd2d9e9d13b.png" title="VisibilityTimeout" width="2382" height="740" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-pgmq">Using PGMQ<a href="#using-pgmq" class="hash-link" aria-label="Direct link to Using PGMQ" title="Direct link to Using PGMQ">​</a></h2><p>To get started, check out our project’s <a href="https://github.com/tembo-io/pgmq/blob/main/README.md#installation" target="_blank" rel="noopener noreferrer">README</a> for a guide on installing the extension.</p><p>You can create a new queue by simply calling</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pgmq_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, pgmq_send() a couple messages to the queue. The message id is returned from the send() function.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{"foo": "bar1"}'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{"foo": "bar2"}'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Read <code>2</code> messages from the queue. Make them invisible for <code>30</code> seconds. If the messages are not deleted or archived within 30 seconds, they will become visible again and can be read by another consumer.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> msg_id | read_ct |              vt               |          enqueued_at          |    message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+---------+-------------------------------+-------------------------------+---------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      1 |       1 | 2023-02-07 04:56:00.650342-06 | 2023-02-07 04:54:51.530818-06 | {"foo":"bar1"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 |       1 | 2023-02-07 04:56:00.650342-06 | 2023-02-07 04:54:51.530818-06 | {"foo":"bar2"}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the queue is empty, or if all messages are currently invisible, no rows will be returned.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> msg_id | read_ct | vt | enqueued_at | message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+---------+----+-------------+---------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Archiving</code> removes the message from the queue and inserts it to the queue’s archive table. This provides you with an opt-in retention mechanism for messages, and is an excellent way to debug applications.</p><p>Archive the message with id 2.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_archive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then inspect the message on the archive table.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_my_queue_archive</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> msg_id | read_ct |         enqueued_at          |          deleted_at           |              vt               |     message     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+---------+------------------------------+-------------------------------+-------------------------------+-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      2 |       1 | 2023-04-25 00:55:40.68417-05 | 2023-04-25 00:56:35.937594-05 | 2023-04-25 00:56:20.532012-05 | {"foo": "bar2"}```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, you can delete a message forever.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq_send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{"foo": "bar3"}'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pgmq_delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'my_queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-involved">Getting involved<a href="#getting-involved" class="hash-link" aria-label="Direct link to Getting involved" title="Direct link to Getting involved">​</a></h2><p>Give us a <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">star</a> and try out PGMQ by cloning the <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">repo</a> and following the example in the README. Please use Github issues if you run into any issues or have any feedback. </p><p>We’ve also built client side libraries in <a href="https://github.com/tembo-io/pgmq/tree/main/core" target="_blank" rel="noopener noreferrer">Rust</a> and <a href="https://github.com/tembo-io/pgmq/tree/main/tembo-pgmq-python" target="_blank" rel="noopener noreferrer">Python</a>, which will give you an ORM-like experience.</p><p>You can also try PGMQ on <a href="https://tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> as part of our <a href="https://tembo.io/docs/stacks/message-queue" target="_blank" rel="noopener noreferrer">Message Queue Stack</a>. Tembo Cloud’s Message Queue Stack is powered by PGMQ, but also ships with Postgres configurations optimized for message queue workloads. We’re also working on adding metrics and data visualizations specific to message queues.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="interested-in-learning-more">Interested in learning more?<a href="#interested-in-learning-more" class="hash-link" aria-label="Direct link to Interested in learning more?" title="Direct link to Interested in learning more?">​</a></h2><p>Stay tuned for our upcoming post <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">pg_later</a>, an extension we built on top of PGMQ as well as benchmarks comparing PGMQ to <a href="https://aws.amazon.com/sqs/" target="_blank" rel="noopener noreferrer">SQS</a> and <a href="https://redis.com/" target="_blank" rel="noopener noreferrer">Redis</a>.</p>]]></content:encoded>
            <author>noreply@tembo.io (Adam Hendel)</author>
            <category>postgres</category>
            <category>announcement</category>
            <category>queues</category>
        </item>
        <item>
            <title><![CDATA[Tembo Manifesto]]></title>
            <link>https://tembo.io/blog/tembo-manifesto</link>
            <guid>https://tembo.io/blog/tembo-manifesto</guid>
            <pubDate>Wed, 05 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[tembo brand]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" alt="tembo brand" src="/assets/images/tembo_brand-4de95da93efcd22872e894cefb0a7f33.png" width="14063" height="10668" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="100-billion">$100 billion+<a href="#100-billion" class="hash-link" aria-label="Direct link to $100 billion+" title="Direct link to $100 billion+">​</a></h2><p>That's the expected size of the global database market in the coming years. The amount of data being generated, stored, and leveraged is growing exponentially, as is the need for applications to operate at a global scale. We're producing more data, we need it faster, and the uses for it are more and more complex by the day. </p><p>There's an <em>incredible</em> opportunity in the making here. But first, a little context. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-database-market">The Database Market<a href="#the-database-market" class="hash-link" aria-label="Direct link to The Database Market" title="Direct link to The Database Market">​</a></h2><p>Enterprises typically store their data across various databases, generally grouped into transactional and analytical systems. There's roughly 10x more transactional than analytical data, mostly in Oracle, MySQL, and Postgres, and there have been some sizable shifts to this landscape in recent years:</p><ol><li>First, we saw some analytical workloads move to the cloud. This was the big data era, resulting in the rise of platforms like Snowflake and Databricks.</li><li>Next, some transactional workloads moved to streaming and real-time data. This required transactional and analytical processing platforms to be managed by app developers, not database admins.</li><li>Finally, application infrastructure has been abstracted, allowing developers to build and scale applications more efficiently. Services like Vercel and Netlify have streamlined the development lifecycle, but tend to build on top of databases rather than dealing with the databases themselves.</li></ol><p>The net result? Exactly what we see around us—an ever-expanding menagerie of innovative apps and services built upon an increasingly complex database ecosystem. The modern data stack is more complicated and expensive than it's ever been, and with the normalization of AI, the trend is accelerating. </p><p>How can we cope? </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-as-a-platform">Postgres as a Platform<a href="#postgres-as-a-platform" class="hash-link" aria-label="Direct link to Postgres as a Platform" title="Direct link to Postgres as a Platform">​</a></h2><p>Developers would love an open-source, multi-functional data platform to simplify their lives and work—as long as it doesn't restrict their freedom. Companies want reliability, flexibility, and a pathway out of the spiraling costs and vendor lock-in attempts that they're currently saddled with. At face value, there's an obvious solution that ticks all the necessary boxes:</p><p><strong>Postgres.</strong></p><p>Postgres, the world's favorite database with millions of deployments, features a liberal OSS license and a large community. It efficiently manages SQL and JSON queries across diverse workloads due to its growing, decade-old ecosystem of add-ons and extensions. It is popular for its open-source, standards-compliant, extensible nature, and ACID compliance, making it a reliable, cost-effective system. It handles low latency, high throughput analytical cases, offering HTAP-lite capabilities through window functions and foreign data wrappers. Even better, it’s extensibility has resulted in a wide ecosystem of add-ons and plugins for GIS data, image processing, vector databases, and more, with some extensions evolving into companies like CitusDB and Timescale. In short, everything you’d want and then some.</p><p><img loading="lazy" alt="Postgres is most admired and desired" src="/assets/images/postgres_is_admired_and_desired_stackoverflow-de1207ee92eac0debfe8053dc1fb80a1.png" width="1852" height="1032" class="img_ev3q"></p><p><em>Source: <a href="https://survey.stackoverflow.co/2023/#section-admired-and-desired-databases" target="_blank" rel="noopener noreferrer">Stack Overflow Developer Survey 2023</a></em></p><p>Problem solved, right? Not so fast. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overwhelmment">Overwhelmment<a href="#overwhelmment" class="hash-link" aria-label="Direct link to Overwhelmment" title="Direct link to Overwhelmment">​</a></h2><p><em>(It's a word now. Go with it.)</em></p><p>Companies are typically hesitant to adopt databases due to costs, complexity, and risk. The effort required to build, configure, and optimize a new system often makes the transition value negligible at best. For these companies (especially large enterprises that spend billions per year on a fragmented database architecture), Postgres and it's assimilation of database innovations <em>should</em> be an ideal solution. Open source, extensible, free from vendor lock in and ever-increasing costs—it should be a no brainer. </p><p>“What's the holdup?” you might say. Well, Postgres is... complicated. </p><p>To create a self-managed cluster of Postgres clusters, DBAs have to consider infrastructure, environment, security, data management, backups, and workload-specific tuning. Further, maintaining and scaling Postgres involves meeting high availability requirements, managing data storage, updating schemas, optimizing query performance, and managing failover protection and caching. Lastly, extensions exist to support additional functionality in Postgres but they are hard to discover, evaluate, certify and deploy.</p><p>Put simply, Postgres is the solution.. <em>if</em> you can tame it and make it manageable. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="our-vision">Our Vision<a href="#our-vision" class="hash-link" aria-label="Direct link to Our Vision" title="Direct link to Our Vision">​</a></h2><p>This is where Tembo comes in. Tembo is the managed cloud to run Postgres and its entire ecosystem—extensions, applications, tools, and more—all within a single unified platform. It simplifies deploying Postgres with a virtualized runtime experience, enabling one-click migrations and access to the Postgres ecosystem. Developers can control the data model lifecycle, and deploy to multiple zones and clouds. Advanced options will include autoscaling, hybrid transactional and analytical processing (HTAP), and edge caching.</p><p>Additionally, Tembo invests in the Postgres extension ecosystem, aiming to standardize and simplify the use and creation of extensions. By unbundling and decoupling the database into services and abstraction layers, Tembo enables new simplicity and capability.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tembo-cloud">Tembo Cloud<a href="#tembo-cloud" class="hash-link" aria-label="Direct link to Tembo Cloud" title="Direct link to Tembo Cloud">​</a></h2><p>It's Postgres the way it <em>should</em> be. With Tembo, you don't have to be a database expert to build an expert database. We are building a dev-first, fully-extensible, fully-managed, secure, and scalable Postgres service. Available on all clouds and bare metal providers, Tembo Cloud provides the largest curated library of easily-installed extensions, allowing our customers to expand their use cases of Postgres.</p><p><img loading="lazy" alt="Organization home" src="/assets/images/org_home-d9bedbb2673b1b2475dc367da497d3cf.png" width="2662" height="1564" class="img_ev3q"></p><p><img loading="lazy" alt="Instance home" src="/assets/images/instance_home-ba650017410b6ebf93b19106b6ed0ee0.png" width="2684" height="1452" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tembo-stacks">Tembo Stacks<a href="#tembo-stacks" class="hash-link" aria-label="Direct link to Tembo Stacks" title="Direct link to Tembo Stacks">​</a></h2><p>It's “Postgres for Everything,” and we mean it. Stacks accelerate your development by enabling you to quickly create and deploy custom-built "flavors" of Postgres + extensions that are tailor made for key enterprise needs. No need to spin up new databases and endure the pain and associated sprawl—Stacks enable you to replace external, non-Postgres data services. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-this-mean">What Does This Mean?<a href="#what-does-this-mean" class="hash-link" aria-label="Direct link to What Does This Mean?" title="Direct link to What Does This Mean?">​</a></h2><p>No matter who you are or what you're trying to build, three things are true about Tembo:</p><ol><li><strong>True Managed Open Source</strong>: You don't have to settle for a complex web of OSS data services <strong>or</strong> a restrictive, locked-in, expensive managed contract with one of the large cloud providers. Tembo is committed to making true open-source Postgres manageable and accessible.</li><li><strong>Developer Centric</strong>: You <em>can</em> have the flexibility and control you've dreamed of. Tembo is made by developers, for developers; we give you fast deployment, automatic migration, and a clear path to genuine value. We win when you win.</li><li><strong>Future Proof</strong>: Postgres is the world's most developer beloved database. It isn't going anywhere, and with the constantly growing ecosystem of extensions and applications, it's only getting better. With Tembo, you get all the potential of that ever-growing network, right at the click of a button.</li></ol><p><strong>Tembo: It's everything you need to build anything on Postgres.</strong></p>]]></content:encoded>
            <author>noreply@tembo.io (Ry Walker)</author>
            <category>postgres</category>
            <category>announcement</category>
        </item>
        <item>
            <title><![CDATA[Introducing Tembo]]></title>
            <link>https://tembo.io/blog/introducing-tembo</link>
            <guid>https://tembo.io/blog/introducing-tembo</guid>
            <pubDate>Tue, 18 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[pink nodes]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" alt="pink nodes" src="/assets/images/db_pink_nodes-fddc2d65c8e2fdb033ebb5f4e367884c.png" width="1344" height="896" class="img_ev3q"></p><p>Hello, world :) We are thrilled to announce the launch of our new startup, Tembo, and our mission to build a game-changing managed Postgres service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2><p>While wrapping up my involvement in my previous company, I learned about the rich Postgres extension ecosystem, and was drawn to an idea that these extensions represent a big opportunity to expand the use cases for Postgres—maybe even collapse the modern data stack into a Postgres-centric platform, and eliminate a lot of unnecessary and expensive data movement.The vast majority of developers and companies primarily use "Vanilla" Postgres. This is partly because the current user experience of discovering, installing, and gaining proficiency in Postgres extensions is subpar—especially compared to other ecosystems. This has been voiced by many community members. As such, most existing managed services offer only a sliver of the potential value that extensions could provide.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="weve-started-a-company">We've started a company<a href="#weve-started-a-company" class="hash-link" aria-label="Direct link to We've started a company" title="Direct link to We've started a company">​</a></h2><p>Tembo’s mission is to continuously improve the dev experience of Postgres, especially in the area of expanded use cases that rely on community extensions.Postgres is the most loved database by a long shot, and all Postgres users (including me) owe a huge debt of gratitude to all the companies and people who have invested into Postgres over the past 26 years. Our goal is to serve the Postgres community in an increasingly valuable manner.Our mission is to empower developers and businesses worldwide with the full power of Postgres and its extensions ecosystem, enabling users to use Postgres for a growing number of use cases.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="weve-raised-some-money">We've raised some money<a href="#weve-raised-some-money" class="hash-link" aria-label="Direct link to We've raised some money" title="Direct link to We've raised some money">​</a></h2><p>We have raised a $6.5M seed round led by Venrock, with participation from CincyTech and Wireframe Ventures, and other influential tech angel investors, and we've already got a team of 10 working on our SaaS product and related open-source projects.
We've been building a product</p><p>We are building what we hope will be a world-class managed Postgres service:</p><ul><li>Use any extension, even custom or private extensions</li><li>Provide UI for popular extensions, and a framework to include the community in those efforts</li><li>Stacks - packaging of extensions, tools and configurations, to make it easy to get started using Postgres for specific new use cases</li><li>An intelligent advisor that helps you to better use the features that you’re already using in Postgres</li></ul><p><img loading="lazy" alt="create cluster" src="/assets/images/create_cluster-51e9af4adc3bfdbacf17b4c3ca64afa6.jpg" width="1440" height="918" class="img_ev3q"></p><p><img loading="lazy" alt="org home" src="/assets/images/org_home-3b71f96c0abcb8b3c0be59559dcec598.jpg" width="1440" height="1018" class="img_ev3q"></p><p>The Tembo team is incredibly excited to share our platform with you as we enter our closed beta period, and support your journey towards data-driven success. </p><p>We invite you to try <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, to access the future of database management.</p>]]></content:encoded>
            <author>noreply@tembo.io (Ry Walker)</author>
            <category>postgres</category>
            <category>announcement</category>
        </item>
    </channel>
</rss>