<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Tembo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" property="og:url" content="https://tembo.io/blog/page/2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Tembo"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tembo.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/page/2" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tembo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tembo Atom Feed">





<script id="hs-script-loader" src="//js.hs-scripts.com/23590420.js"></script>
<link rel="preconnect" href="https://cdn.segment.io">
<script>!function(){var e=window.analytics=window.analytics||[];if(!e.initialize)if(e.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{e.invoked=!0,e.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],e.factory=function(t){return function(){if(window.analytics.initialized)return window.analytics[t].apply(window.analytics,arguments);var n=Array.prototype.slice.call(arguments);return n.unshift(t),e.push(n),e}};for(var t=0;t<e.methods.length;t++){var n=e.methods[t];e[n]=e.factory(n)}e.load=function(t,n){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(a,i),e._loadOptions=n},e._writeKey="YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE",e.SNIPPET_VERSION="4.16.1",e.load("YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE"),e.page()}}()</script>
<link key="docusaurus-plugin-plausible-preconnect" rel="preconnect" href="https://plausible.io">
<script key="docusaurus-plugin-plausible-script" async defer="defer" data-domain="tembo.io" src="https://plausible.io/js/plausible.js"></script>
<script key="docusaurus-plugin-plausible-custom-events">window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>

<script>prefinery=window.prefinery||function(){(window.prefinery.q=window.prefinery.q||[]).push(arguments)}</script>
<script src="https://widget.prefinery.com/widget/v2/yisnnyak.js" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.92bb70b2.css">
<link rel="preload" href="/assets/js/runtime~main.ef584dc9.js" as="script">
<link rel="preload" href="/assets/js/main.75ceccb8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" href="/docs">Docs</a><a class="navbar__item navbar__link" target="_blank" href="/blog">Blog</a><a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Tembo Cloud<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/tembo-io/tembo-stacks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep8">Hacking Postgres, Ep. 8: Philippe Noël</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-self-regulating-queue">PGMQ: Lightweight Message Queue on Postgres with No Background Worker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep7">Hacking Postgres Ep. 7: Burak Yucesoy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator-apps">Application Services: Helping Postgres Do More, Faster</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep6">Hacking Postgres, Ep. 6: Regina Obe and Paul Ramsey</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator">Tembo Operator: A Rust-based Kubernetes Operator for Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/anon-dump">Anonymized dump of your Postgres data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep5">Hacking Postgres, Ep. 5: Alexander Korotkov</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep4">Hacking Postgres, Ep. 4: Pavlo Golub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep3">Hacking Postgres, Ep. 3: Eric Ridge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep2">Hacking Postgres, Ep. 2: Adam Hendel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep1">Hacking Postgres Ep. 1: Marco Slot</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-terraform-provider-for-tembo">Introducing Terraform Provider for Tembo</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-16">Postgres 16: The exciting and the unnoticed</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-stacks-intro">Tembo Stacks: Making Postgres the Everything Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/optimizing-postgres-auto-vacuum">Optimizing Postgres&#x27;s Autovacuum for High-Churn Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-with-python">Using pgmq with Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pg-later">Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pgmq">Introducing PGMQ: Simple Message Queues built on Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-manifesto">Tembo Manifesto</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-tembo">Introducing Tembo</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/hacking-postgres-ep2">Hacking Postgres, Ep. 2: Adam Hendel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-19T00:00:00.000Z" itemprop="datePublished">October 19, 2023</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ericankenman" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ericankenman.png" alt="Eric Ankenman"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ericankenman" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Eric Ankenman</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this episode, Ry and Adam talk about developing extensions for Postgres, being in the trenches of the modern data stack sprawl, and the future of what’s possible with Tembo Stacks. If you haven’t seen or listened to it yet, you can do so below, or on Apple/Spotify (or your podcast platform of choice). Special thanks to Adam for joining us today!</p><p>Want to know more about something they mentioned? Here’s a starting point:</p><iframe width="560" height="315" src="https://www.youtube.com/embed/8vkhlaY7AqM?si=ttqL-LBuwgXzEvFG" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><ul><li>Pgmq - <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>; also see Adam’s blog post about pgmq - <a href="https://tembo.io/blog/introducing-pgmq" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/introducing-pgmq</a></li><li>pg_later - <a href="https://github.com/tembo-io/pg_later" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pg_later</a>; Adam wrote about this one too - <a href="https://tembo.io/blog/introducing-pg-later" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/introducing-pg-later</a></li><li>clerk_fdw -<a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/clerk_fdw</a>; for more information, have a look at our blog post about it - <a href="https://tembo.io/blog/clerk-fdw/" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/clerk-fdw/</a></li><li>Supabase wrappers - <a href="https://github.com/supabase/wrappers" target="_blank" rel="noopener noreferrer">https://github.com/supabase/wrappers</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>pg_cron - <a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/pg_cron</a></li><li>Kafka - <a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">https://kafka.apache.org/</a></li><li>Tembo Stacks - <a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates</a>; also check out our blog about them - <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">https://tembo.io/blog/tembo-stacks-intro</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at @tembo_io or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000013---ry"><em>[00:00:13]<!-- --> - Ry</em><a href="#000013---ry" class="hash-link" aria-label="Direct link to 000013---ry" title="Direct link to 000013---ry">​</a></h5><p>Welcome to the show, Adam. Excited to chat with you today. How many postgres extensions have you authored in 2023?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000023---adam"><em>[00:00:23]<!-- --> - Adam</em><a href="#000023---adam" class="hash-link" aria-label="Direct link to 000023---adam" title="Direct link to 000023---adam">​</a></h5><p>Oh, it at least two.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000028---ry"><em>[00:00:28]<!-- --> - Ry</em><a href="#000028---ry" class="hash-link" aria-label="Direct link to 000028---ry" title="Direct link to 000028---ry">​</a></h5><p>At least two?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000029---adam"><em>[00:00:29]<!-- --> - Adam</em><a href="#000029---adam" class="hash-link" aria-label="Direct link to 000029---adam" title="Direct link to 000029---adam">​</a></h5><p>Well, in early 2023, I was just like, getting started and trying to figure out how to write one. And I know I wrote like a handful of them that didn&#x27;t really do anything. I think the first one was just put like a rest server inside an extension and see what happens. Kind of didn&#x27;t work very well.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000057---ry"><em>[00:00:57]<!-- --> - Ry</em><a href="#000057---ry" class="hash-link" aria-label="Direct link to 000057---ry" title="Direct link to 000057---ry">​</a></h5><p>Yeah, I remember that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000059---adam"><em>[00:00:59]<!-- --> - Adam</em><a href="#000059---adam" class="hash-link" aria-label="Direct link to 000059---adam" title="Direct link to 000059---adam">​</a></h5><p>I think I made like, a prometheus exporter, and then recently there were two ones that are kind of more useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000105---ry"><em>[00:01:05]<!-- --> - Ry</em><a href="#000105---ry" class="hash-link" aria-label="Direct link to 000105---ry" title="Direct link to 000105---ry">​</a></h5><p>Yeah, that&#x27;s great. Well, so obviously we know each other. We both worked together at Tembo. I mean, I could ask you questions as if I don&#x27;t already know the answers, but since I do, I&#x27;m not going to do that. I was going to say getting into postgres, though, joining Tembo wasn&#x27;t your first touch of postgres. Do you remember starting with, like I can&#x27;t really quite remember when I started. But can you remember when you did?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000133---adam"><em>[00:01:33]<!-- --> - Adam</em><a href="#000133---adam" class="hash-link" aria-label="Direct link to 000133---adam" title="Direct link to 000133---adam">​</a></h5><p>Well, the first time I heard of postgres I&#x27;m pretty sure was like in undergrad, like database management systems class. And it was like, there&#x27;s Oracle, there&#x27;s these companies around it, and then there&#x27;s open source stuff, postgresQL, you know? And I remember thinking, like, oh, that&#x27;s And I probably Googled it and saw the elephant. And then I know I started using it in undergrad. I was doing some scientific computing stuff and I just needed somewhere to I didn&#x27;t want to just keep writing to CSVs. I wanted to put it somewhere that was easier to search. And I just used postgres for it. Didn&#x27;t really know what I was doing. It was just like, dump it into this database.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000221---ry"><em>[00:02:21]<!-- --> - Ry</em><a href="#000221---ry" class="hash-link" aria-label="Direct link to 000221---ry" title="Direct link to 000221---ry">​</a></h5><p>Nice, nice. And then as far as hacking postgres, that just started recently, or have you messed with the internals of postgres prior to this year?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000235---adam"><em>[00:02:35]<!-- --> - Adam</em><a href="#000235---adam" class="hash-link" aria-label="Direct link to 000235---adam" title="Direct link to 000235---adam">​</a></h5><p>Definitely not prior to this year. It&#x27;s mostly focused on the application layer, building stuff on top of postgres. This year still getting deeper into the internals of postgres. I had installed some extensions before this year. Definitely didn&#x27;t even think about how do you write build an extension, but it&#x27;s.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000300---ry"><em>[00:03:00]<!-- --> - Ry</em><a href="#000300---ry" class="hash-link" aria-label="Direct link to 000300---ry" title="Direct link to 000300---ry">​</a></h5><p>Pretty easy to build them?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000301---adam"><em>[00:03:01]<!-- --> - Adam</em><a href="#000301---adam" class="hash-link" aria-label="Direct link to 000301---adam" title="Direct link to 000301---adam">​</a></h5><p>Yeah, that&#x27;s very recent for me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000302---ry"><em>[00:03:02]<!-- --> - Ry</em><a href="#000302---ry" class="hash-link" aria-label="Direct link to 000302---ry" title="Direct link to 000302---ry">​</a></h5><p>Pretty easy to build them. Right. Would you say?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000304---adam"><em>[00:03:04]<!-- --> - Adam</em><a href="#000304---adam" class="hash-link" aria-label="Direct link to 000304---adam" title="Direct link to 000304---adam">​</a></h5><p>Yeah. A shallow one is easy if you can learn rust. Yeah, it&#x27;s a challenge. I think it&#x27;s hard.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000317---ry"><em>[00:03:17]<!-- --> - Ry</em><a href="#000317---ry" class="hash-link" aria-label="Direct link to 000317---ry" title="Direct link to 000317---ry">​</a></h5><p>Yeah, I was kind of kidding.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000319---adam"><em>[00:03:19]<!-- --> - Adam</em><a href="#000319---adam" class="hash-link" aria-label="Direct link to 000319---adam" title="Direct link to 000319---adam">​</a></h5><p>And then there&#x27;s like a learning curve, and then once you get over a curve, you can kind of get moving with it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000327---ry"><em>[00:03:27]<!-- --> - Ry</em><a href="#000327---ry" class="hash-link" aria-label="Direct link to 000327---ry" title="Direct link to 000327---ry">​</a></h5><p>Maybe. Let&#x27;s talk about the extensions that you&#x27;re, I guess, most proud of or have the most traction so far. What are those?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000339---adam"><em>[00:03:39]<!-- --> - Adam</em><a href="#000339---adam" class="hash-link" aria-label="Direct link to 000339---adam" title="Direct link to 000339---adam">​</a></h5><p>Pgmq, I think, has the most traction message queue extension. It&#x27;s a lot like SQS Amazon&#x27;s simple Queue service or Redisimple Message queue except on postgres. Well, we wrote it for Tembo to help run our cloud. We needed a message queue between Control Plane and Data Plane, so we wrote it for that. And then just in the last couple of months, we started kind of talking about it in the community. And after we wrote a blog about it, we&#x27;ve had a few people from the community that didn&#x27;t know before who are now consistently contributing to the project. So Pgmq is definitely the one that I think has most traction.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000436---ry"><em>[00:04:36]<!-- --> - Ry</em><a href="#000436---ry" class="hash-link" aria-label="Direct link to 000436---ry" title="Direct link to 000436---ry">​</a></h5><p>And I think you&#x27;re also working on well, you kind of have a stack of them, right? Because your other extension relies on Pgmq. True?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000448---adam"><em>[00:04:48]<!-- --> - Adam</em><a href="#000448---adam" class="hash-link" aria-label="Direct link to 000448---adam" title="Direct link to 000448---adam">​</a></h5><p>PG later.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000450---ry"><em>[00:04:50]<!-- --> - Ry</em><a href="#000450---ry" class="hash-link" aria-label="Direct link to 000450---ry" title="Direct link to 000450---ry">​</a></h5><p>Is that true?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000451---adam"><em>[00:04:51]<!-- --> - Adam</em><a href="#000451---adam" class="hash-link" aria-label="Direct link to 000451---adam" title="Direct link to 000451---adam">​</a></h5><p>Yeah. Okay. Yeah, PG later, that&#x27;s another extension that lets you submit a query to Postgres and then forget about it and come back later and see the results from that query. And that&#x27;s built on top of Pgmq. So it&#x27;s like a stack of extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000520---ry"><em>[00:05:20]<!-- --> - Ry</em><a href="#000520---ry" class="hash-link" aria-label="Direct link to 000520---ry" title="Direct link to 000520---ry">​</a></h5><p>Nice. I guess you&#x27;re in the position now to be the extension mentor for others in the company who may be building extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000529---adam"><em>[00:05:29]<!-- --> - Adam</em><a href="#000529---adam" class="hash-link" aria-label="Direct link to 000529---adam" title="Direct link to 000529---adam">​</a></h5><p>I know.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000529---ry"><em>[00:05:29]<!-- --> - Ry</em><a href="#000529---ry" class="hash-link" aria-label="Direct link to 000529---ry" title="Direct link to 000529---ry">​</a></h5><p>I just hired a co op who&#x27;s working on one, and I imagine you&#x27;re mentoring him to some degree.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000537---adam"><em>[00:05:37]<!-- --> - Adam</em><a href="#000537---adam" class="hash-link" aria-label="Direct link to 000537---adam" title="Direct link to 000537---adam">​</a></h5><p>Yeah, Jay talking about? Yeah, Jay&#x27;s. Great. Hey, Jay. Jay, if you&#x27;re listening yeah. Jay&#x27;s been working on the another extension written in Rust, Clerk FDW. So it&#x27;s a foreign data wrapper around Clerk, which is like our identity provider. We just want to be able to build this data warehouse that has our users and their organizations and have that data persisted in our data warehouse. So we built well, Jay is building that foreign data wrapper around Clerk, which is pretty cool.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000617---ry"><em>[00:06:17]<!-- --> - Ry</em><a href="#000617---ry" class="hash-link" aria-label="Direct link to 000617---ry" title="Direct link to 000617---ry">​</a></h5><p>Yeah, we probably should give a shout out to Supabase for the Wrappers project that we&#x27;re using to build that with. Sounds like it&#x27;s been a pretty nice experience. Jay&#x27;s a co op that just joined, like, last week and so already being very productive. So I&#x27;m excited. I think that there&#x27;s the possibility of an explosion of new extensions for Postgres now that Pgrx allows us to use Rust. You agree with that?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000651---adam"><em>[00:06:51]<!-- --> - Adam</em><a href="#000651---adam" class="hash-link" aria-label="Direct link to 000651---adam" title="Direct link to 000651---adam">​</a></h5><p>Yeah, it&#x27;s pretty powerful because take this Clerk FDW, that extension that Jay&#x27;s building. We can bootstrap the software together the same way as you might do outside of Postgres, but we don&#x27;t have to spin up another resource somewhere, manage a pod or another VM, can package it up into an extension, use Supabase Wrapper. So that&#x27;s a software that&#x27;s already built. It&#x27;s tested. We don&#x27;t have to reinvent the wheel on that. We write the extension in Rust. So we pull in Rust libraries that are already built, already tested. Then we write our own tests on top of these things and then package it into our extension and then deploy it as part of the database. And then we can kind of just monitor the data there and not have to manage another service that could crash.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000754---ry"><em>[00:07:54]<!-- --> - Ry</em><a href="#000754---ry" class="hash-link" aria-label="Direct link to 000754---ry" title="Direct link to 000754---ry">​</a></h5><p>Yeah, it&#x27;s pretty nice. So I was going to change a little bit to...you&#x27;ve also been using a lot of other people&#x27;s extensions. Again, probably a lot more since joining Tembo than before, but what are some of your, I don&#x27;t know, favorite extensions that you&#x27;ve been exposed to?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000815---adam"><em>[00:08:15]<!-- --> - Adam</em><a href="#000815---adam" class="hash-link" aria-label="Direct link to 000815---adam" title="Direct link to 000815---adam">​</a></h5><p>Yeah, you said PG Cron a few different places. There&#x27;s another extension that I&#x27;m working on. It&#x27;s, like, really early, but it&#x27;s kind of wrapping up kind of some of the stuff that Langchain does in Python, but wrapping it up into an extension, pulling in PG vector into that, pulling in pg_cron, pulls in Pgmq and PostgresML as well. So it&#x27;s like a bootstrapped extension. So all of those are pretty good PostgresML, pg_cron, pgvector, and they all have pretty good docs, so you can get up and running with them quickly and kind of figure out what you need to do.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000909---ry"><em>[00:09:09]<!-- --> - Ry</em><a href="#000909---ry" class="hash-link" aria-label="Direct link to 000909---ry" title="Direct link to 000909---ry">​</a></h5><p>Yeah. So have you found that you&#x27;ve had to study the internals of postgres much as part of the process of building these extensions?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000923---adam"><em>[00:09:23]<!-- --> - Adam</em><a href="#000923---adam" class="hash-link" aria-label="Direct link to 000923---adam" title="Direct link to 000923---adam">​</a></h5><p>Not really too much. Only when I&#x27;m having trouble getting it up and running for the first time do I need to really look at postgres. But a lot of these extensions don&#x27;t. They&#x27;re not like touching with hooks into and replacing core functionality of postgres. They&#x27;re extending things. So a lot of what PostgresML does is just give you functions that go off and make rest calls or download data from elsewhere in the Internet and put it in your database for you, give you access to some pre trained machine learning models. And it&#x27;s not changing fundamentally how postgres runs. It&#x27;s still like the normal postgres. It&#x27;s kind of like a layer on top of yeah. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001019---ry"><em>[00:10:19]<!-- --> - Ry</em><a href="#001019---ry" class="hash-link" aria-label="Direct link to 001019---ry" title="Direct link to 001019---ry">​</a></h5><p>I think some extensions can do surgery and some are, know, laying on top of and not messing with the core functionality.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001028---adam"><em>[00:10:28]<!-- --> - Adam</em><a href="#001028---adam" class="hash-link" aria-label="Direct link to 001028---adam" title="Direct link to 001028---adam">​</a></h5><p>Right? Yeah, it&#x27;s an area I&#x27;m kind of new with that, so I haven&#x27;t gotten super deep into replacing core functionality of postgres quite yet. But soon we&#x27;ll probably start working in that space a little bit more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001047---ry"><em>[00:10:47]<!-- --> - Ry</em><a href="#001047---ry" class="hash-link" aria-label="Direct link to 001047---ry" title="Direct link to 001047---ry">​</a></h5><p>What&#x27;s, like the testing story? If you&#x27;re a dev that likes to write TDD, test driven development, are you able to do that with extensions in particular, I guess, with Pgrx. What&#x27;s the test driven story there look like?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001103---adam"><em>[00:11:03]<!-- --> - Adam</em><a href="#001103---adam" class="hash-link" aria-label="Direct link to 001103---adam" title="Direct link to 001103---adam">​</a></h5><p>Pgrx, I think, is pretty good. They have a way for you to say unit test or integration test for the extension that you&#x27;re writing, so you can say, execute some queries and then make assertions on the outputs of those queries. So kind of like, have normal assertions that you would do in whatever language that you&#x27;re testing. Pgrx has some tooling around like, oh, I want to spin up postgres 15.3, spin up a new environment for that, install your extension into it, and then run your test suite on it. Yeah, I guess it can get a little bit trickier, I think could be because depending on how complex the extension is, you could have system dependencies, um, like, oh, I need a specific version of GCC or something, or OpenSSL version something has to be installed. I haven&#x27;t really quite found a good way to test all of those things to make it super portable to say, like, yep, all these test pass. And that means my extension is just good for everybody.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001228---ry"><em>[00:12:28]<!-- --> - Ry</em><a href="#001228---ry" class="hash-link" aria-label="Direct link to 001228---ry" title="Direct link to 001228---ry">​</a></h5><p>For the test running on your local machine. I know they&#x27;re running on your local machine, but in a docker container or just natively.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001241---adam"><em>[00:12:41]<!-- --> - Adam</em><a href="#001241---adam" class="hash-link" aria-label="Direct link to 001241---adam" title="Direct link to 001241---adam">​</a></h5><p>You could do both, I guess. Kind of like my workflow for it. I guess I would do, like, run the test locally and then have the extension in a GitHub repo and have a CI pipeline that runs the same tests, but in Docker or within a GitHub workflow to be like, hey, before you merge this, you need to pass all these tests, kind of gate yourself a little bit.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001310---ry"><em>[00:13:10]<!-- --> - Ry</em><a href="#001310---ry" class="hash-link" aria-label="Direct link to 001310---ry" title="Direct link to 001310---ry">​</a></h5><p>That&#x27;s great. Well, cool. So I was going to ask, as far as your background prior to Tembo, you were doing little ML engineering too. Did you use postgres much in that role? I guess the question is, did you use any of the special parts of Postgres or was it really just like a standard transactional store with little knowledge of the extension ecosystem?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001339---adam"><em>[00:13:39]<!-- --> - Adam</em><a href="#001339---adam" class="hash-link" aria-label="Direct link to 001339---adam" title="Direct link to 001339---adam">​</a></h5><p>Nothing too crazy. I&#x27;ve always tried to do a queue on postgres, so be like, build up this giant queue of things that a machine learning model needs to make predictions on, or make a bunch of different predictions, dump them into a queue, and then have another process. Look at all these predictions and pick the best one before giving it back to the user. But a lot of OLTP like high transaction workloads in kind of machine learning space. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001418---ry"><em>[00:14:18]<!-- --> - Ry</em><a href="#001418---ry" class="hash-link" aria-label="Direct link to 001418---ry" title="Direct link to 001418---ry">​</a></h5><p>So you said you&#x27;ve been trying to build queues historically, a lot of times in bigger companies, there are less tools for various tasks. For example, use redis if you want to build a queue, or use snowflake if you want to build a data warehouse. I don&#x27;t even know that these things were officially declared by any sort of powers that be. It&#x27;s more like the sales reps at those companies decided that this company is going to be a salesforce company or a snowflake company. Right. It&#x27;s kind of a slow boil that you suddenly realize, oh, I guess we have kafka now. I guess we&#x27;re a kafka shop and starts with a POC and then ends up you have all these tools. We call it the modern data stack. But yeah, I&#x27;m curious how your take on that in particular? Around start with the queue since you&#x27;ve just implemented it in postgres and probably had to use other tools in the past.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001516---adam"><em>[00:15:16]<!-- --> - Adam</em><a href="#001516---adam" class="hash-link" aria-label="Direct link to 001516---adam" title="Direct link to 001516---adam">​</a></h5><p>Yeah, a couple of places that I&#x27;ve worked at, it&#x27;s like, hey, we need to pass messages between two services. And any engineer will be like, all right, well, we&#x27;re going to evaluate what we have here. We want to try to do things like, oh, let&#x27;s keep things simple, not make things too complex. And then depending on the size of the organization, it&#x27;ll be like, well, we use Kafka for messaging, so use Kafka. And so it&#x27;s like, okay, so make progress. A lot of times it&#x27;s better to not fight that and just be like, we want to make progress, we just need our application to work. It&#x27;s not like Kafka wouldn&#x27;t work for this, but it&#x27;s definitely overkill for a lot of situations. So then it&#x27;s like, okay, we&#x27;re going to build this in Kafka and maybe the rest of the application is in postgres, but this message piece of it, we&#x27;re going to put it in Kafka. And from the application perspective, it&#x27;s kind of no difference. Like I said, it&#x27;s an overkill tool for a lot of use cases. But then when things start to go wrong and need to troubleshoot it, it&#x27;s like, okay, now we have to bring in the Kafka expert.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001635---adam"><em>[00:16:35]<!-- --> - Adam</em><a href="#001635---adam" class="hash-link" aria-label="Direct link to 001635---adam" title="Direct link to 001635---adam">​</a></h5><p>And if it&#x27;s a big company, it&#x27;s probably a handful of people who are on this Kafka team and they got a lot of other stuff going on. So it&#x27;s like, what do you have to do? You have to learn Kafka. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001647---ry"><em>[00:16:47]<!-- --> - Ry</em><a href="#001647---ry" class="hash-link" aria-label="Direct link to 001647---ry" title="Direct link to 001647---ry">​</a></h5><p>And you&#x27;re a small use case, right? You&#x27;re like a small unimportant use case. And so, yeah, you can&#x27;t get their attention. You kind of accepted the fact that, okay, I can learn. It&#x27;s kind of fun to learn new technologies and try new things out, right? That&#x27;s the day. Zero joy of learning something new. But then now all of a sudden you&#x27;ve got to support it, right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001709---adam"><em>[00:17:09]<!-- --> - Adam</em><a href="#001709---adam" class="hash-link" aria-label="Direct link to 001709---adam" title="Direct link to 001709---adam">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001710---ry"><em>[00:17:10]<!-- --> - Ry</em><a href="#001710---ry" class="hash-link" aria-label="Direct link to 001710---ry" title="Direct link to 001710---ry">​</a></h5><p>You support what you make a lot of. Yeah, you got judoed into that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001716---adam"><em>[00:17:16]<!-- --> - Adam</em><a href="#001716---adam" class="hash-link" aria-label="Direct link to 001716---adam" title="Direct link to 001716---adam">​</a></h5><p>In my career, it was fun to learn Kafka and there&#x27;s some things I really like about it, but then at the same time, it&#x27;s a very complex tool and it does take a team to run and manage it. Same with RabbitMQ. If you&#x27;re going to do those things, you need some people dedicated to making sure that they&#x27;re functioning the way you expect it to.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001745---ry"><em>[00:17:45]<!-- --> - Ry</em><a href="#001745---ry" class="hash-link" aria-label="Direct link to 001745---ry" title="Direct link to 001745---ry">​</a></h5><p>Yeah, well, I think kind of leads into one of our core missions at the company, which you&#x27;re leading at Tembo, which is our stacks. I guess it probably would make sense for you to say a few words on what we&#x27;re trying to accomplish with stacks at the company.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001805---adam"><em>[00:18:05]<!-- --> - Adam</em><a href="#001805---adam" class="hash-link" aria-label="Direct link to 001805---adam" title="Direct link to 001805---adam">​</a></h5><p>Yeah. So stacks are workload optimized postgres clusters. So the message queue stack is one that we have and our goal with that is if you need to run a message queue, we want this to be the most optimized way to do a message queue on postgres. Of course, there&#x27;ll be a point in time when it&#x27;s like, hey, your use case has grown so big that maybe that stack&#x27;s not going to fit you, but that stack will be to the very edge of what postgres can do for that workload. We&#x27;re taking that same approach with our OLAP stack that we&#x27;re building right now. We have an OLTP stack, there&#x27;s a machine learning stack. So each one of these stacks is do it on postgres and we&#x27;re going to make it be the best possible squeeze every last piece of juice out of postgres that we possibly can for that workload.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001908---ry"><em>[00:19:08]<!-- --> - Ry</em><a href="#001908---ry" class="hash-link" aria-label="Direct link to 001908---ry" title="Direct link to 001908---ry">​</a></h5><p>Yeah. And you&#x27;re curating extensions for each stack. What else are you doing besides that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001913---adam"><em>[00:19:13]<!-- --> - Adam</em><a href="#001913---adam" class="hash-link" aria-label="Direct link to 001913---adam" title="Direct link to 001913---adam">​</a></h5><p>Yeah, extensions are a big piece. A lot of that has to do with there are certain types of developer experience that we think people want around workloads. And then there&#x27;s the postgres configuration itself. So like, what should shared buffers be or how many parallel worker processes and how should the auto vacuum vacuum error be tuned for that workload? That&#x27;s a whole class of things that are unique to every stack. Of course, there&#x27;s like a user interface component of every stack as well. So if you want to come up and to look and see and observe the stack, there&#x27;ll be user interface metrics are kind of really tightly related to the UI, so there&#x27;s different metrics for every stack as well. Some of them are going to be the same across stacks. But for example, current number of messages in a queue, that&#x27;s like a metric that you can monitor, you can write alerts around that metric and it&#x27;s mostly unique to the message queue workload.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002032---ry"><em>[00:20:32]<!-- --> - Ry</em><a href="#002032---ry" class="hash-link" aria-label="Direct link to 002032---ry" title="Direct link to 002032---ry">​</a></h5><p>Yeah. And if the message queue stack is competing against a commercial queue product, they probably have some sort of visualization of the state of each queue.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002045---adam"><em>[00:20:45]<!-- --> - Adam</em><a href="#002045---adam" class="hash-link" aria-label="Direct link to 002045---adam" title="Direct link to 002045---adam">​</a></h5><p>Right?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002046---ry"><em>[00:20:46]<!-- --> - Ry</em><a href="#002046---ry" class="hash-link" aria-label="Direct link to 002046---ry" title="Direct link to 002046---ry">​</a></h5><p>And so a postgres backed queue ought to have that same UI, that same monitoring tailored monitoring system. It makes it, I don&#x27;t know how many times harder versus just configuration and curating some extensions, but I think it&#x27;s all worth it to the user to be able to really defend their choice to use postgres for this use case against one of the modern data stack alternatives. </p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002120---adam"><em>[00:21:20]<!-- --> - Adam</em><a href="#002120---adam" class="hash-link" aria-label="Direct link to 002120---adam" title="Direct link to 002120---adam">​</a></h5><p>Right? Yeah. I think something really useful that I like about having stacks and having postgres aligned to specific workloads, the complexity of an overall application can really come down a lot by running everything on postgres. You could still have separate postgres clusters for workloads, like a certain set of CPU and memory dedicated to mission critical process A and a separate one for this other mission critical process. But still when it comes to troubleshooting these things, you&#x27;re troubleshooting postgres and it&#x27;s not like, hey, I have to switch and be like, okay, now I&#x27;m troubleshooting Kafka, or jumping to Redis or jumping to Mongo or Snowflake. It&#x27;s still like the context switching I think, for the developers is big time minimized when it&#x27;s still the same underlying data store between all the different workloads, same technology. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002227---ry"><em>[00:22:27]<!-- --> - Ry</em><a href="#002227---ry" class="hash-link" aria-label="Direct link to 002227---ry" title="Direct link to 002227---ry">​</a></h5><p>And we have this vision of potentially having some built in stack connectivity, right, where these databases, if they&#x27;re all kind of sitting back to back to back so you have five different stacks they could and should be able to communicate really well with each other. And you should be able to write queries across them in the same way that Citus allows you to write queries across an array of postgres clusters very efficiently. You should be able to do the same thing here and pull data from multiple stacks with a very nice user experience, again, without having to move data around. So that&#x27;s one of the exciting things for me as a former airflow company founder. All these data pipelines are very painful between modern data stack companies. And one of the things I&#x27;m excited about is the possibility that we can give developers the option to not have to create all those pipelines.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002336---adam"><em>[00:23:36]<!-- --> - Adam</em><a href="#002336---adam" class="hash-link" aria-label="Direct link to 002336---adam" title="Direct link to 002336---adam">​</a></h5><p>Yeah, I&#x27;m really excited to work on that problem when we start doing that, but that&#x27;ll be I think, a really big differentiator is to say I have ten different machines running postgres and I have a single pane of view across all of them. I think it&#x27;s definitely doable. It&#x27;ll be challenging.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002402---ry"><em>[00:24:02]<!-- --> - Ry</em><a href="#002402---ry" class="hash-link" aria-label="Direct link to 002402---ry" title="Direct link to 002402---ry">​</a></h5><p>Yeah, it&#x27;s a dream we&#x27;re chasing. Yeah. Good. Well, I think it was great chatting with you, Adam. I&#x27;m sure we&#x27;ll have you on the show again. I know that, again, you&#x27;ve got a lot more extensions coming and appreciate the work you&#x27;ve done for the community so far and yeah, looking forward to seeing your future work and talking about it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002428---adam"><em>[00:24:28]<!-- --> - Adam</em><a href="#002428---adam" class="hash-link" aria-label="Direct link to 002428---adam" title="Direct link to 002428---adam">​</a></h5><p>Sounds good. Thanks a lot, Ry.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/hacking-postgres">hacking_postgres</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/RAG-cd4c28ec5c956f11e8de9ccf5bde2db2.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-18T00:00:00.000Z" itemprop="datePublished">October 18, 2023</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/binidxaba.png" alt="Binidxaba"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Binidxaba</span></a></div><small class="avatar__subtitle" itemprop="description">Community contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>Language models are like the wizards of the digital world, conjuring up text that sounds eerily human. These marvels of artificial intelligence, such as GPT-3.5, are sophisticated algorithms that have been trained on vast swathes of text from the internet. They can understand context, generate coherent paragraphs, translate languages, and even assist in tasks like writing, chatbots, and more. Think of them as your trusty digital scribe, ready to assist with their textual sorcery whenever you summon them.</em></p><p>If you have used ChatGPT in the past, you probably were able to suspect that the previous paragraph was generated using it. And that&#x27;s true. See the prompt <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">here</a>.</p><p>From the example above, you can witness the eloquence LLMs are capable of. Some people have been shocked so much that they became convinced that these <a href="https://www.scientificamerican.com/article/google-engineer-claims-ai-chatbot-is-sentient-why-that-matters/" target="_blank" rel="noopener noreferrer">models were sentient</a>. However, in the end, they are nothing but a large, complex series of <a href="https://www.youtube.com/watch?v=bCz4OMemCcA" target="_blank" rel="noopener noreferrer">matrix and vector operations</a>. These matrices and vectors have been trained to represent the semantic meaning of words.</p><p>In today&#x27;s post, we will explore these meaning vectors and how they are related to Postgres. In particular, we are going to play with sentence transformers, vectors, and similarity search. All of that with the help of the pgvector Postgres extension.</p><p>Let’s go!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="from-words-to-vectors">From words to vectors<a href="#from-words-to-vectors" class="hash-link" aria-label="Direct link to From words to vectors" title="Direct link to From words to vectors">​</a></h2><p>Like we said, a vector can represent many things, for example, the position of a character in a 3D video game, the position of a pixel in your screen, the force applied to an object, a color in the RGB space, or even the meaning of a word…</p><p>Word embedding refers to the technique by which words can be represented as vectors. These days, the embeddings offered by <a href="https://openai.com/blog/new-and-improved-embedding-model" target="_blank" rel="noopener noreferrer">OpenAI</a> are very popular. However, other alternatives exist, like <a href="https://arxiv.org/abs/1301.3781" target="_blank" rel="noopener noreferrer">word2vect</a>, <a href="https://aclanthology.org/D14-1162.pdf" target="_blank" rel="noopener noreferrer">Glove</a>, <a href="https://fasttext.cc/docs/en/support.html" target="_blank" rel="noopener noreferrer">FastText</a>, and <a href="https://arxiv.org/abs/1802.05365v2" target="_blank" rel="noopener noreferrer">ELMo</a>.</p><p>Similarly, entire sentences can be represented as vectors using <a href="https://platform.openai.com/docs/guides/embeddings/what-are-embeddings" target="_blank" rel="noopener noreferrer">OpenAI embeddings</a> or <a href="https://sbert.net/" target="_blank" rel="noopener noreferrer">SentenceTransformers</a>, for example.</p><p>These models can be accessed through libraries for different languages. The following Python snippet shows how to obtain the vector embeddings of three sentences using SentenceTransformer:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SentenceTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SentenceTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentences </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SentenceTransformers is a Python framework for state-of-the-art sentence, text and image embeddings.&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;Pgvector is postgres extension for vector similarity search.&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;Tembo will help you say goodby to database sprawl, and hello to Postgres.&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence_embeddings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Sentence:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Embedding:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The code used in this blog post can be found in <a href="https://gist.github.com/binidxaba/2eb3bff573c6be700e4391d650a302db" target="_blank" rel="noopener noreferrer">this gist</a>.</p></div></div><p>The mind-blowing part is that words and sentences with a similar meaning will have similar vectors. This characteristic is the basis of a search technique called similarity search, where we simply find the nearest embedding vectors to find texts that are similar to our query.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-meets-language-models">Postgres meets Language Models<a href="#postgres-meets-language-models" class="hash-link" aria-label="Direct link to Postgres meets Language Models" title="Direct link to Postgres meets Language Models">​</a></h2><p>Models are great at generating content that seems credible, as shown earlier. However, you may have experienced cases where ChatGPT hallucinates answers or delivers out-of-date information. That&#x27;s because LLMs are <strong>pre-trained</strong> using <strong>general data</strong>. And, because of that, creating a chatbot based only on the pre-trained data wouldn&#x27;t be helpful for your customers, for instance.</p><p>The concept of <a href="https://arxiv.org/abs/2005.11401" target="_blank" rel="noopener noreferrer">RAG (Retrieval-Augmented Generation)</a> acknowledges this limitation. </p><p>One way of overcoming these problems is to store your company&#x27;s knowledge base in a database.... preferably in a vector database. You could then query related content and feed that content to the LLM of your preference.</p><p><img loading="lazy" alt="RAG with pgvector" src="/assets/images/RAG-cd4c28ec5c956f11e8de9ccf5bde2db2.png" width="450" height="288" class="img_ev3q"></p><p>Specialized vector databases include <a href="https://milvus.io/" target="_blank" rel="noopener noreferrer">Milvus</a>, <a href="https://qdrant.tech/" target="_blank" rel="noopener noreferrer">Qdrant</a>, <a href="https://weaviate.io/" target="_blank" rel="noopener noreferrer">Weaviate</a>, and <a href="https://www.pinecone.io/" target="_blank" rel="noopener noreferrer">Pinecone</a>. However, you probably want to <a href="https://www.amazingcto.com/postgres-for-everything/" target="_blank" rel="noopener noreferrer">stick to your Postgres database</a>. </p><p>Postgres is not in itself a vector database, but extensions can come to the rescue one more time... This time with <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer"><strong>pgvector</strong></a>.</p><p>Let&#x27;s use it and explore how we would query related content from a Postgres database.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvector-postgres-as-a-vector-database">pgvector: Postgres as a vector database<a href="#pgvector-postgres-as-a-vector-database" class="hash-link" aria-label="Direct link to pgvector: Postgres as a vector database" title="Direct link to pgvector: Postgres as a vector database">​</a></h2><p><a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">pgvector</a> is a Postgres extension that helps work with vectors and stores them in your postgres database. It offers functions for calculating the distance between vectors and for similarity search.</p><p>For the following demo, I converted all of Tembo’s blogs into document vectors using the following Python script that uses the <a href="https://python.langchain.com" target="_blank" rel="noopener noreferrer">langchain framework</a>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">document_loaders </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TextLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text_splitter </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RecursiveCharacterTextSplitter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vectorstores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pgvector </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> PGVector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONNECTION_STRING </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;postgresql+psycopg2://postgres:password@localhost:5432/vector_db&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COLLECTION_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_collection&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text_splitter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RecursiveCharacterTextSplitter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chunk_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chunk_overlap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./corpus&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin">file</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;./corpus/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">file</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Loading: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">file_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TextLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    document </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> loader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    texts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> text_splitter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">document</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_content </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> texts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGVector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            embedding</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            documents</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">texts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            collection_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">COLLECTION_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection_string</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">CONNECTION_STRING</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It basically loads each document and then inserts them into Postgres using the <a href="https://python.langchain.com/docs/integrations/vectorstores/pgvector" target="_blank" rel="noopener noreferrer"><code>PGVector</code> class</a>. As a result, in my Postgres database called <code>vector_db</code>, I got two tables:</p><p><img loading="lazy" alt="Show tables" src="/assets/images/table-list-3c5b0f371564f4dd0af86bcf7d14e209.png" width="434" height="177" class="img_ev3q"></p><ul><li><code>langchain_pg_collection</code>: contains information about all collections.</li><li><code>langchain_pg_embedding</code>: contains all the resulting vectors.</li></ul><p>The following picture shows part of the contents of (2):</p><p><img loading="lazy" alt="Show vectors" src="/assets/images/select-vectors-8523ebc09c243b1bc0987332c2225b8b.png" width="1470" height="465" class="img_ev3q"></p><p>The resulting vectors have <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2" target="_blank" rel="noopener noreferrer">384 dimensions</a>.  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="are-these-sentences-similar">Are these sentences similar?<a href="#are-these-sentences-similar" class="hash-link" aria-label="Direct link to Are these sentences similar?" title="Direct link to Are these sentences similar?">​</a></h2><p>Let’s now play with these vectors.</p><p>Using pgvector we can search content that is similar to a query. For example, we can find content related to <code>postgres 16</code>.</p><p>First, we can obtain a vector that represents a query:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“What </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> new </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> postgres </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then we can search vectors stored in the database that are similar to the query vector. The tool for that is <a href="https://en.wikipedia.org/wiki/Cosine_similarity" target="_blank" rel="noopener noreferrer"><code>cosine distance</code></a>, which in pgvector is represented with the <code>&lt;=&gt;</code> operator:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding </span><span class="token operator" style="color:#393A34">&lt;=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[&lt;your_vector_here&gt;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> langchain_pg_embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> cosine_similarity </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above query retrieves vectors/chunks of text ordered by how close they are (in terms of <code>cosine distance</code>) to the query vector. In my case, the most similar chunk of text was:</p><blockquote><p>In case you missed it, Postgres 16 came out last week - and this year it
arrived earlier than the last few years. There are many features that
I’ve been looking forward to for the last few months and I’m excited to
see them get into the hands of users. Before we dive into the specific
features of this release, let’s discuss what a Postgres major release
actually means.</p><p>[postgres-16]</p><p>Postgres Releases</p><p>The PostgreSQL Global Development Group releases a new major version
every year with new features.</p><p>In addition, Postgres releases minor versions of each major release
every 3 months or so with bug fixes and security fixes. No new features
are released in minor versions, and that’s what makes major version
releases so exciting as it’s the culmination of about a year’s worth of
development work on the project.</p></blockquote><p>Which is an excerpt from <a href="https://tembo.io/blog/postgres-16" target="_blank" rel="noopener noreferrer">Postgres 16: The exciting and the unnoticed</a>.</p><p>Let us look at what Postgres is doing behind the scenes, using <code>explain analyze</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit  (cost=28.07..28.08 rows=2 width=641) (actual time=1.069..1.071 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Sort  (cost=28.07..28.53 rows=181 width=641) (actual time=1.067..1.068 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Key: ((embedding &lt;=&gt; &#x27;[&lt;your_vector&gt;]&#x27;::vector))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Method: top-N heapsort  Memory: 28kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         -&gt;  Seq Scan on langchain_pg_embedding  (cost=0.00..26.26 rows=181 width=641) (actual time=0.036..0.953 rows=181 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.079 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.093 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(7 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can observe that Postgres is sequentially scanning all rows. Then it computes the <code>cosine distance</code> for all those rows and sorts them. Finally,  it takes the first two rows.</p><p>The <code>sequential scan</code> could be avoided if we had an index. Indeed, we can create one thanks to pgvector, for example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> langchain_pg_embedding </span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> vector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">384</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> langchain_pg_embedding  </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> ivfflat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding vector_cosine_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lists </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Limit  (cost=5.01..5.11 rows=2 width=641) (actual time=0.175..0.179 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Index Scan using langchain_pg_embedding_embedding_idx2 on langchain_pg_embedding  (cost=5.01..13.49 rows=181 width=641) (actual time=0.172..0.175 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Order By: (embedding &lt;=&gt; &#x27;[&lt;your_vector&gt;]&#x27;::vector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.154 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.224 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One thing to keep in mind is that these indexes are used for <code>approximate nearest neighbor search</code>. We’ll explore what that means in a future blog post. <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">Let us know</a> if that would be interesting for you.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvectorize">Pgvector(ize)?<a href="#pgvectorize" class="hash-link" aria-label="Direct link to Pgvector(ize)?" title="Direct link to Pgvector(ize)?">​</a></h2><p>Ok, at this point you should now have a sense of what pgvector is, and how to use it together with Python. However, wouldn&#x27;t it be great if the vectorizing step could happen all within Postgres?</p><p><a href="https://github.com/tembo-io/pg_vectorize" target="_blank" rel="noopener noreferrer"><strong>Pg_vectorize</strong></a> is an extension being developed by <strong>Tembo</strong> that intends to streamline the process of generating vectors from the data in your Postgres tables. It uses a background worker to generate and update the embeddings in batches every <em>N</em> seconds. Also, if you need to find similar vectors, the extension can do that. All within Postgres. Isn&#x27;t that a cool idea? </p><p>I invite you to check out the repository and stay tuned.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="to-wrap-up">To wrap up...<a href="#to-wrap-up" class="hash-link" aria-label="Direct link to To wrap up..." title="Direct link to To wrap up...">​</a></h2><p>In this post, we briefly discussed the concept of <code>embeddings</code>, why they are important, and how they can be generated using one of the multiple available libraries. We also explored how to store and query the resulting vectors using Postgres and the pgvector extension.</p><p>These concepts are relevant to leveraging a knowledge base in conjunction with LLMs in an emerging technique called RAG. Of course, when implementing a real-life solution, <a href="ttps://medium.com/@neum_ai/retrieval-augmented-generation-at-scale-building-a-distributed-system-for-synchronizing-and-eaa29162521" target="_blank" rel="noopener noreferrer">more factors need to be considered</a>, and this post was just an introduction.</p><p>I invite everyone to try out pgvector (e.g. using the scripts in this post), and the different operations that it offers. Also, can you think of other uses of pgvector? Let us know your thoughts in <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h2><p><em>The first paragraph in this blog post was generated using ChatGPT. <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">Here’s the prompt</a></em></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/embedding">embedding</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/vector">vector</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgvector">pgvector</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/hacking-postgres-ep1">Hacking Postgres Ep. 1: Marco Slot</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-16T00:00:00.000Z" itemprop="datePublished">October 16, 2023</time> · <!-- -->26 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ericankenman" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ericankenman.png" alt="Eric Ankenman"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ericankenman" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Eric Ankenman</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="episode-notes">Episode Notes<a href="#episode-notes" class="hash-link" aria-label="Direct link to Episode Notes" title="Direct link to Episode Notes">​</a></h2><p>In this episode, Ry and Marco talk about the early days of Citus and its development, creating pg_cron (on a plane!), and the new possibilities on the horizon for extensions in the Postgres landscape. If you haven’t seen or listened to it yet, you can play the video below, or listen on Apple/Spotify (or your podcast platform of choice). Special thanks to Marco for joining us today!</p><iframe width="560" height="315" src="https://www.youtube.com/embed/UxUrn6bKDfU?si=JMm_cMMPToh1K2KK" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><p>Want to know more about something they mentioned? Here’s a starting point:</p><ul><li>CloudFront - <a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/cloudfront/</a></li><li>Citus - <a href="https://www.citusdata.com/" target="_blank" rel="noopener noreferrer">https://www.citusdata.com/</a></li><li>pg_cron - <a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">https://github.com/citusdata/pg_cron</a></li><li>pg_timetable - <a href="https://github.com/cybertec-postgresql/pg_timetable" target="_blank" rel="noopener noreferrer">https://github.com/cybertec-postgresql/pg_timetable</a></li><li>pgrx - <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a></li><li>PostGIS - <a href="https://postgis.net/" target="_blank" rel="noopener noreferrer">https://postgis.net/</a></li><li>PostgresML - <a href="https://postgresml.org/" target="_blank" rel="noopener noreferrer">https://postgresml.org/</a></li><li>pgvector - <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">https://github.com/pgvector/pgvector</a></li><li>pg_embedding - <a href="https://github.com/neondatabase/pg_embedding" target="_blank" rel="noopener noreferrer">https://github.com/neondatabase/pg_embedding</a></li></ul><p>Did you enjoy the episode? Have ideas for someone else we should invite? Let us know your thoughts on X at <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a> or share them with the team in our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-23o25qt91-AnZoC1jhLMLubwia4GeNGw" target="_blank" rel="noopener noreferrer">Slack Community</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transcript">Transcript<a href="#transcript" class="hash-link" aria-label="Direct link to Transcript" title="Direct link to Transcript">​</a></h2><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000012---ry"><em>[00:00:12]<!-- --> - Ry</em><a href="#000012---ry" class="hash-link" aria-label="Direct link to 000012---ry" title="Direct link to 000012---ry">​</a></h5><p>Welcome to Hacking Postgres. Today we have Marco Slot joining us. I&#x27;m meeting Marco for the first time today. I&#x27;m super excited to be meeting you, Marco. Welcome to the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000025---marco"><em>[00:00:25]<!-- --> - Marco</em><a href="#000025---marco" class="hash-link" aria-label="Direct link to 000025---marco" title="Direct link to 000025---marco">​</a></h5><p>Hey Ry. Yeah, very nice to meet you. Yeah. So I&#x27;m Marco, I work at Microsoft and I&#x27;ve been working on Postgres extensions for about nine years now, starting with Citus, pgCron, and a bunch of other ones. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000044---ry"><em>[00:00:44]<!-- --> - Ry</em><a href="#000044---ry" class="hash-link" aria-label="Direct link to 000044---ry" title="Direct link to 000044---ry">​</a></h5><p>That&#x27;s awesome.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000045---marco"><em>[00:00:45]<!-- --> - Marco</em><a href="#000045---marco" class="hash-link" aria-label="Direct link to 000045---marco" title="Direct link to 000045---marco">​</a></h5><p>Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000045---ry"><em>[00:00:45]<!-- --> - Ry</em><a href="#000045---ry" class="hash-link" aria-label="Direct link to 000045---ry" title="Direct link to 000045---ry">​</a></h5><p>So this is not really supposed to be an interview. It&#x27;s more just us geeking out about Postgres, extensions, what they mean to users and opinions about anything and everything related to our work is fair game. Yeah, sounds good. So what&#x27;d you do before you got into Postgres stuff, out of curiosity?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000109---marco"><em>[00:01:09]<!-- --> - Marco</em><a href="#000109---marco" class="hash-link" aria-label="Direct link to 000109---marco" title="Direct link to 000109---marco">​</a></h5><p>Yeah. My background is more in distributed systems, so I spent a few years at AWS. It was quite early days in AWS when I think I joined. There were three Web Services. S3, SQS and EC2.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000124---ry"><em>[00:01:24]<!-- --> - Ry</em><a href="#000124---ry" class="hash-link" aria-label="Direct link to 000124---ry" title="Direct link to 000124---ry">​</a></h5><p>Wow.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000125---marco"><em>[00:01:25]<!-- --> - Marco</em><a href="#000125---marco" class="hash-link" aria-label="Direct link to 000125---marco" title="Direct link to 000125---marco">​</a></h5><p>And then we built number Four, which was CloudFront, which gives people started using S3 for websites, which it wasn&#x27;t really built for. But then we were asked to solve this and we built the CDN, and then we also built Route 53 for the DNS.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000140---ry"><em>[00:01:40]<!-- --> - Ry</em><a href="#000140---ry" class="hash-link" aria-label="Direct link to 000140---ry" title="Direct link to 000140---ry">​</a></h5><p>Wow.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000141---marco"><em>[00:01:41]<!-- --> - Marco</em><a href="#000141---marco" class="hash-link" aria-label="Direct link to 000141---marco" title="Direct link to 000141---marco">​</a></h5><p>And then yeah, I did a PhD in sort of self driving cars, but specifically like, cooperation between self driving cars, like, what if they can communicate with each other and sort of coordinate? So it&#x27;s sort of advanced distributed systems in a way as well. Yeah. So that led to me joining Citus, which is sort of founded by former Amazon folks.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000205---ry"><em>[00:02:05]<!-- --> - Ry</em><a href="#000205---ry" class="hash-link" aria-label="Direct link to 000205---ry" title="Direct link to 000205---ry">​</a></h5><p>Got it. So building Citus was probably easy compared to all other stuff, actually.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000212---marco"><em>[00:02:12]<!-- --> - Marco</em><a href="#000212---marco" class="hash-link" aria-label="Direct link to 000212---marco" title="Direct link to 000212---marco">​</a></h5><p>Yeah. If you do self driving cooperation between self driving cars, which is this kind of like life critical system distribute where your nodes kind of just move around and they move away from each other, it does make things relatively easy. But then yeah, building databases is never actually very easy.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000231---ry"><em>[00:02:31]<!-- --> - Ry</em><a href="#000231---ry" class="hash-link" aria-label="Direct link to 000231---ry" title="Direct link to 000231---ry">​</a></h5><p>No, I know. How good do you want to make it right? Is how hard it becomes.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000238---marco"><em>[00:02:38]<!-- --> - Marco</em><a href="#000238---marco" class="hash-link" aria-label="Direct link to 000238---marco" title="Direct link to 000238---marco">​</a></h5><p>Yeah. I guess the challenge is always everything sort of in the word relational. Right. Like everything relates to everything else. There&#x27;s not like a feature you can implement without considering all the other aspects of the database and all the things that can happen concurrently with the operation that you&#x27;re working on and all the possible ways in which things can fail. Especially if you&#x27;re in a kind of distributed setup.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000301---ry"><em>[00:03:01]<!-- --> - Ry</em><a href="#000301---ry" class="hash-link" aria-label="Direct link to 000301---ry" title="Direct link to 000301---ry">​</a></h5><p>Yeah, I think that&#x27;s really interesting perspective. You think of all of the configuration options, too. Adding a new configuration option adds complexity, adds flexibility, adds potential complex, and it&#x27;s tough.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000320---marco"><em>[00:03:20]<!-- --> - Marco</em><a href="#000320---marco" class="hash-link" aria-label="Direct link to 000320---marco" title="Direct link to 000320---marco">​</a></h5><p>Yeah, definitely. I think one thing we learned is there&#x27;s a sort of certain danger in creating modes where every setting you add, which can be on/off now you have two modes in your system. You add another setting that can be on/off. Now you have four modes in your system. It&#x27;s kind of this exponential explosion of possible ways in which your database might be running. And so that&#x27;s hard learned lesson that&#x27;s, like, don&#x27;t introduce major modes. Sometimes you have to because of backwards compatibility reasons, maybe, but you want to get rid of them over time.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000357---ry"><em>[00:03:57]<!-- --> - Ry</em><a href="#000357---ry" class="hash-link" aria-label="Direct link to 000357---ry" title="Direct link to 000357---ry">​</a></h5><p>Were you one of the first team members on Citus? Actually, I don&#x27;t really know the full history. Did it start as a fork and made its way as an extension, or was it always an extension?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000410---marco"><em>[00:04:10]<!-- --> - Marco</em><a href="#000410---marco" class="hash-link" aria-label="Direct link to 000410---marco" title="Direct link to 000410---marco">​</a></h5><p>Yeah, I was one of the first, though I think Samay was already there. I think he&#x27;s joined Tembo. So but yeah, we started out as a fork and then we called it CitusDB, and then we made it an extension and called it Citus. Though I think the name CitusDB kind of stuck around for...I still hear it sometimes. But yeah, it was very pretty early days for extensions. Like 2015 PostGIS obviously existed. It was one of the first major ones. But yeah, we were lucky at the time. We had Andres Freund working for us. Well, he&#x27;s also now working for Microsoft, but he&#x27;s like one of the top Postgres committers, and we put him in a room for a while, know, can you turn this into an extension, please? And he came up with some terrible, terrible hacks. But over time, those also drove some of the extension APIs in Postgres itself, where things that used to require really terrible hacks are now kind of more structured and you can introduce your own sort of data structures into Postgres without doing lots of weird stuff.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000522---ry"><em>[00:05:22]<!-- --> - Ry</em><a href="#000522---ry" class="hash-link" aria-label="Direct link to 000522---ry" title="Direct link to 000522---ry">​</a></h5><p>Well, I was thinking probably not everybody knows what Citus is. Maybe if you could give a quick I&#x27;d love to hear a quick overview of what it is and then maybe a couple of things that maybe you can think of that are unusual, that people might not know about it, that are part of it. I don&#x27;t know if that&#x27;s a stupid question, but yeah, if you could try no.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000541---marco"><em>[00:05:41]<!-- --> - Marco</em><a href="#000541---marco" class="hash-link" aria-label="Direct link to 000541---marco" title="Direct link to 000541---marco">​</a></h5><p>Yeah, so it comes from basically this denotion that Postgres is ultimately limited to a single machine. I mean, you can read replicas, but you definitely cannot scale the writes. Usually if you have read replicas, they&#x27;ll kind of end up having the same stuff in memory. So you cannot really scale the memory either. And so Citus is a solution to basically adds sharding to Postgres in a very transparent way, where you can have tables that are sort of transparently sharded across many nodes, you still connect to a Postgres server. There&#x27;s just a table, looks, walks, and talks like a table. But if you insert into it, it actually gets rooted to a particular node. And if you insert another value, it might get rooted into another node that uses this hash distribution. And that way you can scale across infinitely many machines and have some users have petabytes of data in their Citus cluster part of the advantage is also that queries can get paralyzed on these tables because we can use all the nodes at the same time and multiple cores per node. But more and more it&#x27;s also actually being used for LTP workloads.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000655---marco"><em>[00:06:55]<!-- --> - Marco</em><a href="#000655---marco" class="hash-link" aria-label="Direct link to 000655---marco" title="Direct link to 000655---marco">​</a></h5><p>And particularly the most popular use case is actually multitenancy, where you have this kind of B2B app where you have lots of relatively independent users and you kind of want to just transparently spread those across different machines without having to actually manage that yourself and figure out how to move data around. Because that was all very kind of automated. You can just ask it to rebalance your data and it does that using logical replication. And so then you have the advantage of just as much memory as you need to make your application fast and as much disk IOPS as you need by just adding more machines with more disks and so that helps you scale. And then we have a sort of managed service in Azure around that. But yeah, we use every hook that&#x27;s available in Postgres to achieve things like starting with the planner hook. That&#x27;s one of the interesting things about Postgres. It&#x27;s like you just replace the whole planner with something else. You get a parsed query tree and then you can do whatever you want with it. You can just do some like okay, look at this query and log something interesting and then just go to the regular planner.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000812---marco"><em>[00:08:12]<!-- --> - Marco</em><a href="#000812---marco" class="hash-link" aria-label="Direct link to 000812---marco" title="Direct link to 000812---marco">​</a></h5><p>Or you could just do something completely different. And so we use all these hooks to kind of create this facade around Postgres tables where it&#x27;s like Postgres table is still there, you just cannot touch it. We just intercept everything that&#x27;s going on. The most recent and most terrible hack we did it was like the give it as this hack in Postgres so we can figure out so we have shards. Like the writes go into shards but then if you do logical decoding you see writes on shards, you don&#x27;t see writes on these what we call distributed tables. But the user doesn&#x27;t even know about shards probably. So how can we fix that? And there wasn&#x27;t really any kind of hook we could use to change the way that the logical decoding process works except that we realized that the client specifies a decoder name usually just hard coded like Pgoutput or Wal2json or test_decoding and that actually refers to the name of a .so,  like a shared library. And we realized we could create a .so with the same name and put it in a different directory and then change the dynamic library path to be prefixed with that directory so it would load our library instead.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000934---marco"><em>[00:09:34]<!-- --> - Marco</em><a href="#000934---marco" class="hash-link" aria-label="Direct link to 000934---marco" title="Direct link to 000934---marco">​</a></h5><p>This is kind of the worst thing we did. But it works nicely actually. I mean, that new .so file calls the original .so file and it kind of makes some changes to hide the sharding from the coding. But yeah, it is a hack. It&#x27;s very much a hack. But it&#x27;s nice that Postgres ultimately lets you do these kind of things.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="000959---ry"><em>[00:09:59]<!-- --> - Ry</em><a href="#000959---ry" class="hash-link" aria-label="Direct link to 000959---ry" title="Direct link to 000959---ry">​</a></h5><p>I think, like Citus says, there&#x27;s like a requirement that Citus loads first as an extension. Is that true? I&#x27;m trying to remember if I&#x27;m making that up.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001008---marco"><em>[00:10:08]<!-- --> - Marco</em><a href="#001008---marco" class="hash-link" aria-label="Direct link to 001008---marco" title="Direct link to 001008---marco">​</a></h5><p>It is true. I mean, maybe it&#x27;s a bit of laziness on our part, but it&#x27;s also.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001013---ry"><em>[00:10:13]<!-- --> - Ry</em><a href="#001013---ry" class="hash-link" aria-label="Direct link to 001013---ry" title="Direct link to 001013---ry">​</a></h5><p>Because...</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001016---marco"><em>[00:10:16]<!-- --> - Marco</em><a href="#001016---marco" class="hash-link" aria-label="Direct link to 001016---marco" title="Direct link to 001016---marco">​</a></h5><p>We generate very weird plans that wouldn&#x27;t make any sense to other extensions. So if you have multiple layers of planner hooks, you kind of want Citus to be but by putting it first, it actually becomes the last because everyone else overwrites Citus. And then hopefully when you go through the chain of planner hook, Citus is the last one remaining and it can produce some quirky distributed query plan that doesn&#x27;t make sense to anyone else and pick that up.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001048---ry"><em>[00:10:48]<!-- --> - Ry</em><a href="#001048---ry" class="hash-link" aria-label="Direct link to 001048---ry" title="Direct link to 001048---ry">​</a></h5><p>Are there known extensions that aren&#x27;t compatible with Citus that you&#x27;re aware of or as far as you know? It kind of works with most everything.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001056---marco"><em>[00:10:56]<!-- --> - Marco</em><a href="#001056---marco" class="hash-link" aria-label="Direct link to 001056---marco" title="Direct link to 001056---marco">​</a></h5><p>Yeah, I mean, Citus is a little bit of a paradigm shift because now you have many servers and some extensions just don&#x27;t make sense if you&#x27;re on many servers because they keep their state on one of them and then they&#x27;re not aware of others. But most things just work. But I kind of feel like there&#x27;s this notion of a deep extension, if you will, like timescaleDB or Citus. They kind of go really deep into planner hooks and change behavioral characteristics. Whereas something like PostGIS and a lot of extensions that just introduce new types and functions. They&#x27;re sitting on top of this much more clean interface and usually the interoperability of those things is pretty good. But Timescale has this notion of a hyper table inside as a distributed table and you cannot really make a distributed hyper table. But yeah, compatibility, it comes down to sometimes also the individual features. It&#x27;s not like if you install one, then the other doesn&#x27;t work anymore. I mean, that happens for some extensions, but for Citus, most other things just kind of work with it. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001208---ry"><em>[00:12:08]<!-- --> - Ry</em><a href="#001208---ry" class="hash-link" aria-label="Direct link to 001208---ry" title="Direct link to 001208---ry">​</a></h5><p>So let&#x27;s talk about pg_Cron. How early were you involved in that project?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001213---marco"><em>[00:12:13]<!-- --> - Marco</em><a href="#001213---marco" class="hash-link" aria-label="Direct link to 001213---marco" title="Direct link to 001213---marco">​</a></h5><p>Well, I created it. I used to have this thing where I am much more productive on flights and I flew to San Francisco a lot for a while and then I had a few of these projects that I was just working on on flights and pg_Cron was one of them. And so at the time we had customers who did kind of this real time analytics scenarios on Postgres on Citus. And those involve a lot of materialization. So a bunch of raw data keeps coming in like time series data. And at some point you want to take all the new data and kind of pre aggregate it inside of the database and that needs to happen periodically. I think the background worker concept was pretty new at the time. I don&#x27;t know. This was many years ago. And so I realized you could do something like Cron. It maybe also comes from the Amazon background because Amazon, at least at the time, was all like glued together with Cron, Perl and R Sync. There were Cron jobs that would R sync metadata files to other servers and it was all pretty hacky. But anyway, I figured it would be pretty useful to have this kind of thing in Postgres also for just vacuuming or calling certain stored procedures that, I don&#x27;t know, delete your old data.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001342---marco"><em>[00:13:42]<!-- --> - Marco</em><a href="#001342---marco" class="hash-link" aria-label="Direct link to 001342---marco" title="Direct link to 001342---marco">​</a></h5><p>Like those kind of maintenance tasks. It was just much easier if that&#x27;s like you run a command once and then it works forever, rather than I need to maintain this separate infrastructure that periodically connects to the database and does that. So that became quite popular. I think pretty much all major managed services have pg_Cron now. Yeah, I kind of built it as a very I mean, it was definitely my side project. So I also built it as a very low maintenance thing that I wouldn&#x27;t have to constantly fix bugs in. Also a little bit selective about adding new features. For a long time I resisted adding people want like, can I run a job every few seconds? And normally Cron is like at the minute, granularity. But recently I caved and I added doing it every few seconds because I realized it&#x27;s kind of feature if there&#x27;s some kind of issue, some kind of memory leak or whatever, if you run it every few seconds, it&#x27;s going to be way worse than if you run it once a minute. So you need to be more careful in that case. But you can now also do like every second, for example, which is kind of useful.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001456---ry"><em>[00:14:56]<!-- --> - Ry</em><a href="#001456---ry" class="hash-link" aria-label="Direct link to 001456---ry" title="Direct link to 001456---ry">​</a></h5><p>That&#x27;s awesome. Yeah, I was looking at we&#x27;re just building a new data warehouse, trying to use Postgres to do that. I&#x27;m exploring all the columnar extension as well, which sort of is part of Citus. I don&#x27;t know if you did any work on that, but yeah, looking at pg_cron versus pg_timetable, have you had the question of what about have you looked at timetable and its features and yeah, I&#x27;m kind of curious to get your assessment of the two.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001528---marco"><em>[00:15:28]<!-- --> - Marco</em><a href="#001528---marco" class="hash-link" aria-label="Direct link to 001528---marco" title="Direct link to 001528---marco">​</a></h5><p>Yeah, I&#x27;ve looked at it a mean for a long time. It wasn&#x27;t so much an extension. I think nowadays it is more or less an autonomous extension, I think. Yeah, I mean, it&#x27;s somewhat more complex in a way. I don&#x27;t feel like competitive of like you should use pg_cron or use pg_timetable. I think pg_cron is just intentionally simple such just this very simple thing that just works and does what you&#x27;d expect it to mean almost unless your time zone is in a different unless you&#x27;re not in GMT, then it sort of doesn&#x27;t quite do what you&#x27;d expect it to anyway. So yeah, I think Cron is just simpler. But if you need some more specific, I guess it comes down to do you need the extra features that pg_timetable adds? But I think for most people, pg_cron is good enough because you can also just I&#x27;ve also seen people do their own kind of job queues on top of pg_cron, where you just have this thing that runs. Every few seconds or every minute, and then looks are there some jobs to do? And it actually executes the stuff that&#x27;s in the job state.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001639---marco"><em>[00:16:39]<!-- --> - Marco</em><a href="#001639---marco" class="hash-link" aria-label="Direct link to 001639---marco" title="Direct link to 001639---marco">​</a></h5><p>So it&#x27;s kind of composable as well. You can build your own things on top if you want. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001645---ry"><em>[00:16:45]<!-- --> - Ry</em><a href="#001645---ry" class="hash-link" aria-label="Direct link to 001645---ry" title="Direct link to 001645---ry">​</a></h5><p>And especially if you could trigger it every second to check for work. Yeah, that&#x27;s just fine. Yeah, I&#x27;m coming from my previous company was doing Apache Airflow and so it&#x27;s like kind of getting back to some of the stuff. I mean, obviously that&#x27;s a very complicated system with a lot of capabilities and dag like chaining of tasks and fanning out and all that kind of stuff. But yeah, I think it&#x27;s interesting to try to do some of that stuff inside of Postgres without requiring we&#x27;re trying to go with the mantra of like just use Postgres for everything.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001729---marco"><em>[00:17:29]<!-- --> - Marco</em><a href="#001729---marco" class="hash-link" aria-label="Direct link to 001729---marco" title="Direct link to 001729---marco">​</a></h5><p>It&#x27;s not a bad mantra. You&#x27;ve got, I guess, different levels of commitment to that idea of how much of our backend can we shove into Postgres? And there&#x27;s these GraphQL extensions where you pretty much put your entire backend in Postgres. Yeah.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001751---ry"><em>[00:17:51]<!-- --> - Ry</em><a href="#001751---ry" class="hash-link" aria-label="Direct link to 001751---ry" title="Direct link to 001751---ry">​</a></h5><p>Your API, is there?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001752---marco"><em>[00:17:52]<!-- --> - Marco</em><a href="#001752---marco" class="hash-link" aria-label="Direct link to 001752---marco" title="Direct link to 001752---marco">​</a></h5><p>Yeah, I guess Supabase is going pretty long way in that direction, but at some point you want to debug stuff or you want to have certain rollout procedures. And sometimes Postgres is not as mature a tool as just shipping Python files somewhere. There&#x27;s just better CI tools for most normal programming languages than for Postgres. So you have to find the right balance, I think.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001824---ry"><em>[00:18:24]<!-- --> - Ry</em><a href="#001824---ry" class="hash-link" aria-label="Direct link to 001824---ry" title="Direct link to 001824---ry">​</a></h5><p>Yeah, we&#x27;re building and maybe this shouldn&#x27;t have happened, but apparently yesterday we were working on a new FDW and I think it hit an exception that wasn&#x27;t handled and it appeared to shut down the Postgres server. This is kind of fun. Should that have happened? Should that be possible? Should an extension error take it down? But we&#x27;re still investigating that. But yeah, I think there&#x27;s always risk with trying to do a lot inside, but I think with a mature extension that&#x27;s well tested and battle tested, it should be. I mean, if you think about everything that&#x27;s happening, there&#x27;s no SRP in Postgres, right? It&#x27;s not just doing one thing, it&#x27;s got a vacuum. There&#x27;s like lots of processes running and so then the question is, is it a sin to add one more thing? Especially if it has the capability to have a background worker? It&#x27;s just like staring you in the face. Like use me.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="001929---marco"><em>[00:19:29]<!-- --> - Marco</em><a href="#001929---marco" class="hash-link" aria-label="Direct link to 001929---marco" title="Direct link to 001929---marco">​</a></h5><p>Like the extension APIs are slowly evolving from just a complete hacky approach for people to try out their Postgres batches before merging them into core. To some, I guess Extensibility was there from the start. But that&#x27;s more too for custom types and custom functions than it is for planner hooks and background workers and those kind of things. Those are a little bit more what if we add this function pointer to see maybe extensions can do something interesting with it. And it&#x27;s not very extremely well structured, but I mean the whole rust like pgrx and building extensions in rust, it does create an opportunity to have a little bit more of a well defined method of developing extensions.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002025---ry"><em>[00:20:25]<!-- --> - Ry</em><a href="#002025---ry" class="hash-link" aria-label="Direct link to 002025---ry" title="Direct link to 002025---ry">​</a></h5><p>Yeah, I think what&#x27;s interesting to me about Postgres is like the history of forks and it sucks to be on the true fork, as I&#x27;m sure you were aware. Creating the extension framework helps people out of the land of forks, but it does create the possibility for even more risk extensions in terms of all that. So it&#x27;s like a double edged sword. I think it&#x27;s great though, that to me is the reason why Postgres is doing so well now, is all that freedom that the core team has given the community in terms of how to use it. It&#x27;s unprecedented, almost dangerous, but I also think empowering to developers who want to have some fun with their database.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002121---marco"><em>[00:21:21]<!-- --> - Marco</em><a href="#002121---marco" class="hash-link" aria-label="Direct link to 002121---marco" title="Direct link to 002121---marco">​</a></h5><p>Yeah, definitely. What we also often find is just an extension versus an external tool. At least we&#x27;re sort of in the business of running a Postgres managed service. But even if you have just your own Postgres servers, it has a fairly straightforward deployment model, right? Like you don&#x27;t have to create a whole separate cluster with its own configuration that connects to your Postgres database and does things with it. You just shove it into your existing Postgres server and it&#x27;ll restart the background workers and you don&#x27;t have to worry about all those things. It does have a lot of merit, actually, to develop a software as a Postgres extension. I mean, it comes with its own protocol. I think the most interesting thing is just like you get all this synergy between all these different extensions, that the sum of the parts is greater than the or what is it? The whole is greater than the sum of the parts. But also things like PostGIS and Citus, they kind of layer like you can distribute it, geospatial joins, whatever. But then also maybe you have some interesting function and you can run it periodically using pg_cron.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002239---marco"><em>[00:22:39]<!-- --> - Marco</em><a href="#002239---marco" class="hash-link" aria-label="Direct link to 002239---marco" title="Direct link to 002239---marco">​</a></h5><p>And it&#x27;s like all these things kind of give you this little platform where you can just by running SQL queries, do increasingly interesting things. Maybe you have an FTW that does an Http call and you run it using pg_cron, for example. And now your Postgres server is not just pg_cron, is not just Postgres cron, it&#x27;s actually anything cron. Like you can reach out to other systems. So that plugability.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002310---ry"><em>[00:23:10]<!-- --> - Ry</em><a href="#002310---ry" class="hash-link" aria-label="Direct link to 002310---ry" title="Direct link to 002310---ry">​</a></h5><p>I literally have a co-op that started last week and his first task was, I said create an FDW for this API and use pg_cron and ingest that data. And he&#x27;s like, well, how do I do it? Just brand new to data warehousing in general, but he&#x27;s got the FDW built and now he&#x27;s working on if he has any problems, I&#x27;ll send him your way. Kidding. I won&#x27;t. Kidding, kidding. I won&#x27;t do that.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002341---marco"><em>[00:23:41]<!-- --> - Marco</em><a href="#002341---marco" class="hash-link" aria-label="Direct link to 002341---marco" title="Direct link to 002341---marco">​</a></h5><p>If there&#x27;s bugs open issues like I&#x27;d like to know, of course.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002344---ry"><em>[00:23:44]<!-- --> - Ry</em><a href="#002344---ry" class="hash-link" aria-label="Direct link to 002344---ry" title="Direct link to 002344---ry">​</a></h5><p>But there&#x27;s no bugs. No. So do you have any long flights coming up where you have some new extensions coming?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002351---marco"><em>[00:23:51]<!-- --> - Marco</em><a href="#002351---marco" class="hash-link" aria-label="Direct link to 002351---marco" title="Direct link to 002351---marco">​</a></h5><p>No, we had a baby last year. It&#x27;s like my flight budget is very low at the moment. That&#x27;s true.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002358---ry"><em>[00:23:58]<!-- --> - Ry</em><a href="#002358---ry" class="hash-link" aria-label="Direct link to 002358---ry" title="Direct link to 002358---ry">​</a></h5><p>Your latest extension is human.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002401---marco"><em>[00:24:01]<!-- --> - Marco</em><a href="#002401---marco" class="hash-link" aria-label="Direct link to 002401---marco" title="Direct link to 002401---marco">​</a></h5><p>Yeah, but yeah, I&#x27;d like to play more with Rust because that the problem with extensions in the past. Like developing them in C has always been like c doesn&#x27;t have any good sort of dependency framework. There&#x27;s these old established library like, I don&#x27;t know, LibZ and LibXML or something, like something that was developed 20 years ago and now, okay, every system has it, you can use it, but for anything newer than ten years, it&#x27;s extremely annoying and hard to use a C library. And then even if you can figure out your configure and your make files, the memory allocation is probably going to not play nicely with Postgres. So that&#x27;s where Rust is kind of interesting. Now there&#x27;s this whole ecosystem of open source libraries that can potentially become extensions and we&#x27;re still sort of at the very start of that, what&#x27;s going to happen?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002505---ry"><em>[00:25:05]<!-- --> - Ry</em><a href="#002505---ry" class="hash-link" aria-label="Direct link to 002505---ry" title="Direct link to 002505---ry">​</a></h5><p>It&#x27;s kind of scary because it could be very much of a Cambrian explosion. What happens if there are 300 new extensions that are worth adding? It&#x27;s sort of a pain for the managed service providers.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002519---marco"><em>[00:25:19]<!-- --> - Marco</em><a href="#002519---marco" class="hash-link" aria-label="Direct link to 002519---marco" title="Direct link to 002519---marco">​</a></h5><p>Yeah, definitely. Yeah. And they can have funny incompatibilities. It helps that then Rust is a little bit more safe and a little bit more not managed, but the memory allocation is a bit more sort of safe as well. But then, yeah, you can have a lot of weird bugs if you combine all these unknown bits of code.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002546---ry"><em>[00:25:46]<!-- --> - Ry</em><a href="#002546---ry" class="hash-link" aria-label="Direct link to 002546---ry" title="Direct link to 002546---ry">​</a></h5><p>That&#x27;s great. Are there any extensions that you&#x27;ve run across either recently or in the past that you love, that you would mention as exciting? I mean, you mentioned PostGIS and anything else that you can think of. It&#x27;s no big deal if not.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002604---marco"><em>[00:26:04]<!-- --> - Marco</em><a href="#002604---marco" class="hash-link" aria-label="Direct link to 002604---marco" title="Direct link to 002604---marco">​</a></h5><p>Yeah, there&#x27;s many. I&#x27;m sort of intrigued by Postgres_ML. It&#x27;s like this just machine learning extension that they seem to be doing a lot of interesting things. I don&#x27;t have a good use case for it myself yet, but I really like what you&#x27;re doing. Also in Rust, I think MIT licensed, so it can be used in a lot of places. There&#x27;s of course a lot of buzz around pg_vector and more recently pg_embedding, which is sort of an interesting kind of development because now I think they both added this HNSW indexes which are faster than the IFV flat indexes that pgvector provided. But then it also means they are now incompatible with the latest versions. You can create one or the other, not both, which is a little awkward. But I think that is where, of course, one of the most fastest moving areas and I think some of these things will be figured out.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002706---ry"><em>[00:27:06]<!-- --> - Ry</em><a href="#002706---ry" class="hash-link" aria-label="Direct link to 002706---ry" title="Direct link to 002706---ry">​</a></h5><p>Have you gotten those extensions added to the Citus managed service?</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002711---marco"><em>[00:27:11]<!-- --> - Marco</em><a href="#002711---marco" class="hash-link" aria-label="Direct link to 002711---marco" title="Direct link to 002711---marco">​</a></h5><p>Yeah, we definitely have pg_vector. Yeah, I mean, I think that took the landscape by storm. I think they&#x27;re pretty much on every managed service now.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002719---ry"><em>[00:27:19]<!-- --> - Ry</em><a href="#002719---ry" class="hash-link" aria-label="Direct link to 002719---ry" title="Direct link to 002719---ry">​</a></h5><p>It&#x27;s interesting, we&#x27;re working on this thing called Trunk where we&#x27;re trying to maybe I don&#x27;t know if we can get you guys to participate, but the idea would be to send some metadata to some sort of central repository that we&#x27;d know, like which extensions are trending, waning, completely dead or not. I just think it&#x27;s interesting as a new person coming into the Postgres ecosystem, there&#x27;s just this library of potential extensions that it&#x27;s pretty expansive and kind of trails off in a know because you can find them loosely here or there on GitHub. But I think having a better directory of them would be good for the community.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002804---marco"><em>[00:28:04]<!-- --> - Marco</em><a href="#002804---marco" class="hash-link" aria-label="Direct link to 002804---marco" title="Direct link to 002804---marco">​</a></h5><p>Yeah, I guess. One thing that&#x27;s also tricky about extensions, it&#x27;s like you&#x27;d want it in an ideal world, you write it once and then it works forever. In the real world, every Postgres version potentially breaks your extension, so someone has to actually go and fix it. For new Postgres versions, sometimes it&#x27;s okay. I think with pg_cron, I had like once or twice. It&#x27;s like I think Postgres 16 didn&#x27;t actually no, it did require some fixes. I think there was one Postgres version which didn&#x27;t require any fixes. Maybe PG 15, I was already happy. But usually C is a bit of this wild west of programming languages. But yeah, sometimes just some function header changes, there&#x27;s an extra argument and then none of the extensions that use that function compile you have to have some level of maintenance behind each extension. Well, not every extension does well. Great.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002903---ry"><em>[00:29:03]<!-- --> - Ry</em><a href="#002903---ry" class="hash-link" aria-label="Direct link to 002903---ry" title="Direct link to 002903---ry">​</a></h5><p>I mean, it was great to chat with you. Happy to have you back on again. If you have a big new release of Citus, I don&#x27;t know, do you guys have any big plans for it or has it reached a certain point of stability where it is what it is? Yeah, I&#x27;m kind of curious.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002919---marco"><em>[00:29:19]<!-- --> - Marco</em><a href="#002919---marco" class="hash-link" aria-label="Direct link to 002919---marco" title="Direct link to 002919---marco">​</a></h5><p>Well, our most recent major release added this kind of notion of Schema based Sharding, where so far it&#x27;s always been like you have distributed tables and you have a distribution column and you need to pick which columns you use. But the Schema based Sharding is just like every Schema becomes its own group, own Shard, essentially, so it might be on a different node. So for apps that use Schema per tenant, that&#x27;s a very nice model. And so we&#x27;re investing more in that at the moment.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002949---ry"><em>[00:29:49]<!-- --> - Ry</em><a href="#002949---ry" class="hash-link" aria-label="Direct link to 002949---ry" title="Direct link to 002949---ry">​</a></h5><p>Well, great. Good to meet you. Looking forward to continuing to get to know you. And thanks for joining us on the show.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="002956---marco"><em>[00:29:56]<!-- --> - Marco</em><a href="#002956---marco" class="hash-link" aria-label="Direct link to 002956---marco" title="Direct link to 002956---marco">​</a></h5><p>Yeah, it was great. Thanks for having me.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/hacking-postgres">hacking_postgres</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/tembo-terraform-provider-1f558963ff1cc4e5c8174935be971505.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/introducing-terraform-provider-for-tembo">Introducing Terraform Provider for Tembo</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-10T00:00:00.000Z" itemprop="datePublished">October 10, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/shahadarsh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/shahadarsh.png" alt="Adarsh Shah"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/shahadarsh" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Adarsh Shah</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="tembo-terraform-provider" src="/assets/images/tembo-terraform-provider-1f558963ff1cc4e5c8174935be971505.png" width="1408" height="1402" class="img_ev3q"></p><p>At Tembo, we want to empower developers to build fast. That’s why we built the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Provider for Tembo Cloud</a>, allowing developers to manage Postgres resources using Infrastructure-as-Code (IaC). In this blog, we&#x27;ll explore the Terraform Provider for Tembo and how it can help you streamline database management while keeping teams agile, accountable and enforcing organizational policies.</p><p>Simpler, faster, safer, and easier? That’s Tembo - but let’s back up and start at the beginning.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-tembo-cloud">What is Tembo Cloud?<a href="#what-is-tembo-cloud" class="hash-link" aria-label="Direct link to What is Tembo Cloud?" title="Direct link to What is Tembo Cloud?">​</a></h2><p><a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> is a developer-first, fully-extensible, fully-managed, secure, and scalable Postgres service. It not only simplifies Postgres management but also provides specialized Postgres deployments through <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">Tembo Stacks</a>, catering to various use cases.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="database-as-code-using-terraform">Database as Code using Terraform<a href="#database-as-code-using-terraform" class="hash-link" aria-label="Direct link to Database as Code using Terraform" title="Direct link to Database as Code using Terraform">​</a></h2><p>Databases as code provides a safe, consistent, and repeatable way of managing databases and is a game-changer for developers. This approach allows you to version-control any changes, ensuring auditability, and facilitates efficient workflows such as Pull Request flows and <a href="https://about.gitlab.com/topics/gitops/" target="_blank" rel="noopener noreferrer">GitOps</a>.</p><p>Terraform is the most popular Infrastructure as Code tool today. It provides a way to define the desired state of your infrastructure using Hashicorp Configuration Language(HCL). Terraform handles all the complexity of making sure that when changes are applied, the actual state matches the desired state. Therefore, it is an efficient way of managing databases as code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-terraform-provider-for-tembo">Using Terraform Provider for Tembo<a href="#using-terraform-provider-for-tembo" class="hash-link" aria-label="Direct link to Using Terraform Provider for Tembo" title="Direct link to Using Terraform Provider for Tembo">​</a></h2><p>With the Terraform Provider for Tembo, you can manage Postgres databases on Tembo Cloud with all the benefits mentioned in the previous section. You can find the Terraform Provider for Tembo on the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Registry</a> along with <a href="https://registry.terraform.io/providers/tembo-io/tembo/latest/docs/resources/" target="_blank" rel="noopener noreferrer">the documentation</a>, and the Github repo is <a href="https://github.com/tembo-io/terraform-provider-tembo" target="_blank" rel="noopener noreferrer">here</a>. A new Postgres instance can be provisioned on Tembo Cloud in about 1 minute and destroying an instance takes just 10 seconds.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-terraform-file">Example Terraform file<a href="#example-terraform-file" class="hash-link" aria-label="Direct link to Example Terraform file" title="Direct link to Example Terraform file">​</a></h3><p>You can create a new Tembo instance on Tembo Cloud using the <code>tembo_instance</code> resource available with the provider. Below is an example configuration.</p><p><strong>Note:</strong> Tembo Terraform Provider needs an <code>access_token</code> to authenticate with the API. Generate a long-lived API token by following steps <a href="https://tembo.io/docs/tembo-cloud/security-and-authentication/api-authentication#create-a-long-lived-api-token" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tembo = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source = &quot;tembo-io/tembo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;&gt;= 0.1.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;tembo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access_token = var.access_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;access_token&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;tembo_instance&quot; &quot;test_instance&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_name = &quot;test-instance&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  org_id        = &quot;org_test&quot; # Replace this with your Tembo organization id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cpu           = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stack_type    = &quot;Standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment   = &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory        = &quot;4Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage       = &quot;10Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas      = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  extensions = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name        = &quot;plperl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;PL/Perl procedural language&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locations = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      database = &quot;app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      schema   = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version  = &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled  = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        database = &quot;postgres&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        schema   = &quot;public&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        version  = &quot;1.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;instance&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = tembo_instance.test_instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Applying the above Terraform will provision a Postgres Instance on Tembo Cloud. For a demo explaining the steps watch the video below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="demo">Demo<a href="#demo" class="hash-link" aria-label="Direct link to Demo" title="Direct link to Demo">​</a></h2><p>The demo in the video explains how to use the Terraform Provider for Tembo. The Terraform code used in the video can be found <a href="https://github.com/tembo-io/terraform-provider-tembo/tree/main/examples/resource-creation" target="_blank" rel="noopener noreferrer">here</a>.</p><div style="width:640px;height:360px"></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next-for-the-provider">What’s next for the Provider<a href="#whats-next-for-the-provider" class="hash-link" aria-label="Direct link to What’s next for the Provider" title="Direct link to What’s next for the Provider">​</a></h2><p>We are actively working on an Import feature that will allow you to import existing Tembo instances to Terraform to easily start managing existing instances with Terraform. Stay updated by starring our <a href="https://github.com/tembo-io/terraform-provider-tembo" target="_blank" rel="noopener noreferrer">GitHub repository</a> and monitoring changes on the <a href="https://registry.terraform.io/providers/tembo-io/tembo" target="_blank" rel="noopener noreferrer">Terraform Registry</a>. Most importantly, please try it out, and <a href="https://github.com/tembo-io/terraform-provider-tembo/issues" target="_blank" rel="noopener noreferrer">file any issues and feature requests in our repository</a>. You can also access the documentation for the Tembo provider <a href="https://registry.terraform.io/providers/tembo-io/tembo/latest/docs" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/announcement">announcement</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/terraform">terraform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/infrastructure-as-code">infrastructure_as_code</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/clerk-flowchart-ecda66b28a07b45684d4932e0aac931a.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Jayko001" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/Jayko001.png" alt="Jay Kothari"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Jayko001" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jay Kothari</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineering Intern</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The maxim of building a product is to know your user. However, any company big or small will often have user data spread around in various systems. A data platform team will often deploy various pipelines that can sync data from various sources into a data warehouse. As an alternative, Postgres supports the concept of a Foreign Data Wrapper. Let’s dive into what this is and how it can help us.</p><p>In this blog, we&#x27;ll look at <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a>—a tool that bridges the gap between <a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a>, a leading user management solution, and your very own Postgres Database. By the end, you&#x27;ll discover how this integration can empower you to make data-driven decisions, optimize your pricing strategy, and refine your market approach. Let&#x27;s get started!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-a-foreign-data-wrapper">What’s a Foreign Data Wrapper?<a href="#whats-a-foreign-data-wrapper" class="hash-link" aria-label="Direct link to What’s a Foreign Data Wrapper?" title="Direct link to What’s a Foreign Data Wrapper?">​</a></h2><p>A foreign data wrapper is an extension available in PostgreSQL that allows you to bring ‘foreign data’ (i.e. data in a different Postgres DB, a different database like DB2, or even a different kind of data source, like an API) and query it the same way you would query a normal Postgres table. They are particularly useful when your data may be segregated into different databases, but are still related in ways that you could gather some useful information from them. In building a foreign data wrapper for Clerk.com, we have used <a href="https://supabase.github.io/wrappers/" target="_blank" rel="noopener noreferrer">Supabase Wrappers</a> that make it easier to build Foreign Data Wrappers and interact with third-party data using SQL.</p><p>If you should take something away from this blog, is that Postgres’ Foreign Data Wrappers are a great tool to build an analytics platform based on Postgres. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-clerk">What’s Clerk?<a href="#whats-clerk" class="hash-link" aria-label="Direct link to What’s Clerk?" title="Direct link to What’s Clerk?">​</a></h2><p><a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a> is a user management tool. With Clerk, users experience a seamless sign-up and sign-in flow, whether they prefer using email, SMS, or even their favorite social media accounts. Its versatility and developer-friendly APIs make it an excellent choice for us at Tembo for both efficiency and a superior user experience.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-power-of-integration">The Power of Integration<a href="#the-power-of-integration" class="hash-link" aria-label="Direct link to The Power of Integration" title="Direct link to The Power of Integration">​</a></h2><p>Being able to access data from a User Management Tool like Clerk as part of your data platform is especially useful because it enables you to have a 360-degree view of the user experience on your product, without having to set up any complex data export pipelines from Clerk into other systems.</p><p>In fact, we built <code>clerk_fdw</code> at Tembo to address needs in our internal analytics pipeline . Here are some of the ways we are using it:</p><ul><li>Run advanced analytics that combine internal data with user data from Clerk.</li><li>Understand user interaction patterns with our product.</li><li>Identify and engage with top users.</li></ul><p><img loading="lazy" alt="clerk" src="/assets/images/clerk-flowchart-ecda66b28a07b45684d4932e0aac931a.png" title="clerk_fdw structure" width="1345" height="1158" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-clerk_fdw">Setting up <code>clerk_fdw</code><a href="#setting-up-clerk_fdw" class="hash-link" aria-label="Direct link to setting-up-clerk_fdw" title="Direct link to setting-up-clerk_fdw">​</a></h2><p>The first step would be installing the <code>clerk_fdw</code> extension. You can <a href="https://tembo-io.github.io/trunk/#trunk-install" target="_blank" rel="noopener noreferrer">install this extension using trunk</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> clerk_fdw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The next step would be to enable the extension in your postgres instance. You can do so using the following command:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> clerk_fdw</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-foreign-data-wrapper-for-clerk">Create the foreign data wrapper for clerk<a href="#create-the-foreign-data-wrapper-for-clerk" class="hash-link" aria-label="Direct link to Create the foreign data wrapper for clerk" title="Direct link to Create the foreign data wrapper for clerk">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">handler</span><span class="token plain"> clerk_fdw_handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validator clerk_fdw_validator</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connect-to-clerk-using-your-credentials">Connect to Clerk using your credentials<a href="#connect-to-clerk-using-your-credentials" class="hash-link" aria-label="Direct link to Connect to Clerk using your credentials" title="Direct link to Connect to Clerk using your credentials">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api_key </span><span class="token string" style="color:#e3116c">&#x27;&lt;clerk secret Key&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-foreign-table">Create Foreign Table:<a href="#create-foreign-table" class="hash-link" aria-label="Direct link to Create Foreign Table:" title="Direct link to Create Foreign Table:">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="user-table">User table<a href="#user-table" class="hash-link" aria-label="Direct link to User table" title="Direct link to User table">​</a></h4><p>This table will store information about the users.</p><blockquote><p>Note: The current limit is 500 users. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_users </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  first_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gender </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_sign_in_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  phone_numbers </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      object </span><span class="token string" style="color:#e3116c">&#x27;users&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="organization-table">Organization Table<a href="#organization-table" class="hash-link" aria-label="Direct link to Organization Table" title="Direct link to Organization Table">​</a></h4><p>This table will store information about the organizations.</p><blockquote><p>Note: The current limit is 500 organizations. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organizations </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slug </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_by </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">&#x27;organizations&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="junction-table">Junction Table<a href="#junction-table" class="hash-link" aria-label="Direct link to Junction Table" title="Direct link to Junction Table">​</a></h4><p>This table connects the <code>clerk_users</code> and <code>clerk_orgs</code>. It lists out all users and their roles in each organization.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organization_memberships </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">&#x27;organization_memberships&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dive-into-the-data">Dive into the Data<a href="#dive-into-the-data" class="hash-link" aria-label="Direct link to Dive into the Data" title="Direct link to Dive into the Data">​</a></h2><p>Now you can query through your database and get useful information like:</p><ul><li>How many organizations have been created each week in the past</li><li>How many users have signed up in the past 30 days</li><li>What organizations is a user part of</li><li>All users and their roles in an organization</li><li>And more….</li></ul><p>Here are some of the charts we were able to make from the clerk foreign data wrapper using some synthetic data.</p><p><img loading="lazy" alt="chart1" src="/assets/images/chart1-f041e3a0ece55d964478a2e23fffc37d.png" title="Daily New Signups" width="582" height="356" class="img_ev3q">
<img loading="lazy" alt="chart2" src="/assets/images/chart2-c1ad7d55ca70c351cda145b80752bf19.png" title="Total Organizations" width="581" height="351" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In conclusion, we believe that Postgres’ concept of Foreign Data Wrappers is more than just a technical integration—it&#x27;s a game-changer that allows Postgres users to build data warehouse platforms that reach across all data sources in the business. It paves the way for businesses to harness critical insights directly from their operational databases, making informed decisions easier than ever before. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><p>Give us a star and try out <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a> by running the example in the README. If you hit any snags, please create an issue. We would greatly welcome contributions to the project as well.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-29T00:00:00.000Z" itemprop="datePublished">September 29, 2023</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="back-in-time" src="/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg" width="788" height="453" class="img_ev3q"></p><p>A nice feature of AWS S3 is version history and lifecycle policies. When objects are updated or deleted, the old object version remains in the bucket, but it’s hidden. Old versions are deleted eventually by the lifecycle policy.</p><p>I would like something like that for my Postgres table data. <strong>We can use the temporal_tables extension for version history, and combine it with pg_partman to partition by time, automatically expiring old versions.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-model">Data model<a href="#data-model" class="hash-link" aria-label="Direct link to Data model" title="Direct link to Data model">​</a></h2><p>Let&#x27;s say we have a table <strong>employees</strong>, and it looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |  7000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will add one more column to this table, <code>sys_period</code>, which is a time range. This time range represents &quot;since when&quot; is this row the current version. This range is unbounded on the right side, because all the rows in the <strong>employees</strong> table are the present version.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 13:30:19.24318+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 13:33:58.735932+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 13:33:58.738827+00&quot;,)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will make a new table <strong>employees_history</strong> to store previous versions. This will have the same columns as the <strong>employees</strong> table, but all the rows in <code>sys_period</code> are bounded on the the right and the left sides. These ranges represent when this row was the current version. We will configure <strong>temporal_tables</strong> to automatically create these rows when anything changes in the <strong>employees</strong> table.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 13:30:19.18544+00&quot;,&quot;2023-09-28 13:33:58.683279+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 13:33:58.683279+00&quot;,&quot;2023-09-28 13:33:58.731332+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 13:33:58.731332+00&quot;,&quot;2023-09-28 13:33:58.735932+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 13:30:19.239152+00&quot;,&quot;2023-09-28 13:33:58.738827+00&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To automatically delete old versions, we&#x27;ll add one more column to the <strong>employees_table</strong>, <code>created_at</code>. We will use this information to expire old versions after they are older than our retenion configuration, with the help of <strong>pg_partman</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally. I&#x27;ve followed that guide to set up my environment with <strong>temporal_tables</strong> and <strong>pg_partman</strong>.</p><p>I have a Dockefile, two SQL scripts, and a file with Postgres configurations.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 0_startup.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 1_create_versioned_table.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── custom.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Dockerfile:</strong> We use <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a> to install pg_partman and temporal_tables. Then, we copy the three other files into the image.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install pg_partman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install temporal_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 0_startup.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 1_create_versioned_table.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY custom.conf $PGDATA/extra-configs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>0_startup.sql:</strong> Enables temporal_tables and pg_partman when Postgres starts.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> temporal_tables</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_partman</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>1_create_versioned_table.sql:</strong> Creates a sample table, then enables version history on it.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Sample: an existing table we want to enable versioning on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  department </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Adding version history to the table,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">first we need to add a time range to the existing table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">This represents &quot;since when&quot; has this row been current.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> sys_period tstzrange </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Creating a time-partitioned version table</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">each row has the range the data was valid for,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">and also the time this version was created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> employees INCLUDING DEFAULTS EXCLUDING INDEXES EXCLUDING CONSTRAINTS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at timestamptz </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Allow efficient querying of partition key and name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Enable automatic partitioning with pg_partman, partitioning every 1 minute.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to partition daily or greater.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> create_parent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;created_at&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;native&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1 minute&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- This connects employees table to employees_history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> versioning_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEFORE </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR EACH ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> versioning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;sys_period&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Configure retention policy for employee history to keep old versions for 10 minutes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to configure retention for 1 year.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 minutes&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        infinite_time_partitions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>custom.conf:</strong> our additions to the Postgres configuration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Enable pg_partman background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shared_preload_libraries = &#x27;pg_partman_bgw&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many seconds between pg_partman background worker runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s more realistic to run every 3600 seconds, or longer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.interval = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Which database pg_partman should target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.dbname = &#x27;postgres&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s best practice to use limited permissions for the background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_partman_bgw.role = &#x27;limitedrole&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This was helpful when I was working on getting the settings working</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log_min_messages = &#x27;DEBUG1&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With those four files in place, we can run Postgres like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it -d --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In a separate shell, I connect into the Postgres container.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">psql postgres://postgres:postgres@localhost:5432</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-demo-of-saving-old-versions">Basic demo of saving old versions<a href="#basic-demo-of-saving-old-versions" class="hash-link" aria-label="Direct link to Basic demo of saving old versions" title="Direct link to Basic demo of saving old versions">​</a></h2><p>After we are set up, we have version history and retention policy configured on the <strong>employees</strong> table, but both the <strong>employees</strong> table and the <strong>employees_history</strong> table are empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Adding data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Helmholtz Watson&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;College of Emotional Engineering&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees</strong> has some data, and <strong>employees_history</strong> is still empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |   salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+-----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     |  10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |   7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson |  18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modifying data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11200</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11400</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11601</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees_history</strong> table has past versions.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 20:23:50.731597+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 20:23:50.734214+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,&quot;2023-09-28 20:23:50.684293+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 20:23:50.684293+00&quot;,&quot;2023-09-28 20:23:50.727283+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 20:23:50.727283+00&quot;,&quot;2023-09-28 20:23:50.731597+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,&quot;2023-09-28 20:23:50.734214+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(4 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="looking-up-past-versions">Looking up past versions<a href="#looking-up-past-versions" class="hash-link" aria-label="Direct link to Looking up past versions" title="Direct link to Looking up past versions">​</a></h2><p>Let&#x27;s say we want to look up Bernard&#x27;s salary at a previous date. We can check the <strong>employees_history</strong> table to find the row where the time range matches our provided timestamp. However, this wouldn&#x27;t find the correct salary if we provide a timestamp that is after the most recent update to Bernard&#x27;s salary, since that row is in the <strong>employees</strong> table.</p><p>We can first create a <a href="https://www.postgresql.org/docs/current/tutorial-views.html" target="_blank" rel="noopener noreferrer">view</a> for this purpose. We only need to do this once, then we can query this view like a table going forward.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VIEW</span><span class="token plain"> employee_history_view </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we can use this query to find Bernard&#x27;s salary at any given date.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 20:23:30+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>@&gt;</code> Is a <em>containment operator</em> and you might recognize it if you have used <a href="https://tembo.io/docs/postgres_guides/postgres-basics/jsonb" target="_blank" rel="noopener noreferrer">JSONB</a>.</p><p>Comparing to the <strong>employees_history</strong> table shown above, it is returning the correct value.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also works to look up the current salary:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If I try to query a salary from the future, it will return the current salary. If I try to query a salary from before Bernard is known in the <strong>employees_history</strong> table, then I get an empty result.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partitioning">Partitioning<a href="#partitioning" class="hash-link" aria-label="Direct link to Partitioning" title="Direct link to Partitioning">​</a></h2><p><strong>What is partitioning?</strong> <a href="https://www.postgresql.org/docs/current/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">Postgres documentation</a> has detailed information on partitioning but just to summarize, partitioning is about splitting what is logically one large table into smaller tables. Typically, this is done for query performance. In our case, <strong>we are partitioning to expire old versions.</strong></p><p>Partitioning tables is something I’m familiar with from Tembo’s work in <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, which is a queueing extension for Postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writes">Writes<a href="#writes" class="hash-link" aria-label="Direct link to Writes" title="Direct link to Writes">​</a></h3><p>We should expect write performance to be slower, since we are writing to two tables for every update.</p><p>I created a new table that does not have versioning enabled to compare write performance.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a table like employees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ...and insert one row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees_write_test </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tstzrange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, I used <code>EXPLAIN ANALYZE</code> to compare the write performance. I ran the query a few times for each.</p><p><strong>Without versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11608</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.654 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.540 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.760 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.079 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>With versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11610</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.423 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=2.430 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 4.783 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.311 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.091 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.979 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.825 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.711 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 5.686 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It&#x27;s more than twice as slow on a single update. That&#x27;s because we have to write to two rows instead of one, there is more data to write (the time ranges), and because there is some additional processing, for instance determining which range to put on each row. In the next section, I also compare how much time it takes to write 100,000 rows in each of these tables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reads">Reads<a href="#reads" class="hash-link" aria-label="Direct link to Reads" title="Direct link to Reads">​</a></h3><p>We created a view which is a union between <strong>employees</strong> and <strong>employees_history</strong>, then we query the view to find an employee&#x27;s salary at a given time.</p><p>To generate some data, let&#x27;s make a procedure to update a salary 100,000 times in a row. The below example uses <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>. By default, PL/pgSQL functions run as a single transaction, so it would only result in a single update to the <strong>employees_history</strong> table. For this reason, I am using a procedure with <code>COMMIT</code> so that each increment will be a separate transaction, this way we also get 100,000 updates to the <strong>employees_history</strong> table. I had to explain that nuance to chatGPT in order for this procedure to be produced properly.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Table name and employee name as inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to get the current salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SELECT salary FROM %I WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> v_salary </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Loop 100 thousand times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Increment the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_salary :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v_salary </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to update the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;UPDATE %I SET salary = $2 WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_salary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Commit the transaction, triggering the versioning procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;employees&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This took 55 seconds to run on my laptop. I also tried it on the table without versioning enabled, at in this case it took 38 seconds. I ran it a couple more times on the table with versioning enabled, so that the versions would be distributed across multiple partitions. Now we have an <strong>employees_history</strong> table that&#x27;s populated with many rows for Bernard.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s run the same type of query command we ran before, with <code>EXPLAIN ANALYZE</code>. I picked a timestamp that will not be found to ensure it&#x27;s as slow as possible.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 15:28:25+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Simplified query plan output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Append</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Bitmap Heap Scan on employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Recheck Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: (sys_period @&gt; &#x27;...&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Heap Blocks: exact=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Bitmap Index Scan on employees_pkey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Index Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 99969</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0035</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 97393</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0036</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 102607</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 12.427 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 262.706 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(47 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query took 263 milliseconds. We notice this query needs to scan all partitions, because we are partitioning by <code>created_at</code>, and querying <code>sys_period</code>. We can improve the speed with indexes.</p><p>If this was a real workload, I doubt that employees&#x27; salaries are being updated so frequently, or at least that&#x27;s been the case in my personal experience. However, if it&#x27;s a big company, then there could be a lot of employees. In that case, it would be best to add an index on the name (or more realistically, employee ID) in the <strong>employees_history</strong> table. Then, withing each partition it will find only rows for the employee being queryed using the index, then it would scan the remaining rows, probably typically zero, one, or two rows, to find the correct salary.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expiring-old-versions">Expiring old versions<a href="#expiring-old-versions" class="hash-link" aria-label="Direct link to Expiring old versions" title="Direct link to Expiring old versions">​</a></h2><p>Earlier in this blog, we configured <strong>pg_partman</strong> to partition in 1 minute increments, to expire partitions that are older than 15 minutes, and to check every 30 seconds. Every 30 seconds, any partition that is older that 15 minutes is deleted by the <strong>pg_partman</strong> background worker.</p><p>With this query, I can check how many rows and the total data size in each partition.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- This query was produced by ChatGPT 4 with the prompt:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- &quot;How can I check the number of rows in each partition of employees_history?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_total_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> total_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_live_tup </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_inherits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class parent </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhparent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class child </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhrelid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to check that old versions are being dropped, I ran the procedure to create a lot of salaray increments several times in a row.</p><p>Then, running the above query, I find an output like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2204 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2205 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2206 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13180928 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     868352 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this output, we can see that we have 1 partition for every minute, and a total of 15 partitions. I have old versions expiring after 10 minutes. I thought it&#x27;s interesting to note that <strong>pg_partman</strong> is preemptively creating partitions for the future, in this case 5 minutes into the future.</p><p>If you refer to the original set up steps, I have configured <code>infinite_time_partitions = true</code>, and this means we will generate partitions even when we are not generating any data for them. I think this is the proper configuration since we also have a retention policy that will drop the old partitions. The concern of making infinite partitions as time passes, even if no data is being generated, is not applicable because old tables are being dropped.</p><p>To confirm data was being deleted, I sampled the above query over time, and we can see the large body of inserts moving up into the oldest available partitions, then falling outside of the retention policy and being deleted.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 131733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2229 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="thanks">Thanks!<a href="#thanks" class="hash-link" aria-label="Direct link to Thanks!" title="Direct link to Thanks!">​</a></h2><p>If you got this far, thank you for reading this! I hope that you are inspired to try out extensions on your own and see what they can do. The next time you have some problem to solve with your data, consider that maybe it could just be handled by a Postgres extension.</p><p>If you want to try extensions without any local setup, you should try Tembo Cloud at <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">cloud.tembo.io</a>.</p><p>Just use Postgres!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/temporal-tables">temporal_tables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pg-partman">pg_partman</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-28T00:00:00.000Z" itemprop="datePublished">September 28, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/binidxaba.png" alt="Binidxaba"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Binidxaba</span></a></div><small class="avatar__subtitle" itemprop="description">Community contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In my <a href="https://tembo.io/blog/pgmq-with-python" target="_blank" rel="noopener noreferrer">previous submission</a> to this space, I described my experience with <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a> while using the Python library. In this post, I&#x27;ll share what I found after inspecting the code.</p><p>So, first, I&#x27;ll describe the general structure of the project. Then, I&#x27;ll explain what happens when we install the pgmq extension. Finally, I&#x27;ll describe how some of its functions work.</p><p>In this post, I&#x27;ll be using version v0.25.0, which you can find <a href="https://github.com/tembo-io/pgmq/releases/tag/v0.25.0" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure">​</a></h2><p>After cloning the appropriate tag, we can see that the repository contains the following files:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTRIBUTING.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dockerfile.build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tembo-pgmq-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tests</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The project uses <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">pgrx</a>. From pgrx&#x27;s <a href="https://github.com/pgcentralfoundation/pgrx/blob/develop/README.md" target="_blank" rel="noopener noreferrer">README</a>, we know that the relevant files for the extension are <code>Cargo.toml</code>, <code>pgmq.control</code> and the <code>src</code> and <code>sql</code> directories:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tree sql src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.11.1--0.11.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.0--0.8.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.1--0.9.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── errors.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── metrics.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── partition.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── sql_src.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── util.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> directories, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-the-pgmq-extension">Installing the pgmq extension<a href="#installing-the-pgmq-extension" class="hash-link" aria-label="Direct link to Installing the pgmq extension" title="Direct link to Installing the pgmq extension">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This section assumes that you have successfully installed the pre-requisites as described in <a href="https://github.com/tembo-io/pgmq/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">CONTRIBUTING.md</a></p></div></div><p>To build the pgmq extension, we can do the following:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, to build and install the pgmq extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In either case, we can see a shared library <code>pgmq.so</code> being created. The installation process also places the shared library in the <code>lib</code> directory of the postgres installation; and the sql files and the control file in the <code>extensions</code> directory. In my case:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/share/extension/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/lib/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/lib/pgmq.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To test the extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and it&#x27;ll start a <code>psql</code> prompt. In the prompt, we can execute the <code>create extension</code> statement to start using pgmq:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Enable pgmq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension pgmq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will look something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# create extension pgmq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |                             Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq    | 0.25.0  | public     | A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also list the available functions:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List available functions under pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\df pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \df pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                         List of functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |          Name          |                                                                         Result data type                                                                         |                                                 Argument data types                                                  | Type </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | TABLE(archive boolean)                                                                                                                                           | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create                 | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_non_partitioned | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_partitioned     | void                                                                                                                                                             | queue_name text, partition_interval text DEFAULT &#x27;10000&#x27;::text, retention_interval text DEFAULT &#x27;100000&#x27;::text       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | TABLE(delete boolean)                                                                                                                                            | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | drop_queue             | boolean                                                                                                                                                          | queue_name text, partitioned boolean DEFAULT false                                                                   | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | list_queues            | TABLE(queue_name text, created_at timestamp with time zone)                                                                                                      |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics                | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics_all            | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | pop                    | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | purge_queue            | bigint                                                                                                                                                           | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read                   | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer                                                                         | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read_with_poll         | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer, poll_timeout_s integer DEFAULT 5, poll_interval_ms integer DEFAULT 250 | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send                   | bigint                                                                                                                                                           | queue_name text, message jsonb, delay integer DEFAULT 0                                                              | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send_batch             | TABLE(msg_id bigint)                                                                                                                                             | queue_name text, messages jsonb[], delay integer DEFAULT 0                                                           | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | set_vt                 | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, msg_id bigint, vt_offset integer                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(18 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this, we can now explore the extension from the inside. And, if needed, recompile and reinstall the extension to play with it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-internals">The internals<a href="#the-internals" class="hash-link" aria-label="Direct link to The internals" title="Direct link to The internals">​</a></h2><p>We know that when an extension is created with pgrx, it generates a <code>lib.rs</code> file. Let us explore it.</p><p>One of the first thing we can see, is that the other five files in the <code>src/</code> directory are included:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub mod api;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod partition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod util;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After reviewing these files a little bit, we can notice that there&#x27;s also some relevant code in another module, the one in <code>core/</code>. For example, in <code>src/partition.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use pgmq_core::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors::PgmqError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive, assign_queue, create_archive, create_archive_index, create_index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_meta, grant_pgmon_meta, grant_pgmon_queue, grant_pgmon_queue_seq, insert_meta,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    types::{PGMQ_SCHEMA, QUEUE_PREFIX},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    util::CheckedName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, at this point we know that we can find the source code in two places: <code>src/</code> and <code>core/</code>. </p><p>If we continue exploring <code>lib.rs</code>, we can see that a sql file (<code>sql_src.sql</code>) is executed when the extension is enabled:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE pgmq.meta (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name VARCHAR UNIQUE NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_partitioned BOOLEAN NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can actually see that table with <code>psql</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List tables in the pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List contents of pgmq.meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-# \dt pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema | Name | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------+-------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public | meta | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like right after <code>CREATE EXTENSION</code> is executed:</p><p><img loading="lazy" alt="after-create-extension" src="/assets/images/after-create-extension-e590194728d15b0433b8e5510725f9ff.png" title="after create extension" width="596" height="551" class="img_ev3q"></p><p>From this point, we can suspect that every time we create a queue, a new row is inserted into this table.</p><p>Let us see what <code>pgmq.create()</code> does...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqcreate">pgmq.create()<a href="#pgmqcreate" class="hash-link" aria-label="Direct link to pgmq.create()" title="Direct link to pgmq.create()">​</a></h3><p>Most of the functions provided by pgmq are defined in <code>src/api.rs</code>. In that file, we can find the function <code>pgmq_create(queue_name: &amp;str)</code>, and if we chase the call sequence, we can discover that the interesting function is <code>init_queue(name: &amp;str)</code> in <code>core/src/query.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn init_queue(name: &amp;str) -&gt; Result&lt;Vec&lt;String&gt;, PgmqError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let name = CheckedName::new(name)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(vec![</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert_meta(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grant_pgmon_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function generates several sql statements that are later executed in <code>pgmq_create_non_partitioned</code> using an <a href="https://docs.rs/pgx/latest/pgx/spi/struct.SpiClient.html" target="_blank" rel="noopener noreferrer"><code>Spi</code> client</a>.</p><p>I&#x27;ll skip the details, but the sql statements basically do:</p><ol><li>Create a table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pqmg extension.</li><li>Create an index on the <code>pgmq.q_&lt;queue_name&gt;</code> table.</li><li>Create a table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pgmq extension.</li><li>Create an index on the <code>pgmq.a_&lt;queue_name&gt;</code> table.</li><li>Insert a row on the <code>pgmq.meta</code> table.</li><li>Grant privileges to <code>pg_monitor</code>.</li></ol><p>We can see the effects of this in psql using the following lines:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List tables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List indexes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\di pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- See the contents of pgmq_meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will show something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq_create(&#x27;my_queue&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dt pgmq.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |    Name    | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------+-------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta       | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \di pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |           Name           | Type  |   Owner   |   Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+--------------------------+-------+-----------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue_pkey          | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archived_at_idx_my_queue | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta_queue_name_key      | index | binidxaba | meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_pkey          | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_vt_idx        | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | is_partitioned |          created_at           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ------------+----------------+-------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_queue   | f              | 2023-09-18 23:35:38.163096-06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like at this point:</p><p><img loading="lazy" alt="complete" src="/assets/images/complete-0b9cb3715d61904139d1d12fb7d717e6.png" title="after create queue" width="596" height="551" class="img_ev3q"></p><p>For the queue <code>my_queue</code>, we can see the underlying table and the corresponding archive table. Each table has an index associated with the primary key. The <code>pgmq.q_my_queue</code> table also has an index on the <code>vt</code> column, and <code>pgmq.a_my_queue</code> has an index on the <code>archived_at</code> column.</p><p>We can suspect that the <code>pgmq.q_my_queue</code> table is used in the send and read operations. Let us look at those two functions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqsend">pgmq.send()<a href="#pgmqsend" class="hash-link" aria-label="Direct link to pgmq.send()" title="Direct link to pgmq.send()">​</a></h3><p>We can explore the send operation in a similar way. The relevant SQL is straightforward. It just inserts a new row in the the underlying table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">values</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-send" src="/assets/images/pgmq-send-e0f2306ae56fdd9487889c5125c8b461.png" title="what send does" width="596" height="624" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>At this point, we can see the following pattern in the pgmq project: </p><ul><li>the exposed SQL functions are defined in <code>src/api.rs</code>, and </li><li>the underlying SQL statements are defined in <code>core/src/query.rs</code></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqread">pgmq.read()<a href="#pgmqread" class="hash-link" aria-label="Direct link to pgmq.read()" title="Direct link to pgmq.read()">​</a></h3><p>So, let&#x27;s see. If I were the one programming <code>pgmq.read()</code>, I would perhaps do something like &quot;get the first <code>{limit}</code> rows from the queue table whose <code>{vt}</code> has already expired, and for those rows, also update the visibility timeout to <code>now() + {vt}</code>.&quot; Naively, maybe something like:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain">                                                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In reality, <code>pgmq.read</code> is more interesting than that 😅. It performs the following DML:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{vt} seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cte</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cte</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-read" src="/assets/images/pgmq-read-b13515d2be7805a182167d1430faad87.png" title="what read does" width="596" height="624" class="img_ev3q"></p><p>Firstly, in pgmq&#x27;s version, there is a CTE (Common Table Expression) to obtain the first <code>{limit}</code> message IDs whose <code>vt</code> has expired. (It would be interesting to discuss why pgmq developers used a CTE, but we can explore that in another post.)</p><p>There are two crucial things to notice in the CTE. One is the <code>order by</code> clause that ensures the FIFO ordering. The other one is the <code>FOR UPDATE SKIP LOCKED</code> clause, claiming the rows no one else has claimed. This part is essential because it ensures correctness in the case of concurrent  <code>pgmq.read()</code> operations. </p><p>The next step in the DML is to update the corresponding rows with a new vt value by adding the supplied <code>{vt}</code> to the current timestamp. Additionally, the <code>read_ct</code> value is incremented by 1. What is the use of this counter? In general, we can suspect that there is a problem processing a given message if it has a high <code>read_ct</code> value because users usually archive the message after successfully processing it. So, ideally, a message is only read once. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqarchive">pgmq.archive()<a href="#pgmqarchive" class="hash-link" aria-label="Direct link to pgmq.archive()" title="Direct link to pgmq.archive()">​</a></h3><p>The next stage in the lifecycle of a message is archiving it. For that, pgmq uses the following insert statement:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> archived </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{ARCHIVE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Essentially, it deletes the message with the provided <code>msg_id</code> from the queue table, and then the message is placed in the corresponding archive table.</p><p><img loading="lazy" alt="pgmq-archive" src="/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png" title="what archive does" width="596" height="624" class="img_ev3q"></p><p>One interesting thing to notice is that <code>pgmq.archive()</code> can be used to archive a batch of messages too:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">archive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ARRAY</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq.archive(&#x27;my_queue&#x27;, ARRAY[3, 4, 5]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is achieved in pgrx by declaring two functions using the <a href="https://github.com/pgcentralfoundation/pgrx/blob/047b1d1fc9e9c4007c871e226fa81e294f8bf5e6/pgrx-macros/src/lib.rs#L462" target="_blank" rel="noopener noreferrer">same name in the <code>pg_extern</code></a> derive macro as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive(queue_name: &amp;str, msg_id: i64) -&gt; Result&lt;Option&lt;bool&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive_batch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name: &amp;str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_ids: Vec&lt;i64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;TableIterator&lt;&#x27;static, (name!(archive, bool),)&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqdrop_queue">pgmq.drop<!-- -->_<!-- -->queue()<a href="#pgmqdrop_queue" class="hash-link" aria-label="Direct link to pgmqdrop_queue" title="Direct link to pgmqdrop_queue">​</a></h3><p>Finally, let&#x27;s talk about <code>pgmq.drop_queue()</code>. It essentially executes multiple statements:</p><ol><li>Unassign the <code>pgmq.q_&lt;queue_name&gt;</code> table from the extension.</li><li>Unassign the <code>pgmq.a_&lt;queue_name&gt;</code> table from the extension.</li><li>Drop the table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Drop the table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Delete the corresponding row from the <code>pgmq.meta</code> table.</li></ol><p>Nothing surprising in this one, and with it, we conclude our tour.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this post, we explored how the pgrx tool is used to generate the pgmq extension. We explored how the metadata objects are created and how they are used in the basic send, read and archive operations. At least from an explorer perspective, the internals of the extension are currently easy to read and understand.</p><p>I invite everyone to explore how the other pgmq functions work. You can explore the code at <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>. And you can learn more about pgrx at: <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgmq">pgmq</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgrx">pgrx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/postgres-16">Postgres 16: The exciting and the unnoticed</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-20T00:00:00.000Z" itemprop="datePublished">September 20, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/samay-sharma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/samay-sharma.png" alt="Samay Sharma"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/samay-sharma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Samay Sharma</span></a></div><small class="avatar__subtitle" itemprop="description">CTO Tembo</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In case you missed it, Postgres 16 came out last week - and this year it arrived earlier than the last few years. There are many features that I’ve been looking forward to for the last few months and I’m excited to see them get into the hands of users. Before we dive into the specific features of this release, let’s discuss what a Postgres major release actually means.</p><p><img loading="lazy" alt="postgres-16" src="/assets/images/postgres-16-1cfe231777e20520fac3b292397f20e6.png" title="PG16" width="1666" height="1140" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-releases">Postgres Releases<a href="#postgres-releases" class="hash-link" aria-label="Direct link to Postgres Releases" title="Direct link to Postgres Releases">​</a></h2><p>The PostgreSQL Global Development Group releases a new <em>major</em> <a href="https://www.postgresql.org/support/versioning/" target="_blank" rel="noopener noreferrer">version</a> every year with new features. </p><p>In addition, Postgres releases minor versions of each major release every 3 months or so with bug fixes and security fixes. No new features are released in minor versions, and that’s what makes major version releases so exciting as it’s the culmination of about a year’s worth of development work on the project. </p><p>While there&#x27;s a case to be made for faster release of features, Postgres prides itself on stability and this release cadence provides enough time for features to be proposed, reviewed, committed and tested before they get shipped.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="should-i-upgrade-to-postgres-16">Should I upgrade to Postgres 16?<a href="#should-i-upgrade-to-postgres-16" class="hash-link" aria-label="Direct link to Should I upgrade to Postgres 16?" title="Direct link to Should I upgrade to Postgres 16?">​</a></h2><p>If you are building a new application, yes, I would recommend that you start with the latest major version of Postgres. This will guarantee the latest and greatest features, and a continuous flow of minor releases that fix bugs and improve the security of your database.</p><p>If you are upgrading an existing system, there are more factors to consider. The general advice is to <strong>upgrade minor versions</strong> always - because they contain security and bug fixes and the risk of not upgrading is higher. </p><p>However, for major versions, you will need to consider the tradeoffs as the major versions usually change the internal format of system tables and data files. That means, you can’t just use previous versions of the data directory — you’ll need to use <code>pg_dump</code> / <code>pg_restore</code> or <a href="https://www.postgresql.org/docs/current/pgupgrade.html" target="_blank" rel="noopener noreferrer">pg_upgrade</a> to upgrade. In addition, depending on the features you are using and the Postgres release, manual changes to your code or queries may also be required.</p><p>Obviously, another important factor if you are using a managed service provider is when they provide support for Postgres 16. At <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we’ve already started working on supporting Postgres 16 and expect it to be available in a few weeks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-most-exciting-about-postgres-16">What’s most exciting about Postgres 16?<a href="#whats-most-exciting-about-postgres-16" class="hash-link" aria-label="Direct link to What’s most exciting about Postgres 16?" title="Direct link to What’s most exciting about Postgres 16?">​</a></h2><p>Postgres 16 delivers exciting features in all aspects of the database ranging from performance improvements, monitoring enhancements, better security and privilege handling, replication improvements, new server features and commands and a lot more. </p><p>If you’re interested in the complete list of features, you can read the detailed <a href="https://www.postgresql.org/docs/16/release-16.html" target="_blank" rel="noopener noreferrer">release notes</a>. Below, I’ll talk about the aspects of this release which excite me the most and we will talk about a few not-so-talked about features which lay the groundwork for more exciting features in Postgres 17.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logical-replication-improvements">Logical replication improvements<a href="#logical-replication-improvements" class="hash-link" aria-label="Direct link to Logical replication improvements" title="Direct link to Logical replication improvements">​</a></h3><p><a href="https://www.postgresql.org/docs/current/logical-replication.html" target="_blank" rel="noopener noreferrer">Logical replication</a> is a feature I’ve always been interested in, as it allows you to expand the capabilities of Postgres by moving data between different Postgres databases or from Postgres to other databases. It finds interesting use cases in: replicating selectively from one database to another, replicating across Postgres versions, online migrations and allowing consolidation from multiple databases.</p><p>This release, arguably the most exciting logical replication feature, is allowing <a href="https://pganalyze.com/blog/5mins-postgres-16-logical-decoding" target="_blank" rel="noopener noreferrer">logical replication from standby servers</a>. Prior to this feature, you could only create a logical replication slot on the primary which meant adding more replicas would add more load on the primary. With Postgres 16, secondaries also have the ability to create replication slots allowing for more distribution of that load. What’s more is that the replication slots on the secondary are persisted even when the standby is promoted to the primary. This means that subscribers won’t be affected even during a failover! You can read more about this feature in Bertrand’s <a href="https://bdrouvot.github.io/2023/04/19/postgres-16-highlight-logical-decoding-on-standby/" target="_blank" rel="noopener noreferrer">blog post</a>.</p><p>The short of it is that now you can do this on a Postgres 16 standby:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# select pg_is_in_recovery();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_is_in_recovery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# SELECT * FROM pg_create_logical_replication_slot(&#x27;active_slot&#x27;, &#x27;test_decoding&#x27;, false, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slot_name  |    lsn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> active_slot | 0/C0053A78</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On Postgres 15, the same thing would have errored out:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres@standby=# SELECT * FROM pg_create_logical_replication_slot(&#x27;active_slot&#x27;, &#x27;test_decoding&#x27;, false, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  logical decoding cannot be used while in recovery</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to this, there are a number of other logical replication performance improvements. This includes faster initial table sync using <a href="https://www.postgresql.org/message-id/flat/TYCPR01MB8373B593010467315C2BA8EBED229%40TYCPR01MB8373.jpnprd01.prod.outlook.com#be8109723de40d3724730713175517ab" target="_blank" rel="noopener noreferrer">binary format</a>, use of <a href="https://www.postgresql.org/message-id/flat/CACawEhX6TvX%2Bj8EpcpCKvnMGao8Gcp8W43Sgc87pg9o6-Xbf2Q%40mail.gmail.com#81e7ec5c7732e7492c9e28d0f38df657" target="_blank" rel="noopener noreferrer">btree indexes</a> during logical replication apply when tables don’t have a primary key (previously the table would be scanned sequentially) and parallel application of large transactions (~25-40% speedups).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-improvements">Monitoring improvements<a href="#monitoring-improvements" class="hash-link" aria-label="Direct link to Monitoring improvements" title="Direct link to Monitoring improvements">​</a></h3><p>The other bucket of features which intrigued me are the monitoring enhancements. While Postgres provides a number of statistics tables with monitoring information, I believe more can be done to provide actionable insights to users. As an example, Lukas pointed out several interesting gaps in Postgres monitoring in his <a href="https://www.pgcon.org/events/pgcon_2020/sessions/session/132/slides/49/Whats%20Missing%20for%20Postgres%20Monitoring.pdf" target="_blank" rel="noopener noreferrer">PGCon 2020 talk</a>.</p><p>Coming back to this release, <a href="https://www.postgresql.org/docs/16/monitoring-stats.html#MONITORING-PG-STAT-IO-VIEW" target="_blank" rel="noopener noreferrer"><code>pg_stat_io</code></a> has to be the most useful piece of information added to the Postgres stats views in Postgres 16. It allows you to understand the I/O done by Postgres at a more granular level, broken down by <code>backend_type</code> and <code>context</code>. This means you can calculate a more accurate cache hit ratio by ignoring the I/O done by VACUUM, differentiate between <code>extends</code> and <code>flushes</code>, and separate out bulk operations while deciding which configurations to tune. Melanie talks about this and much more in her <a href="https://www.youtube.com/watch?v=rCzSNdUOEdg" target="_blank" rel="noopener noreferrer">talk</a> and this <a href="https://www.depesz.com/2023/02/27/waiting-for-postgresql-16-add-pg_stat_io-view-providing-more-detailed-io-statistics/" target="_blank" rel="noopener noreferrer">blog post</a> approaches how you would use this as a DBA.</p><p>Here is an example of the statistics you can see in <code>pg_stat_io</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ SELECT * FROM pg_stat_io ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backend_type     │   io_object   │ io_context │  reads  │ writes  │ extends │ op_bytes │ evictions │ reuses  │ fsyncs │          stats_reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">─────────────────────┼───────────────┼────────────┼─────────┼─────────┼─────────┼──────────┼───────────┼─────────┼────────┼───────────────────────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> autovacuum launcher │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> autovacuum worker   │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> client backend      │ temp relation │ normal     │       0 │       0 │       0 │     8192 │         0 │  [NULL] │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> background worker   │ relation      │ bulkread   │  268221 │  268189 │  [NULL] │     8192 │         0 │  268189 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> checkpointer        │ relation      │ normal     │  [NULL] │   32121 │  [NULL] │     8192 │    [NULL] │  [NULL] │   3356 │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> standalone backend  │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> startup             │ relation      │ vacuum     │       0 │       0 │       0 │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> walsender           │ relation      │ bulkread   │       0 │       0 │  [NULL] │     8192 │         0 │       0 │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> walsender           │ temp relation │ normal     │       0 │       0 │       0 │     8192 │         0 │  [NULL] │ [NULL] │ 2023-02-27 13:25:39.725072+01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to this, there are other improvements including the addition of <code>last_seq_scan</code> and <code>last_idx_scan</code> on <code>pg_stat_*</code> tables which allow you to understand index usage better and figure out when plans for a query might have changed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-mentions">Special mentions<a href="#special-mentions" class="hash-link" aria-label="Direct link to Special mentions" title="Direct link to Special mentions">​</a></h3><p>Like I said, each release comes with many improvements - and I could not outline them all in a blog post (and if I did, nobody would read it!). But I do want to mention a few other items in Postgres 16 that I won’t be able to dive deeper into but are interesting as well.</p><ul><li>Load balancing with multiple hosts in <code>libpq</code>: This feature allows to balance the load across Postgres read replicas directly within <code>libpq</code> (which is the foundational Postgres client library) without having to use another load balancer. You can read <a href="https://mydbops.wordpress.com/2023/05/07/postgresql-16-brings-load-balancing-support-in-libpq-psql/" target="_blank" rel="noopener noreferrer">this blog post</a> on how this new feature is implemented and can be used.</li><li>Performance: I won’t repeat what’s in the release notes but there’s a long list of performance improvements in this release. There’s support for more parallelism on <code>FULL</code> and <code>OUTER</code> <code>JOINs</code> and on more aggregates, greater usage of incremental sorts, window function optimizations and even an upto 300% performance improvement in <code>COPY</code>.</li><li><code>VACUUM</code> improvements: Last thing I’d mention is improvements to <code>VACUUM</code> which include freezing performance improvements, ability to increase (or decrease) shared buffer usage by <code>VACUUM</code>, and faster loading of <code>VACUUM</code> configs.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="laying-the-groundwork-for-an-exciting-postgres-17-and-beyond">Laying the groundwork for an exciting Postgres 17 (and beyond)<a href="#laying-the-groundwork-for-an-exciting-postgres-17-and-beyond" class="hash-link" aria-label="Direct link to Laying the groundwork for an exciting Postgres 17 (and beyond)" title="Direct link to Laying the groundwork for an exciting Postgres 17 (and beyond)">​</a></h2><p>All of the features mentioned above can immediately add a lot of value to your Postgres usage, but there are new features which lay the groundwork for powerful features in future releases. I’ll quickly touch upon three items that I believe are noteworthy:</p><ul><li>Direct IO and Async IO in Postgres: In Postgres 16, several building blocks for implementing direct and <a href="https://www.youtube.com/watch?v=CD0w3gWBF7s" target="_blank" rel="noopener noreferrer">asynchronous IO</a> for Postgres were committed. This includes reduced contention on the relation extension lock and addition of Direct IO as a developer only option via the <code>debug_io_direct</code> setting. This important but hard work has been ongoing for several releases and Postgres 17 will likely be the first release where users will be able to utilize these features.</li><li>Moving towards Active Active replication: A feature was committed in Postgres 16 to allow logical replication to avoid replication loops, which is when a transaction gets replicated from source to target and back. Postgres 16 allows subscribers to process only changes which have no origin which allows you to prevent these loops. Bi-directional active-active replication is still very complicated and requires solving a lot of problems, but this feature tackles one of those important sub-problems.</li><li>Migration of the build system to Meson: This might have slipped under your radar but in this release, Postgres added support for a new build system which is expected to replace the Autoconf and Windows based build systems. Why, you might ask? Andres makes a compelling case for it in <a href="https://www.postgresql.org/message-id/flat/20211012083721.hvixq4pnh2pixr3j%40alap3.anarazel.de" target="_blank" rel="noopener noreferrer">this thread</a> if you’re interested but some reasons include faster build times, simpler dependency management and moving towards a common build system across Linux and Windows.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-continues-to-deliver">Postgres continues to deliver<a href="#postgres-continues-to-deliver" class="hash-link" aria-label="Direct link to Postgres continues to deliver" title="Direct link to Postgres continues to deliver">​</a></h2><p>With every new release, Postgres becomes more and more compelling and adds great features that improve the experience of its users. I recommend you check out the <a href="https://www.postgresql.org/about/news/postgresql-16-released-2715/" target="_blank" rel="noopener noreferrer">press release</a>, and <a href="https://www.postgresql.org/docs/16/release-16.html" target="_blank" rel="noopener noreferrer">the release notes</a> to see everything coming along with this new release.</p><p>And if you want to try out the full power of Postgres including its powerful extension ecosystem on a managed service, try out <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-14T00:00:00.000Z" itemprop="datePublished">September 14, 2023</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Before working for a Postgres company, I had never used extensions.</p><p>Now, I&#x27;m part of a team working to fully automate turning on any extension. I didn&#x27;t find great resources to explain the process of turning on an extension, and why it varies between different extensions.</p><p><strong>I want to share my mental model for the different types of extensions, how to know what type of extension you&#x27;re working with, and how to get it turned on.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="turn-on-an-extension">Turn on an extension<a href="#turn-on-an-extension" class="hash-link" aria-label="Direct link to Turn on an extension" title="Direct link to Turn on an extension">​</a></h2><p><img loading="lazy" alt="one-does-not-simply" src="/assets/images/one-does-not-simply-095857686f6255714eb3f6df0f595d5b.png" width="651" height="383" class="img_ev3q"></p><p><strong>What&#x27;s traditionally involved:</strong></p><ul><li>Find the extension you want</li><li>Figure out how to build it</li><li>Sometimes, installation of dependencies (for example with <em>apt-get</em> or <em>yum</em>)</li><li>Sometimes, installation of other extensions (<em>goto</em> ‘figure out how to build it’)</li><li>Install your extension</li><li>Sometimes, load a library</li><li>Sometimes, provide extension-specific configurations</li><li>Sometimes, run the <code>CREATE EXTENSION</code> command</li></ul><p>Building and installing extensions is well covered by other resources. In this blog, I want to focus on steps to get an extension up and running after it&#x27;s installed, and how <strong>I believe that all extensions fit into four mostly-tidy categories.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a href="#terminology" class="hash-link" aria-label="Direct link to Terminology" title="Direct link to Terminology">​</a></h3><p>Extensions consist of <strong>SQL</strong> and / or <strong>libraries</strong>.</p><p>A <strong>library</strong> simply means compiled code, for example written in <a href="https://www.postgresql.org/docs/current/xfunc-c.html" target="_blank" rel="noopener noreferrer">C</a> or <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">Rust</a>.</p><p><strong><a href="https://www.postgresql.org/docs/current/extend-extensions.html#:~:text=A%20useful%20extension%20to%20PostgreSQL,package%20to%20simplify%20database%20management." target="_blank" rel="noopener noreferrer">SQL objects</a></strong>, let&#x27;s just call it SQL, are extensions of SQL, for example new functions and data types. These are often implemented by a library, but can also be implemented in other ways, for example using a procedural language like <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>.</p><p><strong>Hooks:</strong> A Postgres feature informally called <em>hooks</em> can be used to connect into Postgres&#x27; existing functionality. Hooks allow for overwriting default Postgres functionality, or calling back into an extension&#x27;s code at the appropriate time. For example, one type of hook can modify Postgres start up behavior to launch a background worker, and a different type of hook can be used to redirect queries to a different table.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Sometimes extensions are instead referred to as &#x27;modules&#x27;, but I like to simply refer to everything as an &#x27;extension&#x27;, but feel free to @ me on X to tell me why that&#x27;s wrong (<a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>).</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-the-matrix">Enter the matrix<a href="#enter-the-matrix" class="hash-link" aria-label="Direct link to Enter the matrix" title="Direct link to Enter the matrix">​</a></h2><p><img loading="lazy" alt="im-in-matrix" src="/assets/images/im-in-matrix-dc7fbaffd858e30723ad62d60ebdd4a3.gif" width="498" height="278" class="img_ev3q"></p><p>A big part of what I have been working on is fully automating enabling any extension. In order to do that, we have to understand exactly how extensions vary. We can break it down into a 2x2 matrix by defining two boolean categories.</p><p><strong>Requires <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong> true or false and <strong>requires <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a></strong> true or false:</p><table><thead><tr><th></th><th>Requires <code>CREATE EXTENSION</code></th><th>Does not require <code>CREATE EXTENSION</code></th></tr></thead><tbody><tr><td><strong>Requires <code>LOAD</code></strong></td><td>Extensions that use SQL and their libraries have hooks</td><td>Extensions that do not use SQL, may or may not have hooks</td></tr><tr><td><strong>Does not require <code>LOAD</code></strong></td><td>SQL-only extensions, and SQL + libraries without hooks</td><td>Output plugins</td></tr></tbody></table><p><em>By categorizing an extension into this 2x2 matrix, we can know how to turn it on.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load">LOAD<a href="#load" class="hash-link" aria-label="Direct link to LOAD" title="Direct link to LOAD">​</a></h3><p> <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a> is a command that tells Postgres to <em>load</em> a library, meaning make the code accessible to Postgres by loading the compiled code on disk into memory. If a library has hooks, <strong>performing a load will activate the hooks</strong>.</p><p><strong>Requires <code>LOAD</code>: true</strong> means you have to do one of the following steps to load a library:</p><ul><li><strong><a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong>: using the <code>LOAD</code> command directly loads a library for the current connection only</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=at%20session_preload_libraries%20instead.-,session_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">session_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD for new connections</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=pooling%20is%20used.-,shared_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD at server start, and therefore requires a restart</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Even though code is loaded in other ways during <code>CREATE EXTENSION</code>, that is not <strong>requires <code>LOAD</code>: true</strong> under this definition. I mean that the user must do something other than <code>CREATE EXTENSION</code> to load in libraries. Also, we are conflating <a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=load%20that%20module.-,local_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">local_preload_libraries</a> with <code>session_preload_libraries</code> to simplify things in this blog post.</p></div></div><p>For example, if you installed the extension <a href="https://pgt.dev/extensions/auto_explain" target="_blank" rel="noopener noreferrer">auto explain</a>, then you may have a library file called <code>auto_explain.so</code> in your library directory, which can be found with <a href="https://pgpedia.info/d/dynamic_library_path.html" target="_blank" rel="noopener noreferrer">pg_config --pkglibdir</a>. Libraries are not always named exactly the same as the extension.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] auto_explain.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --pkglibdir) | grep auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_explain.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Auto explain can be loaded into your session like <code>LOAD &#x27;auto_explain&#x27;;</code>. This command will always match exactly the name of the library file, less the file type, in this example <code>.so</code>. With a <a href="https://www.postgresql.org/docs/current/auto-explain.html#AUTO-EXPLAIN-EXAMPLE" target="_blank" rel="noopener noreferrer">couple of configurations</a>, now this extension will automatically log the <a href="https://www.postgresql.org/docs/current/sql-explain.html" target="_blank" rel="noopener noreferrer">EXPLAIN ANALYZE</a> output for long-running queries.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;auto_explain&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, the <code>LOAD</code> command is not typically used directly, and many extensions require you do not load them in this way. Instead, typically the Postgres configuration <a href="https://pgpedia.info/s/shared_preload_libraries.html" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a> is used instead.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;pg_cron&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  pg_cron can only be loaded via shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINT:  Add pg_cron to the shared_preload_libraries configuration variable in postgresql.conf.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The best reason to use <code>LOAD</code> directly is for debugging. It can be nice to <code>LOAD</code> on-demand while troubleshooting.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><strong>What to do when an extension requires load:</strong></p><p>Extensions that <strong>requires <code>LOAD</code>: true</strong> can always be configured in <code>shared_preload_libraries</code>, but this configuration requires a restart to take effect. Some extensions can be loaded without a restart using <code>LOAD</code> directly, but in this case it&#x27;s usually better to use the <code>session_preload_libraries</code> configuration, and <a href="https://pgpedia.info/p/pg_reload_conf.html" target="_blank" rel="noopener noreferrer">reload the Postgres configuration</a> with <code>SELECT pg_reload_conf();</code>. You should run <code>LOAD</code> directly when you are intentionally loading for only the current connection.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-extension">CREATE EXTENSION<a href="#create-extension" class="hash-link" aria-label="Direct link to CREATE EXTENSION" title="Direct link to CREATE EXTENSION">​</a></h3><p>When you run <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a>, this basically just runs an extension&#x27;s SQL script. The script will typically create new SQL objects such as functions, data types, operators and so on.</p><p><code>CREATE EXTENSION</code> looks at the extension&#x27;s <strong>control file</strong>, which is installed to the <code>extension</code> directory of <strong>sharedir</strong>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: &quot;/var/lib/postgresql/data/tembo/15/lib&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using sharedir: &quot;/var/lib/postgresql/data/tembo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] pg_jsonschema.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema--0.1.4.sql =&gt; /var/lib/postgresql/data/tembo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema.control =&gt; /var/lib/postgresql/data/tembo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>sharedir</strong> can be located with <code>pg_config --sharedir</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$  ls $(pg_config --pkglibdir) | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --sharedir)/extension | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema--0.1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The information in a control file is used to determine what start up or upgrade scripts to run. We&#x27;ll cover upgrades in-depth in a future blog, so let&#x27;s focus on first-time enabling. For example, in the above installation output, we notice a file <code>pg_jsonschema--0.1.4.sql</code>. Postgres knows to run this because the name of the control file matches the name of the script suffixed by the <code>default_version</code> defined in the control file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat $(pg_config --sharedir)/extension/pg_jsonschema.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;JSON schema validation on json and jsonb data types&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.1.4&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/pg_jsonschema&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running <code>CREATE EXTENSION</code>, the extension name always matches exactly the name of a control file, less the <code>.control</code> file type.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I mentioned that a start up script creates new SQL, including new functions. For example in the case of <a href="https://pgt.dev/extensions/pg_jsonschema" target="_blank" rel="noopener noreferrer">pg_jsonschema</a>, the start up script <code>pg_jsonschema--0.1.4.sql</code> includes the following SQL to create a new function called <code>jsonb_matches_schema</code>. Even though we have a library file, we don&#x27;t need <code>LOAD</code> because <code>CREATE FUNCTION</code> is another way to load code from a file. This is an example of <strong>requires <code>LOAD</code>: false</strong>, <strong>requires <code>CREATE EXTENSION</code>: true</strong>.</p><p><a href="https://www.postgresql.org/docs/current/sql-createfunction.html" target="_blank" rel="noopener noreferrer">CREATE FUNCTION ... AS &#x27;obj_file&#x27; documentation</a></p><blockquote><p>obj_file is the name of the shared library file containing the compiled <!-- -->[code]</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE FUNCTION &quot;jsonb_matches_schema&quot;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;schema&quot; json,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;instance&quot; jsonb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) RETURNS bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMMUTABLE STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LANGUAGE c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS &#x27;MODULE_PATHNAME&#x27;, &#x27;jsonb_matches_schema_wrapper&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>You can always know whether or not an extension requires <code>CREATE EXTENSION</code> by the presence of a control file in <code>$(pg_config --sharedir)/extension</code></p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooks-that-require-a-restart">Hooks that require a restart<a href="#hooks-that-require-a-restart" class="hash-link" aria-label="Direct link to Hooks that require a restart" title="Direct link to Hooks that require a restart">​</a></h3><p>An extension is in the category <strong>requires <code>CREATE EXTENSION</code>: true</strong> and <strong>requires <code>LOAD</code>: true</strong> if the extension has libraries that use hooks which require a restart and it has a control file.</p><p>You will be able to identify this is the case when the extension&#x27;s documentation mentions both <code>CREATE EXTENSION</code> and <code>shared_preload_libraries</code>. Sometimes an error message or hint is provided if you run <code>CREATE EXTENSION</code> before loaded the library, or if you try to run <code>LOAD</code> directly, but you can&#x27;t count on that.</p><p>For example, in the case of both <code>pg_cron</code> and <code>pg_partman</code>, there are a background workers. These are examples of extensions using hooks in the start up process of Postgres. So, in both of these cases the user is expected to configure <code>shared_preload_libraries</code> to start the background worker, then run <code>CREATE EXTENSION</code> on a cluster where that background worker is already running.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-is-needed-when-there-isnt-a-control-file">LOAD is needed when there isn&#x27;t a control file<a href="#load-is-needed-when-there-isnt-a-control-file" class="hash-link" aria-label="Direct link to LOAD is needed when there isn&#x27;t a control file" title="Direct link to LOAD is needed when there isn&#x27;t a control file">​</a></h3><p>In the case of auto_explain, it uses hooks that do not require a restart. In this case, there is no control file and no extra SQL objects to be created. So <code>LOAD</code> is required simply because we have to load it into memory somehow. To demonstrate, it is technically possible to make a control file for auto_explain to allow for <code>CREATE EXTENSION</code> behavior instead of <code>LOAD</code>:</p><p><strong>auto_explain.control:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;auto explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.0.1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/auto_explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>auto_explain--0.0.1.sql</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOAD &#x27;auto_explain&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In practice, do not use <code>LOAD</code> in an extension start up script to activate hooks. <code>LOAD</code> is only applicable for the current connection.</p></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION auto_explain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name       | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> auto_explain    | 0.0.1   | public     | auto explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql         | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_min_duration = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_analyze = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running the above, now my subsequent queries have their <code>EXPLAIN ANALYZE</code> logged.</p><p>So, if that could work, <strong>why not just have control files for all extensions?</strong></p><p><strong>Having a control file requires version upgrade handling.</strong></p><p>When you have a control file, you also have to write upgrade scripts for every new version. In the case of pg_cron, we can find all these files in <strong>sharedir</strong>. When enabling version 1.5, it will run <code>pg_cron--1.0.sql</code>, then each migration script up to 1.5.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0--1.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.1--1.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.2--1.3.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.3--1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4-1--1.5.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4--1.4-1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since that&#x27;s not really applicable on auto_explain, because it&#x27;s just logging outputs and there is nothing to migrate or handle between versions, it&#x27;s just cleaner to not have a control file. Upgrading auto_explain only involves replacing the library, then loading it again.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Upgrade logic is not applicable for extensions that do not require <code>CREATE EXTENSION</code>. These cases just involve re-loading a new version of the library.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-dont-load-hooks-during-create-extension">You don&#x27;t load hooks during CREATE EXTENSION<a href="#you-dont-load-hooks-during-create-extension" class="hash-link" aria-label="Direct link to You don&#x27;t load hooks during CREATE EXTENSION" title="Direct link to You don&#x27;t load hooks during CREATE EXTENSION">​</a></h3><p>It made sense to me for activating hooks that require a restart they have to be configured in <code>shared_preload_libraries</code>. But for extensions that do not require a restart, it&#x27;s not obvious why the hooks can&#x27;t just be loaded during the <code>CREATE EXTENSION</code> start up script like I just demonstrated is possible with auto_explain.</p><p><strong>Even though it&#x27;s technically possible to <code>LOAD</code> hooks during <code>CREATE EXTENSION</code>, it&#x27;s a bad idea.</strong></p><p>First of all, when using the <code>LOAD</code> command directly, it&#x27;s only applicable to the current connection. So, in the above example with auto explain, the queries are only logged in the connection where I ran <code>CREATE EXTENSION</code>. To apply to all connections without a restart, it would need to go into <code>session_preload_libraries</code>. It is technically possible to do that inside of <code>CREATE EXTENSION</code> by doing <code>ALTER SYSTEM SET session_preload_libraries</code> then <code>SELECT pg_reload_conf()</code> in your start up script, but it is not a good approach for <code>CREATE EXTENSION</code> to automatically perform a configuration update. First of all it would confuse a user to change a config on the fly, and secondly there is currently no concept to automatically merge multi-value, comma-separated configurations like <code>session_preload_libraries</code>.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The 2x2 matrix makes it easier to understand how to enable an extension.</p><p>Just ask yourself &quot;do I need to run <code>CREATE EXTENSION</code>?&quot; determined by presence of a control file, and &quot;do I need to do a <code>LOAD</code>?&quot; determined by any mention of <code>LOAD</code>, <code>shared_preload_libraries</code>, or <code>session_preload_libraries</code> in the extension&#x27;s documentation or an error message.</p><p>In all cases of needing a <code>LOAD</code>, you can get away with setting it in <code>shared_preload_libraries</code>. You can optimize to avoid restarts in some cases.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="output-plugins">Output plugins<a href="#output-plugins" class="hash-link" aria-label="Direct link to Output plugins" title="Direct link to Output plugins">​</a></h3><p>There are some extensions, for example <a href="https://pgt.dev/extensions/wal2json" target="_blank" rel="noopener noreferrer">wal2json</a> that require neither <code>CREATE EXTENSION</code> or <code>LOAD</code>. In all known cases so far, these are <a href="https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html" target="_blank" rel="noopener noreferrer">output plugins</a>. I think it&#x27;s more of a stretch to call these &#x27;extensions&#x27;, but since they provide additional functionality to Postgres, that counts in my book.</p><p>In the case of output plugins, the library is loaded when a replication slot is created:</p><p><a href="https://www.postgresql.org/docs/current/logicaldecoding-example.html" target="_blank" rel="noopener noreferrer">Postgresql documentation</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM pg_create_logical_replication_slot(&#x27;regression_slot&#x27;, &#x27;test_decoding&#x27;, false, true);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-extensions">Installing extensions<a href="#installing-extensions" class="hash-link" aria-label="Direct link to Installing extensions" title="Direct link to Installing extensions">​</a></h2><p>Some of the above examples use the free and open source <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk project</a> that Tembo created, which allows us to skip the build process. It also installs extension dependencies, and provides metadata about other dependencies. When I&#x27;m trying out extensions, I am starting from one of Tembo’s container images to handle the system dependencies installation.</p><p><strong>I wrote <a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">this guide</a> for trying out extensions locally</strong>. If you have any issues just reach out on our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20v3m8pwz-pPjeFaWSM~Bt3KUqDXff2A" target="_blank" rel="noopener noreferrer">community Slack channel</a> and we can help.</p><p><em>Perhaps it&#x27;s not so bad after all...</em></p><p><img loading="lazy" alt="files-in-computer" src="/assets/images/files-in-computer-5a613d91e5bd9f281c1b4984e6e20976.gif" width="500" height="213" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automate-everything">Automate everything<a href="#automate-everything" class="hash-link" aria-label="Direct link to Automate everything" title="Direct link to Automate everything">​</a></h2><p>We want to make it possible to automatically install and turn on any Postgres extension. For this reason, we are seeking to qualify all known extensions by these two dimensions: requires <code>CREATE EXTENSION</code> true or false, and requires <code>LOAD</code> true or false.</p><p>To enable the community, that metadata is being published on <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a>. On <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we leverage that information to automatically enable extensions. Currently, we&#x27;ve got this working for over 150 extensions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dear-experts-tell-me-how-im-wrong-seriously">Dear experts, tell me how I&#x27;m wrong (seriously!)<a href="#dear-experts-tell-me-how-im-wrong-seriously" class="hash-link" aria-label="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)" title="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)">​</a></h2><p>I&#x27;m serious that I want you to tell me where this is incorrect! If you&#x27;re a Postgres extensions expert, or maybe just know a thing or two about extensions that seems to conflict with something in this blog, please reach out on X <a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a> and let me know. Even if it&#x27;s just minor correction or subjective information, I&#x27;d love to hear from you. I also want to hear if there is an easier mental model than this. I hope this blog can serve as a minimal yet comprehensive explanation of what it takes to get extensions turned on.</p><p>Another way to contribute is to <strong>click the &quot;Edit this page&quot; link below</strong>, and suggest changes. I will happily accept improvements to this blog.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/tembo-stacks-intro">Tembo Stacks: Making Postgres the Everything Database</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-06T00:00:00.000Z" itemprop="datePublished">September 6, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/samay-sharma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/samay-sharma.png" alt="Samay Sharma"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/samay-sharma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Samay Sharma</span></a></div><small class="avatar__subtitle" itemprop="description">CTO Tembo</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>For years, Postgres has been considered among the most popular and advanced open source OLTP databases. Interestingly, 20 years ago, it was a competition between Postgres and MySQL and this debate is still going on <a href="https://news.ycombinator.com/item?id=35906604" target="_blank" rel="noopener noreferrer">today</a>. 🙂 Over the last few years, Postgres added more features and its ecosystem added more extensions and now the comparison list keeps growing. After adding support for <a href="https://www.postgresql.org/docs/release/9.4.0/" target="_blank" rel="noopener noreferrer">jsonb</a> in 9.4, Postgres began to be compared with MongoDB as users started using Postgres to store unstructured data. With <a href="https://github.com/citusdata/citus" target="_blank" rel="noopener noreferrer">Citus</a>, people started using Postgres over other distributed SQL technologies for use cases such as multi-tenancy and analytics. And this phenomenon continues to grow with <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">pgvector</a>, <a href="https://github.com/timescale/timescaledb" target="_blank" rel="noopener noreferrer">timescaledb</a> and others.</p><h1>Use Postgres for Everything</h1><p>Postgres has evolved to where people have started talking about using “Postgres for everything.” There’s strong agreement that it’s wise to use Postgres until you find a strong reason for why you can’t use it anymore - either a very specialized use case, or scale which can’t be achieved by Postgres. This topic was well-discussed on <a href="https://news.ycombinator.com/item?id=33934139" target="_blank" rel="noopener noreferrer">hacker news</a> thanks to a <a href="https://www.amazingcto.com/postgres-for-everything/" target="_blank" rel="noopener noreferrer">blog</a> by a friend, Steven Schmidt.</p><p>And to clarify, when I say Postgres, I mean the entire Postgres ecosystem - this includes Postgres, its extensions and ecosystem tooling for high-availabilty, backups, connection pooling, etc. All of these together turn Postgres into a powerful data platform which you can use to run diverse workloads. However, it’s easier said than done.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="making-postgres-for-everything-real">Making “Postgres for Everything” real<a href="#making-postgres-for-everything-real" class="hash-link" aria-label="Direct link to Making “Postgres for Everything” real" title="Direct link to Making “Postgres for Everything” real">​</a></h2><p>Advanced users may know the recipe which turns Postgres into a distributed database, a vector database, an OLAP database or a search store, but this is still inaccessible to most developers. Over years of working with Postgres users, I’ve realized that even tuning Postgres for OLTP (which is a fairly well known use case) is very hard for most developers. For example: OLTP deployments often have badly chosen indexes, over / under provisioned hardware, insufficiently tuned autovacuum etc. even though they are running on managed services which do the heavy lifting for them.</p><p>So, expecting developers to be able to figure out how to use Postgres for all these use cases when there are other databases focused on user experience for one particular use case is unrealistic. Even though developers know that dealing with 5 different databases is a pain in the medium to long run, when they are starting, they care about getting off the ground fast. So, to expect everybody to use Postgres for everything, we need to make it possible for every user to have easy access to the recipes which turn Postgres into the database for the data service of their choice.</p><h1>Enter Tembo Stacks</h1><p>Tembo stacks are pre-built use-case-specific Postgres deployments which are optimized and tuned to serve a specific workload. They aim to be a replacement for other databases which you actually don’t need, but you are considering because you don’t know how to solve that problem using Postgres. They help you avoid the pains associated with learning, managing and deploying other database systems. Some examples of Stacks are: OLTP, Message Queue, Data Warehouse, Enterprise LLM and Document Store.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="defining-a-stack">Defining a stack<a href="#defining-a-stack" class="hash-link" aria-label="Direct link to Defining a stack" title="Direct link to Defining a stack">​</a></h2><p>A stack is a recipe of how to run an optimized Postgres for a workload, expressed as a spec file. The spec includes the following components:</p><ul><li>Docker Base Image containing a particular version of Postgres</li><li>Curated set of extensions which turn Postgres into best-in-class for that workload.</li><li>Hardware profile which is best suited for that workload</li><li>Postgres configs optimized according to hardware and workload</li><li>Use-case specific metrics, alerts and recommendations</li><li>On-instance sidecar - Kubernetes Services to Deploy a containerized application near Postgres to expand capabilities while minimizing network latency</li></ul><p>Let’s look at an example of a stack spec for a <a href="https://github.com/tembo-io/tembo-stacks/blob/main/tembo-operator/src/stacks/templates/message_queue.yaml" target="_blank" rel="noopener noreferrer">Message queue</a> stack - an <a href="https://aws.amazon.com/sqs/" target="_blank" rel="noopener noreferrer">SQS</a> / <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> replacement based on Postgres.</p><p>It has the following components:</p><ul><li>A standard Postgres 15 base image</li><li>Curated extensions: <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a>, <a href="https://github.com/pgpartman/pg_partman" target="_blank" rel="noopener noreferrer">pg_partman</a> and <a href="https://www.postgresql.org/docs/current/pgstatstatements.html" target="_blank" rel="noopener noreferrer">pg_stat_statements</a></li><li>Optimized Postgres configs: Aggressive autovacuum settings, reduced random_page_cost and Checkpoint and WAL configs tuned for a high throughput Postgres instance</li><li>CPU::Memory ratio recommendations for hardware</li><li>Message queue specific metrics like queue length, oldest message age, newest message age</li><li>(Coming soon) pg_bouncer</li></ul><p>This and many other such stack specifications are <a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator/src/stacks/templates" target="_blank" rel="noopener noreferrer">open source</a> and can be used to deploy a stack locally on a self-managed instance or fully managed on Tembo Cloud. This is a reflection of one of our core values - to always put developers first. We open source our stacks to create the best development experience: locally and on the cloud, and to invite community feedback and collaboration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-a-stack-on-tembo-cloud">Deploying a stack on Tembo Cloud<a href="#deploying-a-stack-on-tembo-cloud" class="hash-link" aria-label="Direct link to Deploying a stack on Tembo Cloud" title="Direct link to Deploying a stack on Tembo Cloud">​</a></h2><p><a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> is a dev-first, fully-extensible, fully-managed, secure, and scalable Postgres service. It has the ability to take this stack spec and deploy a Postgres instance which is built using this stack spec. With Tembo Cloud, you can get all the benefits of a managed service like: backups, high availability, scaling of storage and compute, metrics and alerts with an easy to use UI and CLI. And you get access to an ever growing list of <a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer">extensions</a> which you can add to your stack or bring your own extensions to deploy on Tembo Cloud.</p><p><img loading="lazy" alt="image" src="/assets/images/image-cae704f1f54958b9c0cff9d1ea5cb41d.png" width="2920" height="2076" class="img_ev3q"></p><h1>Evolving Postgres to be the data platform for everything</h1><p>We know we’ve embarked on a challenging journey to turn Postgres into the data platform for Everything. But, we strongly believe that with the power of Postgres and its ecosystem, it’s possible to replace most deployments of esoteric databases with just a flavor of Postgres and save developers a lot of time and effort.</p><p>We’ll be building many stacks, benchmarking them against “competitive” solutions, and making sure Postgres grows to tackle these workloads. We’ll have to optimize Postgres, support a wide variety of extensions, write several new extensions to close feature and performance gaps with other databases and also evolve Postgres. But, we have no doubt that we, along with the Postgres community can make this happen!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tembo">tembo</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/3"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://tembo.breezy.hr/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trunk<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/docs">Docs</a><span class="footer__link-separator">·</span><a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://www.linkedin.com/company/tembo-inc/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tembo. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef584dc9.js"></script>
<script src="/assets/js/main.75ceccb8.js"></script>
</body>
</html>