<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">3 posts tagged with &quot;rust&quot; | Tembo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" property="og:url" content="https://tembo.io/blog/tags/rust"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;rust&quot; | Tembo"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tembo.io/blog/tags/rust"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/rust" hreflang="en"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/rust" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tembo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tembo Atom Feed">





<script id="hs-script-loader" src="//js.hs-scripts.com/23590420.js"></script>
<link rel="preconnect" href="https://cdn.segment.io">
<script>!function(){var e=window.analytics=window.analytics||[];if(!e.initialize)if(e.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{e.invoked=!0,e.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],e.factory=function(t){return function(){if(window.analytics.initialized)return window.analytics[t].apply(window.analytics,arguments);var n=Array.prototype.slice.call(arguments);return n.unshift(t),e.push(n),e}};for(var t=0;t<e.methods.length;t++){var n=e.methods[t];e[n]=e.factory(n)}e.load=function(t,n){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(a,i),e._loadOptions=n},e._writeKey="YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE",e.SNIPPET_VERSION="4.16.1",e.load("YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE"),e.page()}}()</script>
<link key="docusaurus-plugin-plausible-preconnect" rel="preconnect" href="https://plausible.io">
<script key="docusaurus-plugin-plausible-script" async defer="defer" data-domain="tembo.io" src="https://plausible.io/js/plausible.js"></script>
<script key="docusaurus-plugin-plausible-custom-events">window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>

<script>prefinery=window.prefinery||function(){(window.prefinery.q=window.prefinery.q||[]).push(arguments)}</script>
<script src="https://widget.prefinery.com/widget/v2/yisnnyak.js" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.92bb70b2.css">
<link rel="preload" href="/assets/js/runtime~main.ef584dc9.js" as="script">
<link rel="preload" href="/assets/js/main.75ceccb8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" href="/docs">Docs</a><a class="navbar__item navbar__link" target="_blank" href="/blog">Blog</a><a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Tembo Cloud<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/tembo-io/tembo-stacks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep8">Hacking Postgres, Ep. 8: Philippe Noël</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-self-regulating-queue">PGMQ: Lightweight Message Queue on Postgres with No Background Worker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep7">Hacking Postgres Ep. 7: Burak Yucesoy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator-apps">Application Services: Helping Postgres Do More, Faster</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep6">Hacking Postgres, Ep. 6: Regina Obe and Paul Ramsey</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator">Tembo Operator: A Rust-based Kubernetes Operator for Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/anon-dump">Anonymized dump of your Postgres data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep5">Hacking Postgres, Ep. 5: Alexander Korotkov</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep4">Hacking Postgres, Ep. 4: Pavlo Golub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep3">Hacking Postgres, Ep. 3: Eric Ridge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep2">Hacking Postgres, Ep. 2: Adam Hendel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep1">Hacking Postgres Ep. 1: Marco Slot</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-terraform-provider-for-tembo">Introducing Terraform Provider for Tembo</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-16">Postgres 16: The exciting and the unnoticed</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-stacks-intro">Tembo Stacks: Making Postgres the Everything Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/optimizing-postgres-auto-vacuum">Optimizing Postgres&#x27;s Autovacuum for High-Churn Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-with-python">Using pgmq with Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pg-later">Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pgmq">Introducing PGMQ: Simple Message Queues built on Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-manifesto">Tembo Manifesto</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-tembo">Introducing Tembo</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;rust&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/tembo-operator-apps">Application Services: Helping Postgres Do More, Faster</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-01T00:00:00.000Z" itemprop="datePublished">November 1, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ChuckHend" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/chuckhend.png" alt="Adam Hendel"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ChuckHend" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Adam Hendel</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="alt_text" src="/assets/images/tembo_ele-7c81c53d1131a1b7fcca53d6ff51ed82.png" title="Tembo the Operator" width="1784" height="1706" class="img_ev3q"></p><p>So you have a database, and that database does something. (Probably several somethings, if we&#x27;re honest). However, today, you need it to do something else. </p><p>Simple enough...you just create a tool to give it that new functionality. Job done.</p><p>Except it isn&#x27;t. Because the requests for new &quot;things&quot; never stop. They get complicated. They slow things down. They conflict with one another. Sometimes they even screw up your database along the way. And if we&#x27;re honest, you don&#x27;t really want to be constantly building new tools for every new need anyway. Before you know it, all of these &quot;things&quot; you&#x27;re asking the database to do are starting to get in the way of its core performance.</p><p>The good news is that Postgres has a rich ecosystem of tools and services built by the community. Many of these run in the database as Postgres extensions, while others run outside the database as external services. Some of the most well known examples are <a href="https://postgrest.org/en/stable/" target="_blank" rel="noopener noreferrer">PostgREST</a>, an out-of-the box REST API for Postgres and <a href="https://www.pgbouncer.org/usage.html" target="_blank" rel="noopener noreferrer">pgbouncer</a>, a production ready connection pooler. A scalable way to run these pieces of software with the Tembo operator is to utilize a new feature called Application Services, which runs these applications in containers next to postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-the-essence-of-tembo-operator">Understanding the Essence of Tembo Operator<a href="#understanding-the-essence-of-tembo-operator" class="hash-link" aria-label="Direct link to Understanding the Essence of Tembo Operator" title="Direct link to Understanding the Essence of Tembo Operator">​</a></h2><p>We have developed the Tembo Operator looking to add new capabilities for developers and enterprises. We believe that it stands out from other techniques in many ways, and in particular, one important feature is that it lets users deploy applications in containers right alongside their PostgreSQL instances, ensuring efficient connection to Postgres with very low latency.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-advantage-of-running-applications-in-separate-containers">The Advantage of Running Applications in Separate Containers<a href="#the-advantage-of-running-applications-in-separate-containers" class="hash-link" aria-label="Direct link to The Advantage of Running Applications in Separate Containers" title="Direct link to The Advantage of Running Applications in Separate Containers">​</a></h2><p>PostgreSQL is a very powerful piece of software. When running in Kubernetes, a useful pattern is to run important applications in a separate container, in the same namespace. By running these applications in separate containers, we isolate application requirements, such as resource allocations. This means that each container can have dedicated CPU and Memory, ensuring there&#x27;s no competition with the resources reserved for running PostgreSQL. This segregation ensures that the Postgres database and other applications can function and scale efficiently.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spotlight-on-postgrest-a-prime-example">Spotlight on PostgREST: A Prime Example<a href="#spotlight-on-postgrest-a-prime-example" class="hash-link" aria-label="Direct link to Spotlight on PostgREST: A Prime Example" title="Direct link to Spotlight on PostgREST: A Prime Example">​</a></h2><p>PostgREST is a perfect example where an application can run with this pattern. PostgREST serves as a standalone web server that turns your database directly into a RESTful API. The immediate advantage? Developers can use the auto-generated API to build robust applications without writing any code. By simplifying the process and reducing the need for middleware, PostgREST has become a popular tool in the Postgres ecosystem.</p><p>However, let’s remember that  the main advantage of this method is not just resource allocation. It&#x27;s about ensuring the optimal performance of Postgres without bogging it down with additional tasks. </p><p>Let’s look at an example of a spec that would run the workload that we just described. This will look familiar if you’ve worked with the <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Kubernetes Pod spec.</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">postgres</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;quay.io/tembo/standard-cnpg:15.3.0-1-1096aeb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">appServices</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgrest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgrest/postgrest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v10.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ingressPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_URI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFromPlatform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ReadWriteConnection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_SCHEMA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PGRST_DB_ANON_ROLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The Tembo operator always starts postgres with default configurations, so let’s focus on the <code>appServices</code> section of the spec, which will tell us what and how we’ll run an application container.</p><p>We can run any number of applications in containers near the Postgres instance. Only the <code>name</code> and <code>image</code> parameters are required, but you can configure commands, arguments, environment variables, CPU and memory, and readiness and liveness probes for the application.</p><p>If you need network communication, you can also configure the ingress by specifying a port and a path. In our example, postgREST runs on port 3000 and expects traffic routed to the root path. appServices also support various Middleware configurations, but we will cover those in a future blog.</p><p>Environment variables also have some advanced configuration. The Tembo operator creates a few roles in Postgres, and tracks those credentials in a Kubernetes secret. If we want to pull those credentials into an application, we can do so by using the <code>valueFromPlatform</code> option. The service currently supports pulling in credentials for <code>ReadWriteConnection</code>, <code>ReadOnlyConnection</code> but we’ll be building out more role assignments soon.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrary-container-deployments">Arbitrary container deployments<a href="#arbitrary-container-deployments" class="hash-link" aria-label="Direct link to Arbitrary container deployments" title="Direct link to Arbitrary container deployments">​</a></h2><p>The Tembo operator is not limited to postgREST; it can run nearly any containerized application. For example, run your Rails application, or FastAPI web server. Specify the image, and other configurations as necessary and the Tembo operator will provision the resources.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">postgres</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">appServices</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/myImage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ingressPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;python&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-m&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;myapp.py&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MY_ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Kubernetes Footprint</strong></p><p>Let’s take a look at what actually gets created when you specify an appService; we’ll use the postgREST example as an illustration.</p><p>Every application service gets its own Kubernetes Deployment. If the appService has any ingress requirements, then a Kubernetes Service and an ingress resource (Tembo currently uses <a href="https://doc.traefik.io/traefik/middlewares/overview/" target="_blank" rel="noopener noreferrer">Traefik</a>) is created for that appService. Middleware is also created (also Traefik) if the appService has any middleware configuration specified. Here’s an image of the pods you’d likely see in the namespace you create for Postgres.</p><p><img loading="lazy" alt="alt_text" src="/assets/images/kube-5f0581fdf597e5d0acd3b910b88808b3.png" title="image_tooltip" width="1512" height="576" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-to-follow">More to follow<a href="#more-to-follow" class="hash-link" aria-label="Direct link to More to follow" title="Direct link to More to follow">​</a></h2><p>The Tembo operator is under continuous development and runs the entire Postgres Stack, which is not limited to just the core Postgres engine. It also includes auxiliary container services that run outside of Postgres. These auxiliary services augment the Postgres experience by running complex applications outside of Postgres which isolates their workload from your database. Running this with the Tembo Operator makes it simple to get these services up and running.</p><p>And if you want to try out the full power of Postgres without being concerned with how it will run, try out <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>.Drop into our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20dtnhcmo-pLNV7_Aobi50TdTLpfQ~EQ" target="_blank" rel="noopener noreferrer">Slack</a> channel to ask questions and get help from the Tembo team and other community members.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/k8s-operator-e0798d9d346084f00e21f39668252d9d.webp"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/tembo-operator">Tembo Operator: A Rust-based Kubernetes Operator for Postgres</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-25T00:00:00.000Z" itemprop="datePublished">October 25, 2023</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ianstanton" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ianstanton.png" alt="Ian Stanton"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ianstanton" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Ian Stanton</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>At Tembo, we’ve been developing an open-source Kubernetes Operator for Postgres. We use this operator to power our managed Postgres platform, <a href="https://cloud.tembo.io/" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>. We’re excited to share our progress, experience, and vision for this project. This post aims to assist anyone interested in utilizing Kubernetes operators for Postgres or writing Kubernetes operators using Rust.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-kubernetes-operator">What is a Kubernetes Operator?<a href="#what-is-a-kubernetes-operator" class="hash-link" aria-label="Direct link to What is a Kubernetes Operator?" title="Direct link to What is a Kubernetes Operator?">​</a></h2><p>Kubernetes was designed with automation in mind, and operators allow for users to extend native Kubernetes behavior and principles to manage custom resources and components.</p><p>With a Kubernetes operator, users can write code that defines how their application should be deployed and managed on Kubernetes. This code is then packaged into a container image and deployed to Kubernetes. The operator then watches for changes to the custom resource and takes action to reconcile the state of the application’s components with the desired state of the custom resource.</p><p>In short, using a Kubernetes operator is the most effective way to run applications on Kubernetes in 2023.</p><p>You can read more about Kubernetes operators on this <a href="https://www.cncf.io/blog/2022/06/15/kubernetes-operators-what-are-they-some-examples/" target="_blank" rel="noopener noreferrer">CNCF blog post</a>, where the image below is.</p><p><img loading="lazy" alt="./k8s-operator.webp" src="/assets/images/k8s-operator-e0798d9d346084f00e21f39668252d9d.webp" width="1920" height="1080" class="img_ev3q"></p><p align="center">*Image credit: CNCF blog*</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-operators-and-the-rise-of-rust">Kubernetes Operators and the Rise of Rust<a href="#kubernetes-operators-and-the-rise-of-rust" class="hash-link" aria-label="Direct link to Kubernetes Operators and the Rise of Rust" title="Direct link to Kubernetes Operators and the Rise of Rust">​</a></h2><p>Because Kubernetes itself is written in Go, the majority of Kubernetes operators available today are also written in Go. The <a href="https://book.kubebuilder.io/" target="_blank" rel="noopener noreferrer">kubebuilder</a> project simplifies the process of building Kubernetes operators in Go and is widely considered the de facto standard for doing so.</p><p>With the increasing popularity of Rust, it was only a matter of time before someone developed a framework for building Kubernetes operators in Rust. The <a href="https://github.com/kube-rs/kube" target="_blank" rel="noopener noreferrer">kube-rs</a> project allows developers to build Rust-based Kubernetes operators in a similar manner to the <code>kubebuilder</code> project. This project excited us for a few reasons:</p><ol><li>We were interested in learning Rust.</li><li>We wanted to explore whether Rust could be a viable alternative to Go for writing Kubernetes operators.</li><li>We were inspired by the success of companies like <a href="https://github.com/stackabletech" target="_blank" rel="noopener noreferrer">Stackable</a>, who have developed numerous Kubernetes operators in Rust.</li></ol><p>This excitement led us to the decision to write our Kubernetes operator in Rust.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-the-tembo-operator">Building the Tembo Operator<a href="#building-the-tembo-operator" class="hash-link" aria-label="Direct link to Building the Tembo Operator" title="Direct link to Building the Tembo Operator">​</a></h2><p>Tembo Cloud distinguishes itself from other managed Postgres offerings in several ways, one of which is the ability to install and enable Postgres extensions on the fly. This experience is in part powered by <a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer">Trunk</a>, a Postgres extension registry and companion CLI that provide a simplified extension management experience.</p><p>It also introduces the concept of <a href="https://tembo.io/blog/tembo-stacks-intro" target="_blank" rel="noopener noreferrer">Stacks</a>, which are pre-built use-case-specific Postgres deployments which are optimized and tuned to serve a specific workload.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="roll-your-own">Roll Your Own<a href="#roll-your-own" class="hash-link" aria-label="Direct link to Roll Your Own" title="Direct link to Roll Your Own">​</a></h3><p>In order to build these unique capabilities, we knew we’d need to harness the power and flexibility of a Kubernetes operator in our own way. Although there are several Kubernetes operators for Postgres available, none of them offer the same unique Postgres extension management experience or the concept of Stacks.</p><p>Initially, we attempted to build our own operator from scratch. We had successfully built the extension management piece, but soon realized that we were duplicating existing efforts. We had a comprehensive list of baseline features to develop, which included:</p><ul><li>Backup</li><li>Recovery</li><li>Connection Pooling</li><li>Failover</li><li>Upgrades</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cnpg-to-the-rescue">CNPG to the Rescue<a href="#cnpg-to-the-rescue" class="hash-link" aria-label="Direct link to CNPG to the Rescue" title="Direct link to CNPG to the Rescue">​</a></h3><p>Enter <a href="https://cloudnative-pg.io/" target="_blank" rel="noopener noreferrer">CloudNativePG</a> (CNPG). CNPG is a Kubernetes operator for Postgres created by the folks at EDB. We found it to be the most compelling of the many Kubernetes operators for Postgres out there. It provided many of the features we needed, including backup, recovery, connection pooling, failover, and upgrades. However, we still needed the ability to install and enable any Postgres extensions on the fly and define Stacks.</p><p>This is where the Tembo Operator comes in. We built the Tembo Operator in a way that utilizes CNPG, which enables us to offer a distinctive management experience for Postgres extensions and Stacks while utilizing a reliable and stable Postgres solution.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-tembo-operator">Using the Tembo Operator<a href="#using-the-tembo-operator" class="hash-link" aria-label="Direct link to Using the Tembo Operator" title="Direct link to Using the Tembo Operator">​</a></h2><p>Let’s take a look at what a custom resource spec looks like for the Tembo Operator. Here’s an example for our Machine Learning Stack. We can see this sample spec makes use of our Machine Learning Stack and includes a handful of extensions. Keep in mind, these extensions are installed at runtime with Trunk and are not built into the container image.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> coredb.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CoreDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">machine</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">learning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;quay.io/tembo/ml-cnpg:15.3.0-1-a3e532d&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">stop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">stack</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MachineLearning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">postgres_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_stat_statements.track</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cron.host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /controller/run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> track_io_timing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;on&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_stat_statements</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pgml</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_cron</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">trunk_installs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgvector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2.7.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.14.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project pgvector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project postgresml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2.7.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># trunk project pg_embedding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_cron</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pgmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.14.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vectorize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> simple vector search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> async query execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">runtime_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shared_buffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1024MB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> max_connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;431&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> work_mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5MB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bgwriter_delay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;200ms&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> effective_cache_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2867MB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> maintenance_work_mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;204MB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> max_wal_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10GB&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To create our Postgres instance, we run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl apply -f yaml/sample-machine-learning.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">coredb.coredb.io/sample-machine-learning created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">❯ kubectl get po</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                               READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample-machine-learning-1                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample-machine-learning-metrics-5fbcf9b676-hkxtk   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          31s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once we’ve connected to the Postgres instance, we can run <code>\dx</code> to confirm the extensions were installed and enabled as expected:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">PGPASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get secrets/sample-machine-learning-connection --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable punctuation" style="color:#393A34">{</span><span class="token variable punctuation" style="color:#393A34">{</span><span class="token variable" style="color:#36acaa">.data.password</span><span class="token variable punctuation" style="color:#393A34">}</span><span class="token variable punctuation" style="color:#393A34">}</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> base64 -d</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">❯ psql postgres://postgres:</span><span class="token variable" style="color:#36acaa">$PGPASSWORD</span><span class="token plain">@sample-machine-learning.localhost:5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ubuntu </span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain">-1.pgdg22.04+1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, server </span><span class="token number" style="color:#36acaa">15.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSL connection </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token string" style="color:#e3116c">&quot;help&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">postgres</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># \dx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Version </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   Schema   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                              Description                               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------+---------+------------+------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_cron            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Job scheduler </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> PostgreSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_later           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.8   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pglater    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_later:  Run queries now and get results later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_stat_statements </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.10</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> track planning and execution statistics of all SQL statements executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.14</span><span class="token plain">.2  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vector             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vector data </span><span class="token builtin class-name">type</span><span class="token plain"> and ivfflat access method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vectorize          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.2   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vectorize  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> The simplest way to </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> vector search on Postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let’s install a new extension by adding the following to our sample spec:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">trunk_installs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_bm25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.4.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg_bm25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.4.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After applying the updated spec and connecting to Postgres, we can see the new extension <a href="https://pgt.dev/extensions/pg_bm25" target="_blank" rel="noopener noreferrer">pg_bm25</a> is installed and enabled as expected:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ psql postgres://postgres:</span><span class="token variable" style="color:#36acaa">$PGPASSWORD</span><span class="token plain">@sample-machine-learning.localhost:5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ubuntu </span><span class="token number" style="color:#36acaa">16.0</span><span class="token plain">-1.pgdg22.04+1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, server </span><span class="token number" style="color:#36acaa">15.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SSL connection </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token string" style="color:#e3116c">&quot;help&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> help.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">postgres</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># \dx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Version </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   Schema   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">                              Description                               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------+---------+------------+------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_bm25            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> paradedb   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_bm25: PostgreSQL-native, full text search using BM25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_cron            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Job scheduler </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> PostgreSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_later           </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.8   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pglater    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_later:  Run queries now and get results later</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pg_stat_statements </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.10</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> track planning and execution statistics of all SQL statements executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq               </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.14</span><span class="token plain">.2  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> pg_catalog </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vector             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain">.0   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> public     </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vector data </span><span class="token builtin class-name">type</span><span class="token plain"> and ivfflat access method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> vectorize          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.2   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> vectorize  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> The simplest way to </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> vector search on Postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="up-next">Up Next<a href="#up-next" class="hash-link" aria-label="Direct link to Up Next" title="Direct link to Up Next">​</a></h2><p>We’re currently working on exciting new features that enable the deployment of custom applications alongside Postgres. These features include a REST API, GraphQL, and more. Stay tuned for future updates!</p><p>For more information on running the Tembo Operator, check out our docs at:</p><ul><li><a href="https://tembo.io/docs/tembo-stacks/local-tembo-operator" target="_blank" rel="noopener noreferrer">https://tembo.io/docs/tembo-stacks/local-tembo-operator</a></li></ul><p>If you&#x27;re interested in contributing to the project, check out our Github repo at:</p><ul><li><a href="https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/tembo-stacks/tree/main/tembo-operator</a></li></ul><p>And if you want to try out the full power of Postgres and fully delegate extension management to us, <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">try out Tembo Cloud</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-28T00:00:00.000Z" itemprop="datePublished">September 28, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/binidxaba.png" alt="Binidxaba"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Binidxaba</span></a></div><small class="avatar__subtitle" itemprop="description">Community contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In my <a href="https://tembo.io/blog/pgmq-with-python" target="_blank" rel="noopener noreferrer">previous submission</a> to this space, I described my experience with <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a> while using the Python library. In this post, I&#x27;ll share what I found after inspecting the code.</p><p>So, first, I&#x27;ll describe the general structure of the project. Then, I&#x27;ll explain what happens when we install the pgmq extension. Finally, I&#x27;ll describe how some of its functions work.</p><p>In this post, I&#x27;ll be using version v0.25.0, which you can find <a href="https://github.com/tembo-io/pgmq/releases/tag/v0.25.0" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure">​</a></h2><p>After cloning the appropriate tag, we can see that the repository contains the following files:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTRIBUTING.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dockerfile.build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tembo-pgmq-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tests</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The project uses <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">pgrx</a>. From pgrx&#x27;s <a href="https://github.com/pgcentralfoundation/pgrx/blob/develop/README.md" target="_blank" rel="noopener noreferrer">README</a>, we know that the relevant files for the extension are <code>Cargo.toml</code>, <code>pgmq.control</code> and the <code>src</code> and <code>sql</code> directories:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tree sql src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.11.1--0.11.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.0--0.8.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.1--0.9.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── errors.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── metrics.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── partition.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── sql_src.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── util.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> directories, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-the-pgmq-extension">Installing the pgmq extension<a href="#installing-the-pgmq-extension" class="hash-link" aria-label="Direct link to Installing the pgmq extension" title="Direct link to Installing the pgmq extension">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This section assumes that you have successfully installed the pre-requisites as described in <a href="https://github.com/tembo-io/pgmq/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">CONTRIBUTING.md</a></p></div></div><p>To build the pgmq extension, we can do the following:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, to build and install the pgmq extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In either case, we can see a shared library <code>pgmq.so</code> being created. The installation process also places the shared library in the <code>lib</code> directory of the postgres installation; and the sql files and the control file in the <code>extensions</code> directory. In my case:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/share/extension/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/lib/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/lib/pgmq.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To test the extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and it&#x27;ll start a <code>psql</code> prompt. In the prompt, we can execute the <code>create extension</code> statement to start using pgmq:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Enable pgmq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension pgmq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will look something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# create extension pgmq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |                             Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq    | 0.25.0  | public     | A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also list the available functions:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List available functions under pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\df pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \df pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                         List of functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |          Name          |                                                                         Result data type                                                                         |                                                 Argument data types                                                  | Type </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | TABLE(archive boolean)                                                                                                                                           | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create                 | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_non_partitioned | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_partitioned     | void                                                                                                                                                             | queue_name text, partition_interval text DEFAULT &#x27;10000&#x27;::text, retention_interval text DEFAULT &#x27;100000&#x27;::text       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | TABLE(delete boolean)                                                                                                                                            | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | drop_queue             | boolean                                                                                                                                                          | queue_name text, partitioned boolean DEFAULT false                                                                   | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | list_queues            | TABLE(queue_name text, created_at timestamp with time zone)                                                                                                      |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics                | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics_all            | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | pop                    | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | purge_queue            | bigint                                                                                                                                                           | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read                   | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer                                                                         | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read_with_poll         | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer, poll_timeout_s integer DEFAULT 5, poll_interval_ms integer DEFAULT 250 | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send                   | bigint                                                                                                                                                           | queue_name text, message jsonb, delay integer DEFAULT 0                                                              | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send_batch             | TABLE(msg_id bigint)                                                                                                                                             | queue_name text, messages jsonb[], delay integer DEFAULT 0                                                           | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | set_vt                 | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, msg_id bigint, vt_offset integer                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(18 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this, we can now explore the extension from the inside. And, if needed, recompile and reinstall the extension to play with it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-internals">The internals<a href="#the-internals" class="hash-link" aria-label="Direct link to The internals" title="Direct link to The internals">​</a></h2><p>We know that when an extension is created with pgrx, it generates a <code>lib.rs</code> file. Let us explore it.</p><p>One of the first thing we can see, is that the other five files in the <code>src/</code> directory are included:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub mod api;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod partition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod util;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After reviewing these files a little bit, we can notice that there&#x27;s also some relevant code in another module, the one in <code>core/</code>. For example, in <code>src/partition.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use pgmq_core::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors::PgmqError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive, assign_queue, create_archive, create_archive_index, create_index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_meta, grant_pgmon_meta, grant_pgmon_queue, grant_pgmon_queue_seq, insert_meta,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    types::{PGMQ_SCHEMA, QUEUE_PREFIX},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    util::CheckedName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, at this point we know that we can find the source code in two places: <code>src/</code> and <code>core/</code>. </p><p>If we continue exploring <code>lib.rs</code>, we can see that a sql file (<code>sql_src.sql</code>) is executed when the extension is enabled:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE pgmq.meta (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name VARCHAR UNIQUE NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_partitioned BOOLEAN NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can actually see that table with <code>psql</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List tables in the pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List contents of pgmq.meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-# \dt pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema | Name | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------+-------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public | meta | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like right after <code>CREATE EXTENSION</code> is executed:</p><p><img loading="lazy" alt="after-create-extension" src="/assets/images/after-create-extension-e590194728d15b0433b8e5510725f9ff.png" title="after create extension" width="596" height="551" class="img_ev3q"></p><p>From this point, we can suspect that every time we create a queue, a new row is inserted into this table.</p><p>Let us see what <code>pgmq.create()</code> does...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqcreate">pgmq.create()<a href="#pgmqcreate" class="hash-link" aria-label="Direct link to pgmq.create()" title="Direct link to pgmq.create()">​</a></h3><p>Most of the functions provided by pgmq are defined in <code>src/api.rs</code>. In that file, we can find the function <code>pgmq_create(queue_name: &amp;str)</code>, and if we chase the call sequence, we can discover that the interesting function is <code>init_queue(name: &amp;str)</code> in <code>core/src/query.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn init_queue(name: &amp;str) -&gt; Result&lt;Vec&lt;String&gt;, PgmqError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let name = CheckedName::new(name)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(vec![</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert_meta(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grant_pgmon_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function generates several sql statements that are later executed in <code>pgmq_create_non_partitioned</code> using an <a href="https://docs.rs/pgx/latest/pgx/spi/struct.SpiClient.html" target="_blank" rel="noopener noreferrer"><code>Spi</code> client</a>.</p><p>I&#x27;ll skip the details, but the sql statements basically do:</p><ol><li>Create a table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pqmg extension.</li><li>Create an index on the <code>pgmq.q_&lt;queue_name&gt;</code> table.</li><li>Create a table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pgmq extension.</li><li>Create an index on the <code>pgmq.a_&lt;queue_name&gt;</code> table.</li><li>Insert a row on the <code>pgmq.meta</code> table.</li><li>Grant privileges to <code>pg_monitor</code>.</li></ol><p>We can see the effects of this in psql using the following lines:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List tables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List indexes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\di pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- See the contents of pgmq_meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will show something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq_create(&#x27;my_queue&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dt pgmq.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |    Name    | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------+-------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta       | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \di pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |           Name           | Type  |   Owner   |   Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+--------------------------+-------+-----------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue_pkey          | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archived_at_idx_my_queue | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta_queue_name_key      | index | binidxaba | meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_pkey          | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_vt_idx        | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | is_partitioned |          created_at           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ------------+----------------+-------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_queue   | f              | 2023-09-18 23:35:38.163096-06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like at this point:</p><p><img loading="lazy" alt="complete" src="/assets/images/complete-0b9cb3715d61904139d1d12fb7d717e6.png" title="after create queue" width="596" height="551" class="img_ev3q"></p><p>For the queue <code>my_queue</code>, we can see the underlying table and the corresponding archive table. Each table has an index associated with the primary key. The <code>pgmq.q_my_queue</code> table also has an index on the <code>vt</code> column, and <code>pgmq.a_my_queue</code> has an index on the <code>archived_at</code> column.</p><p>We can suspect that the <code>pgmq.q_my_queue</code> table is used in the send and read operations. Let us look at those two functions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqsend">pgmq.send()<a href="#pgmqsend" class="hash-link" aria-label="Direct link to pgmq.send()" title="Direct link to pgmq.send()">​</a></h3><p>We can explore the send operation in a similar way. The relevant SQL is straightforward. It just inserts a new row in the the underlying table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">values</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-send" src="/assets/images/pgmq-send-e0f2306ae56fdd9487889c5125c8b461.png" title="what send does" width="596" height="624" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>At this point, we can see the following pattern in the pgmq project: </p><ul><li>the exposed SQL functions are defined in <code>src/api.rs</code>, and </li><li>the underlying SQL statements are defined in <code>core/src/query.rs</code></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqread">pgmq.read()<a href="#pgmqread" class="hash-link" aria-label="Direct link to pgmq.read()" title="Direct link to pgmq.read()">​</a></h3><p>So, let&#x27;s see. If I were the one programming <code>pgmq.read()</code>, I would perhaps do something like &quot;get the first <code>{limit}</code> rows from the queue table whose <code>{vt}</code> has already expired, and for those rows, also update the visibility timeout to <code>now() + {vt}</code>.&quot; Naively, maybe something like:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain">                                                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In reality, <code>pgmq.read</code> is more interesting than that 😅. It performs the following DML:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{vt} seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cte</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cte</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-read" src="/assets/images/pgmq-read-b13515d2be7805a182167d1430faad87.png" title="what read does" width="596" height="624" class="img_ev3q"></p><p>Firstly, in pgmq&#x27;s version, there is a CTE (Common Table Expression) to obtain the first <code>{limit}</code> message IDs whose <code>vt</code> has expired. (It would be interesting to discuss why pgmq developers used a CTE, but we can explore that in another post.)</p><p>There are two crucial things to notice in the CTE. One is the <code>order by</code> clause that ensures the FIFO ordering. The other one is the <code>FOR UPDATE SKIP LOCKED</code> clause, claiming the rows no one else has claimed. This part is essential because it ensures correctness in the case of concurrent  <code>pgmq.read()</code> operations. </p><p>The next step in the DML is to update the corresponding rows with a new vt value by adding the supplied <code>{vt}</code> to the current timestamp. Additionally, the <code>read_ct</code> value is incremented by 1. What is the use of this counter? In general, we can suspect that there is a problem processing a given message if it has a high <code>read_ct</code> value because users usually archive the message after successfully processing it. So, ideally, a message is only read once. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqarchive">pgmq.archive()<a href="#pgmqarchive" class="hash-link" aria-label="Direct link to pgmq.archive()" title="Direct link to pgmq.archive()">​</a></h3><p>The next stage in the lifecycle of a message is archiving it. For that, pgmq uses the following insert statement:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> archived </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{ARCHIVE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Essentially, it deletes the message with the provided <code>msg_id</code> from the queue table, and then the message is placed in the corresponding archive table.</p><p><img loading="lazy" alt="pgmq-archive" src="/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png" title="what archive does" width="596" height="624" class="img_ev3q"></p><p>One interesting thing to notice is that <code>pgmq.archive()</code> can be used to archive a batch of messages too:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">archive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ARRAY</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq.archive(&#x27;my_queue&#x27;, ARRAY[3, 4, 5]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is achieved in pgrx by declaring two functions using the <a href="https://github.com/pgcentralfoundation/pgrx/blob/047b1d1fc9e9c4007c871e226fa81e294f8bf5e6/pgrx-macros/src/lib.rs#L462" target="_blank" rel="noopener noreferrer">same name in the <code>pg_extern</code></a> derive macro as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive(queue_name: &amp;str, msg_id: i64) -&gt; Result&lt;Option&lt;bool&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive_batch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name: &amp;str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_ids: Vec&lt;i64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;TableIterator&lt;&#x27;static, (name!(archive, bool),)&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqdrop_queue">pgmq.drop<!-- -->_<!-- -->queue()<a href="#pgmqdrop_queue" class="hash-link" aria-label="Direct link to pgmqdrop_queue" title="Direct link to pgmqdrop_queue">​</a></h3><p>Finally, let&#x27;s talk about <code>pgmq.drop_queue()</code>. It essentially executes multiple statements:</p><ol><li>Unassign the <code>pgmq.q_&lt;queue_name&gt;</code> table from the extension.</li><li>Unassign the <code>pgmq.a_&lt;queue_name&gt;</code> table from the extension.</li><li>Drop the table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Drop the table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Delete the corresponding row from the <code>pgmq.meta</code> table.</li></ol><p>Nothing surprising in this one, and with it, we conclude our tour.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this post, we explored how the pgrx tool is used to generate the pgmq extension. We explored how the metadata objects are created and how they are used in the basic send, read and archive operations. At least from an explorer perspective, the internals of the extension are currently easy to read and understand.</p><p>I invite everyone to explore how the other pgmq functions work. You can explore the code at <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>. And you can learn more about pgrx at: <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgmq">pgmq</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgrx">pgrx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://tembo.breezy.hr/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trunk<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/docs">Docs</a><span class="footer__link-separator">·</span><a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://www.linkedin.com/company/tembo-inc/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tembo. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef584dc9.js"></script>
<script src="/assets/js/main.75ceccb8.js"></script>
</body>
</html>