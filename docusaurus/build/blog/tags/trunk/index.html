<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">2 posts tagged with &quot;trunk&quot; | Tembo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" property="og:url" content="https://tembo.io/blog/tags/trunk"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="2 posts tagged with &quot;trunk&quot; | Tembo"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tembo.io/blog/tags/trunk"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/trunk" hreflang="en"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/trunk" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tembo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tembo Atom Feed">





<script id="hs-script-loader" src="//js.hs-scripts.com/23590420.js"></script>
<link rel="preconnect" href="https://cdn.segment.io">
<script>!function(){var e=window.analytics=window.analytics||[];if(!e.initialize)if(e.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{e.invoked=!0,e.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],e.factory=function(t){return function(){if(window.analytics.initialized)return window.analytics[t].apply(window.analytics,arguments);var n=Array.prototype.slice.call(arguments);return n.unshift(t),e.push(n),e}};for(var t=0;t<e.methods.length;t++){var n=e.methods[t];e[n]=e.factory(n)}e.load=function(t,n){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(a,i),e._loadOptions=n},e._writeKey="YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE",e.SNIPPET_VERSION="4.16.1",e.load("YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE"),e.page()}}()</script>
<link key="docusaurus-plugin-plausible-preconnect" rel="preconnect" href="https://plausible.io">
<script key="docusaurus-plugin-plausible-script" async defer="defer" data-domain="tembo.io" src="https://plausible.io/js/plausible.js"></script>
<script key="docusaurus-plugin-plausible-custom-events">window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>

<script>prefinery=window.prefinery||function(){(window.prefinery.q=window.prefinery.q||[]).push(arguments)}</script>
<script src="https://widget.prefinery.com/widget/v2/yisnnyak.js" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.92bb70b2.css">
<link rel="preload" href="/assets/js/runtime~main.ef584dc9.js" as="script">
<link rel="preload" href="/assets/js/main.75ceccb8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" href="/docs">Docs</a><a class="navbar__item navbar__link" target="_blank" href="/blog">Blog</a><a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Tembo Cloud<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/tembo-io/tembo-stacks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep8">Hacking Postgres, Ep. 8: Philippe Noël</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-self-regulating-queue">PGMQ: Lightweight Message Queue on Postgres with No Background Worker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep7">Hacking Postgres Ep. 7: Burak Yucesoy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator-apps">Application Services: Helping Postgres Do More, Faster</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep6">Hacking Postgres, Ep. 6: Regina Obe and Paul Ramsey</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator">Tembo Operator: A Rust-based Kubernetes Operator for Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/anon-dump">Anonymized dump of your Postgres data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep5">Hacking Postgres, Ep. 5: Alexander Korotkov</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep4">Hacking Postgres, Ep. 4: Pavlo Golub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep3">Hacking Postgres, Ep. 3: Eric Ridge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep2">Hacking Postgres, Ep. 2: Adam Hendel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep1">Hacking Postgres Ep. 1: Marco Slot</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-terraform-provider-for-tembo">Introducing Terraform Provider for Tembo</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-16">Postgres 16: The exciting and the unnoticed</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-stacks-intro">Tembo Stacks: Making Postgres the Everything Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/optimizing-postgres-auto-vacuum">Optimizing Postgres&#x27;s Autovacuum for High-Churn Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-with-python">Using pgmq with Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pg-later">Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pgmq">Introducing PGMQ: Simple Message Queues built on Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-manifesto">Tembo Manifesto</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-tembo">Introducing Tembo</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;trunk&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-29T00:00:00.000Z" itemprop="datePublished">September 29, 2023</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="back-in-time" src="/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg" width="788" height="453" class="img_ev3q"></p><p>A nice feature of AWS S3 is version history and lifecycle policies. When objects are updated or deleted, the old object version remains in the bucket, but it’s hidden. Old versions are deleted eventually by the lifecycle policy.</p><p>I would like something like that for my Postgres table data. <strong>We can use the temporal_tables extension for version history, and combine it with pg_partman to partition by time, automatically expiring old versions.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-model">Data model<a href="#data-model" class="hash-link" aria-label="Direct link to Data model" title="Direct link to Data model">​</a></h2><p>Let&#x27;s say we have a table <strong>employees</strong>, and it looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |  7000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will add one more column to this table, <code>sys_period</code>, which is a time range. This time range represents &quot;since when&quot; is this row the current version. This range is unbounded on the right side, because all the rows in the <strong>employees</strong> table are the present version.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 13:30:19.24318+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 13:33:58.735932+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 13:33:58.738827+00&quot;,)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will make a new table <strong>employees_history</strong> to store previous versions. This will have the same columns as the <strong>employees</strong> table, but all the rows in <code>sys_period</code> are bounded on the the right and the left sides. These ranges represent when this row was the current version. We will configure <strong>temporal_tables</strong> to automatically create these rows when anything changes in the <strong>employees</strong> table.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 13:30:19.18544+00&quot;,&quot;2023-09-28 13:33:58.683279+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 13:33:58.683279+00&quot;,&quot;2023-09-28 13:33:58.731332+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 13:33:58.731332+00&quot;,&quot;2023-09-28 13:33:58.735932+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 13:30:19.239152+00&quot;,&quot;2023-09-28 13:33:58.738827+00&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To automatically delete old versions, we&#x27;ll add one more column to the <strong>employees_table</strong>, <code>created_at</code>. We will use this information to expire old versions after they are older than our retenion configuration, with the help of <strong>pg_partman</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally. I&#x27;ve followed that guide to set up my environment with <strong>temporal_tables</strong> and <strong>pg_partman</strong>.</p><p>I have a Dockefile, two SQL scripts, and a file with Postgres configurations.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 0_startup.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 1_create_versioned_table.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── custom.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Dockerfile:</strong> We use <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a> to install pg_partman and temporal_tables. Then, we copy the three other files into the image.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install pg_partman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install temporal_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 0_startup.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 1_create_versioned_table.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY custom.conf $PGDATA/extra-configs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>0_startup.sql:</strong> Enables temporal_tables and pg_partman when Postgres starts.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> temporal_tables</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_partman</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>1_create_versioned_table.sql:</strong> Creates a sample table, then enables version history on it.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Sample: an existing table we want to enable versioning on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  department </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Adding version history to the table,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">first we need to add a time range to the existing table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">This represents &quot;since when&quot; has this row been current.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> sys_period tstzrange </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Creating a time-partitioned version table</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">each row has the range the data was valid for,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">and also the time this version was created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> employees INCLUDING DEFAULTS EXCLUDING INDEXES EXCLUDING CONSTRAINTS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at timestamptz </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Allow efficient querying of partition key and name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Enable automatic partitioning with pg_partman, partitioning every 1 minute.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to partition daily or greater.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> create_parent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;created_at&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;native&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1 minute&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- This connects employees table to employees_history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> versioning_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEFORE </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR EACH ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> versioning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;sys_period&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Configure retention policy for employee history to keep old versions for 10 minutes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to configure retention for 1 year.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 minutes&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        infinite_time_partitions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>custom.conf:</strong> our additions to the Postgres configuration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Enable pg_partman background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shared_preload_libraries = &#x27;pg_partman_bgw&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many seconds between pg_partman background worker runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s more realistic to run every 3600 seconds, or longer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.interval = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Which database pg_partman should target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.dbname = &#x27;postgres&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s best practice to use limited permissions for the background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_partman_bgw.role = &#x27;limitedrole&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This was helpful when I was working on getting the settings working</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log_min_messages = &#x27;DEBUG1&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With those four files in place, we can run Postgres like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it -d --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In a separate shell, I connect into the Postgres container.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">psql postgres://postgres:postgres@localhost:5432</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-demo-of-saving-old-versions">Basic demo of saving old versions<a href="#basic-demo-of-saving-old-versions" class="hash-link" aria-label="Direct link to Basic demo of saving old versions" title="Direct link to Basic demo of saving old versions">​</a></h2><p>After we are set up, we have version history and retention policy configured on the <strong>employees</strong> table, but both the <strong>employees</strong> table and the <strong>employees_history</strong> table are empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Adding data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Helmholtz Watson&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;College of Emotional Engineering&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees</strong> has some data, and <strong>employees_history</strong> is still empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |   salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+-----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     |  10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |   7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson |  18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modifying data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11200</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11400</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11601</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees_history</strong> table has past versions.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 20:23:50.731597+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 20:23:50.734214+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,&quot;2023-09-28 20:23:50.684293+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 20:23:50.684293+00&quot;,&quot;2023-09-28 20:23:50.727283+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 20:23:50.727283+00&quot;,&quot;2023-09-28 20:23:50.731597+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,&quot;2023-09-28 20:23:50.734214+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(4 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="looking-up-past-versions">Looking up past versions<a href="#looking-up-past-versions" class="hash-link" aria-label="Direct link to Looking up past versions" title="Direct link to Looking up past versions">​</a></h2><p>Let&#x27;s say we want to look up Bernard&#x27;s salary at a previous date. We can check the <strong>employees_history</strong> table to find the row where the time range matches our provided timestamp. However, this wouldn&#x27;t find the correct salary if we provide a timestamp that is after the most recent update to Bernard&#x27;s salary, since that row is in the <strong>employees</strong> table.</p><p>We can first create a <a href="https://www.postgresql.org/docs/current/tutorial-views.html" target="_blank" rel="noopener noreferrer">view</a> for this purpose. We only need to do this once, then we can query this view like a table going forward.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VIEW</span><span class="token plain"> employee_history_view </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we can use this query to find Bernard&#x27;s salary at any given date.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 20:23:30+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>@&gt;</code> Is a <em>containment operator</em> and you might recognize it if you have used <a href="https://tembo.io/docs/postgres_guides/postgres-basics/jsonb" target="_blank" rel="noopener noreferrer">JSONB</a>.</p><p>Comparing to the <strong>employees_history</strong> table shown above, it is returning the correct value.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also works to look up the current salary:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If I try to query a salary from the future, it will return the current salary. If I try to query a salary from before Bernard is known in the <strong>employees_history</strong> table, then I get an empty result.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partitioning">Partitioning<a href="#partitioning" class="hash-link" aria-label="Direct link to Partitioning" title="Direct link to Partitioning">​</a></h2><p><strong>What is partitioning?</strong> <a href="https://www.postgresql.org/docs/current/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">Postgres documentation</a> has detailed information on partitioning but just to summarize, partitioning is about splitting what is logically one large table into smaller tables. Typically, this is done for query performance. In our case, <strong>we are partitioning to expire old versions.</strong></p><p>Partitioning tables is something I’m familiar with from Tembo’s work in <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, which is a queueing extension for Postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writes">Writes<a href="#writes" class="hash-link" aria-label="Direct link to Writes" title="Direct link to Writes">​</a></h3><p>We should expect write performance to be slower, since we are writing to two tables for every update.</p><p>I created a new table that does not have versioning enabled to compare write performance.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a table like employees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ...and insert one row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees_write_test </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tstzrange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, I used <code>EXPLAIN ANALYZE</code> to compare the write performance. I ran the query a few times for each.</p><p><strong>Without versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11608</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.654 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.540 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.760 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.079 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>With versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11610</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.423 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=2.430 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 4.783 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.311 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.091 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.979 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.825 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.711 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 5.686 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It&#x27;s more than twice as slow on a single update. That&#x27;s because we have to write to two rows instead of one, there is more data to write (the time ranges), and because there is some additional processing, for instance determining which range to put on each row. In the next section, I also compare how much time it takes to write 100,000 rows in each of these tables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reads">Reads<a href="#reads" class="hash-link" aria-label="Direct link to Reads" title="Direct link to Reads">​</a></h3><p>We created a view which is a union between <strong>employees</strong> and <strong>employees_history</strong>, then we query the view to find an employee&#x27;s salary at a given time.</p><p>To generate some data, let&#x27;s make a procedure to update a salary 100,000 times in a row. The below example uses <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>. By default, PL/pgSQL functions run as a single transaction, so it would only result in a single update to the <strong>employees_history</strong> table. For this reason, I am using a procedure with <code>COMMIT</code> so that each increment will be a separate transaction, this way we also get 100,000 updates to the <strong>employees_history</strong> table. I had to explain that nuance to chatGPT in order for this procedure to be produced properly.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Table name and employee name as inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to get the current salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SELECT salary FROM %I WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> v_salary </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Loop 100 thousand times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Increment the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_salary :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v_salary </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to update the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;UPDATE %I SET salary = $2 WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_salary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Commit the transaction, triggering the versioning procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;employees&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This took 55 seconds to run on my laptop. I also tried it on the table without versioning enabled, at in this case it took 38 seconds. I ran it a couple more times on the table with versioning enabled, so that the versions would be distributed across multiple partitions. Now we have an <strong>employees_history</strong> table that&#x27;s populated with many rows for Bernard.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s run the same type of query command we ran before, with <code>EXPLAIN ANALYZE</code>. I picked a timestamp that will not be found to ensure it&#x27;s as slow as possible.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 15:28:25+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Simplified query plan output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Append</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Bitmap Heap Scan on employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Recheck Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: (sys_period @&gt; &#x27;...&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Heap Blocks: exact=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Bitmap Index Scan on employees_pkey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Index Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 99969</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0035</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 97393</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0036</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 102607</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 12.427 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 262.706 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(47 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query took 263 milliseconds. We notice this query needs to scan all partitions, because we are partitioning by <code>created_at</code>, and querying <code>sys_period</code>. We can improve the speed with indexes.</p><p>If this was a real workload, I doubt that employees&#x27; salaries are being updated so frequently, or at least that&#x27;s been the case in my personal experience. However, if it&#x27;s a big company, then there could be a lot of employees. In that case, it would be best to add an index on the name (or more realistically, employee ID) in the <strong>employees_history</strong> table. Then, withing each partition it will find only rows for the employee being queryed using the index, then it would scan the remaining rows, probably typically zero, one, or two rows, to find the correct salary.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expiring-old-versions">Expiring old versions<a href="#expiring-old-versions" class="hash-link" aria-label="Direct link to Expiring old versions" title="Direct link to Expiring old versions">​</a></h2><p>Earlier in this blog, we configured <strong>pg_partman</strong> to partition in 1 minute increments, to expire partitions that are older than 15 minutes, and to check every 30 seconds. Every 30 seconds, any partition that is older that 15 minutes is deleted by the <strong>pg_partman</strong> background worker.</p><p>With this query, I can check how many rows and the total data size in each partition.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- This query was produced by ChatGPT 4 with the prompt:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- &quot;How can I check the number of rows in each partition of employees_history?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_total_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> total_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_live_tup </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_inherits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class parent </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhparent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class child </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhrelid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to check that old versions are being dropped, I ran the procedure to create a lot of salaray increments several times in a row.</p><p>Then, running the above query, I find an output like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2204 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2205 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2206 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13180928 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     868352 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this output, we can see that we have 1 partition for every minute, and a total of 15 partitions. I have old versions expiring after 10 minutes. I thought it&#x27;s interesting to note that <strong>pg_partman</strong> is preemptively creating partitions for the future, in this case 5 minutes into the future.</p><p>If you refer to the original set up steps, I have configured <code>infinite_time_partitions = true</code>, and this means we will generate partitions even when we are not generating any data for them. I think this is the proper configuration since we also have a retention policy that will drop the old partitions. The concern of making infinite partitions as time passes, even if no data is being generated, is not applicable because old tables are being dropped.</p><p>To confirm data was being deleted, I sampled the above query over time, and we can see the large body of inserts moving up into the oldest available partitions, then falling outside of the retention policy and being deleted.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 131733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2229 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="thanks">Thanks!<a href="#thanks" class="hash-link" aria-label="Direct link to Thanks!" title="Direct link to Thanks!">​</a></h2><p>If you got this far, thank you for reading this! I hope that you are inspired to try out extensions on your own and see what they can do. The next time you have some problem to solve with your data, consider that maybe it could just be handled by a Postgres extension.</p><p>If you want to try extensions without any local setup, you should try Tembo Cloud at <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">cloud.tembo.io</a>.</p><p>Just use Postgres!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/temporal-tables">temporal_tables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pg-partman">pg_partman</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-14T00:00:00.000Z" itemprop="datePublished">September 14, 2023</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Before working for a Postgres company, I had never used extensions.</p><p>Now, I&#x27;m part of a team working to fully automate turning on any extension. I didn&#x27;t find great resources to explain the process of turning on an extension, and why it varies between different extensions.</p><p><strong>I want to share my mental model for the different types of extensions, how to know what type of extension you&#x27;re working with, and how to get it turned on.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="turn-on-an-extension">Turn on an extension<a href="#turn-on-an-extension" class="hash-link" aria-label="Direct link to Turn on an extension" title="Direct link to Turn on an extension">​</a></h2><p><img loading="lazy" alt="one-does-not-simply" src="/assets/images/one-does-not-simply-095857686f6255714eb3f6df0f595d5b.png" width="651" height="383" class="img_ev3q"></p><p><strong>What&#x27;s traditionally involved:</strong></p><ul><li>Find the extension you want</li><li>Figure out how to build it</li><li>Sometimes, installation of dependencies (for example with <em>apt-get</em> or <em>yum</em>)</li><li>Sometimes, installation of other extensions (<em>goto</em> ‘figure out how to build it’)</li><li>Install your extension</li><li>Sometimes, load a library</li><li>Sometimes, provide extension-specific configurations</li><li>Sometimes, run the <code>CREATE EXTENSION</code> command</li></ul><p>Building and installing extensions is well covered by other resources. In this blog, I want to focus on steps to get an extension up and running after it&#x27;s installed, and how <strong>I believe that all extensions fit into four mostly-tidy categories.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a href="#terminology" class="hash-link" aria-label="Direct link to Terminology" title="Direct link to Terminology">​</a></h3><p>Extensions consist of <strong>SQL</strong> and / or <strong>libraries</strong>.</p><p>A <strong>library</strong> simply means compiled code, for example written in <a href="https://www.postgresql.org/docs/current/xfunc-c.html" target="_blank" rel="noopener noreferrer">C</a> or <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">Rust</a>.</p><p><strong><a href="https://www.postgresql.org/docs/current/extend-extensions.html#:~:text=A%20useful%20extension%20to%20PostgreSQL,package%20to%20simplify%20database%20management." target="_blank" rel="noopener noreferrer">SQL objects</a></strong>, let&#x27;s just call it SQL, are extensions of SQL, for example new functions and data types. These are often implemented by a library, but can also be implemented in other ways, for example using a procedural language like <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>.</p><p><strong>Hooks:</strong> A Postgres feature informally called <em>hooks</em> can be used to connect into Postgres&#x27; existing functionality. Hooks allow for overwriting default Postgres functionality, or calling back into an extension&#x27;s code at the appropriate time. For example, one type of hook can modify Postgres start up behavior to launch a background worker, and a different type of hook can be used to redirect queries to a different table.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Sometimes extensions are instead referred to as &#x27;modules&#x27;, but I like to simply refer to everything as an &#x27;extension&#x27;, but feel free to @ me on X to tell me why that&#x27;s wrong (<a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>).</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-the-matrix">Enter the matrix<a href="#enter-the-matrix" class="hash-link" aria-label="Direct link to Enter the matrix" title="Direct link to Enter the matrix">​</a></h2><p><img loading="lazy" alt="im-in-matrix" src="/assets/images/im-in-matrix-dc7fbaffd858e30723ad62d60ebdd4a3.gif" width="498" height="278" class="img_ev3q"></p><p>A big part of what I have been working on is fully automating enabling any extension. In order to do that, we have to understand exactly how extensions vary. We can break it down into a 2x2 matrix by defining two boolean categories.</p><p><strong>Requires <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong> true or false and <strong>requires <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a></strong> true or false:</p><table><thead><tr><th></th><th>Requires <code>CREATE EXTENSION</code></th><th>Does not require <code>CREATE EXTENSION</code></th></tr></thead><tbody><tr><td><strong>Requires <code>LOAD</code></strong></td><td>Extensions that use SQL and their libraries have hooks</td><td>Extensions that do not use SQL, may or may not have hooks</td></tr><tr><td><strong>Does not require <code>LOAD</code></strong></td><td>SQL-only extensions, and SQL + libraries without hooks</td><td>Output plugins</td></tr></tbody></table><p><em>By categorizing an extension into this 2x2 matrix, we can know how to turn it on.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load">LOAD<a href="#load" class="hash-link" aria-label="Direct link to LOAD" title="Direct link to LOAD">​</a></h3><p> <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a> is a command that tells Postgres to <em>load</em> a library, meaning make the code accessible to Postgres by loading the compiled code on disk into memory. If a library has hooks, <strong>performing a load will activate the hooks</strong>.</p><p><strong>Requires <code>LOAD</code>: true</strong> means you have to do one of the following steps to load a library:</p><ul><li><strong><a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong>: using the <code>LOAD</code> command directly loads a library for the current connection only</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=at%20session_preload_libraries%20instead.-,session_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">session_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD for new connections</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=pooling%20is%20used.-,shared_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD at server start, and therefore requires a restart</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Even though code is loaded in other ways during <code>CREATE EXTENSION</code>, that is not <strong>requires <code>LOAD</code>: true</strong> under this definition. I mean that the user must do something other than <code>CREATE EXTENSION</code> to load in libraries. Also, we are conflating <a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=load%20that%20module.-,local_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">local_preload_libraries</a> with <code>session_preload_libraries</code> to simplify things in this blog post.</p></div></div><p>For example, if you installed the extension <a href="https://pgt.dev/extensions/auto_explain" target="_blank" rel="noopener noreferrer">auto explain</a>, then you may have a library file called <code>auto_explain.so</code> in your library directory, which can be found with <a href="https://pgpedia.info/d/dynamic_library_path.html" target="_blank" rel="noopener noreferrer">pg_config --pkglibdir</a>. Libraries are not always named exactly the same as the extension.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] auto_explain.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --pkglibdir) | grep auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_explain.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Auto explain can be loaded into your session like <code>LOAD &#x27;auto_explain&#x27;;</code>. This command will always match exactly the name of the library file, less the file type, in this example <code>.so</code>. With a <a href="https://www.postgresql.org/docs/current/auto-explain.html#AUTO-EXPLAIN-EXAMPLE" target="_blank" rel="noopener noreferrer">couple of configurations</a>, now this extension will automatically log the <a href="https://www.postgresql.org/docs/current/sql-explain.html" target="_blank" rel="noopener noreferrer">EXPLAIN ANALYZE</a> output for long-running queries.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;auto_explain&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, the <code>LOAD</code> command is not typically used directly, and many extensions require you do not load them in this way. Instead, typically the Postgres configuration <a href="https://pgpedia.info/s/shared_preload_libraries.html" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a> is used instead.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;pg_cron&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  pg_cron can only be loaded via shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINT:  Add pg_cron to the shared_preload_libraries configuration variable in postgresql.conf.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The best reason to use <code>LOAD</code> directly is for debugging. It can be nice to <code>LOAD</code> on-demand while troubleshooting.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><strong>What to do when an extension requires load:</strong></p><p>Extensions that <strong>requires <code>LOAD</code>: true</strong> can always be configured in <code>shared_preload_libraries</code>, but this configuration requires a restart to take effect. Some extensions can be loaded without a restart using <code>LOAD</code> directly, but in this case it&#x27;s usually better to use the <code>session_preload_libraries</code> configuration, and <a href="https://pgpedia.info/p/pg_reload_conf.html" target="_blank" rel="noopener noreferrer">reload the Postgres configuration</a> with <code>SELECT pg_reload_conf();</code>. You should run <code>LOAD</code> directly when you are intentionally loading for only the current connection.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-extension">CREATE EXTENSION<a href="#create-extension" class="hash-link" aria-label="Direct link to CREATE EXTENSION" title="Direct link to CREATE EXTENSION">​</a></h3><p>When you run <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a>, this basically just runs an extension&#x27;s SQL script. The script will typically create new SQL objects such as functions, data types, operators and so on.</p><p><code>CREATE EXTENSION</code> looks at the extension&#x27;s <strong>control file</strong>, which is installed to the <code>extension</code> directory of <strong>sharedir</strong>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: &quot;/var/lib/postgresql/data/tembo/15/lib&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using sharedir: &quot;/var/lib/postgresql/data/tembo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] pg_jsonschema.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema--0.1.4.sql =&gt; /var/lib/postgresql/data/tembo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema.control =&gt; /var/lib/postgresql/data/tembo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>sharedir</strong> can be located with <code>pg_config --sharedir</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$  ls $(pg_config --pkglibdir) | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --sharedir)/extension | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema--0.1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The information in a control file is used to determine what start up or upgrade scripts to run. We&#x27;ll cover upgrades in-depth in a future blog, so let&#x27;s focus on first-time enabling. For example, in the above installation output, we notice a file <code>pg_jsonschema--0.1.4.sql</code>. Postgres knows to run this because the name of the control file matches the name of the script suffixed by the <code>default_version</code> defined in the control file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat $(pg_config --sharedir)/extension/pg_jsonschema.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;JSON schema validation on json and jsonb data types&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.1.4&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/pg_jsonschema&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running <code>CREATE EXTENSION</code>, the extension name always matches exactly the name of a control file, less the <code>.control</code> file type.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I mentioned that a start up script creates new SQL, including new functions. For example in the case of <a href="https://pgt.dev/extensions/pg_jsonschema" target="_blank" rel="noopener noreferrer">pg_jsonschema</a>, the start up script <code>pg_jsonschema--0.1.4.sql</code> includes the following SQL to create a new function called <code>jsonb_matches_schema</code>. Even though we have a library file, we don&#x27;t need <code>LOAD</code> because <code>CREATE FUNCTION</code> is another way to load code from a file. This is an example of <strong>requires <code>LOAD</code>: false</strong>, <strong>requires <code>CREATE EXTENSION</code>: true</strong>.</p><p><a href="https://www.postgresql.org/docs/current/sql-createfunction.html" target="_blank" rel="noopener noreferrer">CREATE FUNCTION ... AS &#x27;obj_file&#x27; documentation</a></p><blockquote><p>obj_file is the name of the shared library file containing the compiled <!-- -->[code]</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE FUNCTION &quot;jsonb_matches_schema&quot;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;schema&quot; json,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;instance&quot; jsonb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) RETURNS bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMMUTABLE STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LANGUAGE c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS &#x27;MODULE_PATHNAME&#x27;, &#x27;jsonb_matches_schema_wrapper&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>You can always know whether or not an extension requires <code>CREATE EXTENSION</code> by the presence of a control file in <code>$(pg_config --sharedir)/extension</code></p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooks-that-require-a-restart">Hooks that require a restart<a href="#hooks-that-require-a-restart" class="hash-link" aria-label="Direct link to Hooks that require a restart" title="Direct link to Hooks that require a restart">​</a></h3><p>An extension is in the category <strong>requires <code>CREATE EXTENSION</code>: true</strong> and <strong>requires <code>LOAD</code>: true</strong> if the extension has libraries that use hooks which require a restart and it has a control file.</p><p>You will be able to identify this is the case when the extension&#x27;s documentation mentions both <code>CREATE EXTENSION</code> and <code>shared_preload_libraries</code>. Sometimes an error message or hint is provided if you run <code>CREATE EXTENSION</code> before loaded the library, or if you try to run <code>LOAD</code> directly, but you can&#x27;t count on that.</p><p>For example, in the case of both <code>pg_cron</code> and <code>pg_partman</code>, there are a background workers. These are examples of extensions using hooks in the start up process of Postgres. So, in both of these cases the user is expected to configure <code>shared_preload_libraries</code> to start the background worker, then run <code>CREATE EXTENSION</code> on a cluster where that background worker is already running.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-is-needed-when-there-isnt-a-control-file">LOAD is needed when there isn&#x27;t a control file<a href="#load-is-needed-when-there-isnt-a-control-file" class="hash-link" aria-label="Direct link to LOAD is needed when there isn&#x27;t a control file" title="Direct link to LOAD is needed when there isn&#x27;t a control file">​</a></h3><p>In the case of auto_explain, it uses hooks that do not require a restart. In this case, there is no control file and no extra SQL objects to be created. So <code>LOAD</code> is required simply because we have to load it into memory somehow. To demonstrate, it is technically possible to make a control file for auto_explain to allow for <code>CREATE EXTENSION</code> behavior instead of <code>LOAD</code>:</p><p><strong>auto_explain.control:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;auto explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.0.1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/auto_explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>auto_explain--0.0.1.sql</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOAD &#x27;auto_explain&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In practice, do not use <code>LOAD</code> in an extension start up script to activate hooks. <code>LOAD</code> is only applicable for the current connection.</p></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION auto_explain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name       | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> auto_explain    | 0.0.1   | public     | auto explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql         | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_min_duration = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_analyze = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running the above, now my subsequent queries have their <code>EXPLAIN ANALYZE</code> logged.</p><p>So, if that could work, <strong>why not just have control files for all extensions?</strong></p><p><strong>Having a control file requires version upgrade handling.</strong></p><p>When you have a control file, you also have to write upgrade scripts for every new version. In the case of pg_cron, we can find all these files in <strong>sharedir</strong>. When enabling version 1.5, it will run <code>pg_cron--1.0.sql</code>, then each migration script up to 1.5.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0--1.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.1--1.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.2--1.3.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.3--1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4-1--1.5.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4--1.4-1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since that&#x27;s not really applicable on auto_explain, because it&#x27;s just logging outputs and there is nothing to migrate or handle between versions, it&#x27;s just cleaner to not have a control file. Upgrading auto_explain only involves replacing the library, then loading it again.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Upgrade logic is not applicable for extensions that do not require <code>CREATE EXTENSION</code>. These cases just involve re-loading a new version of the library.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-dont-load-hooks-during-create-extension">You don&#x27;t load hooks during CREATE EXTENSION<a href="#you-dont-load-hooks-during-create-extension" class="hash-link" aria-label="Direct link to You don&#x27;t load hooks during CREATE EXTENSION" title="Direct link to You don&#x27;t load hooks during CREATE EXTENSION">​</a></h3><p>It made sense to me for activating hooks that require a restart they have to be configured in <code>shared_preload_libraries</code>. But for extensions that do not require a restart, it&#x27;s not obvious why the hooks can&#x27;t just be loaded during the <code>CREATE EXTENSION</code> start up script like I just demonstrated is possible with auto_explain.</p><p><strong>Even though it&#x27;s technically possible to <code>LOAD</code> hooks during <code>CREATE EXTENSION</code>, it&#x27;s a bad idea.</strong></p><p>First of all, when using the <code>LOAD</code> command directly, it&#x27;s only applicable to the current connection. So, in the above example with auto explain, the queries are only logged in the connection where I ran <code>CREATE EXTENSION</code>. To apply to all connections without a restart, it would need to go into <code>session_preload_libraries</code>. It is technically possible to do that inside of <code>CREATE EXTENSION</code> by doing <code>ALTER SYSTEM SET session_preload_libraries</code> then <code>SELECT pg_reload_conf()</code> in your start up script, but it is not a good approach for <code>CREATE EXTENSION</code> to automatically perform a configuration update. First of all it would confuse a user to change a config on the fly, and secondly there is currently no concept to automatically merge multi-value, comma-separated configurations like <code>session_preload_libraries</code>.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The 2x2 matrix makes it easier to understand how to enable an extension.</p><p>Just ask yourself &quot;do I need to run <code>CREATE EXTENSION</code>?&quot; determined by presence of a control file, and &quot;do I need to do a <code>LOAD</code>?&quot; determined by any mention of <code>LOAD</code>, <code>shared_preload_libraries</code>, or <code>session_preload_libraries</code> in the extension&#x27;s documentation or an error message.</p><p>In all cases of needing a <code>LOAD</code>, you can get away with setting it in <code>shared_preload_libraries</code>. You can optimize to avoid restarts in some cases.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="output-plugins">Output plugins<a href="#output-plugins" class="hash-link" aria-label="Direct link to Output plugins" title="Direct link to Output plugins">​</a></h3><p>There are some extensions, for example <a href="https://pgt.dev/extensions/wal2json" target="_blank" rel="noopener noreferrer">wal2json</a> that require neither <code>CREATE EXTENSION</code> or <code>LOAD</code>. In all known cases so far, these are <a href="https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html" target="_blank" rel="noopener noreferrer">output plugins</a>. I think it&#x27;s more of a stretch to call these &#x27;extensions&#x27;, but since they provide additional functionality to Postgres, that counts in my book.</p><p>In the case of output plugins, the library is loaded when a replication slot is created:</p><p><a href="https://www.postgresql.org/docs/current/logicaldecoding-example.html" target="_blank" rel="noopener noreferrer">Postgresql documentation</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM pg_create_logical_replication_slot(&#x27;regression_slot&#x27;, &#x27;test_decoding&#x27;, false, true);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-extensions">Installing extensions<a href="#installing-extensions" class="hash-link" aria-label="Direct link to Installing extensions" title="Direct link to Installing extensions">​</a></h2><p>Some of the above examples use the free and open source <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk project</a> that Tembo created, which allows us to skip the build process. It also installs extension dependencies, and provides metadata about other dependencies. When I&#x27;m trying out extensions, I am starting from one of Tembo’s container images to handle the system dependencies installation.</p><p><strong>I wrote <a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">this guide</a> for trying out extensions locally</strong>. If you have any issues just reach out on our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20v3m8pwz-pPjeFaWSM~Bt3KUqDXff2A" target="_blank" rel="noopener noreferrer">community Slack channel</a> and we can help.</p><p><em>Perhaps it&#x27;s not so bad after all...</em></p><p><img loading="lazy" alt="files-in-computer" src="/assets/images/files-in-computer-5a613d91e5bd9f281c1b4984e6e20976.gif" width="500" height="213" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automate-everything">Automate everything<a href="#automate-everything" class="hash-link" aria-label="Direct link to Automate everything" title="Direct link to Automate everything">​</a></h2><p>We want to make it possible to automatically install and turn on any Postgres extension. For this reason, we are seeking to qualify all known extensions by these two dimensions: requires <code>CREATE EXTENSION</code> true or false, and requires <code>LOAD</code> true or false.</p><p>To enable the community, that metadata is being published on <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a>. On <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we leverage that information to automatically enable extensions. Currently, we&#x27;ve got this working for over 150 extensions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dear-experts-tell-me-how-im-wrong-seriously">Dear experts, tell me how I&#x27;m wrong (seriously!)<a href="#dear-experts-tell-me-how-im-wrong-seriously" class="hash-link" aria-label="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)" title="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)">​</a></h2><p>I&#x27;m serious that I want you to tell me where this is incorrect! If you&#x27;re a Postgres extensions expert, or maybe just know a thing or two about extensions that seems to conflict with something in this blog, please reach out on X <a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a> and let me know. Even if it&#x27;s just minor correction or subjective information, I&#x27;d love to hear from you. I also want to hear if there is an easier mental model than this. I hope this blog can serve as a minimal yet comprehensive explanation of what it takes to get extensions turned on.</p><p>Another way to contribute is to <strong>click the &quot;Edit this page&quot; link below</strong>, and suggest changes. I will happily accept improvements to this blog.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://tembo.breezy.hr/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trunk<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/docs">Docs</a><span class="footer__link-separator">·</span><a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://www.linkedin.com/company/tembo-inc/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tembo. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef584dc9.js"></script>
<script src="/assets/js/main.75ceccb8.js"></script>
</body>
</html>