<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">6 posts tagged with &quot;extensions&quot; | Tembo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://tembo.io/img/social-card.png"><meta data-rh="true" property="og:url" content="https://tembo.io/blog/tags/extensions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="6 posts tagged with &quot;extensions&quot; | Tembo"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tembo.io/blog/tags/extensions"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/extensions" hreflang="en"><link data-rh="true" rel="alternate" href="https://tembo.io/blog/tags/extensions" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tembo RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tembo Atom Feed">





<script id="hs-script-loader" src="//js.hs-scripts.com/23590420.js"></script>
<link rel="preconnect" href="https://cdn.segment.io">
<script>!function(){var e=window.analytics=window.analytics||[];if(!e.initialize)if(e.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{e.invoked=!0,e.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],e.factory=function(t){return function(){if(window.analytics.initialized)return window.analytics[t].apply(window.analytics,arguments);var n=Array.prototype.slice.call(arguments);return n.unshift(t),e.push(n),e}};for(var t=0;t<e.methods.length;t++){var n=e.methods[t];e[n]=e.factory(n)}e.load=function(t,n){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(a,i),e._loadOptions=n},e._writeKey="YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE",e.SNIPPET_VERSION="4.16.1",e.load("YT4AfD2TuYaN7DiGR20tAnstYP1ujjyE"),e.page()}}()</script>
<link key="docusaurus-plugin-plausible-preconnect" rel="preconnect" href="https://plausible.io">
<script key="docusaurus-plugin-plausible-script" async defer="defer" data-domain="tembo.io" src="https://plausible.io/js/plausible.js"></script>
<script key="docusaurus-plugin-plausible-custom-events">window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>

<script>prefinery=window.prefinery||function(){(window.prefinery.q=window.prefinery.q||[]).push(arguments)}</script>
<script src="https://widget.prefinery.com/widget/v2/yisnnyak.js" defer="defer"></script><link rel="stylesheet" href="/assets/css/styles.92bb70b2.css">
<link rel="preload" href="/assets/js/runtime~main.ef584dc9.js" as="script">
<link rel="preload" href="/assets/js/main.75ceccb8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/title-logo.svg" alt="Tembo Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" href="/docs">Docs</a><a class="navbar__item navbar__link" target="_blank" href="/blog">Blog</a><a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Tembo Cloud<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/tembo-io/tembo-stacks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep8">Hacking Postgres, Ep. 8: Philippe Noël</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-self-regulating-queue">PGMQ: Lightweight Message Queue on Postgres with No Background Worker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep7">Hacking Postgres Ep. 7: Burak Yucesoy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator-apps">Application Services: Helping Postgres Do More, Faster</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep6">Hacking Postgres, Ep. 6: Regina Obe and Paul Ramsey</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-operator">Tembo Operator: A Rust-based Kubernetes Operator for Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/anon-dump">Anonymized dump of your Postgres data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep5">Hacking Postgres, Ep. 5: Alexander Korotkov</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep4">Hacking Postgres, Ep. 4: Pavlo Golub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep3">Hacking Postgres, Ep. 3: Eric Ridge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep2">Hacking Postgres, Ep. 2: Adam Hendel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hacking-postgres-ep1">Hacking Postgres Ep. 1: Marco Slot</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-terraform-provider-for-tembo">Introducing Terraform Provider for Tembo</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/postgres-16">Postgres 16: The exciting and the unnoticed</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-stacks-intro">Tembo Stacks: Making Postgres the Everything Database</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/optimizing-postgres-auto-vacuum">Optimizing Postgres&#x27;s Autovacuum for High-Churn Tables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pgmq-with-python">Using pgmq with Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pg-later">Introducing pg_later: Asynchronous Queries for Postgres, Inspired by Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pgmq">Introducing PGMQ: Simple Message Queues built on Postgres</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tembo-manifesto">Tembo Manifesto</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-tembo">Introducing Tembo</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>6 posts tagged with &quot;extensions&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/anon-dump">Anonymized dump of your Postgres data</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-24T00:00:00.000Z" itemprop="datePublished">October 24, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Someone on X wanted to know how to get an anonymous dump of Postgres data, but doesn&#x27;t want to install an extension in their production DB. I want to show how you can start a local database, dump the production data there, then do an anonymized dump from that without too much hassle.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p>Dockerfile:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Install extensions from Trunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> pgcrypto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> postgresql_anonymizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Setting samples to use for anonymization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN </span><span class="token builtin class-name">cd</span><span class="token plain"> /var/lib/postgresql/data/tembo/extension/anon </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/lorem_ipsum.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifiers_category.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifier_fr_FR.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/identifier_en_US.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/address.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/city.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/company.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/country.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/email.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/first_name.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/iban.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/last_name.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/postcode.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/siret.csv </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://gitlab.com/dalibo/postgresql_anonymizer/-/raw/master/data/lorem_ipsum.csv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Build and run it like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> --force local-tembo </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally in more detail.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dump-the-data-into-your-local-db">Dump the data into your local DB<a href="#dump-the-data-into-your-local-db" class="hash-link" aria-label="Direct link to Dump the data into your local DB" title="Direct link to Dump the data into your local DB">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_dump </span><span class="token string" style="color:#e3116c">&#x27;your-connection-string-here&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> psql </span><span class="token string" style="color:#e3116c">&#x27;postgres://postgres:postgres@localhost:5432&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="anonymize-the-local-db">Anonymize the local DB<a href="#anonymize-the-local-db" class="hash-link" aria-label="Direct link to Anonymize the local DB" title="Direct link to Anonymize the local DB">​</a></h2><p>Initialize the extension:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> session_preload_libraries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;anon&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;anon&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> anon </span><span class="token keyword" style="color:#00009f">CASCADE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> anon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For example, I have a table called &quot;extension_owners&quot;, and I would like to anonymize the user_name column:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select extension_id,user_name from extension_owners limit 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> extension_id |      user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------+---------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           26 | coredb-service-user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I configured anonymization on that column like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SECURITY LABEL </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> anon </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> extension_owners</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MASKED WITH FUNCTION anon.lorem_ipsum( words := 1 )&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are a lot of other options for anonymizing data, and you can even write your own functions. More information in <a href="https://gitlab.com/dalibo/postgresql_anonymizer/-/blob/master/docs/masking_functions.md?ref_type=heads" target="_blank" rel="noopener noreferrer">these docs</a>.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>This next step replaces data in the local database.</p></div></div><p>Since we are working on a local copy of the data, we can just use this function to replace anonymized columns in-place.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT anon.anonymize_database();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see now this column has been anonymized.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select user_name from extension_owners limit 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> user_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> They</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Cell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Parent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Republican</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> With</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Between</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(10 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can do further modification from here, for example masking and replacing additional columns, formatting columns, etc.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="done">Done!<a href="#done" class="hash-link" aria-label="Direct link to Done!" title="Direct link to Done!">​</a></h2><p>Now you have an anonymized database locally. From here, you can pg_dump to a file, or do something else!</p><p>If you think this kind of thing is cool, follow me on X (<a href="https://x.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>) for more content. At Tembo, we are all about Postgres extensions. You can try out extensions on <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a> for free.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgresql-anonymizer">postgresql_anonymizer</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/RAG-cd4c28ec5c956f11e8de9ccf5bde2db2.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/pgvector-and-embedding-solutions-with-postgres">Unleashing the power of vector embeddings with PostgreSQL</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-18T00:00:00.000Z" itemprop="datePublished">October 18, 2023</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/binidxaba.png" alt="Binidxaba"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Binidxaba</span></a></div><small class="avatar__subtitle" itemprop="description">Community contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>Language models are like the wizards of the digital world, conjuring up text that sounds eerily human. These marvels of artificial intelligence, such as GPT-3.5, are sophisticated algorithms that have been trained on vast swathes of text from the internet. They can understand context, generate coherent paragraphs, translate languages, and even assist in tasks like writing, chatbots, and more. Think of them as your trusty digital scribe, ready to assist with their textual sorcery whenever you summon them.</em></p><p>If you have used ChatGPT in the past, you probably were able to suspect that the previous paragraph was generated using it. And that&#x27;s true. See the prompt <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">here</a>.</p><p>From the example above, you can witness the eloquence LLMs are capable of. Some people have been shocked so much that they became convinced that these <a href="https://www.scientificamerican.com/article/google-engineer-claims-ai-chatbot-is-sentient-why-that-matters/" target="_blank" rel="noopener noreferrer">models were sentient</a>. However, in the end, they are nothing but a large, complex series of <a href="https://www.youtube.com/watch?v=bCz4OMemCcA" target="_blank" rel="noopener noreferrer">matrix and vector operations</a>. These matrices and vectors have been trained to represent the semantic meaning of words.</p><p>In today&#x27;s post, we will explore these meaning vectors and how they are related to Postgres. In particular, we are going to play with sentence transformers, vectors, and similarity search. All of that with the help of the pgvector Postgres extension.</p><p>Let’s go!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="from-words-to-vectors">From words to vectors<a href="#from-words-to-vectors" class="hash-link" aria-label="Direct link to From words to vectors" title="Direct link to From words to vectors">​</a></h2><p>Like we said, a vector can represent many things, for example, the position of a character in a 3D video game, the position of a pixel in your screen, the force applied to an object, a color in the RGB space, or even the meaning of a word…</p><p>Word embedding refers to the technique by which words can be represented as vectors. These days, the embeddings offered by <a href="https://openai.com/blog/new-and-improved-embedding-model" target="_blank" rel="noopener noreferrer">OpenAI</a> are very popular. However, other alternatives exist, like <a href="https://arxiv.org/abs/1301.3781" target="_blank" rel="noopener noreferrer">word2vect</a>, <a href="https://aclanthology.org/D14-1162.pdf" target="_blank" rel="noopener noreferrer">Glove</a>, <a href="https://fasttext.cc/docs/en/support.html" target="_blank" rel="noopener noreferrer">FastText</a>, and <a href="https://arxiv.org/abs/1802.05365v2" target="_blank" rel="noopener noreferrer">ELMo</a>.</p><p>Similarly, entire sentences can be represented as vectors using <a href="https://platform.openai.com/docs/guides/embeddings/what-are-embeddings" target="_blank" rel="noopener noreferrer">OpenAI embeddings</a> or <a href="https://sbert.net/" target="_blank" rel="noopener noreferrer">SentenceTransformers</a>, for example.</p><p>These models can be accessed through libraries for different languages. The following Python snippet shows how to obtain the vector embeddings of three sentences using SentenceTransformer:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sentence_transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SentenceTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SentenceTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentences </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;SentenceTransformers is a Python framework for state-of-the-art sentence, text and image embeddings.&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;Pgvector is postgres extension for vector similarity search.&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;Tembo will help you say goodby to database sprawl, and hello to Postgres.&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence_embeddings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Sentence:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Embedding:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> embedding</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The code used in this blog post can be found in <a href="https://gist.github.com/binidxaba/2eb3bff573c6be700e4391d650a302db" target="_blank" rel="noopener noreferrer">this gist</a>.</p></div></div><p>The mind-blowing part is that words and sentences with a similar meaning will have similar vectors. This characteristic is the basis of a search technique called similarity search, where we simply find the nearest embedding vectors to find texts that are similar to our query.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="postgres-meets-language-models">Postgres meets Language Models<a href="#postgres-meets-language-models" class="hash-link" aria-label="Direct link to Postgres meets Language Models" title="Direct link to Postgres meets Language Models">​</a></h2><p>Models are great at generating content that seems credible, as shown earlier. However, you may have experienced cases where ChatGPT hallucinates answers or delivers out-of-date information. That&#x27;s because LLMs are <strong>pre-trained</strong> using <strong>general data</strong>. And, because of that, creating a chatbot based only on the pre-trained data wouldn&#x27;t be helpful for your customers, for instance.</p><p>The concept of <a href="https://arxiv.org/abs/2005.11401" target="_blank" rel="noopener noreferrer">RAG (Retrieval-Augmented Generation)</a> acknowledges this limitation. </p><p>One way of overcoming these problems is to store your company&#x27;s knowledge base in a database.... preferably in a vector database. You could then query related content and feed that content to the LLM of your preference.</p><p><img loading="lazy" alt="RAG with pgvector" src="/assets/images/RAG-cd4c28ec5c956f11e8de9ccf5bde2db2.png" width="450" height="288" class="img_ev3q"></p><p>Specialized vector databases include <a href="https://milvus.io/" target="_blank" rel="noopener noreferrer">Milvus</a>, <a href="https://qdrant.tech/" target="_blank" rel="noopener noreferrer">Qdrant</a>, <a href="https://weaviate.io/" target="_blank" rel="noopener noreferrer">Weaviate</a>, and <a href="https://www.pinecone.io/" target="_blank" rel="noopener noreferrer">Pinecone</a>. However, you probably want to <a href="https://www.amazingcto.com/postgres-for-everything/" target="_blank" rel="noopener noreferrer">stick to your Postgres database</a>. </p><p>Postgres is not in itself a vector database, but extensions can come to the rescue one more time... This time with <a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer"><strong>pgvector</strong></a>.</p><p>Let&#x27;s use it and explore how we would query related content from a Postgres database.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvector-postgres-as-a-vector-database">pgvector: Postgres as a vector database<a href="#pgvector-postgres-as-a-vector-database" class="hash-link" aria-label="Direct link to pgvector: Postgres as a vector database" title="Direct link to pgvector: Postgres as a vector database">​</a></h2><p><a href="https://github.com/pgvector/pgvector" target="_blank" rel="noopener noreferrer">pgvector</a> is a Postgres extension that helps work with vectors and stores them in your postgres database. It offers functions for calculating the distance between vectors and for similarity search.</p><p>For the following demo, I converted all of Tembo’s blogs into document vectors using the following Python script that uses the <a href="https://python.langchain.com" target="_blank" rel="noopener noreferrer">langchain framework</a>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">document_loaders </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TextLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text_splitter </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RecursiveCharacterTextSplitter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vectorstores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pgvector </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> PGVector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONNECTION_STRING </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;postgresql+psycopg2://postgres:password@localhost:5432/vector_db&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COLLECTION_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_collection&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text_splitter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RecursiveCharacterTextSplitter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chunk_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chunk_overlap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./corpus&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin">file</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;./corpus/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">file</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Loading: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">file_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TextLoader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    document </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> loader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    texts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> text_splitter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">document</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sentence_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_content </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> texts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PGVector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            embedding</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            documents</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">texts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            collection_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">COLLECTION_NAME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection_string</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">CONNECTION_STRING</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It basically loads each document and then inserts them into Postgres using the <a href="https://python.langchain.com/docs/integrations/vectorstores/pgvector" target="_blank" rel="noopener noreferrer"><code>PGVector</code> class</a>. As a result, in my Postgres database called <code>vector_db</code>, I got two tables:</p><p><img loading="lazy" alt="Show tables" src="/assets/images/table-list-3c5b0f371564f4dd0af86bcf7d14e209.png" width="434" height="177" class="img_ev3q"></p><ul><li><code>langchain_pg_collection</code>: contains information about all collections.</li><li><code>langchain_pg_embedding</code>: contains all the resulting vectors.</li></ul><p>The following picture shows part of the contents of (2):</p><p><img loading="lazy" alt="Show vectors" src="/assets/images/select-vectors-8523ebc09c243b1bc0987332c2225b8b.png" width="1470" height="465" class="img_ev3q"></p><p>The resulting vectors have <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2" target="_blank" rel="noopener noreferrer">384 dimensions</a>.  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="are-these-sentences-similar">Are these sentences similar?<a href="#are-these-sentences-similar" class="hash-link" aria-label="Direct link to Are these sentences similar?" title="Direct link to Are these sentences similar?">​</a></h2><p>Let’s now play with these vectors.</p><p>Using pgvector we can search content that is similar to a query. For example, we can find content related to <code>postgres 16</code>.</p><p>First, we can obtain a vector that represents a query:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embeddings </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HuggingFaceEmbeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HuggingFaceEmbeddings</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;all-MiniLM-L6-v2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> embeddings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“What </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> new </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> postgres </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then we can search vectors stored in the database that are similar to the query vector. The tool for that is <a href="https://en.wikipedia.org/wiki/Cosine_similarity" target="_blank" rel="noopener noreferrer"><code>cosine distance</code></a>, which in pgvector is represented with the <code>&lt;=&gt;</code> operator:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> document</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding </span><span class="token operator" style="color:#393A34">&lt;=&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;[&lt;your_vector_here&gt;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> langchain_pg_embedding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> cosine_similarity </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above query retrieves vectors/chunks of text ordered by how close they are (in terms of <code>cosine distance</code>) to the query vector. In my case, the most similar chunk of text was:</p><blockquote><p>In case you missed it, Postgres 16 came out last week - and this year it
arrived earlier than the last few years. There are many features that
I’ve been looking forward to for the last few months and I’m excited to
see them get into the hands of users. Before we dive into the specific
features of this release, let’s discuss what a Postgres major release
actually means.</p><p>[postgres-16]</p><p>Postgres Releases</p><p>The PostgreSQL Global Development Group releases a new major version
every year with new features.</p><p>In addition, Postgres releases minor versions of each major release
every 3 months or so with bug fixes and security fixes. No new features
are released in minor versions, and that’s what makes major version
releases so exciting as it’s the culmination of about a year’s worth of
development work on the project.</p></blockquote><p>Which is an excerpt from <a href="https://tembo.io/blog/postgres-16" target="_blank" rel="noopener noreferrer">Postgres 16: The exciting and the unnoticed</a>.</p><p>Let us look at what Postgres is doing behind the scenes, using <code>explain analyze</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit  (cost=28.07..28.08 rows=2 width=641) (actual time=1.069..1.071 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Sort  (cost=28.07..28.53 rows=181 width=641) (actual time=1.067..1.068 rows=2 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Key: ((embedding &lt;=&gt; &#x27;[&lt;your_vector&gt;]&#x27;::vector))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Sort Method: top-N heapsort  Memory: 28kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         -&gt;  Seq Scan on langchain_pg_embedding  (cost=0.00..26.26 rows=181 width=641) (actual time=0.036..0.953 rows=181 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.079 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.093 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(7 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can observe that Postgres is sequentially scanning all rows. Then it computes the <code>cosine distance</code> for all those rows and sorts them. Finally,  it takes the first two rows.</p><p>The <code>sequential scan</code> could be avoided if we had an index. Indeed, we can create one thanks to pgvector, for example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> langchain_pg_embedding </span><span class="token keyword" style="color:#00009f">alter</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">column</span><span class="token plain"> embedding </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> vector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">384</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> langchain_pg_embedding  </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> ivfflat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">embedding vector_cosine_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lists </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Limit  (cost=5.01..5.11 rows=2 width=641) (actual time=0.175..0.179 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -&gt;  Index Scan using langchain_pg_embedding_embedding_idx2 on langchain_pg_embedding  (cost=5.01..13.49 rows=181 width=641) (actual time=0.172..0.175 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Order By: (embedding &lt;=&gt; &#x27;[&lt;your_vector&gt;]&#x27;::vector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.154 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.224 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One thing to keep in mind is that these indexes are used for <code>approximate nearest neighbor search</code>. We’ll explore what that means in a future blog post. <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">Let us know</a> if that would be interesting for you.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pgvectorize">Pgvector(ize)?<a href="#pgvectorize" class="hash-link" aria-label="Direct link to Pgvector(ize)?" title="Direct link to Pgvector(ize)?">​</a></h2><p>Ok, at this point you should now have a sense of what pgvector is, and how to use it together with Python. However, wouldn&#x27;t it be great if the vectorizing step could happen all within Postgres?</p><p><a href="https://github.com/tembo-io/pg_vectorize" target="_blank" rel="noopener noreferrer"><strong>Pg_vectorize</strong></a> is an extension being developed by <strong>Tembo</strong> that intends to streamline the process of generating vectors from the data in your Postgres tables. It uses a background worker to generate and update the embeddings in batches every <em>N</em> seconds. Also, if you need to find similar vectors, the extension can do that. All within Postgres. Isn&#x27;t that a cool idea? </p><p>I invite you to check out the repository and stay tuned.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="to-wrap-up">To wrap up...<a href="#to-wrap-up" class="hash-link" aria-label="Direct link to To wrap up..." title="Direct link to To wrap up...">​</a></h2><p>In this post, we briefly discussed the concept of <code>embeddings</code>, why they are important, and how they can be generated using one of the multiple available libraries. We also explored how to store and query the resulting vectors using Postgres and the pgvector extension.</p><p>These concepts are relevant to leveraging a knowledge base in conjunction with LLMs in an emerging technique called RAG. Of course, when implementing a real-life solution, <a href="ttps://medium.com/@neum_ai/retrieval-augmented-generation-at-scale-building-a-distributed-system-for-synchronizing-and-eaa29162521" target="_blank" rel="noopener noreferrer">more factors need to be considered</a>, and this post was just an introduction.</p><p>I invite everyone to try out pgvector (e.g. using the scripts in this post), and the different operations that it offers. Also, can you think of other uses of pgvector? Let us know your thoughts in <a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer">@tembo_io</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h2><p><em>The first paragraph in this blog post was generated using ChatGPT. <a href="https://chat.openai.com/share/9fab8ac9-6e34-481d-a281-db2f00b0f7f5" target="_blank" rel="noopener noreferrer">Here’s the prompt</a></em></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/embedding">embedding</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/vector">vector</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgvector">pgvector</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/clerk-flowchart-ecda66b28a07b45684d4932e0aac931a.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/clerk-fdw">Unlocking value from your Clerk User Management platform with Postgres</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Jayko001" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/Jayko001.png" alt="Jay Kothari"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Jayko001" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jay Kothari</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineering Intern</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The maxim of building a product is to know your user. However, any company big or small will often have user data spread around in various systems. A data platform team will often deploy various pipelines that can sync data from various sources into a data warehouse. As an alternative, Postgres supports the concept of a Foreign Data Wrapper. Let’s dive into what this is and how it can help us.</p><p>In this blog, we&#x27;ll look at <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a>—a tool that bridges the gap between <a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a>, a leading user management solution, and your very own Postgres Database. By the end, you&#x27;ll discover how this integration can empower you to make data-driven decisions, optimize your pricing strategy, and refine your market approach. Let&#x27;s get started!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-a-foreign-data-wrapper">What’s a Foreign Data Wrapper?<a href="#whats-a-foreign-data-wrapper" class="hash-link" aria-label="Direct link to What’s a Foreign Data Wrapper?" title="Direct link to What’s a Foreign Data Wrapper?">​</a></h2><p>A foreign data wrapper is an extension available in PostgreSQL that allows you to bring ‘foreign data’ (i.e. data in a different Postgres DB, a different database like DB2, or even a different kind of data source, like an API) and query it the same way you would query a normal Postgres table. They are particularly useful when your data may be segregated into different databases, but are still related in ways that you could gather some useful information from them. In building a foreign data wrapper for Clerk.com, we have used <a href="https://supabase.github.io/wrappers/" target="_blank" rel="noopener noreferrer">Supabase Wrappers</a> that make it easier to build Foreign Data Wrappers and interact with third-party data using SQL.</p><p>If you should take something away from this blog, is that Postgres’ Foreign Data Wrappers are a great tool to build an analytics platform based on Postgres. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-clerk">What’s Clerk?<a href="#whats-clerk" class="hash-link" aria-label="Direct link to What’s Clerk?" title="Direct link to What’s Clerk?">​</a></h2><p><a href="https://clerk.com/" target="_blank" rel="noopener noreferrer">Clerk</a> is a user management tool. With Clerk, users experience a seamless sign-up and sign-in flow, whether they prefer using email, SMS, or even their favorite social media accounts. Its versatility and developer-friendly APIs make it an excellent choice for us at Tembo for both efficiency and a superior user experience.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-power-of-integration">The Power of Integration<a href="#the-power-of-integration" class="hash-link" aria-label="Direct link to The Power of Integration" title="Direct link to The Power of Integration">​</a></h2><p>Being able to access data from a User Management Tool like Clerk as part of your data platform is especially useful because it enables you to have a 360-degree view of the user experience on your product, without having to set up any complex data export pipelines from Clerk into other systems.</p><p>In fact, we built <code>clerk_fdw</code> at Tembo to address needs in our internal analytics pipeline . Here are some of the ways we are using it:</p><ul><li>Run advanced analytics that combine internal data with user data from Clerk.</li><li>Understand user interaction patterns with our product.</li><li>Identify and engage with top users.</li></ul><p><img loading="lazy" alt="clerk" src="/assets/images/clerk-flowchart-ecda66b28a07b45684d4932e0aac931a.png" title="clerk_fdw structure" width="1345" height="1158" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-clerk_fdw">Setting up <code>clerk_fdw</code><a href="#setting-up-clerk_fdw" class="hash-link" aria-label="Direct link to setting-up-clerk_fdw" title="Direct link to setting-up-clerk_fdw">​</a></h2><p>The first step would be installing the <code>clerk_fdw</code> extension. You can <a href="https://tembo-io.github.io/trunk/#trunk-install" target="_blank" rel="noopener noreferrer">install this extension using trunk</a>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">trunk </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> clerk_fdw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The next step would be to enable the extension in your postgres instance. You can do so using the following command:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> clerk_fdw</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-foreign-data-wrapper-for-clerk">Create the foreign data wrapper for clerk<a href="#create-the-foreign-data-wrapper-for-clerk" class="hash-link" aria-label="Direct link to Create the foreign data wrapper for clerk" title="Direct link to Create the foreign data wrapper for clerk">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">handler</span><span class="token plain"> clerk_fdw_handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validator clerk_fdw_validator</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connect-to-clerk-using-your-credentials">Connect to Clerk using your credentials<a href="#connect-to-clerk-using-your-credentials" class="hash-link" aria-label="Direct link to Connect to Clerk using your credentials" title="Direct link to Connect to Clerk using your credentials">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> wrapper clerk_wrapper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api_key </span><span class="token string" style="color:#e3116c">&#x27;&lt;clerk secret Key&gt;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-foreign-table">Create Foreign Table:<a href="#create-foreign-table" class="hash-link" aria-label="Direct link to Create Foreign Table:" title="Direct link to Create Foreign Table:">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="user-table">User table<a href="#user-table" class="hash-link" aria-label="Direct link to User table" title="Direct link to User table">​</a></h4><p>This table will store information about the users.</p><blockquote><p>Note: The current limit is 500 users. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_users </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  first_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gender </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_sign_in_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  phone_numbers </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  username </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      object </span><span class="token string" style="color:#e3116c">&#x27;users&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="organization-table">Organization Table<a href="#organization-table" class="hash-link" aria-label="Direct link to Organization Table" title="Direct link to Organization Table">​</a></h4><p>This table will store information about the organizations.</p><blockquote><p>Note: The current limit is 500 organizations. We are working to increase this limitation in future releases.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organizations </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  slug </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updated_at </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  created_by </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">&#x27;organizations&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="junction-table">Junction Table<a href="#junction-table" class="hash-link" aria-label="Direct link to Junction Table" title="Direct link to Junction Table">​</a></h4><p>This table connects the <code>clerk_users</code> and <code>clerk_orgs</code>. It lists out all users and their roles in each organization.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">foreign</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> clerk_organization_memberships </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  organization_id </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server my_clerk_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object </span><span class="token string" style="color:#e3116c">&#x27;organization_memberships&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dive-into-the-data">Dive into the Data<a href="#dive-into-the-data" class="hash-link" aria-label="Direct link to Dive into the Data" title="Direct link to Dive into the Data">​</a></h2><p>Now you can query through your database and get useful information like:</p><ul><li>How many organizations have been created each week in the past</li><li>How many users have signed up in the past 30 days</li><li>What organizations is a user part of</li><li>All users and their roles in an organization</li><li>And more….</li></ul><p>Here are some of the charts we were able to make from the clerk foreign data wrapper using some synthetic data.</p><p><img loading="lazy" alt="chart1" src="/assets/images/chart1-f041e3a0ece55d964478a2e23fffc37d.png" title="Daily New Signups" width="582" height="356" class="img_ev3q">
<img loading="lazy" alt="chart2" src="/assets/images/chart2-c1ad7d55ca70c351cda145b80752bf19.png" title="Total Organizations" width="581" height="351" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In conclusion, we believe that Postgres’ concept of Foreign Data Wrappers is more than just a technical integration—it&#x27;s a game-changer that allows Postgres users to build data warehouse platforms that reach across all data sources in the business. It paves the way for businesses to harness critical insights directly from their operational databases, making informed decisions easier than ever before. See examples of other <a href="https://pgt.dev/?cat=connectors" target="_blank" rel="noopener noreferrer">FDWs in Trunk</a></p><p>Give us a star and try out <a href="https://github.com/tembo-io/clerk_fdw" target="_blank" rel="noopener noreferrer">clerk_fdw</a> by running the example in the README. If you hit any snags, please create an issue. We would greatly welcome contributions to the project as well.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/table-version-history">Version History and Lifecycle Policies for Postgres Tables</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-29T00:00:00.000Z" itemprop="datePublished">September 29, 2023</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="back-in-time" src="/assets/images/back-in-time-1adcd964a1d80bc51e3abee252d02e3c.jpeg" width="788" height="453" class="img_ev3q"></p><p>A nice feature of AWS S3 is version history and lifecycle policies. When objects are updated or deleted, the old object version remains in the bucket, but it’s hidden. Old versions are deleted eventually by the lifecycle policy.</p><p>I would like something like that for my Postgres table data. <strong>We can use the temporal_tables extension for version history, and combine it with pg_partman to partition by time, automatically expiring old versions.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-model">Data model<a href="#data-model" class="hash-link" aria-label="Direct link to Data model" title="Direct link to Data model">​</a></h2><p>Let&#x27;s say we have a table <strong>employees</strong>, and it looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |  7000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will add one more column to this table, <code>sys_period</code>, which is a time range. This time range represents &quot;since when&quot; is this row the current version. This range is unbounded on the right side, because all the rows in the <strong>employees</strong> table are the present version.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 13:30:19.24318+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 13:33:58.735932+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 13:33:58.738827+00&quot;,)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We will make a new table <strong>employees_history</strong> to store previous versions. This will have the same columns as the <strong>employees</strong> table, but all the rows in <code>sys_period</code> are bounded on the the right and the left sides. These ranges represent when this row was the current version. We will configure <strong>temporal_tables</strong> to automatically create these rows when anything changes in the <strong>employees</strong> table.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 13:30:19.18544+00&quot;,&quot;2023-09-28 13:33:58.683279+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 13:33:58.683279+00&quot;,&quot;2023-09-28 13:33:58.731332+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 13:33:58.731332+00&quot;,&quot;2023-09-28 13:33:58.735932+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 13:30:19.239152+00&quot;,&quot;2023-09-28 13:33:58.738827+00&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To automatically delete old versions, we&#x27;ll add one more column to the <strong>employees_table</strong>, <code>created_at</code>. We will use this information to expire old versions after they are older than our retenion configuration, with the help of <strong>pg_partman</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-set-up">Getting set up<a href="#getting-set-up" class="hash-link" aria-label="Direct link to Getting set up" title="Direct link to Getting set up">​</a></h2><p><a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">This guide</a> covers how to quickly try out Postgres extensions locally. I&#x27;ve followed that guide to set up my environment with <strong>temporal_tables</strong> and <strong>pg_partman</strong>.</p><p>I have a Dockefile, two SQL scripts, and a file with Postgres configurations.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 0_startup.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── 1_create_versioned_table.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── custom.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Dockerfile:</strong> We use <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a> to install pg_partman and temporal_tables. Then, we copy the three other files into the image.</p><div class="language-Dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM quay.io/tembo/tembo-local:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install pg_partman</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN trunk install temporal_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 0_startup.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY 1_create_versioned_table.sql $PGDATA/startup-scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY custom.conf $PGDATA/extra-configs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>0_startup.sql:</strong> Enables temporal_tables and pg_partman when Postgres starts.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> temporal_tables</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_partman</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>1_create_versioned_table.sql:</strong> Creates a sample table, then enables version history on it.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Sample: an existing table we want to enable versioning on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  department </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Adding version history to the table,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">first we need to add a time range to the existing table.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">This represents &quot;since when&quot; has this row been current.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> sys_period tstzrange </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Creating a time-partitioned version table</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">each row has the range the data was valid for,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">and also the time this version was created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> employees INCLUDING DEFAULTS EXCLUDING INDEXES EXCLUDING CONSTRAINTS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at timestamptz </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Allow efficient querying of partition key and name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees_history </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Enable automatic partitioning with pg_partman, partitioning every 1 minute.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to partition daily or greater.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> create_parent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;created_at&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;native&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1 minute&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- This connects employees table to employees_history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TRIGGER</span><span class="token plain"> versioning_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEFORE </span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR EACH ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> versioning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;sys_period&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                              </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Configure retention policy for employee history to keep old versions for 10 minutes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">It&#x27;s more realistic to configure retention for 1 year.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 minutes&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_keep_index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        infinite_time_partitions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public.employees_history&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>custom.conf:</strong> our additions to the Postgres configuration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Enable pg_partman background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shared_preload_libraries = &#x27;pg_partman_bgw&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># How many seconds between pg_partman background worker runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s more realistic to run every 3600 seconds, or longer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.interval = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Which database pg_partman should target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_partman_bgw.dbname = &#x27;postgres&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># It&#x27;s best practice to use limited permissions for the background worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_partman_bgw.role = &#x27;limitedrole&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This was helpful when I was working on getting the settings working</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># log_min_messages = &#x27;DEBUG1&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With those four files in place, we can run Postgres like this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build -t example-local-image </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it -d --name local-tembo -p </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 --rm example-local-image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In a separate shell, I connect into the Postgres container.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">psql postgres://postgres:postgres@localhost:5432</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-demo-of-saving-old-versions">Basic demo of saving old versions<a href="#basic-demo-of-saving-old-versions" class="hash-link" aria-label="Direct link to Basic demo of saving old versions" title="Direct link to Basic demo of saving old versions">​</a></h2><p>After we are set up, we have version history and retention policy configured on the <strong>employees</strong> table, but both the <strong>employees</strong> table and the <strong>employees_history</strong> table are empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Adding data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Helmholtz Watson&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;College of Emotional Engineering&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees</strong> has some data, and <strong>employees_history</strong> is still empty.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |   salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+-----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     |  10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    |   7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson |  18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> name | department | salary | sys_period | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------------+--------+------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modifying data:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11200</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11400</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11601</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Lenina Crowne&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the <strong>employees_history</strong> table has past versions.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">       name       |  salary  |             sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------+----------+------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Helmholtz Watson | 18500.00 | [&quot;2023-09-28 20:23:14.913555+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx     | 11600.00 | [&quot;2023-09-28 20:23:50.731597+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne    | 11601.00 | [&quot;2023-09-28 20:23:50.734214+00&quot;,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     name      |  salary  |                            sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------+----------+-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 10000.00 | [&quot;2023-09-28 20:23:14.840624+00&quot;,&quot;2023-09-28 20:23:50.684293+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11200.00 | [&quot;2023-09-28 20:23:50.684293+00&quot;,&quot;2023-09-28 20:23:50.727283+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Bernard Marx  | 11400.00 | [&quot;2023-09-28 20:23:50.727283+00&quot;,&quot;2023-09-28 20:23:50.731597+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Lenina Crowne |  7000.00 | [&quot;2023-09-28 20:23:14.911528+00&quot;,&quot;2023-09-28 20:23:50.734214+00&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(4 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="looking-up-past-versions">Looking up past versions<a href="#looking-up-past-versions" class="hash-link" aria-label="Direct link to Looking up past versions" title="Direct link to Looking up past versions">​</a></h2><p>Let&#x27;s say we want to look up Bernard&#x27;s salary at a previous date. We can check the <strong>employees_history</strong> table to find the row where the time range matches our provided timestamp. However, this wouldn&#x27;t find the correct salary if we provide a timestamp that is after the most recent update to Bernard&#x27;s salary, since that row is in the <strong>employees</strong> table.</p><p>We can first create a <a href="https://www.postgresql.org/docs/current/tutorial-views.html" target="_blank" rel="noopener noreferrer">view</a> for this purpose. We only need to do this once, then we can query this view like a table going forward.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VIEW</span><span class="token plain"> employee_history_view </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we can use this query to find Bernard&#x27;s salary at any given date.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 20:23:30+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>@&gt;</code> Is a <em>containment operator</em> and you might recognize it if you have used <a href="https://tembo.io/docs/postgres_guides/postgres-basics/jsonb" target="_blank" rel="noopener noreferrer">JSONB</a>.</p><p>Comparing to the <strong>employees_history</strong> table shown above, it is returning the correct value.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10000.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also works to look up the current salary:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11600.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If I try to query a salary from the future, it will return the current salary. If I try to query a salary from before Bernard is known in the <strong>employees_history</strong> table, then I get an empty result.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="partitioning">Partitioning<a href="#partitioning" class="hash-link" aria-label="Direct link to Partitioning" title="Direct link to Partitioning">​</a></h2><p><strong>What is partitioning?</strong> <a href="https://www.postgresql.org/docs/current/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">Postgres documentation</a> has detailed information on partitioning but just to summarize, partitioning is about splitting what is logically one large table into smaller tables. Typically, this is done for query performance. In our case, <strong>we are partitioning to expire old versions.</strong></p><p>Partitioning tables is something I’m familiar with from Tembo’s work in <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">PGMQ</a>, which is a queueing extension for Postgres.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="writes">Writes<a href="#writes" class="hash-link" aria-label="Direct link to Writes" title="Direct link to Writes">​</a></h3><p>We should expect write performance to be slower, since we are writing to two tables for every update.</p><p>I created a new table that does not have versioning enabled to compare write performance.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a table like employees</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">NO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ...and insert one row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> employees_write_test </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> department</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> salary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sys_period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Hatchery and Conditioning Centre&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11600.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tstzrange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, I used <code>EXPLAIN ANALYZE</code> to compare the write performance. I ran the query a few times for each.</p><p><strong>Without versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees_write_test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11608</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.654 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 1.540 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 0.760 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 0.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 1.707 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.079 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>With versioning:</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> salary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11610</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Three samples:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.423 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=2.430 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 4.783 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.311 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.091 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 2.979 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Planning Time: 2.825 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Trigger versioning_trigger: time=1.711 calls=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Execution Time: 5.686 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It&#x27;s more than twice as slow on a single update. That&#x27;s because we have to write to two rows instead of one, there is more data to write (the time ranges), and because there is some additional processing, for instance determining which range to put on each row. In the next section, I also compare how much time it takes to write 100,000 rows in each of these tables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reads">Reads<a href="#reads" class="hash-link" aria-label="Direct link to Reads" title="Direct link to Reads">​</a></h3><p>We created a view which is a union between <strong>employees</strong> and <strong>employees_history</strong>, then we query the view to find an employee&#x27;s salary at a given time.</p><p>To generate some data, let&#x27;s make a procedure to update a salary 100,000 times in a row. The below example uses <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>. By default, PL/pgSQL functions run as a single transaction, so it would only result in a single update to the <strong>employees_history</strong> table. For this reason, I am using a procedure with <code>COMMIT</code> so that each increment will be a separate transaction, this way we also get 100,000 updates to the <strong>employees_history</strong> table. I had to explain that nuance to chatGPT in order for this procedure to be produced properly.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Table name and employee name as inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_salary </span><span class="token keyword" style="color:#00009f">numeric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i </span><span class="token keyword" style="color:#00009f">integer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to get the current salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;SELECT salary FROM %I WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> v_salary </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Loop 100 thousand times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Increment the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_salary :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v_salary </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- Dynamically construct the SQL to update the salary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v_sql :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;UPDATE %I SET salary = $2 WHERE name = $1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_table_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> v_sql </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> p_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_salary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">COMMIT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- Commit the transaction, triggering the versioning procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Run the procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> increment_salary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;employees&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This took 55 seconds to run on my laptop. I also tried it on the table without versioning enabled, at in this case it took 38 seconds. I ran it a couple more times on the table with versioning enabled, so that the versions would be distributed across multiple partitions. Now we have an <strong>employees_history</strong> table that&#x27;s populated with many rows for Bernard.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employees_history </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s run the same type of query command we ran before, with <code>EXPLAIN ANALYZE</code>. I picked a timestamp that will not be found to ensure it&#x27;s as slow as possible.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> salary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> employee_history_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bernard Marx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sys_period @</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TIME</span><span class="token plain"> ZONE </span><span class="token string" style="color:#e3116c">&#x27;2023-09-28 15:28:25+00&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Simplified query plan output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Append</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Bitmap Heap Scan on employees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Recheck Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: (sys_period @&gt; &#x27;...&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Heap Blocks: exact=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Bitmap Index Scan on employees_pkey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Index Cond: (name = &#x27;Bernard Marx&#x27;::text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0030</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0031</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 99969</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0035</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 97393</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on employees_history_p2023_09_29_0036</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: ((sys_period @&gt; &#x27;...&#x27;) AND (name = &#x27;Bernard Marx&#x27;::text))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Rows Removed by Filter: 102607</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ... Empty partitions omitted ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 12.427 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 262.706 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(47 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query took 263 milliseconds. We notice this query needs to scan all partitions, because we are partitioning by <code>created_at</code>, and querying <code>sys_period</code>. We can improve the speed with indexes.</p><p>If this was a real workload, I doubt that employees&#x27; salaries are being updated so frequently, or at least that&#x27;s been the case in my personal experience. However, if it&#x27;s a big company, then there could be a lot of employees. In that case, it would be best to add an index on the name (or more realistically, employee ID) in the <strong>employees_history</strong> table. Then, withing each partition it will find only rows for the employee being queryed using the index, then it would scan the remaining rows, probably typically zero, one, or two rows, to find the correct salary.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expiring-old-versions">Expiring old versions<a href="#expiring-old-versions" class="hash-link" aria-label="Direct link to Expiring old versions" title="Direct link to Expiring old versions">​</a></h2><p>Earlier in this blog, we configured <strong>pg_partman</strong> to partition in 1 minute increments, to expire partitions that are older than 15 minutes, and to check every 30 seconds. Every 30 seconds, any partition that is older that 15 minutes is deleted by the <strong>pg_partman</strong> background worker.</p><p>With this query, I can check how many rows and the total data size in each partition.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- This query was produced by ChatGPT 4 with the prompt:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- &quot;How can I check the number of rows in each partition of employees_history?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_total_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> total_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> data_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_live_tup </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_inherits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class parent </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhparent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_class child </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> pg_inherits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inhrelid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_stat_user_tables </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pg_stat_user_tables</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;employees_history&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In order to check that old versions are being dropped, I ran the procedure to create a lot of salaray increments several times in a row.</p><p>Then, running the above query, I find an output like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2204 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2205 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2206 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13180928 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     868352 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this output, we can see that we have 1 partition for every minute, and a total of 15 partitions. I have old versions expiring after 10 minutes. I thought it&#x27;s interesting to note that <strong>pg_partman</strong> is preemptively creating partitions for the future, in this case 5 minutes into the future.</p><p>If you refer to the original set up steps, I have configured <code>infinite_time_partitions = true</code>, and this means we will generate partitions even when we are not generating any data for them. I think this is the proper configuration since we also have a retention policy that will drop the old partitions. The concern of making infinite partitions as time passes, even if no data is being generated, is not applicable because old tables are being dropped.</p><p>To confirm data was being deleted, I sampled the above query over time, and we can see the large body of inserts moving up into the oldest available partitions, then falling outside of the retention policy and being deleted.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2207 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2208 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2209 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2210 |      32768 |      8192 |         4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2211 |    9584640 |   7995392 |     68267</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2212 |    4489216 |   3719168 |     31733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2213 |   13189120 |  11018240 |     94144</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 131733</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2214 |     876544 |    688128 |      5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5856</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           partition_name           | total_size | data_size | row_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------+------------+-----------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_default          |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2215 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2216 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2217 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2218 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2219 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2220 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2221 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2222 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2223 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2224 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2225 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2226 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2227 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2228 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> employees_history_p2023_09_28_2229 |      16384 |         0 |         0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(16 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# select count(*) from employees_history;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="thanks">Thanks!<a href="#thanks" class="hash-link" aria-label="Direct link to Thanks!" title="Direct link to Thanks!">​</a></h2><p>If you got this far, thank you for reading this! I hope that you are inspired to try out extensions on your own and see what they can do. The next time you have some problem to solve with your data, consider that maybe it could just be handled by a Postgres extension.</p><p>If you want to try extensions without any local setup, you should try Tembo Cloud at <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">cloud.tembo.io</a>.</p><p>Just use Postgres!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/temporal-tables">temporal_tables</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pg-partman">pg_partman</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://tembo.io/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/postgres-extension-in-rust-pgmq">Anatomy of a Postgres extension written in Rust: pgmq</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-28T00:00:00.000Z" itemprop="datePublished">September 28, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/binidxaba.png" alt="Binidxaba"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/binidxaba" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Binidxaba</span></a></div><small class="avatar__subtitle" itemprop="description">Community contributor</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In my <a href="https://tembo.io/blog/pgmq-with-python" target="_blank" rel="noopener noreferrer">previous submission</a> to this space, I described my experience with <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">pgmq</a> while using the Python library. In this post, I&#x27;ll share what I found after inspecting the code.</p><p>So, first, I&#x27;ll describe the general structure of the project. Then, I&#x27;ll explain what happens when we install the pgmq extension. Finally, I&#x27;ll describe how some of its functions work.</p><p>In this post, I&#x27;ll be using version v0.25.0, which you can find <a href="https://github.com/tembo-io/pgmq/releases/tag/v0.25.0" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure">​</a></h2><p>After cloning the appropriate tag, we can see that the repository contains the following files:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTRIBUTING.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dockerfile.build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tembo-pgmq-python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tests</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The project uses <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">pgrx</a>. From pgrx&#x27;s <a href="https://github.com/pgcentralfoundation/pgrx/blob/develop/README.md" target="_blank" rel="noopener noreferrer">README</a>, we know that the relevant files for the extension are <code>Cargo.toml</code>, <code>pgmq.control</code> and the <code>src</code> and <code>sql</code> directories:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tree sql src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.11.1--0.11.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.0--0.8.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pgmq--0.8.1--0.9.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── errors.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── metrics.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── partition.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── sql_src.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── util.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> directories, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> files</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-the-pgmq-extension">Installing the pgmq extension<a href="#installing-the-pgmq-extension" class="hash-link" aria-label="Direct link to Installing the pgmq extension" title="Direct link to Installing the pgmq extension">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This section assumes that you have successfully installed the pre-requisites as described in <a href="https://github.com/tembo-io/pgmq/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">CONTRIBUTING.md</a></p></div></div><p>To build the pgmq extension, we can do the following:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, to build and install the pgmq extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In either case, we can see a shared library <code>pgmq.so</code> being created. The installation process also places the shared library in the <code>lib</code> directory of the postgres installation; and the sql files and the control file in the <code>extensions</code> directory. In my case:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/share/extension/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.10.2--0.11.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq--0.9.0--0.10.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/share/extension/pgmq.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls -1 /opt/postgres/lib/pgmq*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/postgres/lib/pgmq.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To test the extension, we can do:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo pgrx run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and it&#x27;ll start a <code>psql</code> prompt. In the prompt, we can execute the <code>create extension</code> statement to start using pgmq:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Enable pgmq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> extension pgmq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List installed extensions again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will look something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# create extension pgmq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Name   | Version |   Schema   |                             Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+---------+------------+---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq    | 0.25.0  | public     | A lightweight message queue. Like AWS SQS and RSMQ but on Postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also list the available functions:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List available functions under pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\df pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \df pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                         List of functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |          Name          |                                                                         Result data type                                                                         |                                                 Argument data types                                                  | Type </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archive                | TABLE(archive boolean)                                                                                                                                           | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create                 | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_non_partitioned | void                                                                                                                                                             | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | create_partitioned     | void                                                                                                                                                             | queue_name text, partition_interval text DEFAULT &#x27;10000&#x27;::text, retention_interval text DEFAULT &#x27;100000&#x27;::text       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | boolean                                                                                                                                                          | queue_name text, msg_id bigint                                                                                       | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | delete                 | TABLE(delete boolean)                                                                                                                                            | queue_name text, msg_ids bigint[]                                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | drop_queue             | boolean                                                                                                                                                          | queue_name text, partitioned boolean DEFAULT false                                                                   | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | list_queues            | TABLE(queue_name text, created_at timestamp with time zone)                                                                                                      |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics                | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | metrics_all            | TABLE(queue_name text, queue_length bigint, newest_msg_age_sec integer, oldest_msg_age_sec integer, total_messages bigint, scrape_time timestamp with time zone) |                                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | pop                    | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | purge_queue            | bigint                                                                                                                                                           | queue_name text                                                                                                      | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read                   | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer                                                                         | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | read_with_poll         | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, vt integer, &quot;limit&quot; integer, poll_timeout_s integer DEFAULT 5, poll_interval_ms integer DEFAULT 250 | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send                   | bigint                                                                                                                                                           | queue_name text, message jsonb, delay integer DEFAULT 0                                                              | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | send_batch             | TABLE(msg_id bigint)                                                                                                                                             | queue_name text, messages jsonb[], delay integer DEFAULT 0                                                           | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | set_vt                 | TABLE(msg_id bigint, read_ct integer, enqueued_at timestamp with time zone, vt timestamp with time zone, message jsonb)                                          | queue_name text, msg_id bigint, vt_offset integer                                                                    | func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(18 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this, we can now explore the extension from the inside. And, if needed, recompile and reinstall the extension to play with it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-internals">The internals<a href="#the-internals" class="hash-link" aria-label="Direct link to The internals" title="Direct link to The internals">​</a></h2><p>We know that when an extension is created with pgrx, it generates a <code>lib.rs</code> file. Let us explore it.</p><p>One of the first thing we can see, is that the other five files in the <code>src/</code> directory are included:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub mod api;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod metrics;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod partition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub mod util;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After reviewing these files a little bit, we can notice that there&#x27;s also some relevant code in another module, the one in <code>core/</code>. For example, in <code>src/partition.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use pgmq_core::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors::PgmqError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query::{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive, assign_queue, create_archive, create_archive_index, create_index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_meta, grant_pgmon_meta, grant_pgmon_queue, grant_pgmon_queue_seq, insert_meta,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    types::{PGMQ_SCHEMA, QUEUE_PREFIX},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    util::CheckedName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, at this point we know that we can find the source code in two places: <code>src/</code> and <code>core/</code>. </p><p>If we continue exploring <code>lib.rs</code>, we can see that a sql file (<code>sql_src.sql</code>) is executed when the extension is enabled:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE pgmq.meta (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name VARCHAR UNIQUE NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_partitioned BOOLEAN NOT NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can actually see that table with <code>psql</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- List tables in the pgmq schema</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List contents of pgmq.meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq-# \dt pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema | Name | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------+-------+----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public | meta | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | created_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(0 rows)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like right after <code>CREATE EXTENSION</code> is executed:</p><p><img loading="lazy" alt="after-create-extension" src="/assets/images/after-create-extension-e590194728d15b0433b8e5510725f9ff.png" title="after create extension" width="596" height="551" class="img_ev3q"></p><p>From this point, we can suspect that every time we create a queue, a new row is inserted into this table.</p><p>Let us see what <code>pgmq.create()</code> does...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqcreate">pgmq.create()<a href="#pgmqcreate" class="hash-link" aria-label="Direct link to pgmq.create()" title="Direct link to pgmq.create()">​</a></h3><p>Most of the functions provided by pgmq are defined in <code>src/api.rs</code>. In that file, we can find the function <code>pgmq_create(queue_name: &amp;str)</code>, and if we chase the call sequence, we can discover that the interesting function is <code>init_queue(name: &amp;str)</code> in <code>core/src/query.rs</code>:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn init_queue(name: &amp;str) -&gt; Result&lt;Vec&lt;String&gt;, PgmqError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let name = CheckedName::new(name)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(vec![</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assign_archive(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        create_archive_index(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert_meta(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grant_pgmon_queue(name)?,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This function generates several sql statements that are later executed in <code>pgmq_create_non_partitioned</code> using an <a href="https://docs.rs/pgx/latest/pgx/spi/struct.SpiClient.html" target="_blank" rel="noopener noreferrer"><code>Spi</code> client</a>.</p><p>I&#x27;ll skip the details, but the sql statements basically do:</p><ol><li>Create a table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pqmg extension.</li><li>Create an index on the <code>pgmq.q_&lt;queue_name&gt;</code> table.</li><li>Create a table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Assign the table to the pgmq extension.</li><li>Create an index on the <code>pgmq.a_&lt;queue_name&gt;</code> table.</li><li>Insert a row on the <code>pgmq.meta</code> table.</li><li>Grant privileges to <code>pg_monitor</code>.</li></ol><p>We can see the effects of this in psql using the following lines:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Create a queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List tables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\dt pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- List indexes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\di pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- See the contents of pgmq_meta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output will show something like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq_create(&#x27;my_queue&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \dt pgmq.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |    Name    | Type  |  Owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+------------+-------+-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta       | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue | table | binidxaba</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# \di pgmq.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         List of relations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Schema |           Name           | Type  |   Owner   |   Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------+--------------------------+-------+-----------+------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | a_my_queue_pkey          | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | archived_at_idx_my_queue | index | binidxaba | a_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | meta_queue_name_key      | index | binidxaba | meta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_pkey          | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq   | q_my_queue_vt_idx        | index | binidxaba | q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(5 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select * from pgmq.meta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> queue_name | is_partitioned |          created_at           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ------------+----------------+-------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  my_queue   | f              | 2023-09-18 23:35:38.163096-06</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (1 row)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following diagram shows what the pgmq schema looks like at this point:</p><p><img loading="lazy" alt="complete" src="/assets/images/complete-0b9cb3715d61904139d1d12fb7d717e6.png" title="after create queue" width="596" height="551" class="img_ev3q"></p><p>For the queue <code>my_queue</code>, we can see the underlying table and the corresponding archive table. Each table has an index associated with the primary key. The <code>pgmq.q_my_queue</code> table also has an index on the <code>vt</code> column, and <code>pgmq.a_my_queue</code> has an index on the <code>archived_at</code> column.</p><p>We can suspect that the <code>pgmq.q_my_queue</code> table is used in the send and read operations. Let us look at those two functions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqsend">pgmq.send()<a href="#pgmqsend" class="hash-link" aria-label="Direct link to pgmq.send()" title="Direct link to pgmq.send()">​</a></h3><p>We can explore the send operation in a similar way. The relevant SQL is straightforward. It just inserts a new row in the the underlying table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">values</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-send" src="/assets/images/pgmq-send-e0f2306ae56fdd9487889c5125c8b461.png" title="what send does" width="596" height="624" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>At this point, we can see the following pattern in the pgmq project: </p><ul><li>the exposed SQL functions are defined in <code>src/api.rs</code>, and </li><li>the underlying SQL statements are defined in <code>core/src/query.rs</code></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqread">pgmq.read()<a href="#pgmqread" class="hash-link" aria-label="Direct link to pgmq.read()" title="Direct link to pgmq.read()">​</a></h3><p>So, let&#x27;s see. If I were the one programming <code>pgmq.read()</code>, I would perhaps do something like &quot;get the first <code>{limit}</code> rows from the queue table whose <code>{vt}</code> has already expired, and for those rows, also update the visibility timeout to <code>now() + {vt}</code>.&quot; Naively, maybe something like:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10 seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_id </span><span class="token operator" style="color:#393A34">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_my_queue </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                                                      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain">                                                                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In reality, <code>pgmq.read</code> is more interesting than that 😅. It performs the following DML:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> cte </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> vt </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> msg_id </span><span class="token keyword" style="color:#00009f">ASC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> {</span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name} t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clock_timestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{vt} seconds&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_ct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_ct </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cte</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cte</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msg_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="pgmq-read" src="/assets/images/pgmq-read-b13515d2be7805a182167d1430faad87.png" title="what read does" width="596" height="624" class="img_ev3q"></p><p>Firstly, in pgmq&#x27;s version, there is a CTE (Common Table Expression) to obtain the first <code>{limit}</code> message IDs whose <code>vt</code> has expired. (It would be interesting to discuss why pgmq developers used a CTE, but we can explore that in another post.)</p><p>There are two crucial things to notice in the CTE. One is the <code>order by</code> clause that ensures the FIFO ordering. The other one is the <code>FOR UPDATE SKIP LOCKED</code> clause, claiming the rows no one else has claimed. This part is essential because it ensures correctness in the case of concurrent  <code>pgmq.read()</code> operations. </p><p>The next step in the DML is to update the corresponding rows with a new vt value by adding the supplied <code>{vt}</code> to the current timestamp. Additionally, the <code>read_ct</code> value is incremented by 1. What is the use of this counter? In general, we can suspect that there is a problem processing a given message if it has a high <code>read_ct</code> value because users usually archive the message after successfully processing it. So, ideally, a message is only read once. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqarchive">pgmq.archive()<a href="#pgmqarchive" class="hash-link" aria-label="Direct link to pgmq.archive()" title="Direct link to pgmq.archive()">​</a></h3><p>The next stage in the lifecycle of a message is archiving it. For that, pgmq uses the following insert statement:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> archived </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{QUEUE_PREFIX}_{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> msg_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> {PGMQ_SCHEMA}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">{ARCHIVE_PREFIX}_{name} </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read_ct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> enqueued_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> archived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> msg_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Essentially, it deletes the message with the provided <code>msg_id</code> from the queue table, and then the message is placed in the corresponding archive table.</p><p><img loading="lazy" alt="pgmq-archive" src="/assets/images/pgmq-archive-30c5d9c4aaee1ce50a1ada784e3096e3.png" title="what archive does" width="596" height="624" class="img_ev3q"></p><p>One interesting thing to notice is that <code>pgmq.archive()</code> can be used to archive a batch of messages too:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> pgmq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">archive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;my_queue&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ARRAY</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pgmq=# select pgmq.archive(&#x27;my_queue&#x27;, ARRAY[3, 4, 5]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> pgmq_archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That is achieved in pgrx by declaring two functions using the <a href="https://github.com/pgcentralfoundation/pgrx/blob/047b1d1fc9e9c4007c871e226fa81e294f8bf5e6/pgrx-macros/src/lib.rs#L462" target="_blank" rel="noopener noreferrer">same name in the <code>pg_extern</code></a> derive macro as follows:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive(queue_name: &amp;str, msg_id: i64) -&gt; Result&lt;Option&lt;bool&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[pg_extern(name = &quot;archive&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn pgmq_archive_batch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    queue_name: &amp;str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msg_ids: Vec&lt;i64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;TableIterator&lt;&#x27;static, (name!(archive, bool),)&gt;, PgmqExtError&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pgmqdrop_queue">pgmq.drop<!-- -->_<!-- -->queue()<a href="#pgmqdrop_queue" class="hash-link" aria-label="Direct link to pgmqdrop_queue" title="Direct link to pgmqdrop_queue">​</a></h3><p>Finally, let&#x27;s talk about <code>pgmq.drop_queue()</code>. It essentially executes multiple statements:</p><ol><li>Unassign the <code>pgmq.q_&lt;queue_name&gt;</code> table from the extension.</li><li>Unassign the <code>pgmq.a_&lt;queue_name&gt;</code> table from the extension.</li><li>Drop the table <code>pgmq.q_&lt;queue_name&gt;</code>.</li><li>Drop the table <code>pgmq.a_&lt;queue_name&gt;</code>.</li><li>Delete the corresponding row from the <code>pgmq.meta</code> table.</li></ol><p>Nothing surprising in this one, and with it, we conclude our tour.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this post, we explored how the pgrx tool is used to generate the pgmq extension. We explored how the metadata objects are created and how they are used in the basic send, read and archive operations. At least from an explorer perspective, the internals of the extension are currently easy to read and understand.</p><p>I invite everyone to explore how the other pgmq functions work. You can explore the code at <a href="https://github.com/tembo-io/pgmq" target="_blank" rel="noopener noreferrer">https://github.com/tembo-io/pgmq</a>. And you can learn more about pgrx at: <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">https://github.com/pgcentralfoundation/pgrx</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgmq">pgmq</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/pgrx">pgrx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/four-types-of-extensions">Enter the matrix: the four types of Postgres extensions</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-14T00:00:00.000Z" itemprop="datePublished">September 14, 2023</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/sjmiller609.png" alt="Steven Miller"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sjmiller609" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Steven Miller</span></a></div><small class="avatar__subtitle" itemprop="description">Founding Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Before working for a Postgres company, I had never used extensions.</p><p>Now, I&#x27;m part of a team working to fully automate turning on any extension. I didn&#x27;t find great resources to explain the process of turning on an extension, and why it varies between different extensions.</p><p><strong>I want to share my mental model for the different types of extensions, how to know what type of extension you&#x27;re working with, and how to get it turned on.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="turn-on-an-extension">Turn on an extension<a href="#turn-on-an-extension" class="hash-link" aria-label="Direct link to Turn on an extension" title="Direct link to Turn on an extension">​</a></h2><p><img loading="lazy" alt="one-does-not-simply" src="/assets/images/one-does-not-simply-095857686f6255714eb3f6df0f595d5b.png" width="651" height="383" class="img_ev3q"></p><p><strong>What&#x27;s traditionally involved:</strong></p><ul><li>Find the extension you want</li><li>Figure out how to build it</li><li>Sometimes, installation of dependencies (for example with <em>apt-get</em> or <em>yum</em>)</li><li>Sometimes, installation of other extensions (<em>goto</em> ‘figure out how to build it’)</li><li>Install your extension</li><li>Sometimes, load a library</li><li>Sometimes, provide extension-specific configurations</li><li>Sometimes, run the <code>CREATE EXTENSION</code> command</li></ul><p>Building and installing extensions is well covered by other resources. In this blog, I want to focus on steps to get an extension up and running after it&#x27;s installed, and how <strong>I believe that all extensions fit into four mostly-tidy categories.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a href="#terminology" class="hash-link" aria-label="Direct link to Terminology" title="Direct link to Terminology">​</a></h3><p>Extensions consist of <strong>SQL</strong> and / or <strong>libraries</strong>.</p><p>A <strong>library</strong> simply means compiled code, for example written in <a href="https://www.postgresql.org/docs/current/xfunc-c.html" target="_blank" rel="noopener noreferrer">C</a> or <a href="https://github.com/pgcentralfoundation/pgrx" target="_blank" rel="noopener noreferrer">Rust</a>.</p><p><strong><a href="https://www.postgresql.org/docs/current/extend-extensions.html#:~:text=A%20useful%20extension%20to%20PostgreSQL,package%20to%20simplify%20database%20management." target="_blank" rel="noopener noreferrer">SQL objects</a></strong>, let&#x27;s just call it SQL, are extensions of SQL, for example new functions and data types. These are often implemented by a library, but can also be implemented in other ways, for example using a procedural language like <a href="https://www.postgresql.org/docs/current/plpgsql.html" target="_blank" rel="noopener noreferrer">PL/pgSQL</a>.</p><p><strong>Hooks:</strong> A Postgres feature informally called <em>hooks</em> can be used to connect into Postgres&#x27; existing functionality. Hooks allow for overwriting default Postgres functionality, or calling back into an extension&#x27;s code at the appropriate time. For example, one type of hook can modify Postgres start up behavior to launch a background worker, and a different type of hook can be used to redirect queries to a different table.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Sometimes extensions are instead referred to as &#x27;modules&#x27;, but I like to simply refer to everything as an &#x27;extension&#x27;, but feel free to @ me on X to tell me why that&#x27;s wrong (<a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a>).</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-the-matrix">Enter the matrix<a href="#enter-the-matrix" class="hash-link" aria-label="Direct link to Enter the matrix" title="Direct link to Enter the matrix">​</a></h2><p><img loading="lazy" alt="im-in-matrix" src="/assets/images/im-in-matrix-dc7fbaffd858e30723ad62d60ebdd4a3.gif" width="498" height="278" class="img_ev3q"></p><p>A big part of what I have been working on is fully automating enabling any extension. In order to do that, we have to understand exactly how extensions vary. We can break it down into a 2x2 matrix by defining two boolean categories.</p><p><strong>Requires <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong> true or false and <strong>requires <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a></strong> true or false:</p><table><thead><tr><th></th><th>Requires <code>CREATE EXTENSION</code></th><th>Does not require <code>CREATE EXTENSION</code></th></tr></thead><tbody><tr><td><strong>Requires <code>LOAD</code></strong></td><td>Extensions that use SQL and their libraries have hooks</td><td>Extensions that do not use SQL, may or may not have hooks</td></tr><tr><td><strong>Does not require <code>LOAD</code></strong></td><td>SQL-only extensions, and SQL + libraries without hooks</td><td>Output plugins</td></tr></tbody></table><p><em>By categorizing an extension into this 2x2 matrix, we can know how to turn it on.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load">LOAD<a href="#load" class="hash-link" aria-label="Direct link to LOAD" title="Direct link to LOAD">​</a></h3><p> <a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a> is a command that tells Postgres to <em>load</em> a library, meaning make the code accessible to Postgres by loading the compiled code on disk into memory. If a library has hooks, <strong>performing a load will activate the hooks</strong>.</p><p><strong>Requires <code>LOAD</code>: true</strong> means you have to do one of the following steps to load a library:</p><ul><li><strong><a href="https://www.postgresql.org/docs/current/sql-load.html" target="_blank" rel="noopener noreferrer">LOAD</a></strong>: using the <code>LOAD</code> command directly loads a library for the current connection only</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=at%20session_preload_libraries%20instead.-,session_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">session_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD for new connections</li><li><strong><a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=pooling%20is%20used.-,shared_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a></strong>: configuration, specifies which libraries to LOAD at server start, and therefore requires a restart</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Even though code is loaded in other ways during <code>CREATE EXTENSION</code>, that is not <strong>requires <code>LOAD</code>: true</strong> under this definition. I mean that the user must do something other than <code>CREATE EXTENSION</code> to load in libraries. Also, we are conflating <a href="https://www.postgresql.org/docs/15/runtime-config-client.html#GUC-LOCAL-PRELOAD-LIBRARIES:~:text=load%20that%20module.-,local_preload_libraries,-(string)" target="_blank" rel="noopener noreferrer">local_preload_libraries</a> with <code>session_preload_libraries</code> to simplify things in this blog post.</p></div></div><p>For example, if you installed the extension <a href="https://pgt.dev/extensions/auto_explain" target="_blank" rel="noopener noreferrer">auto explain</a>, then you may have a library file called <code>auto_explain.so</code> in your library directory, which can be found with <a href="https://pgpedia.info/d/dynamic_library_path.html" target="_blank" rel="noopener noreferrer">pg_config --pkglibdir</a>. Libraries are not always named exactly the same as the extension.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] auto_explain.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --pkglibdir) | grep auto_explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_explain.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Auto explain can be loaded into your session like <code>LOAD &#x27;auto_explain&#x27;;</code>. This command will always match exactly the name of the library file, less the file type, in this example <code>.so</code>. With a <a href="https://www.postgresql.org/docs/current/auto-explain.html#AUTO-EXPLAIN-EXAMPLE" target="_blank" rel="noopener noreferrer">couple of configurations</a>, now this extension will automatically log the <a href="https://www.postgresql.org/docs/current/sql-explain.html" target="_blank" rel="noopener noreferrer">EXPLAIN ANALYZE</a> output for long-running queries.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;auto_explain&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOAD</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, the <code>LOAD</code> command is not typically used directly, and many extensions require you do not load them in this way. Instead, typically the Postgres configuration <a href="https://pgpedia.info/s/shared_preload_libraries.html" target="_blank" rel="noopener noreferrer">shared_preload_libraries</a> is used instead.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# LOAD &#x27;pg_cron&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR:  pg_cron can only be loaded via shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINT:  Add pg_cron to the shared_preload_libraries configuration variable in postgresql.conf.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The best reason to use <code>LOAD</code> directly is for debugging. It can be nice to <code>LOAD</code> on-demand while troubleshooting.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><strong>What to do when an extension requires load:</strong></p><p>Extensions that <strong>requires <code>LOAD</code>: true</strong> can always be configured in <code>shared_preload_libraries</code>, but this configuration requires a restart to take effect. Some extensions can be loaded without a restart using <code>LOAD</code> directly, but in this case it&#x27;s usually better to use the <code>session_preload_libraries</code> configuration, and <a href="https://pgpedia.info/p/pg_reload_conf.html" target="_blank" rel="noopener noreferrer">reload the Postgres configuration</a> with <code>SELECT pg_reload_conf();</code>. You should run <code>LOAD</code> directly when you are intentionally loading for only the current connection.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-extension">CREATE EXTENSION<a href="#create-extension" class="hash-link" aria-label="Direct link to CREATE EXTENSION" title="Direct link to CREATE EXTENSION">​</a></h3><p>When you run <a href="https://www.postgresql.org/docs/current/sql-createextension.html" target="_blank" rel="noopener noreferrer">CREATE EXTENSION</a>, this basically just runs an extension&#x27;s SQL script. The script will typically create new SQL objects such as functions, data types, operators and so on.</p><p><code>CREATE EXTENSION</code> looks at the extension&#x27;s <strong>control file</strong>, which is installed to the <code>extension</code> directory of <strong>sharedir</strong>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ trunk install pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using pkglibdir: &quot;/var/lib/postgresql/data/tembo/15/lib&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Using sharedir: &quot;/var/lib/postgresql/data/tembo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] pg_jsonschema.so =&gt; /var/lib/postgresql/data/tembo/15/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema--0.1.4.sql =&gt; /var/lib/postgresql/data/tembo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] extension/pg_jsonschema.control =&gt; /var/lib/postgresql/data/tembo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>sharedir</strong> can be located with <code>pg_config --sharedir</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$  ls $(pg_config --pkglibdir) | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls $(pg_config --sharedir)/extension | grep pg_jsonschema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema--0.1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_jsonschema.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The information in a control file is used to determine what start up or upgrade scripts to run. We&#x27;ll cover upgrades in-depth in a future blog, so let&#x27;s focus on first-time enabling. For example, in the above installation output, we notice a file <code>pg_jsonschema--0.1.4.sql</code>. Postgres knows to run this because the name of the control file matches the name of the script suffixed by the <code>default_version</code> defined in the control file.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat $(pg_config --sharedir)/extension/pg_jsonschema.control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;JSON schema validation on json and jsonb data types&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.1.4&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/pg_jsonschema&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running <code>CREATE EXTENSION</code>, the extension name always matches exactly the name of a control file, less the <code>.control</code> file type.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION pg_jsonschema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I mentioned that a start up script creates new SQL, including new functions. For example in the case of <a href="https://pgt.dev/extensions/pg_jsonschema" target="_blank" rel="noopener noreferrer">pg_jsonschema</a>, the start up script <code>pg_jsonschema--0.1.4.sql</code> includes the following SQL to create a new function called <code>jsonb_matches_schema</code>. Even though we have a library file, we don&#x27;t need <code>LOAD</code> because <code>CREATE FUNCTION</code> is another way to load code from a file. This is an example of <strong>requires <code>LOAD</code>: false</strong>, <strong>requires <code>CREATE EXTENSION</code>: true</strong>.</p><p><a href="https://www.postgresql.org/docs/current/sql-createfunction.html" target="_blank" rel="noopener noreferrer">CREATE FUNCTION ... AS &#x27;obj_file&#x27; documentation</a></p><blockquote><p>obj_file is the name of the shared library file containing the compiled <!-- -->[code]</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE FUNCTION &quot;jsonb_matches_schema&quot;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;schema&quot; json,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;instance&quot; jsonb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) RETURNS bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMMUTABLE STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LANGUAGE c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS &#x27;MODULE_PATHNAME&#x27;, &#x27;jsonb_matches_schema_wrapper&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>You can always know whether or not an extension requires <code>CREATE EXTENSION</code> by the presence of a control file in <code>$(pg_config --sharedir)/extension</code></p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooks-that-require-a-restart">Hooks that require a restart<a href="#hooks-that-require-a-restart" class="hash-link" aria-label="Direct link to Hooks that require a restart" title="Direct link to Hooks that require a restart">​</a></h3><p>An extension is in the category <strong>requires <code>CREATE EXTENSION</code>: true</strong> and <strong>requires <code>LOAD</code>: true</strong> if the extension has libraries that use hooks which require a restart and it has a control file.</p><p>You will be able to identify this is the case when the extension&#x27;s documentation mentions both <code>CREATE EXTENSION</code> and <code>shared_preload_libraries</code>. Sometimes an error message or hint is provided if you run <code>CREATE EXTENSION</code> before loaded the library, or if you try to run <code>LOAD</code> directly, but you can&#x27;t count on that.</p><p>For example, in the case of both <code>pg_cron</code> and <code>pg_partman</code>, there are a background workers. These are examples of extensions using hooks in the start up process of Postgres. So, in both of these cases the user is expected to configure <code>shared_preload_libraries</code> to start the background worker, then run <code>CREATE EXTENSION</code> on a cluster where that background worker is already running.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-is-needed-when-there-isnt-a-control-file">LOAD is needed when there isn&#x27;t a control file<a href="#load-is-needed-when-there-isnt-a-control-file" class="hash-link" aria-label="Direct link to LOAD is needed when there isn&#x27;t a control file" title="Direct link to LOAD is needed when there isn&#x27;t a control file">​</a></h3><p>In the case of auto_explain, it uses hooks that do not require a restart. In this case, there is no control file and no extra SQL objects to be created. So <code>LOAD</code> is required simply because we have to load it into memory somehow. To demonstrate, it is technically possible to make a control file for auto_explain to allow for <code>CREATE EXTENSION</code> behavior instead of <code>LOAD</code>:</p><p><strong>auto_explain.control:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">comment = &#x27;auto explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_version = &#x27;0.0.1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module_pathname = &#x27;$libdir/auto_explain&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">relocatable = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">superuser = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>auto_explain--0.0.1.sql</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LOAD &#x27;auto_explain&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In practice, do not use <code>LOAD</code> in an extension start up script to activate hooks. <code>LOAD</code> is only applicable for the current connection.</p></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# CREATE EXTENSION auto_explain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE EXTENSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# \dx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     List of installed extensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Name       | Version |   Schema   |         Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------+---------+------------+------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> auto_explain    | 0.0.1   | public     | auto explain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> plpgsql         | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(2 rows)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_min_duration = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">postgres=# SET auto_explain.log_analyze = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running the above, now my subsequent queries have their <code>EXPLAIN ANALYZE</code> logged.</p><p>So, if that could work, <strong>why not just have control files for all extensions?</strong></p><p><strong>Having a control file requires version upgrade handling.</strong></p><p>When you have a control file, you also have to write upgrade scripts for every new version. In the case of pg_cron, we can find all these files in <strong>sharedir</strong>. When enabling version 1.5, it will run <code>pg_cron--1.0.sql</code>, then each migration script up to 1.5.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0--1.1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.0.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.1--1.2.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.2--1.3.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.3--1.4.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4-1--1.5.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron--1.4--1.4-1.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pg_cron.control</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since that&#x27;s not really applicable on auto_explain, because it&#x27;s just logging outputs and there is nothing to migrate or handle between versions, it&#x27;s just cleaner to not have a control file. Upgrading auto_explain only involves replacing the library, then loading it again.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Upgrade logic is not applicable for extensions that do not require <code>CREATE EXTENSION</code>. These cases just involve re-loading a new version of the library.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-dont-load-hooks-during-create-extension">You don&#x27;t load hooks during CREATE EXTENSION<a href="#you-dont-load-hooks-during-create-extension" class="hash-link" aria-label="Direct link to You don&#x27;t load hooks during CREATE EXTENSION" title="Direct link to You don&#x27;t load hooks during CREATE EXTENSION">​</a></h3><p>It made sense to me for activating hooks that require a restart they have to be configured in <code>shared_preload_libraries</code>. But for extensions that do not require a restart, it&#x27;s not obvious why the hooks can&#x27;t just be loaded during the <code>CREATE EXTENSION</code> start up script like I just demonstrated is possible with auto_explain.</p><p><strong>Even though it&#x27;s technically possible to <code>LOAD</code> hooks during <code>CREATE EXTENSION</code>, it&#x27;s a bad idea.</strong></p><p>First of all, when using the <code>LOAD</code> command directly, it&#x27;s only applicable to the current connection. So, in the above example with auto explain, the queries are only logged in the connection where I ran <code>CREATE EXTENSION</code>. To apply to all connections without a restart, it would need to go into <code>session_preload_libraries</code>. It is technically possible to do that inside of <code>CREATE EXTENSION</code> by doing <code>ALTER SYSTEM SET session_preload_libraries</code> then <code>SELECT pg_reload_conf()</code> in your start up script, but it is not a good approach for <code>CREATE EXTENSION</code> to automatically perform a configuration update. First of all it would confuse a user to change a config on the fly, and secondly there is currently no concept to automatically merge multi-value, comma-separated configurations like <code>session_preload_libraries</code>.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The 2x2 matrix makes it easier to understand how to enable an extension.</p><p>Just ask yourself &quot;do I need to run <code>CREATE EXTENSION</code>?&quot; determined by presence of a control file, and &quot;do I need to do a <code>LOAD</code>?&quot; determined by any mention of <code>LOAD</code>, <code>shared_preload_libraries</code>, or <code>session_preload_libraries</code> in the extension&#x27;s documentation or an error message.</p><p>In all cases of needing a <code>LOAD</code>, you can get away with setting it in <code>shared_preload_libraries</code>. You can optimize to avoid restarts in some cases.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="output-plugins">Output plugins<a href="#output-plugins" class="hash-link" aria-label="Direct link to Output plugins" title="Direct link to Output plugins">​</a></h3><p>There are some extensions, for example <a href="https://pgt.dev/extensions/wal2json" target="_blank" rel="noopener noreferrer">wal2json</a> that require neither <code>CREATE EXTENSION</code> or <code>LOAD</code>. In all known cases so far, these are <a href="https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html" target="_blank" rel="noopener noreferrer">output plugins</a>. I think it&#x27;s more of a stretch to call these &#x27;extensions&#x27;, but since they provide additional functionality to Postgres, that counts in my book.</p><p>In the case of output plugins, the library is loaded when a replication slot is created:</p><p><a href="https://www.postgresql.org/docs/current/logicaldecoding-example.html" target="_blank" rel="noopener noreferrer">Postgresql documentation</a></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM pg_create_logical_replication_slot(&#x27;regression_slot&#x27;, &#x27;test_decoding&#x27;, false, true);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-extensions">Installing extensions<a href="#installing-extensions" class="hash-link" aria-label="Direct link to Installing extensions" title="Direct link to Installing extensions">​</a></h2><p>Some of the above examples use the free and open source <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk project</a> that Tembo created, which allows us to skip the build process. It also installs extension dependencies, and provides metadata about other dependencies. When I&#x27;m trying out extensions, I am starting from one of Tembo’s container images to handle the system dependencies installation.</p><p><strong>I wrote <a href="https://tembo.io/docs/tembo-cloud/try-extensions-locally" target="_blank" rel="noopener noreferrer">this guide</a> for trying out extensions locally</strong>. If you have any issues just reach out on our <a href="https://join.slack.com/t/tembocommunity/shared_invite/zt-20v3m8pwz-pPjeFaWSM~Bt3KUqDXff2A" target="_blank" rel="noopener noreferrer">community Slack channel</a> and we can help.</p><p><em>Perhaps it&#x27;s not so bad after all...</em></p><p><img loading="lazy" alt="files-in-computer" src="/assets/images/files-in-computer-5a613d91e5bd9f281c1b4984e6e20976.gif" width="500" height="213" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automate-everything">Automate everything<a href="#automate-everything" class="hash-link" aria-label="Direct link to Automate everything" title="Direct link to Automate everything">​</a></h2><p>We want to make it possible to automatically install and turn on any Postgres extension. For this reason, we are seeking to qualify all known extensions by these two dimensions: requires <code>CREATE EXTENSION</code> true or false, and requires <code>LOAD</code> true or false.</p><p>To enable the community, that metadata is being published on <a href="https://pgt.dev" target="_blank" rel="noopener noreferrer">Trunk</a>. On <a href="https://cloud.tembo.io" target="_blank" rel="noopener noreferrer">Tembo Cloud</a>, we leverage that information to automatically enable extensions. Currently, we&#x27;ve got this working for over 150 extensions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dear-experts-tell-me-how-im-wrong-seriously">Dear experts, tell me how I&#x27;m wrong (seriously!)<a href="#dear-experts-tell-me-how-im-wrong-seriously" class="hash-link" aria-label="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)" title="Direct link to Dear experts, tell me how I&#x27;m wrong (seriously!)">​</a></h2><p>I&#x27;m serious that I want you to tell me where this is incorrect! If you&#x27;re a Postgres extensions expert, or maybe just know a thing or two about extensions that seems to conflict with something in this blog, please reach out on X <a href="https://twitter.com/sjmiller609" target="_blank" rel="noopener noreferrer">@sjmiller609</a> and let me know. Even if it&#x27;s just minor correction or subjective information, I&#x27;d love to hear from you. I also want to hear if there is an easier mental model than this. I hope this blog can serve as a minimal yet comprehensive explanation of what it takes to get extensions turned on.</p><p>Another way to contribute is to <strong>click the &quot;Edit this page&quot; link below</strong>, and suggest changes. I will happily accept improvements to this blog.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/postgres">postgres</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/extensions">extensions</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trunk">trunk</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://tembo.breezy.hr/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://pgt.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trunk<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/docs">Docs</a><span class="footer__link-separator">·</span><a href="https://twitter.com/tembo_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><span class="footer__link-separator">·</span><a href="https://www.linkedin.com/company/tembo-inc/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tembo. All Rights Reserved</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef584dc9.js"></script>
<script src="/assets/js/main.75ceccb8.js"></script>
</body>
</html>